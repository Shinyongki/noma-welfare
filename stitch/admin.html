<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>관리자 대시보드 - 경상남도사회서비스원</title>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        /* Sidebar navigation */
        .nav-item {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.625rem 1rem; margin: 0 0.5rem;
            border-radius: 0.5rem; font-size: 0.875rem;
            color: rgba(255,255,255,0.6); cursor: pointer;
            transition: all 0.2s; position: relative;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.06); }
        .nav-active {
            color: #fff !important; background: rgba(255,255,255,0.1) !important;
            border-left-color: #fff;
        }
        .nav-item .nav-badge {
            margin-left: auto; min-width: 1.25rem; height: 1.25rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; font-size: 0.65rem; font-weight: 700;
            background: #EF4444; color: #fff; padding: 0 0.35rem;
        }

        /* Cards */
        .card-elevated {
            background: #fff; border-radius: 0.75rem;
            padding: 1.25rem; border: 1px solid #E2E8F0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-elevated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        /* KPI gradient text */
        .kpi-value {
            font-size: 1.875rem; font-weight: 800; line-height: 1.2;
            background: linear-gradient(135deg, #98002E, #4A1942);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Table zebra */
        .table-zebra tbody tr:nth-child(even) { background: #F8FAFC; }
        .table-zebra tbody tr:hover { background: #EEF2FF !important; }

        /* Badge (keep) */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 600; }

        /* Sidebar overlay (mobile) */
        .sidebar-overlay {
            position: fixed; inset: 0; z-index: 45;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* Modal overlay */
        .modal-overlay { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }

        /* Panel content fade-in */
        .panel-content { animation: fade-in 0.3s ease-out both; }

        /* Kanban Board */
        .kanban-container {
            display: flex; gap: 1rem; min-height: 500px;
            align-items: flex-start;
        }
        .kanban-col {
            flex: 1; min-width: 0;
            background: #F8FAFC; border-radius: 0.75rem;
            border: 1px solid #E2E8F0;
            display: flex; flex-direction: column;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .kanban-col.kanban-highlight {
            border-color: #93C5FD;
            box-shadow: 0 0 0 1px #93C5FD, 0 4px 12px rgba(59,130,246,0.08);
        }
        .kanban-col.drag-over {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px #6366F1, 0 4px 16px rgba(99,102,241,0.15);
            background: #EEF2FF;
        }
        .kanban-header {
            padding: 0.75rem 1rem; border-bottom: 1px solid #E2E8F0;
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.8125rem; font-weight: 700;
        }
        .kanban-header .kanban-count {
            margin-left: auto; min-width: 1.25rem; height: 1.25rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; font-size: 0.65rem; font-weight: 700;
            padding: 0 0.35rem;
        }
        .kanban-body {
            padding: 0.5rem; flex: 1;
            overflow-y: auto; max-height: 600px;
            display: flex; flex-direction: column; gap: 0.5rem;
            min-height: 60px;
        }
        .kanban-card {
            background: #fff; border-radius: 0.5rem;
            border: 1px solid #E2E8F0; padding: 0.75rem;
            cursor: pointer; transition: all 0.2s;
            font-size: 0.8125rem;
        }
        .kanban-card:hover {
            border-color: #CBD5E1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .kanban-card.dragging {
            opacity: 0.4; transform: scale(0.97);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .kanban-card.bulk-selected {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99,102,241,0.3);
            background: #F5F3FF;
        }
        .kanban-card .card-summary { pointer-events: none; }
        .kanban-card .bulk-checkbox { pointer-events: auto; }

        /* Kanban Detail Modal */
        .kanban-modal-overlay {
            position: fixed; inset: 0; z-index: 70;
            background: rgba(0,0,0,0.45); backdrop-filter: blur(3px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .kanban-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .kanban-modal-panel {
            background: #fff; border-radius: 1rem;
            width: 100%; max-width: 740px; max-height: 85vh;
            margin: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.18);
            display: flex; flex-direction: column;
            transform: translateY(16px) scale(0.97);
            opacity: 0;
            transition: transform 0.25s cubic-bezier(0.4,0,0.2,1), opacity 0.2s ease;
        }
        .kanban-modal-overlay.active .kanban-modal-panel {
            transform: translateY(0) scale(1); opacity: 1;
        }
        .kanban-modal-header {
            flex-shrink: 0;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #E2E8F0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .kanban-modal-body {
            flex: 1; overflow-y: auto; padding: 1.5rem;
        }
        @media (max-width: 640px) {
            .kanban-modal-panel { max-width: 100%; margin: 0.5rem; max-height: 90vh; }
        }

        /* Approval Timeline */
        .approval-timeline { position: relative; padding-left: 1.5rem; }
        .approval-timeline::before {
            content: ''; position: absolute; left: 0.5rem; top: 0.25rem; bottom: 0.25rem;
            width: 2px; background: #E2E8F0;
        }
        .timeline-item { position: relative; padding-bottom: 0.75rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item .timeline-dot {
            position: absolute; left: -1.25rem; top: 0.125rem;
            width: 0.625rem; height: 0.625rem;
            border-radius: 9999px; border: 2px solid #CBD5E1;
            background: #fff;
        }
        .timeline-item.done .timeline-dot { border-color: #22C55E; background: #22C55E; }
        .timeline-item.current .timeline-dot { border-color: #3B82F6; background: #3B82F6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .timeline-item.rejected .timeline-dot { border-color: #EF4444; background: #EF4444; }

        /* Case Detail Slide-Over Panel */
        .case-panel-overlay {
            position: fixed; inset: 0; z-index: 65;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(2px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .case-panel-overlay.active { opacity: 1; pointer-events: auto; }

        .case-panel-drawer {
            position: fixed; top: 0; right: 0; bottom: 0; z-index: 66;
            width: 500px; max-width: 100vw;
            background: #fff; box-shadow: -4px 0 24px rgba(0,0,0,0.12);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .case-panel-drawer.open { transform: translateX(0); }

        .case-panel-header {
            flex-shrink: 0;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #065f46, #047857);
            color: #fff;
        }
        .case-panel-body {
            flex: 1; overflow-y: auto; padding: 1.25rem;
        }

        /* Case status stepper */
        .case-stepper { display: flex; align-items: flex-start; gap: 0; }
        .case-stepper-step {
            display: flex; flex-direction: column; align-items: center;
            min-width: 48px; flex: 0 0 auto;
        }
        .case-stepper-dot {
            width: 2rem; height: 2rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem; transition: all 0.2s;
        }
        .case-stepper-dot.done { background: #059669; color: #fff; }
        .case-stepper-dot.current { background: #D1FAE5; color: #065F46; box-shadow: 0 0 0 3px rgba(5,150,105,0.25); }
        .case-stepper-dot.future { background: #F1F5F9; color: #94A3B8; }
        .case-stepper-line {
            flex: 1; height: 2px; margin-top: 1rem; min-width: 12px;
        }
        .case-stepper-line.done { background: #059669; }
        .case-stepper-line.future { background: #E2E8F0; }

        /* Collapsible section */
        .case-collapse-toggle { cursor: pointer; user-select: none; }
        .case-collapse-body { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease, opacity 0.2s ease; }
        .case-collapse-body.open { max-height: 1000px; opacity: 1; }
        .case-collapse-icon { transition: transform 0.2s; }
        .case-collapse-body.open ~ .case-collapse-toggle .case-collapse-icon,
        .case-collapse-toggle.active .case-collapse-icon { transform: rotate(180deg); }

        @media (max-width: 640px) {
            .case-panel-drawer { width: 100vw; }
        }

        /* Kanban stats ribbon */
        .kanban-stat { cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
        .kanban-stat:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* Responsive: horizontal scroll on tablet, stack on mobile */
        @media (max-width: 1023px) and (min-width: 641px) {
            .kanban-container {
                overflow-x: auto; -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory; padding-bottom: 0.5rem;
            }
            .kanban-col { min-width: 280px; flex: 0 0 280px; scroll-snap-align: start; }
        }
        @media (max-width: 640px) {
            .kanban-container { flex-direction: column; }
            .kanban-col { min-width: 0; }
            .kanban-body { max-height: 400px; }
            .kanban-card { padding: 0.875rem; font-size: 0.875rem; }
        }

        /* View toggle buttons */
        .view-toggle-btn {
            display: flex; align-items: center; justify-content: center;
            width: 2rem; height: 2rem; border-radius: 0.375rem;
            border: 1px solid #E2E8F0; cursor: pointer;
            transition: all 0.15s; color: #94A3B8;
        }
        .view-toggle-btn:hover { background: #F1F5F9; color: #475569; }
        .view-toggle-btn.active {
            background: #EEF2FF; color: #6366F1;
            border-color: #6366F1;
        }

        /* Collab table view */
        .collab-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        .collab-table thead th {
            padding: 0.625rem 0.75rem; text-align: left;
            font-size: 0.6875rem; font-weight: 700;
            text-transform: uppercase; color: #64748B;
            background: #F8FAFC; border-bottom: 1px solid #E2E8F0;
            cursor: pointer; user-select: none;
            white-space: nowrap;
        }
        .collab-table thead th:hover { color: #334155; background: #F1F5F9; }
        .collab-table thead th .sort-arrow { font-size: 14px; vertical-align: middle; margin-left: 2px; }
        .collab-table tbody tr {
            border-bottom: 1px solid #F1F5F9;
            transition: background 0.15s; cursor: pointer;
        }
        .collab-table tbody tr:hover { background: #EEF2FF !important; }
        .collab-table tbody tr:nth-child(even) { background: #F8FAFC; }
        .collab-table tbody td { padding: 0.5rem 0.75rem; }
        .collab-table tbody tr.bulk-selected { background: #F5F3FF !important; }

        /* Bulk action bar */
        .bulk-bar {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
            z-index: 55; background: #1E293B; color: #fff;
            border-radius: 0.75rem; padding: 0.625rem 1rem;
            display: flex; align-items: center; gap: 0.75rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            animation: fade-in 0.2s ease-out;
            max-width: calc(100% - 2rem);
        }
        .bulk-bar button {
            padding: 0.375rem 0.75rem; border-radius: 0.375rem;
            font-size: 0.75rem; font-weight: 600; white-space: nowrap;
            transition: background 0.15s;
        }

        /* Phase 3: 고대비 모드 */
        @media (prefers-contrast: more) {
            .text-slate-400, .text-slate-500 { color: #1e293b !important; }
            .border-slate-100, .border-slate-200 { border-color: #475569 !important; }
        }

        /* Phase 3: reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body class="bg-content-bg min-h-screen font-sans text-slate-800">

    <!-- 로그인 게이트 -->
    <div id="login-gate" class="flex items-center justify-center min-h-screen bg-gradient-to-b from-sidebar-start to-sidebar-end">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <div class="w-14 h-14 rounded-xl bg-primary/10 flex items-center justify-center mx-auto mb-3">
                    <span class="material-symbols-outlined text-primary text-3xl" aria-hidden="true">admin_panel_settings</span>
                </div>
                <h1 class="text-xl font-bold text-slate-800">관리자 로그인</h1>
                <p class="text-sm text-slate-500 mt-1">경상남도사회서비스원</p>
            </div>
            <div id="login-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm"></div>
            <input id="login-password" type="password" placeholder="관리자 비밀번호"
                class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none text-sm"
                onkeydown="if(event.key==='Enter')doLogin()" />
            <button onclick="doLogin()" class="w-full mt-4 py-3 bg-primary text-white rounded-lg font-semibold text-sm hover:bg-primary-light transition-colors">
                로그인
            </button>
        </div>
    </div>

    <!-- 메인 콘텐츠 (인증 후 표시) -->
    <div id="main-content" class="hidden">

    <!-- Sidebar Overlay (mobile) -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-60 bg-gradient-to-b from-sidebar-start to-sidebar-end flex flex-col transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <!-- Logo -->
        <div class="px-5 py-5 flex items-center gap-3 border-b border-white/10">
            <div class="w-9 h-9 rounded-lg bg-white/15 flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-xl" aria-hidden="true" style="font-variation-settings:'FILL' 1">dashboard</span>
            </div>
            <div>
                <h1 class="text-sm font-bold text-white leading-tight">관리자 대시보드</h1>
                <p class="text-[10px] text-white/40 leading-none mt-0.5">경상남도사회서비스원</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 py-4 space-y-1">
            <div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item nav-active">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">monitoring</span>
                현황판
            </div>
            <div onclick="switchTab('requests')" id="nav-requests" class="nav-item">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">list_alt</span>
                상담 요청
            </div>
            <div onclick="switchTab('analytics')" id="nav-analytics" class="nav-item">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">analytics</span>
                분석
            </div>
            <div onclick="switchTab('collab')" id="nav-collab" class="nav-item">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">hub</span>
                연계 조정
                <span id="sidebar-collab-badge" class="nav-badge" style="display:none">0</span>
            </div>
        </nav>

        <!-- Bottom link -->
        <div class="px-3 pb-4">
            <a href="/" class="nav-item !text-white/40 hover:!text-white/70">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">home</span>
                메인으로
            </a>
        </div>
    </aside>

    <!-- Topbar -->
    <header id="topbar" class="fixed top-0 right-0 left-0 lg:left-60 z-40 h-14 bg-white/80 backdrop-blur-md border-b border-slate-200/60 flex items-center justify-between px-4 sm:px-6 transition-all">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="lg:hidden p-1.5 hover:bg-slate-100 rounded-lg">
                <span class="material-symbols-outlined text-xl text-slate-600" aria-hidden="true">menu</span>
            </button>
            <h2 id="topbar-title" class="text-base font-semibold text-slate-800">현황판</h2>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs text-slate-400 hidden sm:inline" id="topbar-time"></span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="lg:ml-60 pt-14 min-h-screen">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">

            <!-- Tab 1: Dashboard -->
            <section id="panel-dashboard" class="panel-content">
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-primary text-xl" aria-hidden="true">inbox</span>
                            <span class="text-sm text-slate-500">총 접수</span>
                        </div>
                        <p id="kpi-total" class="kpi-value">-</p>
                    </div>
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-amber-500 text-xl" aria-hidden="true">today</span>
                            <span class="text-sm text-slate-500">오늘 접수</span>
                        </div>
                        <p id="kpi-today" class="kpi-value">-</p>
                    </div>
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-blue-500 text-xl" aria-hidden="true">pending_actions</span>
                            <span class="text-sm text-slate-500">미처리</span>
                        </div>
                        <p id="kpi-open" class="kpi-value">-</p>
                    </div>
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-green-600 text-xl" aria-hidden="true">schedule</span>
                            <span class="text-sm text-slate-500">평균 처리일</span>
                        </div>
                        <p id="kpi-avg-days" class="kpi-value">-</p>
                    </div>
                </div>

                <!-- Status Cards -->
                <div class="grid grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
                    <div class="card-elevated text-center !p-4">
                        <span class="badge bg-blue-100 text-blue-600 mb-2">접수</span>
                        <p id="st-open" class="text-2xl font-bold mt-1">-</p>
                    </div>
                    <div class="card-elevated text-center !p-4">
                        <span class="badge bg-amber-100 text-amber-600 mb-2">확인</span>
                        <p id="st-confirmed" class="text-2xl font-bold mt-1">-</p>
                    </div>
                    <div class="card-elevated text-center !p-4">
                        <span class="badge bg-purple-100 text-purple-600 mb-2">연락</span>
                        <p id="st-contacted" class="text-2xl font-bold mt-1">-</p>
                    </div>
                    <div class="card-elevated text-center !p-4">
                        <span class="badge bg-teal-100 text-teal-600 mb-2">연결</span>
                        <p id="st-connected" class="text-2xl font-bold mt-1">-</p>
                    </div>
                    <div class="card-elevated text-center !p-4">
                        <span class="badge bg-green-100 text-green-700 mb-2">완료</span>
                        <p id="st-closed" class="text-2xl font-bold mt-1">-</p>
                    </div>
                    <div class="card-elevated text-center !p-4">
                        <span class="badge bg-indigo-100 text-indigo-600 mb-2">연계</span>
                        <p id="st-referred" class="text-2xl font-bold mt-1">-</p>
                    </div>
                </div>

                <!-- Chart + Overdue / KPI row -->
                <div class="grid lg:grid-cols-3 gap-6 mb-6">
                    <!-- 14-day trend chart -->
                    <div class="lg:col-span-2 card-elevated">
                        <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-primary" aria-hidden="true">bar_chart</span>
                            14일 접수 추이
                        </h3>
                        <div style="height:260px"><canvas id="chart-daily"></canvas></div>
                    </div>
                    <!-- Overdue alerts -->
                    <div class="card-elevated">
                        <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-red-500" aria-hidden="true">warning</span>
                            미처리 알림 (3일+)
                        </h3>
                        <div id="overdue-list" class="space-y-2 max-h-[240px] overflow-y-auto text-sm">
                            <p class="text-slate-400">로딩 중...</p>
                        </div>
                    </div>
                </div>

                <!-- 연계 조정 현황 (dashboard: 승인 대기 + 최근 5건) -->
                <div class="card-elevated mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-indigo-500" aria-hidden="true">hub</span>
                            연계 조정 현황
                            <span id="collab-count" class="ml-1 px-2 py-0.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-600">-</span>
                            <span id="pending-count-badge" class="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-600" style="display:none">대기 0</span>
                        </h3>
                        <button onclick="switchTab('collab')" class="text-xs text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-0.5">
                            더보기<span class="material-symbols-outlined text-sm" aria-hidden="true">chevron_right</span>
                        </button>
                    </div>
                    <div id="collab-dashboard-list" class="space-y-2 max-h-[280px] overflow-y-auto">
                        <p class="text-slate-400 text-sm py-4 text-center">로딩 중...</p>
                    </div>
                </div>

                <!-- System KPI -->
                <div class="card-elevated">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-lg text-deep-purple" aria-hidden="true">speed</span>
                        시스템 KPI (7일)
                    </h3>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4" id="system-kpi">
                        <p class="text-slate-400 text-sm col-span-full">로딩 중...</p>
                    </div>
                </div>
            </section>

            <!-- Tab 2: Requests -->
            <section id="panel-requests" class="hidden">
                <!-- Filter Bar -->
                <div class="card-elevated !p-4 mb-4 flex flex-wrap gap-3 items-center">
                    <select id="filter-status" onchange="loadRequests()" class="rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary">
                        <option value="all">전체 상태</option>
                        <option value="open">접수</option>
                        <option value="confirmed">확인</option>
                        <option value="contacted">연락</option>
                        <option value="connected">연결</option>
                        <option value="closed">완료</option>
                        <option value="referred">연계</option>
                    </select>
                    <div class="flex-1 min-w-[200px]">
                        <input id="filter-search" type="text" placeholder="이름, 전화, 서비스명 검색..." onkeyup="debounceSearch()" class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" />
                    </div>
                    <button onclick="toggleSort()" id="sort-btn" class="flex items-center gap-1 text-sm text-slate-600 hover:text-primary px-3 py-2 rounded-lg border border-slate-300">
                        <span class="material-symbols-outlined text-lg" aria-hidden="true">swap_vert</span>
                        <span id="sort-label">최신순</span>
                    </button>
                </div>

                <!-- Request Table -->
                <div class="card-elevated !p-0 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm table-zebra">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">번호</th>
                                    <th class="px-4 py-3 text-left">이름</th>
                                    <th class="px-4 py-3 text-left hidden sm:table-cell">전화</th>
                                    <th class="px-4 py-3 text-left">서비스명</th>
                                    <th class="px-4 py-3 text-left">상태</th>
                                    <th class="px-4 py-3 text-left hidden md:table-cell">접수일</th>
                                    <th class="px-4 py-3 text-center">상세</th>
                                </tr>
                            </thead>
                            <tbody id="requests-tbody" class="divide-y divide-slate-100">
                                <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="flex items-center justify-between px-4 py-3 border-t border-slate-100 text-sm">
                        <span id="page-info" class="text-slate-500"></span>
                        <div class="flex gap-1" id="page-buttons"></div>
                    </div>
                </div>
            </section>

            <!-- Tab 3: Analytics -->
            <section id="panel-analytics" class="hidden">
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <!-- Service Ranking -->
                    <div class="card-elevated">
                        <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-primary" aria-hidden="true">leaderboard</span>
                            서비스 인기 랭킹
                        </h3>
                        <div style="height:300px"><canvas id="chart-service"></canvas></div>
                    </div>
                    <!-- Category Distribution -->
                    <div class="card-elevated">
                        <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-deep-purple" aria-hidden="true">donut_large</span>
                            카테고리 분포
                        </h3>
                        <div style="height:300px" class="flex items-center justify-center"><canvas id="chart-category"></canvas></div>
                    </div>
                </div>
                <!-- Event Trends -->
                <div class="card-elevated">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-lg text-blue-500" aria-hidden="true">show_chart</span>
                        이벤트 추이 (7일)
                    </h3>
                    <div style="height:280px"><canvas id="chart-trends"></canvas></div>
                </div>
            </section>

            <!-- Tab 4: Linkage Coordination (Kanban) -->
            <section id="panel-collab" class="hidden">
                <!-- Filter toolbar -->
                <div class="card-elevated !p-3 mb-4 flex flex-wrap gap-3 items-center">
                    <select id="collab-filter-cat" onchange="applyCollabFilter()" class="rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary">
                        <option value="all">전체 유형</option>
                        <option value="referral">서비스연계</option>
                        <option value="dept">부서협업</option>
                    </select>
                    <div class="flex-1 min-w-[180px]">
                        <input id="collab-search" type="text" placeholder="이름, 서비스, 부서 검색..." oninput="debounceCollabSearch()" class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" />
                    </div>
                    <span id="collab-total-count" class="text-xs text-slate-400">-</span>
                    <div class="flex gap-1 ml-auto">
                        <button id="view-kanban-btn" class="view-toggle-btn active" onclick="switchCollabView('kanban')" title="칸반 뷰">
                            <span class="material-symbols-outlined" style="font-size:18px" aria-hidden="true">view_kanban</span>
                        </button>
                        <button id="view-table-btn" class="view-toggle-btn" onclick="switchCollabView('table')" title="테이블 뷰">
                            <span class="material-symbols-outlined" style="font-size:18px" aria-hidden="true">table_rows</span>
                        </button>
                    </div>
                </div>

                <!-- Stats ribbon -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-pending')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span>
                            <span class="text-xs font-semibold text-slate-500">부서 대기</span>
                        </div>
                        <p id="kb-st-pending" class="text-xl font-bold text-yellow-700">-</p>
                    </div>
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-dept-approved')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-400"></span>
                            <span class="text-xs font-semibold text-slate-500">관리자 승인 대기</span>
                        </div>
                        <p id="kb-st-dept-approved" class="text-xl font-bold text-blue-700">-</p>
                    </div>
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-approved')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-green-400"></span>
                            <span class="text-xs font-semibold text-slate-500">처리 완료</span>
                        </div>
                        <p id="kb-st-approved" class="text-xl font-bold text-green-700">-</p>
                    </div>
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-rejected')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-400"></span>
                            <span class="text-xs font-semibold text-slate-500">반려/반환</span>
                        </div>
                        <p id="kb-st-rejected" class="text-xl font-bold text-red-600">-</p>
                    </div>
                </div>

                <!-- Bulk action bar (hidden by default) -->
                <div id="bulk-bar" class="bulk-bar" style="display:none">
                    <span id="bulk-count" class="text-sm font-semibold whitespace-nowrap">0건 선택</span>
                    <select id="bulk-status-select" class="rounded border-slate-600 bg-slate-700 text-white text-xs py-1 px-2">
                        <option value="">상태 변경...</option>
                        <option value="pending">부서 대기</option>
                        <option value="dept_approved">관리자 승인 대기</option>
                        <option value="approved">처리 완료</option>
                        <option value="rejected">반려/반환</option>
                    </select>
                    <button onclick="bulkChangeStatus()" class="bg-indigo-500 hover:bg-indigo-600 text-white">적용</button>
                    <button onclick="clearBulkSelection()" class="bg-slate-600 hover:bg-slate-500 text-white">취소</button>
                </div>

                <!-- Kanban board -->
                <div id="collab-kanban" class="kanban-container">
                    <!-- Column 1: 부서 대기 -->
                    <div id="col-pending" class="kanban-col" data-col="pending" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'pending')">
                        <div class="kanban-header text-yellow-700">
                            <span class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span>
                            부서 대기
                            <span class="kanban-count bg-yellow-100 text-yellow-700" id="cnt-pending">0</span>
                        </div>
                        <div class="kanban-body" id="body-pending">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                    <!-- Column 2: 관리자 승인 대기 (highlighted) -->
                    <div id="col-dept-approved" class="kanban-col kanban-highlight" data-col="dept_approved" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'dept_approved')">
                        <div class="kanban-header text-blue-700">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-400"></span>
                            관리자 승인 대기
                            <span class="kanban-count bg-blue-100 text-blue-700" id="cnt-dept-approved">0</span>
                        </div>
                        <div class="kanban-body" id="body-dept-approved">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                    <!-- Column 3: 처리 완료 -->
                    <div id="col-approved" class="kanban-col" data-col="approved" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'approved')">
                        <div class="kanban-header text-green-700">
                            <span class="w-2.5 h-2.5 rounded-full bg-green-400"></span>
                            처리 완료
                            <span class="kanban-count bg-green-100 text-green-700" id="cnt-approved">0</span>
                        </div>
                        <div class="kanban-body" id="body-approved">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                    <!-- Column 4: 반려/반환 -->
                    <div id="col-rejected" class="kanban-col" data-col="rejected" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'rejected')">
                        <div class="kanban-header text-red-600">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-400"></span>
                            반려/반환
                            <span class="kanban-count bg-red-100 text-red-600" id="cnt-rejected">0</span>
                        </div>
                        <div class="kanban-body" id="body-rejected">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                </div>

                <!-- Table view (hidden by default) -->
                <div id="collab-table-view" class="card-elevated !p-0 overflow-hidden" style="display:none">
                    <div class="overflow-x-auto">
                        <table class="collab-table">
                            <thead>
                                <tr>
                                    <th style="width:2.5rem;text-align:center;cursor:default">
                                        <input type="checkbox" id="collab-table-check-all" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 w-3.5 h-3.5" onchange="toggleTableBulkAll(this.checked)" />
                                    </th>
                                    <th onclick="sortTable('id')">번호 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('title')">제목 (유형) <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('status')">상태 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('category')">카테고리 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('date')">날짜 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('dept')">담당부서 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                </tr>
                            </thead>
                            <tbody id="collab-table-body">
                                <tr><td colspan="7" class="text-center text-slate-400 py-8">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[60] hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div id="modal-panel" class="absolute inset-y-0 right-0 w-full max-w-xl bg-white shadow-2xl overflow-y-auto animate-slide-in-right">
            <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex items-center justify-between z-10">
                <h2 class="text-lg font-bold text-slate-800">요청 상세</h2>
                <button onclick="closeModal()" class="p-1 hover:bg-slate-100 rounded-lg">
                    <span class="material-symbols-outlined" aria-hidden="true">close</span>
                </button>
            </div>
            <div id="modal-body" class="p-6">
                <p class="text-slate-400">로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- Kanban Card Detail Modal -->
    <div id="kanban-detail-modal" class="kanban-modal-overlay" onclick="onKanbanModalOverlayClick(event)">
        <div class="kanban-modal-panel" onclick="event.stopPropagation()">
            <div class="kanban-modal-header">
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <span id="kanban-modal-status" class="badge bg-slate-100 text-slate-600" style="font-size:11px">-</span>
                    <h3 id="kanban-modal-title" class="text-base font-bold text-slate-800 truncate">상세 정보</h3>
                </div>
                <button onclick="closeKanbanModal()" class="p-1.5 hover:bg-slate-100 rounded-lg flex-shrink-0 ml-3" aria-label="닫기">
                    <span class="material-symbols-outlined text-slate-500" aria-hidden="true">close</span>
                </button>
            </div>
            <div id="kanban-modal-body" class="kanban-modal-body">
                <p class="text-slate-400 text-sm text-center py-8">로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- Case Detail Slide-Over Panel -->
    <div id="case-panel-overlay" class="case-panel-overlay" onclick="closeCasePanel()"></div>
    <div id="case-panel-drawer" class="case-panel-drawer" role="dialog" aria-modal="true" aria-label="케이스 상세">
        <!-- Header -->
        <div class="case-panel-header">
            <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <span class="material-symbols-outlined text-white/80" aria-hidden="true">assignment</span>
                    <h2 id="case-panel-title" class="text-base font-bold truncate">케이스 상세</h2>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0">
                    <a id="case-panel-newtab" href="#" target="_blank" class="p-1.5 rounded-lg hover:bg-white/15 transition-colors" title="새 탭에서 열기">
                        <span class="material-symbols-outlined text-white/70 text-lg" aria-hidden="true">open_in_new</span>
                    </a>
                    <button onclick="closeCasePanel()" class="p-1.5 rounded-lg hover:bg-white/15 transition-colors" aria-label="닫기">
                        <span class="material-symbols-outlined text-white/70 text-lg" aria-hidden="true">close</span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="case-panel-badge" class="badge bg-white/20 text-white text-xs">-</span>
                <span id="case-panel-name" class="text-sm text-white/70">-</span>
            </div>
        </div>
        <!-- Body -->
        <div id="case-panel-body" class="case-panel-body">
            <p class="text-slate-400 text-sm text-center py-8">로딩 중...</p>
        </div>
    </div>

    <script>
    // ── State ──
    let currentTab = 'dashboard';
    let currentSort = 'newest';
    let currentPage = 1;
    let searchTimer = null;
    let charts = {};
    let sidebarOpen = false;
    let allCollabs = [];
    let draggedLinkageId = null;
    let bulkSelected = new Set();

    // ── Status helpers ──
    const STATUS_MAP = {
        open:      { label: '접수', bg: 'bg-blue-100',   text: 'text-blue-600' },
        confirmed: { label: '확인', bg: 'bg-amber-100',  text: 'text-amber-600' },
        contacted: { label: '연락', bg: 'bg-purple-100', text: 'text-purple-600' },
        connected: { label: '연결', bg: 'bg-teal-100',   text: 'text-teal-600' },
        closed:    { label: '완료', bg: 'bg-green-100',  text: 'text-green-700' },
        referred:  { label: '연계', bg: 'bg-indigo-100', text: 'text-indigo-600' },
    };

    function statusBadge(status) {
        const s = STATUS_MAP[status] || { label: status, bg: 'bg-slate-100', text: 'text-slate-600' };
        return `<span class="badge ${s.bg} ${s.text}">${s.label}</span>`;
    }

    function shortId(id) { return id ? id.slice(0, 8) : '-'; }

    function formatDate(r) {
        if (r.createdAtISO) {
            const d = new Date(r.createdAtISO);
            return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
        return r.createdAt || '-';
    }

    // ── Tab titles ──
    const TAB_TITLES = {
        dashboard: '현황판',
        requests: '상담 요청',
        analytics: '분석',
        collab: '연계 조정',
    };

    // ── Tab switching ──
    function switchTab(tab) {
        currentTab = tab;
        // Sidebar nav active state
        document.querySelectorAll('.nav-item[id^="nav-"]').forEach(el => el.classList.remove('nav-active'));
        const navEl = document.getElementById('nav-' + tab);
        if (navEl) navEl.classList.add('nav-active');

        // Topbar title
        document.getElementById('topbar-title').textContent = TAB_TITLES[tab] || tab;

        // Toggle panels
        ['dashboard', 'requests', 'analytics', 'collab'].forEach(p => {
            const panel = document.getElementById('panel-' + p);
            if (p === tab) {
                panel.classList.remove('hidden');
                panel.classList.add('panel-content');
                // Re-trigger animation
                panel.style.animation = 'none';
                panel.offsetHeight; // reflow
                panel.style.animation = '';
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('panel-content');
            }
        });

        // Load data
        if (tab === 'dashboard') loadDashboard();
        else if (tab === 'requests') loadRequests();
        else if (tab === 'analytics') loadAnalytics();
        else if (tab === 'collab') loadCollabPanel();

        // Close sidebar on mobile
        closeSidebar();
    }

    // ── Sidebar toggle ──
    function toggleSidebar() {
        sidebarOpen ? closeSidebar() : openSidebar();
    }

    function openSidebar() {
        sidebarOpen = true;
        document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.add('active');
    }

    function closeSidebar() {
        if (window.innerWidth >= 1024) return; // Keep open on desktop
        sidebarOpen = false;
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.remove('active');
    }

    // ── Window resize handler ──
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('active');
            sidebarOpen = false;
        } else if (!sidebarOpen) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }
    });

    // ── API helpers ──
    async function api(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        return res.json();
    }

    // ── Dashboard ──
    // 부서 이름 매핑
    let deptMap = {};
    async function loadDeptMap() {
        try {
            const depts = await api('/api/departments');
            depts.forEach(d => { deptMap[d.id] = d.name; });
        } catch { /* ignore */ }
    }
    function getDeptName(id) { return deptMap[id] || id; }

    const APPROVAL_STATUS_MAP = {
        pending:                     { label: '부서 대기', bg: 'bg-yellow-100', text: 'text-yellow-700' },
        dept_approved:               { label: '부서 승인', bg: 'bg-blue-100', text: 'text-blue-700' },
        approved:                    { label: '최종 승인', bg: 'bg-green-100', text: 'text-green-700' },
        rejected:                    { label: '부서 반려', bg: 'bg-red-100', text: 'text-red-600' },
        revision_requested:          { label: '부서 수정요청', bg: 'bg-orange-100', text: 'text-orange-600' },
        admin_rejected:              { label: '관리자 반려', bg: 'bg-red-100', text: 'text-red-600' },
        admin_revision_requested:    { label: '관리자 수정요청', bg: 'bg-orange-100', text: 'text-orange-600' },
    };
    const COLLAB_STATUS_MAP = {
        requested: { label: '대기', bg: 'bg-yellow-100', text: 'text-yellow-700' },
        accepted:  { label: '승인', bg: 'bg-green-100', text: 'text-green-700' },
        completed: { label: '완료', bg: 'bg-green-100', text: 'text-green-700' },
        declined:  { label: '반려', bg: 'bg-red-100', text: 'text-red-600' },
    };
    const COLLAB_TYPE_MAP = {
        consultation: '자문', joint: '공동처리', transfer: '이관', service_referral: '서비스연계',
    };

    function renderCollabItem(c) {
        // 승인 상태 우선 표시
        const approvalSt = c.approvalStatus ? (APPROVAL_STATUS_MAP[c.approvalStatus] || APPROVAL_STATUS_MAP.pending) : null;
        const st = approvalSt || COLLAB_STATUS_MAP[c.status] || COLLAB_STATUS_MAP.requested;
        const typeName = COLLAB_TYPE_MAP[c.type] || '자문';
        const catLabel = c.category === 'referral' ? '서비스연계' : '부서협업';

        // 방향 표시
        let directionHtml = '';
        if (c.category === 'referral' && c.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(c.targetService)}</span>`;
        } else if (c.fromDept && c.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(c.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400 text-sm" aria-hidden="true">arrow_forward</span>
                <span class="font-semibold text-green-700">${getDeptName(c.toDept)}</span>`;
        }

        const bgColor = c.approvalStatus === 'pending' ? 'bg-yellow-50 hover:bg-yellow-100 border border-yellow-200'
            : c.approvalStatus === 'dept_approved' ? 'bg-blue-50 hover:bg-blue-100 border border-blue-200'
            : c.approvalStatus === 'admin_rejected' ? 'bg-red-50 hover:bg-red-100 border border-red-200'
            : c.approvalStatus === 'admin_revision_requested' ? 'bg-orange-50 hover:bg-orange-100 border border-orange-200'
            : 'bg-slate-50 hover:bg-indigo-50';

        return `
        <div class="flex items-center gap-3 p-3 rounded-lg ${bgColor} transition-colors cursor-pointer" onclick="openDetail('${c.requestId}')">
            <div class="flex-shrink-0">
                <span class="badge ${st.bg} ${st.text}">${st.label}</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5 text-sm">
                    ${directionHtml}
                    <span class="text-xs text-slate-400 ml-1">(${typeName})</span>
                </div>
                <p class="text-xs text-slate-500 truncate mt-0.5">${c.userName || '-'} · ${c.serviceName || '-'} · ${c.reason || ''}</p>
            </div>
            <div class="text-xs text-slate-400 flex-shrink-0">${new Date(c.createdAt).toLocaleDateString('ko-KR', {month:'numeric',day:'numeric'})}</div>
        </div>`;
    }

    // 승인 스테퍼 HTML 생성 (관리자용)
    function renderApprovalStepper(approvalStatus) {
        const steps = [
            { label: '담당자', key: 'submitted' },
            { label: '부서 조정자', key: 'dept' },
            { label: '관리자 최종', key: 'admin' },
        ];
        let stepIdx = 0;
        if (approvalStatus === 'dept_approved') stepIdx = 1;
        else if (approvalStatus === 'approved') stepIdx = 2;
        else if (approvalStatus === 'admin_rejected' || approvalStatus === 'admin_revision_requested') stepIdx = 1;
        else if (approvalStatus === 'rejected' || approvalStatus === 'revision_requested') stepIdx = 0;
        const isDone = approvalStatus === 'approved';

        let html = '<div class="flex items-center gap-1 mb-2">';
        steps.forEach((s, i) => {
            const done = isDone || i < stepIdx;
            const current = !isDone && i === stepIdx;
            const colorClass = done ? 'bg-green-500 text-white' : current ? 'bg-blue-500 text-white ring-2 ring-blue-300' : 'bg-slate-200 text-slate-400';
            const lineColor = done ? 'bg-green-400' : 'bg-slate-200';
            html += `<div class="flex flex-col items-center" style="min-width:24px">
                <div class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${colorClass}">${i + 1}</div>
                <span class="text-[9px] mt-0.5 whitespace-nowrap ${current ? 'font-bold text-blue-700' : done ? 'text-green-700' : 'text-slate-400'}">${s.label}</span>
            </div>`;
            if (i < steps.length - 1) html += `<div class="flex-1 h-0.5 ${lineColor} -mt-3"></div>`;
        });
        html += '</div>';
        return html;
    }

    // 승인 대기 카드 (관리자 최종 승인/반려/수정요청 버튼 포함, dept_approved 건만 표시)
    function renderPendingItem(c) {
        const typeName = COLLAB_TYPE_MAP[c.type] || '자문';
        let directionHtml = '';
        if (c.category === 'referral' && c.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(c.targetService)}</span>`;
        } else if (c.fromDept && c.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(c.fromDept)}</span> → <span class="font-semibold text-green-700">${getDeptName(c.toDept)}</span>`;
        }

        return `
        <div class="p-4 rounded-lg border border-blue-200 bg-blue-50">
            <div class="flex items-center gap-2 mb-2">
                <span class="badge bg-blue-100 text-blue-700">부서 승인 완료</span>
                <span class="text-xs text-slate-500">${c.category === 'referral' ? '서비스연계' : '부서협업'} · ${typeName}</span>
                <span class="text-xs text-slate-400 ml-auto">${new Date(c.createdAt).toLocaleDateString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
            </div>
            ${renderApprovalStepper(c.approvalStatus)}
            <div class="text-sm mb-1">${directionHtml}</div>
            <p class="text-xs text-slate-600 mb-1">${c.userName || '-'} · ${c.serviceName || '-'}</p>
            <p class="text-sm text-slate-700 mb-3">${escapeHtml(c.reason || '')}</p>
            <div class="flex gap-2 items-center">
                <button onclick="approveLinkage('${c.id}',event)" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">check_circle</span>최종 승인
                </button>
                <button onclick="rejectLinkage('${c.id}',event)" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>
                <button onclick="revisionLinkage('${c.id}',event)" class="px-3 py-1.5 bg-white border border-orange-300 text-orange-600 rounded-lg text-xs font-semibold hover:bg-orange-50 transition-colors">수정요청</button>
                <div class="flex-1"></div>
                <button onclick="openDetail('${c.requestId}')" class="px-2 py-1.5 text-xs text-indigo-600 hover:text-indigo-800 font-semibold">상세</button>
            </div>
        </div>`;
    }

    function updateSidebarCollabBadge(pendingCount) {
        const badgeEl = document.getElementById('sidebar-collab-badge');
        if (pendingCount > 0) {
            badgeEl.style.display = '';
            badgeEl.textContent = pendingCount;
        } else {
            badgeEl.style.display = 'none';
        }
    }

    async function loadDashboard() {
        try {
            const [stats, kpi, collabs, pendingData] = await Promise.all([
                api('/api/admin/stats'), api('/api/admin/kpi?days=7'),
                api('/api/admin/linkages'), api('/api/admin/pending-approvals'),
            ]);

            allCollabs = collabs;

            document.getElementById('kpi-total').textContent = stats.total;
            document.getElementById('kpi-today').textContent = stats.today;
            document.getElementById('kpi-open').textContent = stats.open;
            document.getElementById('kpi-avg-days').textContent = stats.avgDays ? stats.avgDays + '일' : '-';

            document.getElementById('st-open').textContent = stats.open;
            document.getElementById('st-confirmed').textContent = stats.confirmed;
            document.getElementById('st-contacted').textContent = stats.contacted;
            document.getElementById('st-connected').textContent = stats.connected;
            document.getElementById('st-closed').textContent = stats.closed;
            document.getElementById('st-referred').textContent = stats.referred;

            // Daily chart
            const labels = Object.keys(stats.daily).map(d => d.slice(5)); // MM-DD
            const values = Object.values(stats.daily);
            renderBarChart('chart-daily', labels, values, '접수 건수', '#98002E');

            // Overdue list
            const overdueEl = document.getElementById('overdue-list');
            if (stats.overdue && stats.overdue.length > 0) {
                overdueEl.innerHTML = stats.overdue.map(r => {
                    const days = Math.floor((Date.now() - new Date(r.createdAtISO || 0).getTime()) / 86400000);
                    return `<div class="flex items-center justify-between p-2.5 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition-colors" onclick="openDetail('${r.id}')">
                        <div>
                            <span class="font-medium text-slate-700">${r.userName || '-'}</span>
                            <span class="text-slate-400 ml-1.5">${r.serviceName || ''}</span>
                        </div>
                        <span class="text-xs text-red-500 font-semibold">${days}일 경과</span>
                    </div>`;
                }).join('');
            } else {
                overdueEl.innerHTML = '<p class="text-slate-400 text-sm py-4 text-center">미처리 알림 없음</p>';
            }

            // 연계 조정 현황 (dashboard: 최근 5건)
            const collabEl = document.getElementById('collab-dashboard-list');
            document.getElementById('collab-count').textContent = collabs.length;
            const pendingCount = pendingData.count || 0;
            updateSidebarCollabBadge(pendingCount);

            // 승인 대기 강조
            const pendingBadge = document.getElementById('pending-count-badge');
            if (pendingCount > 0) {
                pendingBadge.style.display = '';
                pendingBadge.textContent = '대기 ' + pendingCount;
            } else {
                pendingBadge.style.display = 'none';
            }

            if (collabs.length > 0) {
                const displayCollabs = collabs.slice(0, 5);
                collabEl.innerHTML = displayCollabs.map(c => renderCollabItem(c)).join('');
            } else {
                collabEl.innerHTML = '<p class="text-slate-400 text-sm py-4 text-center">연계 요청 없음</p>';
            }

            // System KPI
            const kpiEl = document.getElementById('system-kpi');
            kpiEl.innerHTML = `
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-primary">${kpi.ragMatchRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">RAG 매칭률</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-green-600">${kpi.conversionRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">신청 전환율</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-blue-500">${kpi.voiceRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">음성 비율</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-purple-500">${kpi.ttsRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">TTS 비율</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-slate-700">${kpi.chatRequest}</p>
                    <p class="text-xs text-slate-500 mt-1">총 채팅 수</p>
                </div>
            `;
        } catch (e) {
            console.error('Dashboard load error:', e);
        }
    }

    // ── Linkage Coordination Panel (Kanban) ──
    let collabSearchTimer = null;
    let expandedCardData = {};
    let collabViewMode = 'kanban'; // 'kanban' or 'table'
    let tableSortKey = 'date';
    let tableSortAsc = false;

    function debounceCollabSearch() {
        clearTimeout(collabSearchTimer);
        collabSearchTimer = setTimeout(() => renderKanbanBoard(allCollabs), 300);
    }
    function applyCollabFilter() { renderKanbanBoard(allCollabs); }

    function filterCollabs(collabs) {
        const cat = document.getElementById('collab-filter-cat')?.value || 'all';
        const search = (document.getElementById('collab-search')?.value || '').trim().toLowerCase();
        return collabs.filter(c => {
            if (cat === 'referral' && c.category !== 'referral') return false;
            if (cat === 'dept' && c.category === 'referral') return false;
            if (search) {
                const haystack = [c.userName, c.serviceName, c.targetService, c.reason,
                    getDeptName(c.fromDept), getDeptName(c.toDept)].filter(Boolean).join(' ').toLowerCase();
                if (!haystack.includes(search)) return false;
            }
            return true;
        });
    }

    function classifyCollabs(collabs) {
        const cols = { pending: [], dept_approved: [], approved: [], rejected: [] };
        collabs.forEach(c => {
            const as = c.approvalStatus || 'pending';
            if (as === 'pending' || as === 'revision_requested') cols.pending.push(c);
            else if (as === 'dept_approved') cols.dept_approved.push(c);
            else if (as === 'approved') cols.approved.push(c);
            else if (as === 'rejected' || as === 'admin_rejected' || as === 'admin_revision_requested') cols.rejected.push(c);
            else cols.pending.push(c);
        });
        return cols;
    }

    function scrollToKanbanCol(colId) {
        const el = document.getElementById(colId);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
    }

    function renderKanbanCard(c, isActionable) {
        const approvalSt = c.approvalStatus ? (APPROVAL_STATUS_MAP[c.approvalStatus] || APPROVAL_STATUS_MAP.pending) : APPROVAL_STATUS_MAP.pending;

        let directionHtml = '';
        if (c.category === 'referral' && c.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700 text-xs truncate">${escapeHtml(c.targetService)}</span>`;
        } else if (c.fromDept && c.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700 text-xs">${getDeptName(c.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" aria-hidden="true" style="font-size:12px">arrow_forward</span>
                <span class="font-semibold text-green-700 text-xs">${getDeptName(c.toDept)}</span>`;
        }

        const dateStr = new Date(c.createdAt).toLocaleDateString('ko-KR', {month:'numeric',day:'numeric'});
        const isBulkSelected = bulkSelected.has(c.id);

        return `
        <div id="kcard-${c.id}" class="kanban-card ${isBulkSelected ? 'bulk-selected' : ''}" draggable="true" ondragstart="onDragStart(event, '${c.id}')" ondragend="onDragEnd(event)" onclick="openKanbanModal('${c.id}', event)">
            <div class="card-summary">
                <div class="flex items-center gap-1.5">
                    <input type="checkbox" class="bulk-checkbox rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 w-3.5 h-3.5 flex-shrink-0" ${isBulkSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleBulkSelect('${c.id}', this.checked)" />
                    <span class="badge ${approvalSt.bg} ${approvalSt.text}" style="font-size:10px;padding:1px 6px">${approvalSt.label}</span>
                    <span class="flex-1 min-w-0 flex items-center gap-1 truncate">${directionHtml || `<span class="text-xs text-slate-500 truncate">${escapeHtml(c.userName || '-')}</span>`}</span>
                    <span class="text-[10px] text-slate-400 flex-shrink-0">${dateStr}</span>
                </div>
            </div>
        </div>`;
    }

    function renderKanbanColumn(bodyId, items, isActionable) {
        const el = document.getElementById(bodyId);
        if (!el) return;
        if (items.length === 0) {
            el.innerHTML = '<p class="text-slate-400 text-xs text-center py-6">항목 없음</p>';
            return;
        }
        el.innerHTML = items.map(c => renderKanbanCard(c, isActionable)).join('');
    }

    // ── Kanban Detail Modal ──
    let kanbanModalOpen = false;
    let kanbanModalLinkageId = null;

    async function openKanbanModal(linkageId, event) {
        if (event) event.stopPropagation();
        if (event && event.target.closest('.bulk-checkbox')) return;

        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;

        kanbanModalLinkageId = linkageId;
        kanbanModalOpen = true;

        const modal = document.getElementById('kanban-detail-modal');
        const body = document.getElementById('kanban-modal-body');

        // Set header info
        const approvalSt = collab.approvalStatus ? (APPROVAL_STATUS_MAP[collab.approvalStatus] || APPROVAL_STATUS_MAP.pending) : APPROVAL_STATUS_MAP.pending;
        const statusBadgeEl = document.getElementById('kanban-modal-status');
        statusBadgeEl.className = 'badge ' + approvalSt.bg + ' ' + approvalSt.text;
        statusBadgeEl.style.fontSize = '11px';
        statusBadgeEl.textContent = approvalSt.label;

        let titleText = collab.userName || '-';
        if (collab.category === 'referral' && collab.targetService) {
            titleText = collab.targetService;
        } else if (collab.fromDept && collab.toDept) {
            titleText = getDeptName(collab.fromDept) + ' → ' + getDeptName(collab.toDept);
        }
        document.getElementById('kanban-modal-title').textContent = titleText;

        body.innerHTML = '<p class="text-slate-400 text-sm text-center py-8">로딩 중...</p>';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Fetch request data
        if (collab.requestId && !expandedCardData[linkageId]) {
            try {
                const data = await api(`/api/admin/requests/${collab.requestId}`);
                expandedCardData[linkageId] = data;
            } catch (e) {
                expandedCardData[linkageId] = { error: true };
            }
        }

        // Render modal content
        renderKanbanModalContent(linkageId);
    }

    function renderKanbanModalContent(linkageId) {
        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;

        const body = document.getElementById('kanban-modal-body');
        const ed = expandedCardData[linkageId];
        const typeName = COLLAB_TYPE_MAP[collab.type] || '자문';
        const catLabel = collab.category === 'referral' ? '서비스연계' : '부서협업';

        let directionHtml = '';
        if (collab.category === 'referral' && collab.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(collab.targetService)}</span>`;
        } else if (collab.fromDept && collab.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(collab.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" aria-hidden="true" style="font-size:14px">arrow_forward</span>
                <span class="font-semibold text-green-700">${getDeptName(collab.toDept)}</span>`;
        }

        let html = '';

        // Category / Type / Direction info
        html += `<div class="mb-4 pb-4 border-b border-slate-100">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-xs text-slate-400">${catLabel} · ${typeName}</span>
                <span class="text-xs text-slate-400 ml-auto">${new Date(collab.createdAt).toLocaleDateString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
            </div>
            ${directionHtml ? `<div class="flex items-center gap-1.5 text-sm mb-2">${directionHtml}</div>` : ''}
            <p class="text-sm text-slate-600">${escapeHtml(collab.userName || '-')} · ${escapeHtml(collab.serviceName || '-')}</p>
            ${collab.reason ? `<p class="text-sm text-slate-500 mt-1">${escapeHtml(collab.reason)}</p>` : ''}
        </div>`;

        // Approval stepper
        html += `<div class="mb-4">${renderApprovalStepper(collab.approvalStatus)}</div>`;

        // Expanded detail content (same as before, but rendered in modal)
        if (ed) {
            html += renderModalExpandedDetail(collab, ed);
        } else {
            html += '<p class="text-sm text-slate-400 text-center py-4">로딩 중...</p>';
        }

        body.innerHTML = html;
    }

    function renderModalExpandedDetail(linkage, requestData) {
        if (requestData.error) return '<p class="text-sm text-red-400 text-center py-4">데이터를 불러올 수 없습니다.</p>';

        const isActionable = linkage.approvalStatus === 'dept_approved';
        const notes = linkage.notes || [];

        let html = '';

        // 1. Approval timeline
        if (linkage.approvalHistory && linkage.approvalHistory.length > 0) {
            html += `<div class="mb-5">
                <h5 class="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">timeline</span>승인 이력
                </h5>
                ${renderApprovalTimeline(linkage.approvalHistory)}
            </div>`;
        }

        // 2. Request info
        html += `<div class="mb-5 p-4 bg-slate-50 rounded-lg">
            <h5 class="text-xs font-bold text-slate-500 mb-2">원본 요청 정보</h5>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-slate-400">이름:</span> <span class="font-medium">${escapeHtml(requestData.userName || '-')}</span></div>
                <div><span class="text-slate-400">전화:</span> <span class="font-medium">${requestData.userPhone || '-'}</span></div>
                <div class="col-span-2"><span class="text-slate-400">서비스:</span> <span class="font-medium">${escapeHtml(requestData.serviceName || '-')}</span></div>
            </div>
            ${requestData.conversationSummary ? `<div class="mt-3 pt-3 border-t border-slate-200">
                <span class="text-xs font-semibold text-purple-600">AI 요약:</span>
                <p class="text-sm text-slate-600 mt-1">${escapeHtml(requestData.conversationSummary)}</p>
            </div>` : ''}
        </div>`;

        // 3. Notes
        html += `<div class="mb-5">
            <h5 class="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">sticky_note_2</span>메모 (${notes.length})
            </h5>
            ${notes.length > 0 ? '<div class="space-y-1.5 max-h-[180px] overflow-y-auto mb-3">' + notes.map(n => `
                <div class="text-sm p-2.5 bg-amber-50 rounded-lg">
                    <span class="font-semibold text-indigo-600">${escapeHtml(n.dept || n.author || '관리자')}</span>
                    <span class="text-slate-600 ml-1">${escapeHtml(n.text)}</span>
                    <span class="text-slate-300 ml-1 text-xs">${new Date(n.createdAt).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
                </div>
            `).join('') + '</div>' : '<p class="text-sm text-slate-400 mb-3">메모 없음</p>'}
            <div class="flex gap-2">
                <input id="kb-note-${linkage.id}" type="text" placeholder="메모 입력..." class="flex-1 rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addKanbanNoteFromModal('${requestData.id}','${linkage.id}')" />
                <button onclick="addKanbanNoteFromModal('${requestData.id}','${linkage.id}')" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors">추가</button>
            </div>
        </div>`;

        // 4. Action buttons (only for dept_approved)
        if (isActionable) {
            html += `<div class="mb-5 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <textarea id="kb-comment-${linkage.id}" rows="2" placeholder="코멘트 입력 (선택)..." class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 mb-3 focus:ring-primary focus:border-primary resize-none"></textarea>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="kanbanApproveFromModal('${linkage.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 flex items-center gap-1.5 transition-colors">
                        <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">check_circle</span>최종 승인
                    </button>
                    <button onclick="kanbanRejectFromModal('${linkage.id}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-50 transition-colors">반려</button>
                    <button onclick="kanbanRevisionFromModal('${linkage.id}')" class="px-4 py-2 bg-white border border-orange-300 text-orange-600 rounded-lg text-sm font-semibold hover:bg-orange-50 transition-colors">수정요청</button>
                </div>
            </div>`;
        }

        // 5. 케이스 상세 패널 열기 버튼
        html += `<button onclick="closeKanbanModal();openCasePanel('${requestData.id}')" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-50 border border-green-200 rounded-lg text-sm font-semibold text-green-700 hover:bg-green-100 transition-colors">
            <span class="material-symbols-outlined" style="font-size:18px" aria-hidden="true">assignment</span>담당자 처리 페이지 보기
        </button>`;

        return html;
    }

    function closeKanbanModal() {
        kanbanModalOpen = false;
        kanbanModalLinkageId = null;
        const modal = document.getElementById('kanban-detail-modal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    function onKanbanModalOverlayClick(event) {
        if (event.target === event.currentTarget) {
            closeKanbanModal();
        }
    }

    // Modal-specific action wrappers (close modal after action, reload panel)
    async function addKanbanNoteFromModal(requestId, linkageId) {
        const input = document.getElementById('kb-note-' + linkageId);
        const text = input?.value.trim();
        if (!text) return;
        try {
            await fetch(`/api/case/${requestId}/linkage/${linkageId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, author: '관리자', dept: '관리자' }),
            });
            const data = await api(`/api/admin/requests/${requestId}`);
            const updatedLinkage = (data.linkages || []).find(l => l.id === linkageId);
            if (updatedLinkage) {
                const collab = allCollabs.find(c => c.id === linkageId);
                if (collab) Object.assign(collab, { notes: updatedLinkage.notes });
            }
            expandedCardData[linkageId] = data;
            renderKanbanModalContent(linkageId);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    async function kanbanApproveFromModal(linkageId) {
        const comment = document.getElementById('kb-comment-' + linkageId)?.value.trim() || '';
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            closeKanbanModal();
            delete expandedCardData[linkageId];
            loadCollabPanel();
        } catch (e) {
            alert('승인 처리 실패');
        }
    }

    async function kanbanRejectFromModal(linkageId) {
        const comment = document.getElementById('kb-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('반려 사유를 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            closeKanbanModal();
            delete expandedCardData[linkageId];
            loadCollabPanel();
        } catch (e) {
            alert('반려 처리 실패');
        }
    }

    async function kanbanRevisionFromModal(linkageId) {
        const comment = document.getElementById('kb-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('수정 요청 사항을 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/revision`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            closeKanbanModal();
            delete expandedCardData[linkageId];
            loadCollabPanel();
        } catch (e) {
            alert('수정 요청 실패');
        }
    }

    function renderApprovalTimeline(approvalHistory) {
        if (!approvalHistory || approvalHistory.length === 0) {
            return '<p class="text-xs text-slate-400">승인 이력 없음</p>';
        }
        let html = '<div class="approval-timeline">';
        approvalHistory.forEach((h, i) => {
            const isLast = i === approvalHistory.length - 1;
            const statusClass = h.action === 'approved' || h.action === 'dept_approved' ? 'done'
                : (h.action === 'rejected' || h.action === 'admin_rejected') ? 'rejected'
                : isLast ? 'current' : 'done';
            const actionLabel = {
                submitted: '제출',
                dept_approved: '부서 승인',
                approved: '최종 승인',
                rejected: '부서 반려',
                revision_requested: '부서 수정요청',
                admin_rejected: '관리자 반려',
                admin_revision_requested: '관리자 수정요청',
            }[h.action] || h.action;
            const dateStr = h.date ? new Date(h.date).toLocaleString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
            html += `<div class="timeline-item ${statusClass}">
                <div class="timeline-dot"></div>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-semibold text-slate-700">${actionLabel}</span>
                    <span class="text-[10px] text-slate-400">${h.by || ''}</span>
                    <span class="text-[10px] text-slate-400 ml-auto">${dateStr}</span>
                </div>
                ${h.comment ? `<p class="text-[11px] text-slate-500 mt-0.5">${escapeHtml(h.comment)}</p>` : ''}
            </div>`;
        });
        html += '</div>';
        return html;
    }

    function renderKanbanBoard(collabs) {
        const filtered = filterCollabs(collabs);
        const cols = classifyCollabs(filtered);

        document.getElementById('collab-total-count').textContent = `총 ${filtered.length}건`;

        // Stats ribbon
        document.getElementById('kb-st-pending').textContent = cols.pending.length;
        document.getElementById('kb-st-dept-approved').textContent = cols.dept_approved.length;
        document.getElementById('kb-st-approved').textContent = cols.approved.length;
        document.getElementById('kb-st-rejected').textContent = cols.rejected.length;

        // Column counts
        document.getElementById('cnt-pending').textContent = cols.pending.length;
        document.getElementById('cnt-dept-approved').textContent = cols.dept_approved.length;
        document.getElementById('cnt-approved').textContent = cols.approved.length;
        document.getElementById('cnt-rejected').textContent = cols.rejected.length;

        // Render columns
        renderKanbanColumn('body-pending', cols.pending, false);
        renderKanbanColumn('body-dept-approved', cols.dept_approved, true);
        renderKanbanColumn('body-approved', cols.approved, false);
        renderKanbanColumn('body-rejected', cols.rejected, false);

        // Clean stale bulk selections and update bar
        const validIds = new Set(filtered.map(c => c.id));
        for (const id of bulkSelected) {
            if (!validIds.has(id)) bulkSelected.delete(id);
        }
        updateBulkBar();

        // Also update table view if active
        if (collabViewMode === 'table') {
            renderCollabTable(collabs);
        }
    }

    async function loadCollabPanel() {
        try {
            const [collabs, pendingData] = await Promise.all([
                api('/api/admin/linkages'),
                api('/api/admin/pending-approvals'),
            ]);
            allCollabs = collabs;
            const pendingCount = pendingData.count || pendingData.items?.length || 0;
            updateSidebarCollabBadge(pendingCount);
            renderKanbanBoard(collabs);
        } catch (e) {
            console.error('Linkage panel load error:', e);
        }
    }

    // ── View switching (Kanban ↔ Table) ──
    function switchCollabView(mode) {
        collabViewMode = mode;
        const kanbanEl = document.getElementById('collab-kanban');
        const tableEl = document.getElementById('collab-table-view');
        const kanbanBtn = document.getElementById('view-kanban-btn');
        const tableBtn = document.getElementById('view-table-btn');

        if (mode === 'kanban') {
            kanbanEl.style.display = '';
            tableEl.style.display = 'none';
            kanbanBtn.classList.add('active');
            tableBtn.classList.remove('active');
        } else {
            kanbanEl.style.display = 'none';
            tableEl.style.display = '';
            kanbanBtn.classList.remove('active');
            tableBtn.classList.add('active');
            renderCollabTable(allCollabs);
        }
    }

    function sortTable(key) {
        if (tableSortKey === key) {
            tableSortAsc = !tableSortAsc;
        } else {
            tableSortKey = key;
            tableSortAsc = true;
        }
        renderCollabTable(allCollabs);
    }

    function getCollabSortValue(c, key) {
        switch (key) {
            case 'id': return c.id || '';
            case 'title':
                if (c.category === 'referral' && c.targetService) return c.targetService;
                if (c.fromDept && c.toDept) return getDeptName(c.fromDept) + ' ' + getDeptName(c.toDept);
                return c.userName || '';
            case 'status': return c.approvalStatus || 'pending';
            case 'category': return c.category || '';
            case 'date': return c.createdAt || '';
            case 'dept':
                return getDeptName(c.toDept || c.fromDept || '');
            default: return '';
        }
    }

    function renderCollabTable(collabs) {
        const filtered = filterCollabs(collabs);

        // Sort
        const sorted = [...filtered].sort((a, b) => {
            const av = getCollabSortValue(a, tableSortKey);
            const bv = getCollabSortValue(b, tableSortKey);
            let cmp = 0;
            if (tableSortKey === 'date') {
                cmp = new Date(av).getTime() - new Date(bv).getTime();
            } else {
                cmp = String(av).localeCompare(String(bv), 'ko');
            }
            return tableSortAsc ? cmp : -cmp;
        });

        // Update sort arrows
        document.querySelectorAll('.collab-table thead th .sort-arrow').forEach(el => {
            el.textContent = 'unfold_more';
        });
        const activeHeader = document.querySelector(`.collab-table thead th[onclick="sortTable('${tableSortKey}')"] .sort-arrow`);
        if (activeHeader) {
            activeHeader.textContent = tableSortAsc ? 'expand_less' : 'expand_more';
        }

        const tbody = document.getElementById('collab-table-body');
        if (sorted.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-400 py-8">항목 없음</td></tr>';
            return;
        }

        tbody.innerHTML = sorted.map((c, idx) => {
            const approvalSt = c.approvalStatus ? (APPROVAL_STATUS_MAP[c.approvalStatus] || APPROVAL_STATUS_MAP.pending) : APPROVAL_STATUS_MAP.pending;
            const typeName = COLLAB_TYPE_MAP[c.type] || '자문';
            const catLabel = c.category === 'referral' ? '서비스연계' : '부서협업';
            const dateStr = new Date(c.createdAt).toLocaleDateString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'});
            const isBulkSelected = bulkSelected.has(c.id);

            let titleHtml = '';
            if (c.category === 'referral' && c.targetService) {
                titleHtml = `<span class="font-semibold text-blue-700">${escapeHtml(c.targetService)}</span>`;
            } else if (c.fromDept && c.toDept) {
                titleHtml = `<span class="text-indigo-700">${getDeptName(c.fromDept)}</span> <span class="text-slate-400">&rarr;</span> <span class="text-green-700">${getDeptName(c.toDept)}</span>`;
            } else {
                titleHtml = escapeHtml(c.userName || '-');
            }

            const deptName = c.toDept ? getDeptName(c.toDept) : (c.fromDept ? getDeptName(c.fromDept) : '-');

            return `<tr class="${isBulkSelected ? 'bulk-selected' : ''}" onclick="openTableRowDetail('${c.requestId}', event)">
                <td style="text-align:center" onclick="event.stopPropagation()">
                    <input type="checkbox" class="bulk-checkbox rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 w-3.5 h-3.5" ${isBulkSelected ? 'checked' : ''} onchange="toggleBulkSelect('${c.id}', this.checked); renderCollabTable(allCollabs)" />
                </td>
                <td class="font-mono text-xs text-slate-400">${shortId(c.id)}</td>
                <td>
                    <div class="flex items-center gap-1.5">
                        ${titleHtml}
                        <span class="text-[10px] text-slate-400">(${typeName})</span>
                    </div>
                    <p class="text-[11px] text-slate-400 truncate max-w-[220px]">${escapeHtml(c.userName || '-')} · ${escapeHtml(c.serviceName || '-')}</p>
                </td>
                <td><span class="badge ${approvalSt.bg} ${approvalSt.text}">${approvalSt.label}</span></td>
                <td><span class="text-xs">${catLabel}</span></td>
                <td class="text-xs text-slate-500 whitespace-nowrap">${dateStr}</td>
                <td class="text-xs text-slate-600">${deptName}</td>
            </tr>`;
        }).join('');

        // Update check-all state
        const checkAll = document.getElementById('collab-table-check-all');
        if (checkAll) {
            const allIds = sorted.map(c => c.id);
            checkAll.checked = allIds.length > 0 && allIds.every(id => bulkSelected.has(id));
        }
    }

    function toggleTableBulkAll(checked) {
        const filtered = filterCollabs(allCollabs);
        filtered.forEach(c => {
            if (checked) bulkSelected.add(c.id);
            else bulkSelected.delete(c.id);
        });
        updateBulkBar();
        renderCollabTable(allCollabs);
    }

    function openTableRowDetail(requestId, event) {
        if (event && event.target.closest('input[type="checkbox"]')) return;
        if (requestId) openDetail(requestId);
    }

    // ── Drag & Drop ──
    function onDragStart(event, linkageId) {
        draggedLinkageId = linkageId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', linkageId);
        requestAnimationFrame(() => {
            const el = document.getElementById('kcard-' + linkageId);
            if (el) el.classList.add('dragging');
        });
    }

    function onDragEnd(event) {
        if (draggedLinkageId) {
            const el = document.getElementById('kcard-' + draggedLinkageId);
            if (el) el.classList.remove('dragging');
        }
        draggedLinkageId = null;
        document.querySelectorAll('.kanban-col').forEach(col => col.classList.remove('drag-over'));
    }

    function onDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        const col = event.currentTarget;
        if (!col.classList.contains('drag-over')) col.classList.add('drag-over');
    }

    function onDragLeave(event) {
        const col = event.currentTarget;
        if (!col.contains(event.relatedTarget)) col.classList.remove('drag-over');
    }

    async function onDrop(event, targetStatus) {
        event.preventDefault();
        const col = event.currentTarget;
        col.classList.remove('drag-over');
        const linkageId = event.dataTransfer.getData('text/plain');
        if (!linkageId) return;

        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;

        const currentStatus = collab.approvalStatus || 'pending';
        if (currentStatus === targetStatus) return;

        await changeLinkageApprovalStatus(linkageId, targetStatus);
    }

    async function changeLinkageApprovalStatus(linkageId, targetStatus) {
        const endpointMap = {
            approved: 'approve',
            rejected: 'reject',
            admin_revision_requested: 'revision',
        };

        try {
            if (targetStatus === 'approved') {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/approve`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: '칸반 드래그 이동' }),
                });
                if (!resp.ok) throw new Error();
            } else if (targetStatus === 'rejected') {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/reject`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: '칸반 드래그 이동' }),
                });
                if (!resp.ok) throw new Error();
            } else if (targetStatus === 'pending' || targetStatus === 'dept_approved') {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/revision`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: '칸반 드래그 이동 (상태 재설정)' }),
                });
                if (!resp.ok) throw new Error();
            }
            loadCollabPanel();
        } catch (e) {
            alert('상태 변경 실패');
        }
    }

    // ── Bulk Actions ──
    function toggleBulkSelect(linkageId, checked) {
        if (checked) {
            bulkSelected.add(linkageId);
        } else {
            bulkSelected.delete(linkageId);
        }
        const card = document.getElementById('kcard-' + linkageId);
        if (card) card.classList.toggle('bulk-selected', checked);
        updateBulkBar();
    }

    function updateBulkBar() {
        const bar = document.getElementById('bulk-bar');
        const count = bulkSelected.size;
        if (count > 0) {
            bar.style.display = 'flex';
            document.getElementById('bulk-count').textContent = count + '건 선택';
        } else {
            bar.style.display = 'none';
        }
    }

    function clearBulkSelection() {
        bulkSelected.clear();
        document.querySelectorAll('.kanban-card.bulk-selected').forEach(el => el.classList.remove('bulk-selected'));
        document.querySelectorAll('.collab-table tr.bulk-selected').forEach(el => el.classList.remove('bulk-selected'));
        document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = false);
        const checkAll = document.getElementById('collab-table-check-all');
        if (checkAll) checkAll.checked = false;
        updateBulkBar();
    }

    async function bulkChangeStatus() {
        const targetStatus = document.getElementById('bulk-status-select').value;
        if (!targetStatus) { alert('변경할 상태를 선택하세요.'); return; }
        if (bulkSelected.size === 0) return;

        const ids = [...bulkSelected];
        const confirmMsg = `${ids.length}건의 항목을 일괄 변경하시겠습니까?`;
        if (!confirm(confirmMsg)) return;

        const endpointForStatus = (status) => {
            if (status === 'approved') return 'approve';
            if (status === 'rejected') return 'reject';
            return 'revision';
        };
        const endpoint = endpointForStatus(targetStatus);
        const comment = '일괄 상태 변경';

        let failCount = 0;
        for (const linkageId of ids) {
            try {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/${endpoint}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment }),
                });
                if (!resp.ok) failCount++;
            } catch { failCount++; }
        }
        if (failCount > 0) alert(`${failCount}건 처리 실패`);
        bulkSelected.clear();
        updateBulkBar();
        document.getElementById('bulk-status-select').value = '';
        loadCollabPanel();
    }

    // ── Requests ──
    async function loadRequests() {
        const status = document.getElementById('filter-status').value;
        const search = document.getElementById('filter-search').value;

        try {
            const data = await api(`/api/admin/requests?status=${status}&search=${encodeURIComponent(search)}&page=${currentPage}&limit=20&sort=${currentSort}`);
            const tbody = document.getElementById('requests-tbody');

            if (data.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">결과 없음</td></tr>';
            } else {
                tbody.innerHTML = data.items.map(r => `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-mono text-xs text-slate-400">${shortId(r.id)}</td>
                        <td class="px-4 py-3 font-medium">${escapeHtml(r.userName || '-')}</td>
                        <td class="px-4 py-3 hidden sm:table-cell text-slate-500">${escapeHtml(r.userPhone || '-')}</td>
                        <td class="px-4 py-3 max-w-[200px] truncate">${escapeHtml(r.serviceName || '-')}</td>
                        <td class="px-4 py-3">${statusBadge(r.status)}</td>
                        <td class="px-4 py-3 hidden md:table-cell text-slate-500 text-xs">${formatDate(r)}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="openDetail('${r.id}')" class="p-1.5 hover:bg-primary/10 rounded-lg text-primary transition-colors">
                                <span class="material-symbols-outlined text-lg" aria-hidden="true">open_in_new</span>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Pagination
            document.getElementById('page-info').textContent = `${data.total}건 중 ${(data.page-1)*20+1}-${Math.min(data.page*20, data.total)}`;
            const pageBox = document.getElementById('page-buttons');
            let btns = '';
            if (data.page > 1) btns += `<button onclick="goPage(${data.page-1})" class="px-3 py-1 rounded border border-slate-300 hover:bg-slate-100">이전</button>`;
            for (let i = 1; i <= data.totalPages; i++) {
                const active = i === data.page ? 'bg-primary text-white border-primary' : 'border-slate-300 hover:bg-slate-100';
                btns += `<button onclick="goPage(${i})" class="px-3 py-1 rounded border ${active}">${i}</button>`;
            }
            if (data.page < data.totalPages) btns += `<button onclick="goPage(${data.page+1})" class="px-3 py-1 rounded border border-slate-300 hover:bg-slate-100">다음</button>`;
            pageBox.innerHTML = btns;
        } catch (e) {
            console.error('Requests load error:', e);
        }
    }

    function goPage(p) { currentPage = p; loadRequests(); }
    function debounceSearch() { clearTimeout(searchTimer); searchTimer = setTimeout(() => { currentPage = 1; loadRequests(); }, 300); }
    function toggleSort() {
        currentSort = currentSort === 'newest' ? 'oldest' : 'newest';
        document.getElementById('sort-label').textContent = currentSort === 'newest' ? '최신순' : '오래된순';
        currentPage = 1;
        loadRequests();
    }

    // ── Detail Modal ──
    async function openDetail(id) {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        // Reset and trigger slide-in
        panel.classList.remove('animate-slide-out-right');
        panel.classList.add('animate-slide-in-right');
        document.getElementById('modal-body').innerHTML = '<p class="text-slate-400 py-8 text-center">로딩 중...</p>';

        try {
            const data = await api(`/api/admin/requests/${id}`);
            renderDetail(data);
        } catch (e) {
            document.getElementById('modal-body').innerHTML = '<p class="text-red-500">데이터를 불러올 수 없습니다.</p>';
        }
    }

    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        panel.classList.remove('animate-slide-in-right');
        panel.classList.add('animate-slide-out-right');
        setTimeout(() => {
            modal.classList.add('hidden');
            panel.classList.remove('animate-slide-out-right');
        }, 250);
    }

    function renderDetail(data) {
        const el = document.getElementById('modal-body');
        const chain = data.chain || [];
        const notes = data.notes || [];

        el.innerHTML = `
            <!-- Basic Info -->
            <div class="space-y-3 mb-6">
                <div class="flex items-center justify-between">
                    <span class="text-xs text-slate-400 font-mono">${data.id}</span>
                    ${statusBadge(data.status)}
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><span class="text-slate-400 block text-xs mb-0.5">이름</span><span class="font-medium">${data.userName || '-'}</span></div>
                    <div><span class="text-slate-400 block text-xs mb-0.5">전화</span><span class="font-medium">${data.userPhone || '-'}</span></div>
                    <div class="col-span-2"><span class="text-slate-400 block text-xs mb-0.5">서비스명</span><span class="font-medium">${data.serviceName || '-'}</span></div>
                    <div><span class="text-slate-400 block text-xs mb-0.5">접수일</span><span>${data.createdAt || '-'}</span></div>
                    <div><span class="text-slate-400 block text-xs mb-0.5">최종 수정</span><span>${data.updatedAt ? new Date(data.updatedAt).toLocaleString('ko-KR') : '-'}</span></div>
                </div>
            </div>

            <!-- Conversation Summary -->
            ${data.conversationSummary ? `
            <div class="mb-6 p-4 bg-purple-50 border border-purple-100 rounded-lg">
                <h4 class="text-xs font-semibold text-purple-700 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">smart_toy</span>AI 대화 요약
                </h4>
                <p class="text-sm text-slate-700 whitespace-pre-line leading-relaxed">${escapeHtml(data.conversationSummary)}</p>
            </div>` : ''}

            <!-- Referral Chain -->
            ${chain.length > 1 ? `
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-3 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">link</span>연계 체인
                </h4>
                <div class="space-y-2">
                    ${chain.map(c => `
                        <div class="flex items-center gap-2 text-sm p-2 rounded-lg ${c.current ? 'bg-primary/5 border border-primary/20' : 'bg-slate-50'}">
                            ${statusBadge(c.status)}
                            <span class="${c.current ? 'font-semibold text-primary' : 'text-slate-600'}">${c.serviceName}</span>
                            ${c.reason ? `<span class="text-xs text-slate-400 ml-auto">${c.reason}</span>` : ''}
                        </div>
                    `).join('<div class="flex justify-center"><span class="material-symbols-outlined text-slate-300 text-sm" aria-hidden="true">arrow_downward</span></div>')}
                </div>
            </div>` : ''}

            <!-- 연계 요청 (linkages) -->
            ${(data.linkages && data.linkages.length > 0) ? `
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">hub</span>연계 (${data.linkages.length})
                </h4>
                <div class="space-y-2">
                    ${data.linkages.map(l => {
                        const ast = APPROVAL_STATUS_MAP[l.approvalStatus] || APPROVAL_STATUS_MAP.pending;
                        const typeName = COLLAB_TYPE_MAP[l.type] || '자문';
                        const isDeptApproved = l.approvalStatus === 'dept_approved';
                        const isApproved = l.approvalStatus === 'approved';

                        let dirHtml = '';
                        if (l.category === 'referral' && l.targetService) {
                            dirHtml = `<span class="font-semibold text-blue-700">${escapeHtml(l.targetService)}</span>`;
                        } else if (l.fromDept && l.toDept) {
                            dirHtml = `<span class="font-semibold text-indigo-700">${getDeptName(l.fromDept)}</span>
                                <span class="material-symbols-outlined text-slate-400 text-sm" aria-hidden="true">arrow_forward</span>
                                <span class="font-semibold text-green-700">${getDeptName(l.toDept)}</span>`;
                        }

                        const bgClass = isDeptApproved ? 'bg-blue-50 border border-blue-200'
                            : isApproved ? 'bg-green-50 border border-green-100'
                            : l.approvalStatus === 'admin_rejected' || l.approvalStatus === 'admin_revision_requested' ? 'bg-red-50 border border-red-100'
                            : l.approvalStatus === 'pending' ? 'bg-yellow-50 border border-yellow-200'
                            : 'bg-slate-50 border border-slate-100';

                        return `<div class="p-3 ${bgClass} rounded-lg text-sm">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="badge ${ast.bg} ${ast.text}">${ast.label}</span>
                                <span class="text-xs text-slate-400">${l.category === 'referral' ? '서비스연계' : typeName}</span>
                                ${l.executionStatus ? '<span class="text-xs text-blue-600">' + l.executionStatus + '</span>' : ''}
                                <span class="text-xs text-slate-400 ml-auto">${new Date(l.createdAt).toLocaleString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
                            </div>
                            ${renderApprovalStepper(l.approvalStatus)}
                            <div class="flex items-center gap-1.5 text-sm mb-1">${dirHtml}</div>
                            <p class="text-xs text-slate-600">${escapeHtml(l.reason)}</p>
                            ${l.notes && l.notes.length > 0 ? '<div class="mt-1.5 pt-1.5 border-t border-indigo-100 space-y-1">' + l.notes.map(n => '<div class="flex gap-1.5 text-xs"><span class="font-semibold text-indigo-600">' + escapeHtml(n.dept || n.author) + '</span><span class="text-slate-600">' + escapeHtml(n.text) + '</span><span class="text-slate-300 ml-auto">' + new Date(n.createdAt).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) + '</span></div>').join('') + '</div>' : ''}
                            ${isDeptApproved ? `<div class="mt-2 pt-2 border-t border-blue-200 flex flex-wrap gap-1.5"><button onclick="approveLinkage('${l.id}',event)" class="px-2.5 py-1 bg-green-600 text-white rounded text-xs font-semibold hover:bg-green-700">최종 승인</button><button onclick="rejectLinkage('${l.id}',event)" class="px-2.5 py-1 bg-white border border-red-300 text-red-600 rounded text-xs font-semibold hover:bg-red-50">반려</button><button onclick="revisionLinkage('${l.id}',event)" class="px-2.5 py-1 bg-white border border-orange-300 text-orange-600 rounded text-xs font-semibold hover:bg-orange-50">수정요청</button><div class="flex-1"></div><div class="flex gap-1"><input id="admin-lnote-${l.id}" type="text" placeholder="메모..." class="border border-slate-300 rounded px-2 py-1 text-xs w-28 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addAdminLinkageNote('${data.id}','${l.id}')" /><button onclick="addAdminLinkageNote('${data.id}','${l.id}')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700">추가</button></div></div>` : ''}
                        </div>`;
                    }).join('')}
                </div>
            </div>` : ''}

            <!-- 서비스 계획 설계 -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">route</span>서비스 계획
                </h4>
                <div id="service-plan-editor-${data.id}" class="space-y-2">
                    ${(data.servicePlan && data.servicePlan.steps && data.servicePlan.steps.length > 0) ? data.servicePlan.steps.map((s, i) => `
                        <div class="flex items-center gap-2 text-sm p-2 rounded bg-slate-50">
                            <span class="text-xs font-bold text-slate-500">${i+1}</span>
                            <span class="font-medium">${escapeHtml(s.serviceName)}</span>
                            <span class="badge ${s.status === 'completed' ? 'bg-green-100 text-green-700' : s.status === 'in_progress' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500'} ml-auto">${s.status === 'completed' ? '완료' : s.status === 'in_progress' ? '진행' : '대기'}</span>
                        </div>
                    `).join('') : '<p class="text-xs text-slate-400">서비스 계획 없음</p>'}
                </div>
                <div class="mt-2 flex gap-2">
                    <input id="sp-input-${data.id}" type="text" placeholder="서비스명 추가..." class="flex-1 rounded border-slate-300 text-xs py-1.5 px-2 focus:ring-primary focus:border-primary" />
                    <button onclick="addServicePlanStep('${data.id}')" class="px-3 py-1.5 bg-primary text-white rounded text-xs font-semibold hover:bg-primary-light">추가</button>
                </div>
            </div>

            <!-- 담당자 처리 페이지 링크 -->
            <div class="mb-4">
                <a href="/case/${data.id}" target="_blank" class="flex items-center gap-2 px-4 py-2.5 bg-green-50 border border-green-200 rounded-lg text-sm font-semibold text-green-700 hover:bg-green-100 transition-colors">
                    <span class="material-symbols-outlined text-lg" aria-hidden="true">open_in_new</span>
                    담당자 처리 페이지 열기
                </a>
            </div>

            <!-- Status Change -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-2">상태 변경</h4>
                <p class="text-xs text-amber-600 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">warning</span>
                    관리자 오버라이드 - 일반적으로 담당자 처리 페이지에서 상태를 변경합니다.
                </p>
                <div class="flex flex-wrap gap-1.5">
                    ${Object.entries(STATUS_MAP).map(([key, val]) => `
                        <button onclick="changeStatus('${data.id}', '${key}')" class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${data.status === key ? val.bg + ' ' + val.text + ' border-current' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-400'}">
                            ${val.label}
                        </button>
                    `).join('')}
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <h4 class="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">sticky_note_2</span>메모 (${notes.length})
                </h4>
                <div class="space-y-2 mb-3 max-h-[200px] overflow-y-auto">
                    ${notes.length > 0 ? notes.map(n => {
                        const author = n.author || '관리자';
                        const authorBadge = author === '담당자'
                            ? '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700">담당자</span>'
                            : '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-semibold bg-amber-100 text-amber-700">관리자</span>';
                        return `<div class="p-3 bg-amber-50 rounded-lg text-sm">
                            <div class="flex items-center gap-1.5 mb-1">${authorBadge}<span class="text-xs text-slate-400">${new Date(n.createdAt).toLocaleString('ko-KR')}</span></div>
                            <p class="text-slate-700">${escapeHtml(n.text)}</p>
                        </div>`;
                    }).join('') : '<p class="text-sm text-slate-400">메모 없음</p>'}
                </div>
                <div class="flex gap-2">
                    <input id="note-input" type="text" placeholder="메모 입력..." class="flex-1 rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addNote('${data.id}')" />
                    <button onclick="addNote('${data.id}')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-light transition-colors">추가</button>
                </div>
            </div>
        `;
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function changeStatus(id, status) {
        try {
            await fetch(`/api/admin/requests/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }),
            });
            openDetail(id);
            if (currentTab === 'requests') loadRequests();
            if (currentTab === 'dashboard') loadDashboard();
        } catch (e) {
            alert('상태 변경 실패');
        }
    }

    async function addNote(id) {
        const input = document.getElementById('note-input');
        const note = input.value.trim();
        if (!note) return;
        try {
            await fetch(`/api/admin/requests/${id}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note }),
            });
            openDetail(id);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    // ── 연계 조정 (관리자 승인/반려/수정요청) ──
    // Legacy prompt-based versions (used by dashboard detail modal)
    async function approveLinkage(linkageId, event) {
        if (event) event.stopPropagation();
        const comment = prompt('승인 코멘트 (선택):') || '';
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            alert('최종 승인 완료. 이메일이 발송되었습니다.');
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'collab') loadCollabPanel();
        } catch (e) {
            alert('승인 처리 실패');
        }
    }

    async function rejectLinkage(linkageId, event) {
        if (event) event.stopPropagation();
        const comment = prompt('반려 사유를 입력하세요:');
        if (comment === null) return;
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'collab') loadCollabPanel();
        } catch (e) {
            alert('반려 처리 실패');
        }
    }

    async function revisionLinkage(linkageId, event) {
        if (event) event.stopPropagation();
        const comment = prompt('수정 요청 사항을 입력하세요:');
        if (comment === null) return;
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/revision`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'collab') loadCollabPanel();
        } catch (e) {
            alert('수정 요청 실패');
        }
    }

    async function addAdminLinkageNote(requestId, linkageId) {
        const input = document.getElementById('admin-lnote-' + linkageId);
        const text = input.value.trim();
        if (!text) return;
        try {
            await fetch(`/api/case/${requestId}/linkage/${linkageId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, author: '관리자', dept: '관리자' }),
            });
            input.value = '';
            openDetail(requestId);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    // 서비스 계획 관리
    async function addServicePlanStep(requestId) {
        const input = document.getElementById('sp-input-' + requestId);
        const serviceName = input.value.trim();
        if (!serviceName) return;

        // 기존 계획 가져오기
        try {
            const data = await api(`/api/admin/requests/${requestId}`);
            const existingSteps = (data.servicePlan && data.servicePlan.steps) ? data.servicePlan.steps : [];
            existingSteps.push({ order: existingSteps.length + 1, serviceName, status: 'pending' });

            await fetch(`/api/case/${requestId}/service-plan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: existingSteps }),
            });
            input.value = '';
            openDetail(requestId);
        } catch (e) {
            alert('서비스 계획 저장 실패');
        }
    }

    // ── Analytics ──
    async function loadAnalytics() {
        try {
            const [analytics, trends] = await Promise.all([api('/api/admin/analytics'), api('/api/admin/trends?days=7')]);

            // Service Ranking (horizontal bar)
            const ranking = analytics.serviceRanking.slice(0, 10);
            renderHorizontalBarChart('chart-service', ranking.map(r => r.name.length > 12 ? r.name.slice(0, 12) + '..' : r.name), ranking.map(r => r.count));

            // Category Distribution (doughnut)
            const catLabels = Object.keys(analytics.categoryCount);
            const catValues = Object.values(analytics.categoryCount);
            renderDoughnutChart('chart-category', catLabels, catValues);

            // Event Trends (line)
            const trendLabels = trends.map(t => t.date.slice(5));
            renderLineChart('chart-trends', trendLabels, trends);
        } catch (e) {
            console.error('Analytics load error:', e);
        }
    }

    // ── Chart renderers ──
    function destroyChart(id) {
        if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    }

    function renderBarChart(id, labels, data, label, color) {
        destroyChart(id);
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ label, data, backgroundColor: color + '20', borderColor: color, borderWidth: 2, borderRadius: 4 }],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    x: { grid: { display: false } },
                },
            },
        });
    }

    function renderHorizontalBarChart(id, labels, data) {
        destroyChart(id);
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ data, backgroundColor: '#98002E20', borderColor: '#98002E', borderWidth: 2, borderRadius: 4 }],
            },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, ticks: { precision: 0 } },
                    y: { grid: { display: false } },
                },
            },
        });
    }

    function renderDoughnutChart(id, labels, data) {
        destroyChart(id);
        const colors = ['#98002E', '#4A1942', '#1565C0', '#2E7D32', '#FF9800', '#607D8B'];
        charts[id] = new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 } } },
                },
            },
        });
    }

    function renderLineChart(id, labels, trends) {
        destroyChart(id);
        const eventTypes = [
            { key: 'chat_request', label: '채팅', color: '#98002E' },
            { key: 'rag_match', label: 'RAG 매칭', color: '#2E7D32' },
            { key: 'service_apply', label: '신청', color: '#1565C0' },
            { key: 'tts_request', label: 'TTS', color: '#FF9800' },
        ];
        const datasets = eventTypes.map(e => ({
            label: e.label,
            data: trends.map(t => t[e.key] || 0),
            borderColor: e.color,
            backgroundColor: e.color + '10',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
            borderWidth: 2,
        }));
        charts[id] = new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 } } } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    x: { grid: { display: false } },
                },
            },
        });
    }

    // ── Case Detail Slide-Over Panel ──
    let casePanelOpen = false;
    let casePanelRequestId = null;

    function openCasePanel(requestId) {
        if (!requestId) return;
        casePanelRequestId = requestId;
        casePanelOpen = true;

        const overlay = document.getElementById('case-panel-overlay');
        const drawer = document.getElementById('case-panel-drawer');
        const body = document.getElementById('case-panel-body');

        overlay.classList.add('active');
        drawer.classList.add('open');
        body.innerHTML = '<p class="text-slate-400 text-sm text-center py-8">로딩 중...</p>';

        // Update header defaults
        document.getElementById('case-panel-title').textContent = '케이스 상세';
        document.getElementById('case-panel-badge').textContent = '-';
        document.getElementById('case-panel-name').textContent = '-';
        document.getElementById('case-panel-newtab').href = '/case/' + requestId;

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // Fetch data
        loadCasePanelData(requestId);
    }

    function closeCasePanel() {
        casePanelOpen = false;
        casePanelRequestId = null;
        const overlay = document.getElementById('case-panel-overlay');
        const drawer = document.getElementById('case-panel-drawer');
        overlay.classList.remove('active');
        drawer.classList.remove('open');
        document.body.style.overflow = '';
    }

    // ESC key handler for modals/panels (most recent layer first)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (casePanelOpen) { closeCasePanel(); return; }
            if (kanbanModalOpen) { closeKanbanModal(); return; }
            if (!document.getElementById('detail-modal').classList.contains('hidden')) { closeModal(); return; }
        }
    });

    async function loadCasePanelData(requestId) {
        try {
            const data = await api(`/api/admin/requests/${requestId}`);
            renderCasePanel(data);
        } catch (e) {
            document.getElementById('case-panel-body').innerHTML =
                '<p class="text-red-500 text-sm text-center py-8">데이터를 불러올 수 없습니다.</p>';
        }
    }

    function renderCasePanel(data) {
        // Update header
        document.getElementById('case-panel-title').textContent = data.serviceName || '케이스 상세';
        const st = STATUS_MAP[data.status] || { label: data.status, bg: 'bg-slate-100', text: 'text-slate-600' };
        document.getElementById('case-panel-badge').className = 'badge ' + st.bg + ' ' + st.text + ' text-xs';
        document.getElementById('case-panel-badge').textContent = st.label;
        document.getElementById('case-panel-name').textContent = data.userName || '-';

        const body = document.getElementById('case-panel-body');
        const notes = data.notes || [];
        const linkages = data.linkages || [];

        let html = '';

        // B. Status Timeline Stepper
        html += renderCaseStatusStepper(data);

        // C. Subject Info
        html += `<div class="mb-5">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                <span class="material-symbols-outlined text-sm text-green-600" aria-hidden="true">person</span>대상자 정보
            </h4>
            <div class="bg-slate-50 rounded-xl p-4 space-y-2.5 text-sm">
                <div class="flex justify-between">
                    <span class="text-slate-400">이름</span>
                    <span class="font-semibold text-slate-800">${escapeHtml(data.userName || '-')}</span>
                </div>
                <div class="border-t border-slate-100"></div>
                <div class="flex justify-between">
                    <span class="text-slate-400">전화번호</span>
                    <span class="font-semibold text-slate-800">${escapeHtml(data.userPhone || '-')}</span>
                </div>
                <div class="border-t border-slate-100"></div>
                <div class="flex justify-between">
                    <span class="text-slate-400">서비스명</span>
                    <span class="font-semibold text-slate-800">${escapeHtml(data.serviceName || '-')}</span>
                </div>
                <div class="border-t border-slate-100"></div>
                <div class="flex justify-between">
                    <span class="text-slate-400">접수일</span>
                    <span class="text-slate-700">${data.createdAt || '-'}</span>
                </div>
            </div>
        </div>`;

        // AI Summary (collapsible)
        if (data.conversationSummary) {
            html += `<div class="mb-5">
                <div class="case-collapse-toggle flex items-center justify-between p-3 bg-purple-50 border border-purple-100 rounded-xl" onclick="toggleCaseCollapse('case-ai-summary', this)">
                    <h4 class="text-xs font-bold text-purple-700 flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-sm" aria-hidden="true">smart_toy</span>AI 상담 요약
                    </h4>
                    <span class="material-symbols-outlined text-purple-400 text-lg case-collapse-icon" aria-hidden="true">expand_more</span>
                </div>
                <div id="case-ai-summary" class="case-collapse-body">
                    <div class="px-3 pt-3 pb-1">
                        <p class="text-sm text-slate-700 whitespace-pre-line leading-relaxed">${escapeHtml(data.conversationSummary)}</p>
                    </div>
                </div>
            </div>`;
        }

        // D. Notes Section
        html += `<div class="mb-5">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                <span class="material-symbols-outlined text-sm text-amber-500" aria-hidden="true">sticky_note_2</span>메모 (${notes.length})
            </h4>
            <div class="space-y-2 mb-3 max-h-[250px] overflow-y-auto">
                ${notes.length > 0 ? notes.map(n => {
                    const author = n.author || '관리자';
                    const authorBadge = author === '담당자'
                        ? '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 text-green-700">담당자</span>'
                        : '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-amber-100 text-amber-700">관리자</span>';
                    return `<div class="p-3 bg-amber-50 rounded-lg text-sm">
                        <div class="flex items-center gap-1.5 mb-1">${authorBadge}<span class="text-[10px] text-slate-400">${new Date(n.createdAt).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span></div>
                        <p class="text-slate-700 text-[13px]">${escapeHtml(n.text)}</p>
                    </div>`;
                }).join('') : '<p class="text-sm text-slate-400 text-center py-3">메모 없음</p>'}
            </div>
            <div class="flex gap-2">
                <input id="case-panel-note-input" type="text" placeholder="메모 입력..." class="flex-1 rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addCasePanelNote('${data.id}')" />
                <button onclick="addCasePanelNote('${data.id}')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-light transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">add</span>추가
                </button>
            </div>
        </div>`;

        // E. Linkage History
        if (linkages.length > 0) {
            html += `<div class="mb-5">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm text-indigo-500" aria-hidden="true">hub</span>연계 이력 (${linkages.length})
                </h4>
                <div class="space-y-3">
                    ${linkages.map(l => renderCasePanelLinkage(l)).join('')}
                </div>
            </div>`;
        }

        body.innerHTML = html;
    }

    function renderCaseStatusStepper(data) {
        const CASE_STEPS = ['open', 'confirmed', 'contacted', 'connected', 'closed'];
        const CASE_STEP_LABELS = { open: '접수', confirmed: '확인', contacted: '연락', connected: '연결', closed: '완료' };
        const CASE_STEP_ICONS = {
            done: 'check_circle',
            current: 'radio_button_checked',
            future: 'radio_button_unchecked',
        };

        const currentStatus = data.status || 'open';
        const currentIdx = CASE_STEPS.indexOf(currentStatus);
        const effectiveIdx = currentIdx === -1 ? 0 : currentIdx;

        let html = '<div class="mb-5"><div class="case-stepper">';
        CASE_STEPS.forEach((step, i) => {
            let dotClass, icon;
            if (i < effectiveIdx) {
                dotClass = 'done'; icon = CASE_STEP_ICONS.done;
            } else if (i === effectiveIdx) {
                dotClass = 'current'; icon = CASE_STEP_ICONS.current;
            } else {
                dotClass = 'future'; icon = CASE_STEP_ICONS.future;
            }

            html += `<div class="case-stepper-step">
                <div class="case-stepper-dot ${dotClass}">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">${icon}</span>
                </div>
                <span class="text-[10px] mt-1 ${dotClass === 'current' ? 'font-bold text-green-800' : dotClass === 'done' ? 'text-green-700' : 'text-slate-400'}">${CASE_STEP_LABELS[step]}</span>
            </div>`;

            if (i < CASE_STEPS.length - 1) {
                const lineClass = i < effectiveIdx ? 'done' : 'future';
                html += `<div class="case-stepper-line ${lineClass}"></div>`;
            }
        });
        html += '</div>';

        // Read-only notice
        html += '<p class="text-[10px] text-slate-400 mt-2 flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:12px" aria-hidden="true">info</span>상태는 담당자 처리 페이지에서 변경 가능합니다.</p>';
        html += '</div>';
        return html;
    }

    function renderCasePanelLinkage(l) {
        const ast = APPROVAL_STATUS_MAP[l.approvalStatus] || APPROVAL_STATUS_MAP.pending;
        const typeName = COLLAB_TYPE_MAP[l.type] || '자문';
        const catLabel = l.category === 'referral' ? '서비스연계' : '부서협업';

        let dirHtml = '';
        if (l.category === 'referral' && l.targetService) {
            dirHtml = `<span class="font-semibold text-blue-700 text-sm">${escapeHtml(l.targetService)}</span>`;
        } else if (l.fromDept && l.toDept) {
            dirHtml = `<span class="font-semibold text-indigo-700 text-sm">${getDeptName(l.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" style="font-size:14px" aria-hidden="true">arrow_forward</span>
                <span class="font-semibold text-green-700 text-sm">${getDeptName(l.toDept)}</span>`;
        }

        const bgClass = l.approvalStatus === 'approved' ? 'bg-green-50 border-green-200'
            : l.approvalStatus === 'dept_approved' ? 'bg-blue-50 border-blue-200'
            : l.approvalStatus === 'pending' ? 'bg-yellow-50 border-yellow-200'
            : (l.approvalStatus === 'rejected' || l.approvalStatus === 'admin_rejected') ? 'bg-red-50 border-red-200'
            : 'bg-slate-50 border-slate-200';

        let html = `<div class="p-3 rounded-lg border ${bgClass}">
            <div class="flex items-center gap-2 mb-2">
                <span class="badge ${ast.bg} ${ast.text}" style="font-size:11px">${ast.label}</span>
                <span class="text-[10px] text-slate-400">${catLabel} · ${typeName}</span>
                <span class="text-[10px] text-slate-400 ml-auto">${new Date(l.createdAt).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
            </div>
            ${dirHtml ? `<div class="flex items-center gap-1.5 mb-2">${dirHtml}</div>` : ''}
            ${l.reason ? `<p class="text-xs text-slate-600 mb-2">${escapeHtml(l.reason)}</p>` : ''}
            ${renderApprovalStepper(l.approvalStatus)}`;

        // Approval history timeline
        if (l.approvalHistory && l.approvalHistory.length > 0) {
            html += `<div class="mt-2 pt-2 border-t border-slate-200/60">
                <p class="text-[10px] font-semibold text-slate-400 mb-1.5">승인 이력</p>
                ${renderApprovalTimeline(l.approvalHistory)}
            </div>`;
        }

        html += '</div>';
        return html;
    }

    function toggleCaseCollapse(id, toggleEl) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('open');
        if (toggleEl) toggleEl.classList.toggle('active');
    }

    async function addCasePanelNote(requestId) {
        const input = document.getElementById('case-panel-note-input');
        const noteText = input?.value.trim();
        if (!noteText) return;
        try {
            await fetch(`/api/admin/requests/${requestId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note: noteText }),
            });
            // Reload panel data
            loadCasePanelData(requestId);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    // ── Topbar time ──
    function updateTopbarTime() {
        const now = new Date();
        const str = now.toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', weekday: 'short', hour: '2-digit', minute: '2-digit' });
        document.getElementById('topbar-time').textContent = str;
    }

    // ── 로그인 ──
    async function doLogin() {
        const pw = document.getElementById('login-password').value;
        const errEl = document.getElementById('login-error');
        errEl.classList.add('hidden');
        try {
            const resp = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pw }),
            });
            const data = await resp.json();
            if (resp.ok && data.success) {
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initApp();
            } else {
                errEl.textContent = data.error || '로그인 실패';
                errEl.classList.remove('hidden');
            }
        } catch (e) {
            errEl.textContent = '서버에 연결할 수 없습니다.';
            errEl.classList.remove('hidden');
        }
    }

    function initApp() {
        loadDeptMap();
        loadDashboard();
        updateTopbarTime();
        setInterval(updateTopbarTime, 60000);
        // 대시보드 자동 갱신 (30초)
        setInterval(() => {
            if (!document.hidden) loadDashboard();
        }, 30000);
    }

    // ── Init: 인증 상태 확인 ──
    (async function checkAuth() {
        try {
            const resp = await fetch('/api/auth/status');
            const data = await resp.json();
            if (data.authenticated) {
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initApp();
            }
        } catch { /* 서버 미응답 시 로그인 화면 유지 */ }
    })();
    </script>
</div><!-- /main-content -->
</body>
</html>
