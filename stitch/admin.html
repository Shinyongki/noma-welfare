<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>관리자 대시보드 - 경상남도사회서비스원</title>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        /* Sidebar navigation */
        .nav-item {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.625rem 1rem; margin: 0 0.5rem;
            border-radius: 0.5rem; font-size: 0.875rem;
            color: rgba(255,255,255,0.6); cursor: pointer;
            transition: all 0.2s; position: relative;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.06); }
        .nav-active {
            color: #fff !important; background: rgba(255,255,255,0.1) !important;
            border-left-color: #fff;
        }
        .nav-item .nav-badge {
            margin-left: auto; min-width: 1.25rem; height: 1.25rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; font-size: 0.65rem; font-weight: 700;
            background: #EF4444; color: #fff; padding: 0 0.35rem;
        }

        /* Cards */
        .card-elevated {
            background: #fff; border-radius: 0.75rem;
            padding: 1.25rem; border: 1px solid #E2E8F0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-elevated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        /* KPI gradient text */
        .kpi-value {
            font-size: 1.875rem; font-weight: 800; line-height: 1.2;
            background: linear-gradient(135deg, #98002E, #4A1942);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Table zebra */
        .table-zebra tbody tr:nth-child(even) { background: #F8FAFC; }
        .table-zebra tbody tr:hover { background: #EEF2FF !important; }

        /* Badge (keep) */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 600; }

        /* Sidebar overlay (mobile) */
        .sidebar-overlay {
            position: fixed; inset: 0; z-index: 45;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* Modal overlay */
        .modal-overlay { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }

        /* Panel content fade-in */
        .panel-content { animation: fade-in 0.3s ease-out both; }

        /* Kanban Board */
        .kanban-container {
            display: flex; gap: 1rem; min-height: 500px;
            align-items: flex-start;
        }
        .kanban-col {
            flex: 1; min-width: 0;
            background: #F8FAFC; border-radius: 0.75rem;
            border: 1px solid #E2E8F0;
            display: flex; flex-direction: column;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .kanban-col.kanban-highlight {
            border-color: #93C5FD;
            box-shadow: 0 0 0 1px #93C5FD, 0 4px 12px rgba(59,130,246,0.08);
        }
        .kanban-col.drag-over {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px #6366F1, 0 4px 16px rgba(99,102,241,0.15);
            background: #EEF2FF;
        }
        .kanban-header {
            padding: 0.75rem 1rem; border-bottom: 1px solid #E2E8F0;
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.8125rem; font-weight: 700;
        }
        .kanban-header .kanban-count {
            margin-left: auto; min-width: 1.25rem; height: 1.25rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; font-size: 0.65rem; font-weight: 700;
            padding: 0 0.35rem;
        }
        .kanban-body {
            padding: 0.5rem; flex: 1;
            overflow-y: auto; max-height: 600px;
            display: flex; flex-direction: column; gap: 0.5rem;
            min-height: 60px;
        }
        .kanban-card {
            background: #fff; border-radius: 0.5rem;
            border: 1px solid #E2E8F0; padding: 0.75rem;
            cursor: pointer; transition: all 0.2s;
            font-size: 0.8125rem;
        }
        .kanban-card:hover {
            border-color: #CBD5E1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .kanban-card.dragging {
            opacity: 0.4; transform: scale(0.97);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .kanban-card.bulk-selected {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99,102,241,0.3);
            background: #F5F3FF;
        }
        .kanban-card .card-summary { pointer-events: none; }
        .kanban-card .bulk-checkbox { pointer-events: auto; }

        /* Kanban Detail Modal */
        .kanban-modal-overlay {
            position: fixed; inset: 0; z-index: 70;
            background: rgba(0,0,0,0.45); backdrop-filter: blur(3px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .kanban-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .kanban-modal-panel {
            background: #fff; border-radius: 1rem;
            width: 100%; max-width: 1280px; max-height: 90vh;
            margin: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.18);
            display: flex; flex-direction: column;
            transform: translateY(16px) scale(0.97);
            opacity: 0;
            transition: transform 0.25s cubic-bezier(0.4,0,0.2,1), opacity 0.2s ease;
        }
        .kanban-modal-overlay.active .kanban-modal-panel {
            transform: translateY(0) scale(1); opacity: 1;
        }
        .kanban-modal-header {
            flex-shrink: 0;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #E2E8F0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .kanban-modal-body {
            flex: 1; overflow: hidden; padding: 0;
            min-height: 0;
        }
        .kanban-modal-2col {
            display: grid; grid-template-columns: 1fr 1fr;
            min-height: 0; height: 100%;
        }
        .kanban-modal-col {
            overflow-y: auto; padding: 1.25rem;
        }
        .kanban-modal-col-left {
            border-right: 1px solid #E2E8F0;
        }
        @media (max-width: 768px) {
            .kanban-modal-panel { max-width: 100%; margin: 0.5rem; max-height: 92vh; }
            .kanban-modal-2col {
                grid-template-columns: 1fr;
            }
            .kanban-modal-col-left {
                border-right: none;
                border-bottom: 1px solid #E2E8F0;
            }
        }

        /* ── Analytics Bento Grid ── */
        .analytics-section {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            border-radius: 1rem;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #E2E8F0;
        }
        .analytics-section-header {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px;
        }
        .analytics-section-icon {
            width: 28px; height: 28px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .analytics-section-label {
            font-size: 12px; font-weight: 700; color: #334155;
            letter-spacing: 0.02em;
        }
        .analytics-section-sub {
            font-size: 10px; color: #94A3B8; font-weight: 400; margin-left: 2px;
        }
        .analytics-bento {
            display: grid;
            gap: 8px;
        }
        .analytics-card-main {
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.02);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; flex-direction: column;
            min-height: 0;
            position: relative;
            overflow: hidden;
        }
        .analytics-card-main::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 3px;
            border-radius: 12px 12px 0 0;
            opacity: 0; transition: opacity 0.2s;
        }
        .analytics-card-main:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }
        .analytics-card-main:hover::before { opacity: 1; }
        .analytics-card-main:active { transform: translateY(0); }
        .analytics-main-title {
            font-size: 12px; font-weight: 600; color: #475569;
            display: flex; align-items: center; gap: 5px;
            margin-bottom: 8px; flex-shrink: 0;
        }
        .analytics-main-title .material-symbols-outlined { font-size: 16px; }
        .analytics-card-sat {
            background: #fff;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; flex-direction: column;
            min-height: 0;
            position: relative;
        }
        .analytics-card-sat:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }
        .analytics-card-sat:active { transform: translateY(0); }
        .analytics-sat-title {
            font-size: 10px; font-weight: 600; color: #64748B;
            display: flex; align-items: center; gap: 4px;
            margin-bottom: 4px; flex-shrink: 0;
        }
        .analytics-sat-title .material-symbols-outlined { font-size: 12px; }
        /* Accent top-border colors per section */
        .bento-intake .analytics-card-main::before { background: linear-gradient(90deg, #3B82F6, #60A5FA); }
        .bento-service .analytics-card-main::before { background: linear-gradient(90deg, #98002E, #DC2626); }
        .bento-case .analytics-card-main::before { background: linear-gradient(90deg, #0D9488, #14B8A6); }
        /* Bento heights */
        .analytics-bento[style*="repeat(3"] { height: 370px; }
        .analytics-bento[style*="repeat(2"] { height: 250px; }
        @media (max-width: 768px) {
            .analytics-section { padding: 12px; }
            .analytics-bento {
                grid-template-columns: 1fr !important;
                grid-template-rows: auto !important;
                height: auto !important;
            }
            .analytics-card-main { grid-row: auto !important; min-height: 200px; }
            .analytics-card-sat { min-height: 120px; }
        }

        /* ── Analytics Detail Modal ── */
        .analytics-modal-overlay {
            position: fixed; inset: 0; z-index: 70;
            background: rgba(15,23,42,0.45); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .analytics-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .analytics-modal-panel {
            background: #fff; border-radius: 16px;
            width: 100%; max-width: 720px; max-height: 85vh;
            margin: 1rem;
            box-shadow: 0 24px 64px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            transform: translateY(16px) scale(0.96);
            opacity: 0;
            transition: transform 0.25s cubic-bezier(0.22,1,0.36,1), opacity 0.2s ease;
        }
        .analytics-modal-overlay.active .analytics-modal-panel {
            transform: translateY(0) scale(1); opacity: 1;
        }
        .analytics-detail-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
        }
        .analytics-detail-table th {
            text-align: left; padding: 7px 12px; font-weight: 600;
            color: #475569; background: #F8FAFC;
            border-bottom: 2px solid #E2E8F0;
            position: sticky; top: 0; z-index: 1;
        }
        .analytics-detail-table td {
            padding: 6px 12px; border-bottom: 1px solid #F1F5F9; color: #334155;
        }
        .analytics-detail-table tr:hover td { background: #F8FAFC; }

        /* Approval Timeline */
        .approval-timeline { position: relative; padding-left: 1.5rem; }
        .approval-timeline::before {
            content: ''; position: absolute; left: 0.5rem; top: 0.25rem; bottom: 0.25rem;
            width: 2px; background: #E2E8F0;
        }
        .timeline-item { position: relative; padding-bottom: 0.75rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item .timeline-dot {
            position: absolute; left: -1.25rem; top: 0.125rem;
            width: 0.625rem; height: 0.625rem;
            border-radius: 9999px; border: 2px solid #CBD5E1;
            background: #fff;
        }
        .timeline-item.done .timeline-dot { border-color: #22C55E; background: #22C55E; }
        .timeline-item.current .timeline-dot { border-color: #3B82F6; background: #3B82F6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .timeline-item.rejected .timeline-dot { border-color: #EF4444; background: #EF4444; }

        /* (Case Detail Slide-Over Panel removed - integrated into kanban modal) */

        /* Case status stepper */
        .case-stepper { display: flex; align-items: flex-start; gap: 0; }
        .case-stepper-step {
            display: flex; flex-direction: column; align-items: center;
            min-width: 48px; flex: 0 0 auto;
        }
        .case-stepper-dot {
            width: 2rem; height: 2rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem; transition: all 0.2s;
        }
        .case-stepper-dot.done { background: #059669; color: #fff; }
        .case-stepper-dot.current { background: #D1FAE5; color: #065F46; box-shadow: 0 0 0 3px rgba(5,150,105,0.25); }
        .case-stepper-dot.future { background: #F1F5F9; color: #94A3B8; }
        .case-stepper-line {
            flex: 1; height: 2px; margin-top: 1rem; min-width: 12px;
        }
        .case-stepper-line.done { background: #059669; }
        .case-stepper-line.future { background: #E2E8F0; }

        /* Collapsible section */
        .case-collapse-toggle { cursor: pointer; user-select: none; }
        .case-collapse-body { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease, opacity 0.2s ease; }
        .case-collapse-body.open { max-height: 1000px; opacity: 1; }
        .case-collapse-icon { transition: transform 0.2s; }
        .case-collapse-body.open ~ .case-collapse-toggle .case-collapse-icon,
        .case-collapse-toggle.active .case-collapse-icon { transform: rotate(180deg); }

        /* (case-panel-drawer mobile rule removed) */

        /* Kanban stats ribbon */
        .kanban-stat { cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
        .kanban-stat:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* Responsive: horizontal scroll on tablet, stack on mobile */
        @media (max-width: 1023px) and (min-width: 641px) {
            .kanban-container {
                overflow-x: auto; -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory; padding-bottom: 0.5rem;
            }
            .kanban-col { min-width: 280px; flex: 0 0 280px; scroll-snap-align: start; }
        }
        @media (max-width: 640px) {
            .kanban-container { flex-direction: column; }
            .kanban-col { min-width: 0; }
            .kanban-body { max-height: 400px; }
            .kanban-card { padding: 0.875rem; font-size: 0.875rem; }
        }

        /* View toggle buttons */
        .view-toggle-btn {
            display: flex; align-items: center; justify-content: center;
            width: 2rem; height: 2rem; border-radius: 0.375rem;
            border: 1px solid #E2E8F0; cursor: pointer;
            transition: all 0.15s; color: #94A3B8;
        }
        .view-toggle-btn:hover { background: #F1F5F9; color: #475569; }
        .view-toggle-btn.active {
            background: #EEF2FF; color: #6366F1;
            border-color: #6366F1;
        }

        /* Collab table view */
        .collab-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        .collab-table thead th {
            padding: 0.625rem 0.75rem; text-align: left;
            font-size: 0.6875rem; font-weight: 700;
            text-transform: uppercase; color: #64748B;
            background: #F8FAFC; border-bottom: 1px solid #E2E8F0;
            cursor: pointer; user-select: none;
            white-space: nowrap;
        }
        .collab-table thead th:hover { color: #334155; background: #F1F5F9; }
        .collab-table thead th .sort-arrow { font-size: 14px; vertical-align: middle; margin-left: 2px; }
        .collab-table tbody tr {
            border-bottom: 1px solid #F1F5F9;
            transition: background 0.15s; cursor: pointer;
        }
        .collab-table tbody tr:hover { background: #EEF2FF !important; }
        .collab-table tbody tr:nth-child(even) { background: #F8FAFC; }
        .collab-table tbody td { padding: 0.5rem 0.75rem; }
        .collab-table tbody tr.bulk-selected { background: #F5F3FF !important; }

        /* Bulk action bar */
        .bulk-bar {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
            z-index: 55; background: #1E293B; color: #fff;
            border-radius: 0.75rem; padding: 0.625rem 1rem;
            display: flex; align-items: center; gap: 0.75rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            animation: fade-in 0.2s ease-out;
            max-width: calc(100% - 2rem);
        }
        .bulk-bar button {
            padding: 0.375rem 0.75rem; border-radius: 0.375rem;
            font-size: 0.75rem; font-weight: 600; white-space: nowrap;
            transition: background 0.15s;
        }

        /* Phase 3: 고대비 모드 */
        @media (prefers-contrast: more) {
            .text-slate-400, .text-slate-500 { color: #1e293b !important; }
            .border-slate-100, .border-slate-200 { border-color: #475569 !important; }
        }

        /* Phase 3: reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        /* ── Collab Detail View ── */
        .collab-detail-view {
            animation: fade-in 0.25s ease-out both;
        }
        .collab-detail-sticky-header {
            position: sticky; top: 0; z-index: 10;
            background: rgba(255,255,255,0.92); backdrop-filter: blur(8px);
            border-bottom: 1px solid #E2E8F0;
            padding: 0.75rem 1rem;
            display: flex; align-items: center; justify-content: space-between;
            gap: 0.75rem; border-radius: 0.75rem 0.75rem 0 0;
            margin: -1.5rem -1rem 1rem -1rem;
        }
        @media (min-width: 640px) {
            .collab-detail-sticky-header { margin: -1.5rem -1.5rem 1rem -1.5rem; padding: 0.75rem 1.5rem; }
        }
        .collab-detail-summary-card {
            background: #F8FAFC; border: 1px solid #E2E8F0;
            border-radius: 0.75rem; padding: 1rem;
            margin-bottom: 1rem;
        }
        .collab-detail-unified {
            max-width: 720px;
            margin: 0 auto;
        }
        .collab-detail-comment-slide {
            max-height: 0; overflow: hidden; opacity: 0;
            transition: max-height 0.3s ease, opacity 0.2s ease, margin 0.3s ease;
            margin-top: 0;
        }
        .collab-detail-comment-slide.open {
            max-height: 300px; opacity: 1; margin-top: 0.75rem;
        }

        /* Unified timeline */
        .unified-timeline { position: relative; padding-left: 1.75rem; }
        .unified-timeline::before {
            content: ''; position: absolute; left: 0.625rem; top: 0.5rem; bottom: 0.5rem;
            width: 2px; background: #E2E8F0;
        }
        .unified-timeline-item {
            position: relative; padding-bottom: 1rem;
        }
        .unified-timeline-item:last-child { padding-bottom: 0; }
        .unified-timeline-item .ut-dot {
            position: absolute; left: -1.375rem; top: 0.25rem;
            width: 0.75rem; height: 0.75rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
        }
        .unified-timeline-item .ut-dot.ut-approved { background: #22C55E; }
        .unified-timeline-item .ut-dot.ut-rejected { background: #EF4444; }
        .unified-timeline-item .ut-dot.ut-revision { background: #F59E0B; }
        .unified-timeline-item .ut-dot.ut-submitted { background: #3B82F6; }
        .unified-timeline-item .ut-dot.ut-default { background: #CBD5E1; }

        /* Linkage flow diagram */
        .lf-card {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            border: 1px solid #E2E8F0; border-radius: 1rem; padding: 1.25rem;
            position: relative; overflow: hidden;
        }
        .lf-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #818CF8, #34D399);
        }
        .lf-row { display: flex; align-items: stretch; gap: 0; margin-bottom: 1rem; }
        .lf-node {
            flex: 1; min-width: 0; padding: 0.875rem 0.5rem 0.75rem; border-radius: 0.75rem;
            text-align: center; position: relative;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .lf-node-origin { background: white; border: 2px solid #818CF8; }
        .lf-node-target { background: white; border: 2px solid #34D399; }
        .lf-node-icon {
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; margin-bottom: 6px;
        }
        .lf-node-origin .lf-node-icon { background: #EEF2FF; color: #6366F1; }
        .lf-node-target .lf-node-icon { background: #ECFDF5; color: #10B981; }
        .lf-node-name {
            font-size: 13px; font-weight: 800; color: #1E293B;
            line-height: 1.3; word-break: keep-all; margin-bottom: 2px;
        }
        .lf-node-role { font-size: 10px; color: #94A3B8; font-weight: 500; }
        .lf-connector {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0 0.125rem; flex-shrink: 0; min-width: 56px; position: relative;
        }
        .lf-arrow-wrap { position: relative; width: 100%; display: flex; align-items: center; }
        .lf-arrow-line {
            flex: 1; height: 3px; border-radius: 2px;
            background: linear-gradient(90deg, #818CF8, #34D399);
        }
        .lf-arrow-head {
            width: 0; height: 0;
            border-top: 7px solid transparent; border-bottom: 7px solid transparent;
            border-left: 10px solid #34D399; flex-shrink: 0;
        }
        .lf-arrow-label {
            font-size: 10px; font-weight: 700; color: #475569;
            white-space: nowrap; margin-bottom: 6px; text-align: center;
            background: white; padding: 1px 6px; border-radius: 4px;
            border: 1px solid #E2E8F0;
        }
        .lf-arrow-status {
            margin-top: 6px; text-align: center;
        }
        .lf-exec-badge {
            display: inline-flex; align-items: center; gap: 2px;
            font-size: 10px; font-weight: 700; padding: 2px 8px;
            border-radius: 10px;
        }
        /* Approval pipeline */
        .lf-pipeline { display: flex; align-items: center; justify-content: center; gap: 0; }
        .lf-pipe-step {
            display: flex; flex-direction: column; align-items: center; position: relative; z-index: 1;
        }
        .lf-pipe-dot {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; border: 2px solid;
            transition: all 0.2s;
        }
        .lf-pipe-dot.done { background: #22C55E; border-color: #22C55E; color: white; }
        .lf-pipe-dot.current { background: #EEF2FF; border-color: #6366F1; color: #6366F1; animation: lfPulse 2s infinite; }
        .lf-pipe-dot.wait { background: #F1F5F9; border-color: #CBD5E1; color: #CBD5E1; }
        .lf-pipe-dot.fail { background: #FEE2E2; border-color: #EF4444; color: #EF4444; }
        @keyframes lfPulse { 0%,100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.3); } 50% { box-shadow: 0 0 0 6px rgba(99,102,241,0); } }
        .lf-pipe-label { font-size: 9px; font-weight: 600; color: #64748B; margin-top: 3px; white-space: nowrap; }
        .lf-pipe-line { flex: 1; height: 3px; min-width: 16px; border-radius: 2px; margin: 0 -2px; position: relative; z-index: 0; }
        .lf-pipe-line.done { background: #22C55E; }
        .lf-pipe-line.wait { background: #E2E8F0; }
        /* Mini flow row (for other linkages / chain) */
        .lf-mini-row {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 10px; border-radius: 8px; border: 1px solid #E2E8F0;
            background: white; font-size: 11px; margin-bottom: 4px;
        }
        .lf-mini-row.lf-current { border-color: #818CF8; background: #EEF2FF; box-shadow: 0 0 0 1px #C7D2FE; }
        .lf-mini-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .lf-mini-arrow {
            width: 16px; height: 2px; background: #CBD5E1; position: relative; flex-shrink: 0;
        }
        .lf-mini-arrow::after {
            content: ''; position: absolute; right: -1px; top: -3px;
            border: 4px solid transparent; border-left: 5px solid #CBD5E1;
        }
        .lf-vertical-arrow {
            display: flex; justify-content: center; padding: 2px 0; color: #CBD5E1;
        }
        .lf-redirect-bar {
            display: flex; align-items: center; gap: 4px; flex-wrap: wrap;
            padding: 5px 8px; margin-top: 6px;
            background: #FAF5FF; border-radius: 6px; border: 1px dashed #D8B4FE;
            font-size: 10px;
        }
        .lf-add-dept-bar {
            display: flex; align-items: center; gap: 4px; flex-wrap: wrap;
            padding: 5px 8px; margin-top: 6px;
            background: #FFFBEB; border-radius: 6px; border: 1px dashed #FCD34D;
            font-size: 10px;
        }

        /* Hub-spoke layout */
        .lf-hub-layout {
            display: flex; gap: 0; align-items: stretch; position: relative;
            min-height: 120px;
        }
        .lf-hub-origin {
            flex: 0 0 110px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 12px 8px; border-right: 2px solid #E2E8F0;
            background: white; border-radius: 12px 0 0 12px;
        }
        .lf-hub-origin-icon {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: #EEF2FF; margin-bottom: 6px;
        }
        .lf-hub-origin-name {
            font-size: 12px; font-weight: 800; color: #1E293B;
            text-align: center; word-break: keep-all; line-height: 1.3;
        }
        .lf-hub-depts {
            flex: 1; display: flex; flex-direction: column; gap: 3px;
            padding: 8px 10px; background: #F8FAFC; border-radius: 0 12px 12px 0;
        }
        .lf-hub-dept {
            display: flex; align-items: center; gap: 6px;
            padding: 7px 10px; border-radius: 8px;
            border: 1.5px solid #E2E8F0; background: #F1F5F9;
            transition: all 0.2s; min-height: 34px;
        }
        .lf-hub-dept.lf-target {
            border-color: #34D399; background: #ECFDF5;
            box-shadow: 0 0 0 1px rgba(52,211,153,0.3);
        }
        .lf-hub-dept.lf-inactive { opacity: 0.35; }
        .lf-hub-dept-icon {
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: 13px;
        }
        .lf-hub-dept.lf-target .lf-hub-dept-icon { background: #D1FAE5; color: #059669; }
        .lf-hub-dept.lf-inactive .lf-hub-dept-icon { background: #F1F5F9; color: #94A3B8; }
        .lf-hub-dept-name {
            font-size: 12px; font-weight: 700; color: #1E293B;
            flex: 1; min-width: 0;
        }
        .lf-hub-dept.lf-inactive .lf-hub-dept-name { color: #94A3B8; }
        .lf-hub-arrow-inline {
            display: inline-flex; align-items: center; gap: 3px;
            font-size: 9px; font-weight: 700; color: #475569;
            margin-right: 4px; flex-shrink: 0;
        }
        .lf-hub-arrow-line {
            width: 20px; height: 2px; border-radius: 1px;
            background: linear-gradient(90deg, #818CF8, #34D399);
        }
        .lf-hub-arrow-head {
            width: 0; height: 0;
            border-top: 4px solid transparent; border-bottom: 4px solid transparent;
            border-left: 6px solid #34D399;
        }
        .lf-hub-type-label {
            font-size: 9px; font-weight: 700; color: #475569;
            background: white; padding: 1px 5px; border-radius: 3px;
            border: 1px solid #E2E8F0; white-space: nowrap;
        }
        .lf-hub-extra-node {
            display: flex; align-items: center; gap: 6px;
            padding: 7px 10px; border-radius: 8px;
            border: 1.5px dashed #A78BFA; background: #F5F3FF;
            min-height: 34px;
        }
        .lf-hub-extra-node .lf-hub-dept-icon { background: #EDE9FE; color: #7C3AED; }
        .lf-hub-extra-node .lf-hub-dept-name { color: #5B21B6; }

        /* Kanban card enhancements */
        .card-elapsed {
            font-size: 10px; font-weight: 600;
            padding: 1px 5px; border-radius: 4px;
            line-height: 1.4;
        }
        .card-elapsed.overdue { background: #FEE2E2; color: #DC2626; }
        .card-elapsed.normal { background: #F1F5F9; color: #64748B; }
        .card-action-label {
            font-size: 10px; color: #6366F1; font-weight: 600;
            margin-top: 4px; display: flex; align-items: center; gap: 2px;
        }
        .card-ai-preview {
            font-size: 10px; color: #94A3B8; margin-top: 3px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        @media (max-width: 640px) {
            .collab-detail-sticky-header { flex-wrap: wrap; }
            .collab-detail-sticky-header .flex { flex-wrap: wrap; }
        }
    </style>
</head>

<body class="bg-content-bg min-h-screen font-sans text-slate-800">

    <!-- 로그인 게이트 (역할 카드 선택) -->
    <div id="login-gate" class="flex items-center justify-center min-h-screen bg-gradient-to-b from-sidebar-start to-sidebar-end">
        <div class="w-full max-w-md mx-4">
            <!-- 헤더 -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-2xl bg-white/15 backdrop-blur flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-outlined text-white text-4xl" aria-hidden="true">hub</span>
                </div>
                <h1 class="text-2xl font-bold text-white">연계 조정 시스템</h1>
                <p class="text-sm text-white/60 mt-1">경상남도사회서비스원</p>
            </div>
            <div id="login-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm"></div>

            <!-- 역할 선택 카드 (초기 화면) -->
            <div id="login-role-cards" class="grid grid-cols-2 gap-3">
                <button onclick="selectLoginRole('admin')" class="bg-white rounded-2xl p-5 text-center shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5 group">
                    <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center mx-auto mb-3 group-hover:bg-indigo-200 transition-colors">
                        <span class="material-symbols-outlined text-indigo-600 text-2xl" aria-hidden="true">admin_panel_settings</span>
                    </div>
                    <div class="font-bold text-slate-800 text-sm">관리자</div>
                    <p class="text-[11px] text-slate-400 mt-1">전체 연계 관리 및 승인</p>
                </button>
                <button onclick="selectLoginRole('dept')" class="bg-white rounded-2xl p-5 text-center shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5 group">
                    <div class="w-12 h-12 rounded-xl bg-teal-100 flex items-center justify-center mx-auto mb-3 group-hover:bg-teal-200 transition-colors">
                        <span class="material-symbols-outlined text-teal-600 text-2xl" aria-hidden="true">supervisor_account</span>
                    </div>
                    <div class="font-bold text-slate-800 text-sm">부서 조정자</div>
                    <p class="text-[11px] text-slate-400 mt-1">소속 부서 연계 검토</p>
                </button>
            </div>

            <!-- 부서 선택 (부서 조정자 선택 시) -->
            <div id="login-dept-area" class="hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <button onclick="backToRoleSelect()" class="p-1 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="material-symbols-outlined text-slate-400 text-xl" aria-hidden="true">arrow_back</span>
                        </button>
                        <h2 class="text-sm font-bold text-slate-800">소속 부서 선택</h2>
                    </div>
                    <div id="login-dept-list" class="space-y-2">
                        <button onclick="doLoginDept('care')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-teal-300 hover:bg-teal-50 transition-all text-left group">
                            <div class="w-9 h-9 rounded-lg bg-teal-100 flex items-center justify-center flex-shrink-0 group-hover:bg-teal-200 transition-colors">
                                <span class="material-symbols-outlined text-teal-600 text-lg" aria-hidden="true">favorite</span>
                            </div>
                            <div><div class="text-sm font-semibold text-slate-700">통합돌봄팀</div><div class="text-[11px] text-slate-400">돌봄 서비스 총괄</div></div>
                        </button>
                        <button onclick="doLoginDept('emergency')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-teal-300 hover:bg-teal-50 transition-all text-left group">
                            <div class="w-9 h-9 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0 group-hover:bg-red-200 transition-colors">
                                <span class="material-symbols-outlined text-red-600 text-lg" aria-hidden="true">emergency</span>
                            </div>
                            <div><div class="text-sm font-semibold text-slate-700">긴급지원팀</div><div class="text-[11px] text-slate-400">긴급돌봄 및 위기개입</div></div>
                        </button>
                        <button onclick="doLoginDept('facility')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-teal-300 hover:bg-teal-50 transition-all text-left group">
                            <div class="w-9 h-9 rounded-lg bg-amber-100 flex items-center justify-center flex-shrink-0 group-hover:bg-amber-200 transition-colors">
                                <span class="material-symbols-outlined text-amber-600 text-lg" aria-hidden="true">account_balance</span>
                            </div>
                            <div><div class="text-sm font-semibold text-slate-700">시설운영팀</div><div class="text-[11px] text-slate-400">국공립시설 운영</div></div>
                        </button>
                        <button onclick="doLoginDept('casemanage')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-teal-300 hover:bg-teal-50 transition-all text-left group">
                            <div class="w-9 h-9 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-200 transition-colors">
                                <span class="material-symbols-outlined text-blue-600 text-lg" aria-hidden="true">folder_shared</span>
                            </div>
                            <div><div class="text-sm font-semibold text-slate-700">사례관리팀</div><div class="text-[11px] text-slate-400">통합 사례관리</div></div>
                        </button>
                        <button onclick="doLoginDept('private')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-teal-300 hover:bg-teal-50 transition-all text-left group">
                            <div class="w-9 h-9 rounded-lg bg-purple-100 flex items-center justify-center flex-shrink-0 group-hover:bg-purple-200 transition-colors">
                                <span class="material-symbols-outlined text-purple-600 text-lg" aria-hidden="true">handshake</span>
                            </div>
                            <div><div class="text-sm font-semibold text-slate-700">민간협력팀</div><div class="text-[11px] text-slate-400">민간기관 지원 및 협력</div></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 (인증 후 표시) -->
    <div id="main-content" class="hidden">

    <!-- Sidebar Overlay (mobile) -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-60 bg-gradient-to-b from-sidebar-start to-sidebar-end flex flex-col transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <!-- Logo -->
        <div class="px-5 py-5 flex items-center gap-3">
            <div class="w-9 h-9 rounded-lg bg-white/15 flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-xl" aria-hidden="true" style="font-variation-settings:'FILL' 1">dashboard</span>
            </div>
            <div>
                <h1 class="text-sm font-bold text-white leading-tight">연계 조정 시스템</h1>
                <p class="text-[10px] text-white/40 leading-none mt-0.5">경상남도사회서비스원</p>
            </div>
        </div>

        <!-- 역할 표시 + 전환 -->
        <div class="mx-3 mb-3 flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10">
            <div class="w-7 h-7 rounded-md bg-white/15 flex items-center justify-center flex-shrink-0">
                <span id="sidebar-role-icon" class="material-symbols-outlined text-white text-base" aria-hidden="true">admin_panel_settings</span>
            </div>
            <div class="flex-1 min-w-0">
                <div id="sidebar-role-label" class="text-xs font-bold text-white truncate">관리자</div>
                <div id="sidebar-role-sub" class="text-[10px] text-white/50 truncate">전체 관리</div>
            </div>
            <button onclick="switchRole()" class="px-2 py-1 rounded-md bg-white/10 hover:bg-white/25 transition-colors flex items-center gap-1" title="역할 전환">
                <span class="material-symbols-outlined text-white text-base" style="font-variation-settings:'wght' 600" aria-hidden="true">swap_horiz</span>
                <span class="text-[10px] font-bold text-white">전환</span>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 py-2 space-y-1 border-t border-white/10 pt-3">
            <div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item nav-active">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">monitoring</span>
                현황판
            </div>
            <div onclick="switchTab('requests')" id="nav-requests" class="nav-item">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">list_alt</span>
                상담 요청
            </div>
            <div onclick="switchTab('analytics')" id="nav-analytics" class="nav-item">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">analytics</span>
                분석
            </div>
            <div onclick="switchTab('collab')" id="nav-collab" class="nav-item">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">hub</span>
                연계 조정
                <span id="sidebar-collab-badge" class="nav-badge" style="display:none">0</span>
            </div>
        </nav>

        <!-- 하단 여백 -->
        <div class="pb-4"></div>
    </aside>

    <!-- Topbar -->
    <header id="topbar" class="fixed top-0 right-0 left-0 lg:left-60 z-40 h-14 bg-white/80 backdrop-blur-md border-b border-slate-200/60 flex items-center justify-between px-4 sm:px-6 transition-all">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="lg:hidden p-1.5 hover:bg-slate-100 rounded-lg">
                <span class="material-symbols-outlined text-xl text-slate-600" aria-hidden="true">menu</span>
            </button>
            <h2 id="topbar-title" class="text-base font-semibold text-slate-800">현황판</h2>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs text-slate-400 hidden sm:inline" id="topbar-time"></span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="lg:ml-60 pt-14 min-h-screen">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">

            <!-- Tab 1: Dashboard -->
            <section id="panel-dashboard" class="panel-content">
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-primary text-xl" aria-hidden="true">inbox</span>
                            <span class="text-sm text-slate-500">총 접수</span>
                        </div>
                        <p id="kpi-total" class="kpi-value">-</p>
                    </div>
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-amber-500 text-xl" aria-hidden="true">today</span>
                            <span class="text-sm text-slate-500">오늘 접수</span>
                        </div>
                        <p id="kpi-today" class="kpi-value">-</p>
                    </div>
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-blue-500 text-xl" aria-hidden="true">pending_actions</span>
                            <span class="text-sm text-slate-500">진행중</span>
                        </div>
                        <p id="kpi-active" class="kpi-value">-</p>
                        <p class="text-[11px] text-slate-400 mt-0.5">종결·연계 제외</p>
                    </div>
                    <div class="card-elevated">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-green-600 text-xl" aria-hidden="true">schedule</span>
                            <span class="text-sm text-slate-500">평균 처리일</span>
                        </div>
                        <p id="kpi-avg-days" class="kpi-value">-</p>
                    </div>
                </div>

                <!-- Status Bar (한 행 가로 나열 + 클릭 시 아래 펼침) -->
                <div class="card-elevated !p-0 overflow-hidden mb-6" id="status-rows">
                    <div class="flex divide-x divide-slate-100">
                        <button onclick="toggleStatusRow('open')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-blue-50/50 transition-colors" id="stbtn-open">
                            <span class="text-[11px] font-semibold text-blue-600">접수</span>
                            <span id="st-open" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                        <button onclick="toggleStatusRow('confirmed')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-amber-50/50 transition-colors" id="stbtn-confirmed">
                            <span class="text-[11px] font-semibold text-amber-600">확인</span>
                            <span id="st-confirmed" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                        <button onclick="toggleStatusRow('contacted')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-purple-50/50 transition-colors" id="stbtn-contacted">
                            <span class="text-[11px] font-semibold text-purple-600">연락</span>
                            <span id="st-contacted" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                        <button onclick="toggleStatusRow('connected')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-teal-50/50 transition-colors" id="stbtn-connected">
                            <span class="text-[11px] font-semibold text-teal-600">연결</span>
                            <span id="st-connected" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                        <button onclick="toggleStatusRow('providing')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-emerald-50/50 transition-colors" id="stbtn-providing">
                            <span class="text-[11px] font-semibold text-emerald-700">제공중</span>
                            <span id="st-providing" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                        <button onclick="toggleStatusRow('closed')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-green-50/50 transition-colors" id="stbtn-closed">
                            <span class="text-[11px] font-semibold text-green-700">종결</span>
                            <span id="st-closed" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                        <button onclick="toggleStatusRow('referred')" class="flex-1 flex flex-col items-center gap-1 py-3 px-1 hover:bg-indigo-50/50 transition-colors" id="stbtn-referred">
                            <span class="text-[11px] font-semibold text-indigo-600">연계</span>
                            <span id="st-referred" class="text-xl font-bold text-slate-800">-</span>
                        </button>
                    </div>
                    <div id="stlist-panel" class="hidden border-t border-slate-100 bg-slate-50/50 px-4 py-2 max-h-[280px] overflow-y-auto"></div>
                </div>

                <!-- Chart + Overdue / KPI row -->
                <div class="grid lg:grid-cols-3 gap-6 mb-6">
                    <!-- 14-day trend chart -->
                    <div class="lg:col-span-2 card-elevated">
                        <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-primary" aria-hidden="true">bar_chart</span>
                            14일 접수 추이
                        </h3>
                        <div style="height:260px"><canvas id="chart-daily"></canvas></div>
                    </div>
                    <!-- Overdue alerts -->
                    <div class="card-elevated">
                        <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-red-500" aria-hidden="true">warning</span>
                            연락 지연 알림 (2일+)
                        </h3>
                        <div id="overdue-list" class="space-y-2 max-h-[240px] overflow-y-auto text-sm">
                            <p class="text-slate-400">로딩 중...</p>
                        </div>
                    </div>
                </div>

                <!-- 연계 조정 현황 (dashboard: 승인 대기 + 최근 5건) -->
                <div class="card-elevated mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg text-indigo-500" aria-hidden="true">hub</span>
                            연계 조정 현황
                            <span id="collab-count" class="ml-1 px-2 py-0.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-600">-</span>
                            <span id="pending-count-badge" class="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-600" style="display:none">대기 0</span>
                        </h3>
                        <button onclick="switchTab('collab')" class="text-xs text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-0.5">
                            더보기<span class="material-symbols-outlined text-sm" aria-hidden="true">chevron_right</span>
                        </button>
                    </div>
                    <div id="collab-dashboard-list" class="space-y-2 max-h-[280px] overflow-y-auto">
                        <p class="text-slate-400 text-sm py-4 text-center">로딩 중...</p>
                    </div>
                </div>

                <!-- System KPI -->
                <div class="card-elevated">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-lg text-deep-purple" aria-hidden="true">speed</span>
                        시스템 KPI (7일)
                    </h3>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4" id="system-kpi">
                        <p class="text-slate-400 text-sm col-span-full">로딩 중...</p>
                    </div>
                </div>
            </section>

            <!-- Tab 2: Requests -->
            <section id="panel-requests" class="hidden">
                <!-- Filter Bar -->
                <div class="card-elevated !p-4 mb-4 flex flex-wrap gap-3 items-center">
                    <select id="filter-status" onchange="loadRequests()" class="rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary">
                        <option value="all">전체 상태</option>
                        <option value="open">접수</option>
                        <option value="confirmed">확인</option>
                        <option value="contacted">연락</option>
                        <option value="connected">연결</option>
                        <option value="providing">제공중</option>
                        <option value="closed">종결</option>
                        <option value="referred">연계</option>
                    </select>
                    <div class="flex-1 min-w-[200px]">
                        <input id="filter-search" type="text" placeholder="이름, 전화, 서비스명 검색..." onkeyup="debounceSearch()" class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" />
                    </div>
                    <button onclick="toggleSort()" id="sort-btn" class="flex items-center gap-1 text-sm text-slate-600 hover:text-primary px-3 py-2 rounded-lg border border-slate-300">
                        <span class="material-symbols-outlined text-lg" aria-hidden="true">swap_vert</span>
                        <span id="sort-label">최신순</span>
                    </button>
                </div>

                <!-- Request Table -->
                <div class="card-elevated !p-0 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm table-zebra">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">번호</th>
                                    <th class="px-4 py-3 text-left">이름</th>
                                    <th class="px-4 py-3 text-left hidden sm:table-cell">전화</th>
                                    <th class="px-4 py-3 text-left">서비스명</th>
                                    <th class="px-4 py-3 text-left">상태</th>
                                    <th class="px-4 py-3 text-left hidden md:table-cell">접수일</th>
                                    <th class="px-4 py-3 text-center">상세</th>
                                </tr>
                            </thead>
                            <tbody id="requests-tbody" class="divide-y divide-slate-100">
                                <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="flex items-center justify-between px-4 py-3 border-t border-slate-100 text-sm">
                        <span id="page-info" class="text-slate-500"></span>
                        <div class="flex gap-1" id="page-buttons"></div>
                    </div>
                </div>
            </section>

            <!-- Tab 3: Analytics -->
            <section id="panel-analytics" class="hidden">

                <!-- KPI 카드 -->
                <div class="grid grid-cols-5 gap-2 mb-5" id="analytics-kpi"></div>

                <!-- ═══ 그룹 1: 접수 현황 ═══ -->
                <div class="analytics-section bento-intake">
                    <div class="analytics-section-header">
                        <div class="analytics-section-icon" style="background:linear-gradient(135deg,#3B82F6,#2563EB)">
                            <span class="material-symbols-outlined text-white" style="font-size:16px">monitoring</span>
                        </div>
                        <div>
                            <div class="analytics-section-label">접수 현황<span class="analytics-section-sub">30일 이벤트 추이 및 접수 패턴</span></div>
                        </div>
                    </div>
                    <div class="analytics-bento" style="grid-template-columns:2fr 1fr; grid-template-rows:repeat(3,1fr);">
                        <div class="analytics-card-main" style="grid-row:1/4" onclick="openAnalyticsDetail('trends')">
                            <h3 class="analytics-main-title"><span class="material-symbols-outlined text-blue-500">show_chart</span>이벤트 추이 (30일)</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-trends"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('hourly')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-blue-400">schedule</span>시간대별</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-hourly"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('weekday')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-violet-500">date_range</span>요일별</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-weekday"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('weekly')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-emerald-500">trending_up</span>주간 추이</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-weekly"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- ═══ 그룹 2: 서비스 분석 ═══ -->
                <div class="analytics-section bento-service">
                    <div class="analytics-section-header">
                        <div class="analytics-section-icon" style="background:linear-gradient(135deg,#98002E,#DC2626)">
                            <span class="material-symbols-outlined text-white" style="font-size:16px">leaderboard</span>
                        </div>
                        <div>
                            <div class="analytics-section-label">서비스 분석<span class="analytics-section-sub">인기 서비스, 카테고리, 처리 현황</span></div>
                        </div>
                    </div>
                    <div class="analytics-bento" style="grid-template-columns:1fr 2fr; grid-template-rows:repeat(3,1fr);">
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('category')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined" style="color:#7C3AED">donut_large</span>카테고리</h3>
                            <div class="flex-1 min-h-0 flex items-center justify-center"><canvas id="chart-category"></canvas></div>
                        </div>
                        <div class="analytics-card-main" style="grid-row:1/4" onclick="openAnalyticsDetail('service')">
                            <h3 class="analytics-main-title"><span class="material-symbols-outlined text-primary">leaderboard</span>서비스 인기 랭킹</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-service"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('completion')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-emerald-600">check_circle</span>종결률</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-completion"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('duration')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-amber-500">timer</span>처리 소요일</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-duration"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- ═══ 그룹 3: 케이스 & 연계 ═══ -->
                <div class="analytics-section bento-case">
                    <div class="analytics-section-header">
                        <div class="analytics-section-icon" style="background:linear-gradient(135deg,#0D9488,#14B8A6)">
                            <span class="material-symbols-outlined text-white" style="font-size:16px">hub</span>
                        </div>
                        <div>
                            <div class="analytics-section-label">케이스 & 연계<span class="analytics-section-sub">진행 상태 및 부서간 연계 현황</span></div>
                        </div>
                    </div>
                    <div class="analytics-bento" style="grid-template-columns:2fr 1fr; grid-template-rows:repeat(2,1fr);">
                        <div class="analytics-card-main" style="grid-row:1/3" onclick="openAnalyticsDetail('status')">
                            <h3 class="analytics-main-title"><span class="material-symbols-outlined text-teal-600">pie_chart</span>상태별 현황</h3>
                            <div class="flex-1 min-h-0 flex items-center justify-center"><canvas id="chart-status-dist"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('linkage')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-indigo-500">hub</span>연계 승인</h3>
                            <div class="flex-1 min-h-0 flex items-center justify-center"><canvas id="chart-linkage-status"></canvas></div>
                        </div>
                        <div class="analytics-card-sat" onclick="openAnalyticsDetail('deptLinkage')">
                            <h3 class="analytics-sat-title"><span class="material-symbols-outlined text-orange-500">apartment</span>부서별 연계</h3>
                            <div class="flex-1 min-h-0"><canvas id="chart-dept-linkage"></canvas></div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Tab 4: Linkage Coordination (Kanban) -->
            <section id="panel-collab" class="hidden">
                <!-- Filter toolbar -->
                <div class="card-elevated !p-3 mb-4 flex flex-wrap gap-3 items-center">
                    <select id="collab-filter-cat" onchange="applyCollabFilter()" class="rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary">
                        <option value="all">전체 유형</option>
                        <option value="referral">서비스연계</option>
                        <option value="dept">부서협업</option>
                    </select>
                    <div class="flex-1 min-w-[180px]">
                        <input id="collab-search" type="text" placeholder="이름, 서비스, 부서 검색..." oninput="debounceCollabSearch()" class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" />
                    </div>
                    <span id="collab-total-count" class="text-xs text-slate-400">-</span>
                    <div class="flex gap-1 ml-auto">
                        <button id="view-kanban-btn" class="view-toggle-btn active" onclick="switchCollabView('kanban')" title="칸반 뷰">
                            <span class="material-symbols-outlined" style="font-size:18px" aria-hidden="true">view_kanban</span>
                        </button>
                        <button id="view-table-btn" class="view-toggle-btn" onclick="switchCollabView('table')" title="테이블 뷰">
                            <span class="material-symbols-outlined" style="font-size:18px" aria-hidden="true">table_rows</span>
                        </button>
                    </div>
                </div>

                <!-- Stats ribbon (3단계 승인 흐름) -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-dept-review')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span>
                            <span class="text-xs font-semibold text-slate-500">부서 검토</span>
                        </div>
                        <p id="kb-st-dept-review" class="text-xl font-bold text-yellow-700">-</p>
                    </div>
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-admin-review')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-400"></span>
                            <span class="text-xs font-semibold text-slate-500">관리자 결재</span>
                        </div>
                        <p id="kb-st-admin-review" class="text-xl font-bold text-blue-700">-</p>
                    </div>
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-completed')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-green-400"></span>
                            <span class="text-xs font-semibold text-slate-500">처리 완료</span>
                        </div>
                        <p id="kb-st-completed" class="text-xl font-bold text-green-700">-</p>
                    </div>
                    <div class="kanban-stat card-elevated !p-3 text-center" onclick="scrollToKanbanCol('col-returned')">
                        <div class="flex items-center justify-center gap-1.5 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-400"></span>
                            <span class="text-xs font-semibold text-slate-500">반려/재배정</span>
                        </div>
                        <p id="kb-st-returned" class="text-xl font-bold text-red-600">-</p>
                    </div>
                </div>

                <!-- Bulk action bar (hidden by default) -->
                <div id="bulk-bar" class="bulk-bar" style="display:none">
                    <span id="bulk-count" class="text-sm font-semibold whitespace-nowrap">0건 선택</span>
                    <select id="bulk-status-select" class="rounded border-slate-600 bg-slate-700 text-white text-xs py-1 px-2">
                        <option value="">상태 변경...</option>
                        <option value="pending">승인대기</option>
                        <option value="target_approved">관리자 결재 대기</option>
                        <option value="approved">처리 완료</option>
                        <option value="rejected">반려</option>
                    </select>
                    <button onclick="bulkChangeStatus()" class="bg-indigo-500 hover:bg-indigo-600 text-white">적용</button>
                    <button onclick="clearBulkSelection()" class="bg-slate-600 hover:bg-slate-500 text-white">취소</button>
                </div>

                <!-- Kanban board (3단계 승인 흐름, 설계문서 §3 기반) -->
                <div id="collab-kanban" class="kanban-container">
                    <!-- Column 1: 부서 검토 (1·2차 대기) -->
                    <div id="col-dept-review" class="kanban-col" data-col="dept_review" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'pending')">
                        <div class="kanban-header text-yellow-700">
                            <span class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span>
                            부서 검토
                            <span class="kanban-count bg-yellow-100 text-yellow-700" id="cnt-dept-review">0</span>
                        </div>
                        <div class="kanban-body" id="body-dept-review">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                    <!-- Column 2: 관리자 결재 대기 (highlighted) -->
                    <div id="col-admin-review" class="kanban-col kanban-highlight" data-col="admin_review" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'target_approved')">
                        <div class="kanban-header text-blue-700">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-400"></span>
                            관리자 결재
                            <span class="kanban-count bg-blue-100 text-blue-700" id="cnt-admin-review">0</span>
                        </div>
                        <div class="kanban-body" id="body-admin-review">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                    <!-- Column 3: 처리 완료 -->
                    <div id="col-completed" class="kanban-col" data-col="completed" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'approved')">
                        <div class="kanban-header text-green-700">
                            <span class="w-2.5 h-2.5 rounded-full bg-green-400"></span>
                            처리 완료
                            <span class="kanban-count bg-green-100 text-green-700" id="cnt-completed">0</span>
                        </div>
                        <div class="kanban-body" id="body-completed">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                    <!-- Column 4: 반려/재배정 -->
                    <div id="col-returned" class="kanban-col" data-col="returned" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, 'rejected')">
                        <div class="kanban-header text-red-600">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-400"></span>
                            반려/재배정
                            <span class="kanban-count bg-red-100 text-red-600" id="cnt-returned">0</span>
                        </div>
                        <div class="kanban-body" id="body-returned">
                            <p class="text-slate-400 text-xs text-center py-4">로딩 중...</p>
                        </div>
                    </div>
                </div>

                <!-- Table view (hidden by default) -->
                <div id="collab-table-view" class="card-elevated !p-0 overflow-hidden" style="display:none">
                    <div class="overflow-x-auto">
                        <table class="collab-table">
                            <thead>
                                <tr>
                                    <th style="width:2.5rem;text-align:center;cursor:default">
                                        <input type="checkbox" id="collab-table-check-all" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 w-3.5 h-3.5" onchange="toggleTableBulkAll(this.checked)" />
                                    </th>
                                    <th onclick="sortTable('id')">번호 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('title')">제목 (유형) <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('status')">상태 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('category')">카테고리 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('date')">날짜 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                    <th onclick="sortTable('dept')">담당부서 <span class="sort-arrow material-symbols-outlined" aria-hidden="true">unfold_more</span></th>
                                </tr>
                            </thead>
                            <tbody id="collab-table-body">
                                <tr><td colspan="7" class="text-center text-slate-400 py-8">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Collab Detail View (in-panel, replaces modal) -->
                <div id="collab-detail-view" class="collab-detail-view" style="display:none">
                    <div id="collab-detail-header"></div>
                    <div id="collab-detail-summary"></div>
                    <div id="collab-detail-unified" class="collab-detail-unified"></div>
                </div>
            </section>

        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[60] hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div id="modal-panel" class="absolute inset-y-0 right-0 w-full max-w-xl bg-white shadow-2xl overflow-y-auto animate-slide-in-right">
            <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex items-center justify-between z-10">
                <h2 class="text-lg font-bold text-slate-800">요청 상세</h2>
                <button onclick="closeModal()" class="p-1 hover:bg-slate-100 rounded-lg">
                    <span class="material-symbols-outlined" aria-hidden="true">close</span>
                </button>
            </div>
            <div id="modal-body" class="p-6">
                <p class="text-slate-400">로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- Kanban Card Detail Modal (2-column: linkage + case detail) -->
    <div id="kanban-detail-modal" class="kanban-modal-overlay" onclick="onKanbanModalOverlayClick(event)">
        <div class="kanban-modal-panel" onclick="event.stopPropagation()">
            <div class="kanban-modal-header">
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <span id="kanban-modal-status" class="badge bg-slate-100 text-slate-600" style="font-size:11px">-</span>
                    <h3 id="kanban-modal-title" class="text-base font-bold text-slate-800 truncate">상세 정보</h3>
                    <span id="kanban-modal-person" class="text-sm text-slate-500 truncate hidden sm:inline">-</span>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0 ml-3">
                    <a id="kanban-modal-newtab" href="#" target="_blank" class="p-1.5 hover:bg-slate-100 rounded-lg transition-colors" title="새 탭에서 열기">
                        <span class="material-symbols-outlined text-slate-400 text-lg" aria-hidden="true">open_in_new</span>
                    </a>
                    <button onclick="closeKanbanModal()" class="p-1.5 hover:bg-slate-100 rounded-lg" aria-label="닫기">
                        <span class="material-symbols-outlined text-slate-500" aria-hidden="true">close</span>
                    </button>
                </div>
            </div>
            <div id="kanban-modal-body" class="kanban-modal-body">
                <p class="text-slate-400 text-sm text-center py-8">로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- Analytics Detail Modal -->
    <div id="analytics-detail-modal" class="analytics-modal-overlay" onclick="closeAnalyticsModal()">
        <div class="analytics-modal-panel" onclick="event.stopPropagation()">
            <div class="flex-shrink-0 px-5 py-4 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white" style="border-radius:16px 16px 0 0">
                <h3 id="analytics-modal-title" class="text-sm font-bold text-slate-800 flex items-center gap-2"></h3>
                <button onclick="closeAnalyticsModal()" class="p-1.5 hover:bg-slate-100 rounded-lg transition-colors" aria-label="닫기">
                    <span class="material-symbols-outlined text-slate-400" style="font-size:18px" aria-hidden="true">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 min-h-0">
                <div id="analytics-modal-chart" class="mb-5 bg-slate-50/50 rounded-xl p-3 border border-slate-100" style="height:300px"><canvas id="chart-modal-detail"></canvas></div>
                <div id="analytics-modal-table"></div>
            </div>
        </div>
    </div>

    <!-- (Case Detail Slide-Over Panel removed - integrated into kanban modal) -->

    <script>
    // ── State ──
    let currentTab = 'dashboard';
    let currentSort = 'newest';
    let currentPage = 1;
    let searchTimer = null;
    let charts = {};
    let sidebarOpen = false;
    let allCollabs = [];
    let draggedLinkageId = null;
    let bulkSelected = new Set();

    // ── Session State (통합 인증) ──
    let sessionRole = null;   // 'admin' | 'dept'
    let sessionDeptId = null;
    let sessionDeptName = null;

    function isAdmin() { return sessionRole === 'admin'; }
    function isSourceDept(linkage) { return sessionRole === 'dept' && linkage && linkage.fromDept === sessionDeptId; }
    function isTargetDept(linkage) { return sessionRole === 'dept' && linkage && linkage.toDept === sessionDeptId; }

    // ── Collab Detail View State ──
    let collabDetailActive = false;
    let collabDetailLinkageId = null;

    // ── Status helpers ──
    const STATUS_MAP = {
        open:      { label: '접수', bg: 'bg-blue-100',   text: 'text-blue-600' },
        confirmed: { label: '확인', bg: 'bg-amber-100',  text: 'text-amber-600' },
        contacted: { label: '연락', bg: 'bg-purple-100', text: 'text-purple-600' },
        connected: { label: '연결', bg: 'bg-teal-100',   text: 'text-teal-600' },
        providing: { label: '제공중', bg: 'bg-emerald-100', text: 'text-emerald-700' },
        closed:    { label: '종결', bg: 'bg-green-100',  text: 'text-green-700' },
        referred:  { label: '연계', bg: 'bg-indigo-100', text: 'text-indigo-600' },
    };

    function statusBadge(status) {
        const s = STATUS_MAP[status] || { label: status, bg: 'bg-slate-100', text: 'text-slate-600' };
        return `<span class="badge ${s.bg} ${s.text}">${s.label}</span>`;
    }

    function shortId(id) { return id ? id.slice(0, 8) : '-'; }

    // 한국어 날짜("2026. 2. 26. 오후 10:20:05")도 안전하게 파싱
    function safeParseDate(v) {
        if (!v) return null;
        if (v instanceof Date) return isNaN(v) ? null : v;
        // ISO 형식 우선 시도
        let d = new Date(v);
        if (!isNaN(d)) return d;
        // 한국어 로캘 형식: "2026. 2. 26. 오후 10:20:05"
        const m = String(v).match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.\s*(오전|오후)?\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
        if (m) {
            let [, yr, mo, dy, ampm, hr, mi, se] = m;
            hr = Number(hr); mo = Number(mo); dy = Number(dy); mi = Number(mi); se = Number(se || 0);
            if (ampm === '오후' && hr < 12) hr += 12;
            if (ampm === '오전' && hr === 12) hr = 0;
            d = new Date(Number(yr), mo - 1, dy, hr, mi, se);
            if (!isNaN(d)) return d;
        }
        return null;
    }

    function safeDateStr(v) {
        const d = safeParseDate(v);
        if (!d) return v || '-';
        return d.toLocaleString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }

    function safeElapsed(v) {
        const d = safeParseDate(v);
        if (!d) return { ms: 0, text: '-' };
        const ms = Date.now() - d.getTime();
        const days = Math.floor(ms / 86400000);
        const hours = Math.floor(ms / 3600000);
        return { ms, days, hours, text: days > 0 ? `${days}일 전` : `${hours}시간 전` };
    }

    function formatDate(r) {
        if (r.createdAtISO) {
            const d = new Date(r.createdAtISO);
            return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
        return r.createdAt || '-';
    }

    // ── Tab titles ──
    const TAB_TITLES = {
        dashboard: '현황판',
        requests: '상담 요청',
        analytics: '분석',
        collab: '연계 조정',
    };

    // ── Tab switching ──
    function switchTab(tab) {
        // Clean up detail view if active
        if (collabDetailActive) {
            hideCollabDetail();
        }

        currentTab = tab;
        // Sidebar nav active state
        document.querySelectorAll('.nav-item[id^="nav-"]').forEach(el => el.classList.remove('nav-active'));
        const navEl = document.getElementById('nav-' + tab);
        if (navEl) navEl.classList.add('nav-active');

        // Topbar title
        document.getElementById('topbar-title').textContent = TAB_TITLES[tab] || tab;

        // Toggle panels
        ['dashboard', 'requests', 'analytics', 'collab'].forEach(p => {
            const panel = document.getElementById('panel-' + p);
            if (p === tab) {
                panel.classList.remove('hidden');
                panel.classList.add('panel-content');
                // Re-trigger animation
                panel.style.animation = 'none';
                panel.offsetHeight; // reflow
                panel.style.animation = '';
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('panel-content');
            }
        });

        // Load data
        if (tab === 'dashboard') loadDashboard();
        else if (tab === 'requests') loadRequests();
        else if (tab === 'analytics') loadAnalytics();
        else if (tab === 'collab') loadCollabPanel();

        // Close sidebar on mobile
        closeSidebar();
    }

    // ── Sidebar toggle ──
    function toggleSidebar() {
        sidebarOpen ? closeSidebar() : openSidebar();
    }

    function openSidebar() {
        sidebarOpen = true;
        document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.add('active');
    }

    function closeSidebar() {
        if (window.innerWidth >= 1024) return; // Keep open on desktop
        sidebarOpen = false;
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.remove('active');
    }

    // ── Window resize handler ──
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('active');
            sidebarOpen = false;
        } else if (!sidebarOpen) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }
    });

    // ── API helpers ──
    async function api(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        return res.json();
    }

    // ── Dashboard ──
    // 부서 이름 매핑
    let deptMap = {};
    async function loadDeptMap() {
        try {
            const depts = await api('/api/departments');
            depts.forEach(d => { deptMap[d.id] = d.name; });
        } catch { /* ignore */ }
    }
    function getDeptName(id) { return deptMap[id] || id; }

    // 승인 상태 (부서→부서 직접 연계)
    const APPROVAL_STATUS_MAP = {
        pending:              { label: '승인대기',     bg: 'bg-yellow-100', text: 'text-yellow-700', step: 0 },
        dept_approved:        { label: '부서 승인',    bg: 'bg-blue-100',   text: 'text-blue-700',   step: 1 },
        approved:             { label: '승인완료',     bg: 'bg-green-100',  text: 'text-green-700',  step: 2 },
        rejected:             { label: '반려',         bg: 'bg-red-100',    text: 'text-red-600',    step: -1 },
        revision_requested:   { label: '수정요청',     bg: 'bg-orange-100', text: 'text-orange-600', step: -1 },
        target_rejected:      { label: '대상부서 반려', bg: 'bg-red-100',    text: 'text-red-600',    step: -1 },
        target_revision_requested: { label: '대상부서 수정요청', bg: 'bg-orange-100', text: 'text-orange-600', step: -1 },
        // 하위 호환 (기존 데이터)
        origin_approved:      { label: '소속부서 승인', bg: 'bg-sky-100',    text: 'text-sky-700',    step: 1 },
        target_approved:      { label: '대상부서 승인', bg: 'bg-blue-100',   text: 'text-blue-700',   step: 2 },
        redirected:           { label: '재배정',       bg: 'bg-purple-100', text: 'text-purple-600', step: 2 },
        admin_rejected:       { label: '관리자 반려',   bg: 'bg-red-100',    text: 'text-red-600',    step: -1 },
        admin_revision_requested: { label: '관리자 수정요청', bg: 'bg-orange-100', text: 'text-orange-600', step: -1 },
    };
    const COLLAB_STATUS_MAP = {
        requested: { label: '대기', bg: 'bg-yellow-100', text: 'text-yellow-700' },
        accepted:  { label: '승인', bg: 'bg-green-100', text: 'text-green-700' },
        completed: { label: '완료', bg: 'bg-green-100', text: 'text-green-700' },
        declined:  { label: '반려', bg: 'bg-red-100', text: 'text-red-600' },
    };
    // 자문(consultation)은 연계 파이프라인에서 분리 (설계문서 §14)
    const COLLAB_TYPE_MAP = {
        joint: '공동처리', transfer: '이관', service_referral: '서비스연계',
    };

    function renderCollabItem(c) {
        // 승인 상태 우선 표시
        const approvalSt = c.approvalStatus ? (APPROVAL_STATUS_MAP[c.approvalStatus] || APPROVAL_STATUS_MAP.pending) : null;
        const st = approvalSt || COLLAB_STATUS_MAP[c.status] || COLLAB_STATUS_MAP.requested;
        const typeName = COLLAB_TYPE_MAP[c.type] || '자문';
        const catLabel = c.category === 'referral' ? '서비스연계' : '부서협업';

        // 방향 표시
        let directionHtml = '';
        if (c.category === 'referral' && c.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(c.targetService)}</span>`;
        } else if (c.fromDept && c.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(c.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400 text-sm" aria-hidden="true">arrow_forward</span>
                <span class="font-semibold text-green-700">${getDeptName(c.toDept)}</span>`;
        }

        const bgColor = c.approvalStatus === 'pending' ? 'bg-yellow-50 hover:bg-yellow-100 border border-yellow-200'
            : c.approvalStatus === 'origin_approved' ? 'bg-sky-50 hover:bg-sky-100 border border-sky-200'
            : (c.approvalStatus === 'target_approved' || c.approvalStatus === 'dept_approved') ? 'bg-blue-50 hover:bg-blue-100 border border-blue-200'
            : (c.approvalStatus === 'rejected' || c.approvalStatus === 'admin_rejected') ? 'bg-red-50 hover:bg-red-100 border border-red-200'
            : c.approvalStatus === 'redirected' ? 'bg-purple-50 hover:bg-purple-100 border border-purple-200'
            : c.approvalStatus === 'revision_requested' || c.approvalStatus === 'admin_revision_requested' ? 'bg-orange-50 hover:bg-orange-100 border border-orange-200'
            : 'bg-slate-50 hover:bg-indigo-50';

        return `
        <div class="flex items-center gap-3 p-3 rounded-lg ${bgColor} transition-colors cursor-pointer" onclick="openDetail('${c.requestId}')">
            <div class="flex-shrink-0">
                <span class="badge ${st.bg} ${st.text}">${st.label}</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5 text-sm">
                    ${directionHtml}
                    <span class="text-xs text-slate-400 ml-1">(${typeName})</span>
                </div>
                <p class="text-xs text-slate-500 truncate mt-0.5">${c.userName || '-'} · ${c.serviceName || '-'} · ${c.reason || ''}</p>
            </div>
            <div class="text-xs text-slate-400 flex-shrink-0">${safeDateStr(c.createdAtISO || c.createdAt)}</div>
        </div>`;
    }

    // 2단계 승인 스테퍼 (부서→부서 직접 연계)
    function renderApprovalStepper(approvalStatus) {
        const steps = [
            { label: '소속부서', desc: '필요성 검증' },
            { label: '대상부서', desc: '수락 검증' },
        ];
        let stepIdx = 0;
        const statusStepMap = {
            pending: 0, revision_requested: 0,
            dept_approved: 1, target_rejected: 1, target_revision_requested: 1,
            approved: 2,
            // 하위 호환
            origin_approved: 1,
            target_approved: 2,
        };
        stepIdx = statusStepMap[approvalStatus] ?? 0;
        const isDone = approvalStatus === 'approved';
        const isRejected = approvalStatus === 'rejected' || approvalStatus === 'target_rejected';
        const isRevision = approvalStatus === 'target_revision_requested';

        let html = '<div class="flex items-center gap-1 mb-2">';
        steps.forEach((s, i) => {
            const done = isDone || i < stepIdx;
            const current = !isDone && !isRejected && !isRevision && i === stepIdx;
            let colorClass, labelClass;
            if (isRejected && i === stepIdx) {
                colorClass = 'bg-red-500 text-white';
                labelClass = 'font-bold text-red-600';
            } else if (isRevision && i === stepIdx) {
                colorClass = 'bg-orange-500 text-white ring-2 ring-orange-300';
                labelClass = 'font-bold text-orange-600';
            } else if (done) {
                colorClass = 'bg-green-500 text-white';
                labelClass = 'text-green-700';
            } else if (current) {
                colorClass = 'bg-blue-500 text-white ring-2 ring-blue-300';
                labelClass = 'font-bold text-blue-700';
            } else {
                colorClass = 'bg-slate-200 text-slate-400';
                labelClass = 'text-slate-400';
            }
            const lineColor = done ? 'bg-green-400' : 'bg-slate-200';
            html += `<div class="flex flex-col items-center" style="min-width:24px">
                <div class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${colorClass}">${i + 1}</div>
                <span class="text-[9px] mt-0.5 whitespace-nowrap ${labelClass}">${s.label}</span>
            </div>`;
            if (i < steps.length - 1) html += `<div class="flex-1 h-0.5 ${lineColor} -mt-3"></div>`;
        });
        html += '</div>';
        return html;
    }

    // 승인 대기 카드 (관리자 최종 승인/반려/부서변경/부서추가, target_approved 건 표시)
    function renderPendingItem(c) {
        const typeName = COLLAB_TYPE_MAP[c.type] || '자문';
        let directionHtml = '';
        if (c.category === 'referral' && c.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(c.targetService)}</span>`;
        } else if (c.fromDept && c.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(c.fromDept)}</span> → <span class="font-semibold text-green-700">${getDeptName(c.toDept)}</span>`;
        }

        return `
        <div class="p-4 rounded-lg border border-blue-200 bg-blue-50">
            <div class="flex items-center gap-2 mb-2">
                <span class="badge bg-blue-100 text-blue-700">대상부서 승인 완료</span>
                <span class="text-xs text-slate-500">${typeName}</span>
                <span class="text-xs text-slate-400 ml-auto">${safeDateStr(c.createdAtISO || c.createdAt)}</span>
            </div>
            ${renderApprovalStepper(c.approvalStatus)}
            <div class="text-sm mb-1">${directionHtml}</div>
            <p class="text-xs text-slate-600 mb-1">${c.userName || '-'} · ${c.serviceName || '-'}</p>
            <p class="text-sm text-slate-700 mb-3">${escapeHtml(c.reason || '')}</p>
            <div class="flex gap-2 items-center">
                <button onclick="approveLinkage('${c.id}',event)" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">check_circle</span>최종 승인
                </button>
                <button onclick="rejectLinkage('${c.id}',event)" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>
                <button onclick="revisionLinkage('${c.id}',event)" class="px-3 py-1.5 bg-white border border-orange-300 text-orange-600 rounded-lg text-xs font-semibold hover:bg-orange-50 transition-colors">수정요청</button>
                <div class="flex-1"></div>
                <button onclick="openDetail('${c.requestId}')" class="px-2 py-1.5 text-xs text-indigo-600 hover:text-indigo-800 font-semibold">상세</button>
            </div>
        </div>`;
    }

    function updateSidebarCollabBadge(pendingCount) {
        const badgeEl = document.getElementById('sidebar-collab-badge');
        if (pendingCount > 0) {
            badgeEl.style.display = '';
            badgeEl.textContent = pendingCount;
        } else {
            badgeEl.style.display = 'none';
        }
    }

    // ── 상태별 케이스 목록 토글 ──
    const statusRowCache = {};
    let activeStatusRow = null;
    const STATUS_COLORS = { open:'blue', confirmed:'amber', contacted:'purple', connected:'teal', providing:'emerald', closed:'green', referred:'indigo' };

    async function toggleStatusRow(status) {
        const panel = document.getElementById('stlist-panel');
        if (!panel) return;

        // 이전 활성 버튼 하이라이트 해제
        if (activeStatusRow) {
            const prevBtn = document.getElementById('stbtn-' + activeStatusRow);
            if (prevBtn) prevBtn.classList.remove('ring-2', 'ring-inset', 'ring-slate-300', 'bg-slate-50');
        }

        // 같은 상태 재클릭 → 닫기
        if (activeStatusRow === status) {
            panel.classList.add('hidden');
            activeStatusRow = null;
            return;
        }

        // 현재 버튼 하이라이트
        activeStatusRow = status;
        const btn = document.getElementById('stbtn-' + status);
        if (btn) btn.classList.add('ring-2', 'ring-inset', 'ring-slate-300', 'bg-slate-50');

        // 캐시 확인
        if (statusRowCache[status]) {
            panel.innerHTML = statusRowCache[status];
            panel.classList.remove('hidden');
            return;
        }

        panel.innerHTML = '<p class="text-xs text-slate-400 py-3 text-center">불러오는 중...</p>';
        panel.classList.remove('hidden');

        try {
            const data = await api(`/api/admin/requests?status=${status}&limit=50&sort=newest`);
            if (data.items.length === 0) {
                const html = '<p class="text-xs text-slate-400 py-3 text-center">해당 상태의 케이스가 없습니다.</p>';
                statusRowCache[status] = html;
                panel.innerHTML = html;
                return;
            }
            const html = data.items.map(r => {
                const date = formatDate(r);
                return `<div class="flex items-center gap-3 py-2 border-b border-slate-100 last:border-0 cursor-pointer hover:bg-white rounded px-2 transition-colors" onclick="openDetail('${r.id}')">
                    <span class="font-medium text-sm text-slate-700 min-w-[60px]">${escapeHtml(r.userName || '-')}</span>
                    <span class="text-xs text-slate-500 truncate flex-1">${escapeHtml(r.serviceName || '-')}</span>
                    <span class="text-[11px] text-slate-400 whitespace-nowrap">${date}</span>
                </div>`;
            }).join('');
            statusRowCache[status] = html;
            panel.innerHTML = html;
        } catch {
            panel.innerHTML = '<p class="text-xs text-red-400 py-3 text-center">불러오기 실패</p>';
        }
    }

    // 대시보드 새로고침 시 캐시 초기화
    function clearStatusRowCache() {
        Object.keys(statusRowCache).forEach(k => delete statusRowCache[k]);
        const panel = document.getElementById('stlist-panel');
        if (panel) panel.classList.add('hidden');
        if (activeStatusRow) {
            const btn = document.getElementById('stbtn-' + activeStatusRow);
            if (btn) btn.classList.remove('ring-2', 'ring-inset', 'ring-slate-300', 'bg-slate-50');
        }
        activeStatusRow = null;
    }

    async function loadDashboard() {
        clearStatusRowCache();
        try {
            const [stats, kpi, collabs, pendingData] = await Promise.all([
                api('/api/admin/stats'), api('/api/admin/kpi?days=7'),
                api('/api/admin/linkages'), api('/api/admin/pending-approvals'),
            ]);

            allCollabs = collabs;

            document.getElementById('kpi-total').textContent = stats.total;
            document.getElementById('kpi-today').textContent = stats.today;
            const activeCount = (stats.open || 0) + (stats.confirmed || 0) + (stats.contacted || 0) + (stats.connected || 0) + (stats.providing || 0);
            document.getElementById('kpi-active').textContent = activeCount;
            document.getElementById('kpi-avg-days').textContent = stats.avgDays ? stats.avgDays + '일' : '-';

            document.getElementById('st-open').textContent = stats.open;
            document.getElementById('st-confirmed').textContent = stats.confirmed;
            document.getElementById('st-contacted').textContent = stats.contacted;
            document.getElementById('st-connected').textContent = stats.connected;
            document.getElementById('st-providing').textContent = stats.providing || 0;
            document.getElementById('st-closed').textContent = stats.closed;
            document.getElementById('st-referred').textContent = stats.referred;

            // Daily chart
            const labels = Object.keys(stats.daily).map(d => d.slice(5)); // MM-DD
            const values = Object.values(stats.daily);
            renderBarChart('chart-daily', labels, values, '접수 건수', '#98002E');

            // Overdue list
            const overdueEl = document.getElementById('overdue-list');
            if (stats.overdue && stats.overdue.length > 0) {
                overdueEl.innerHTML = stats.overdue.map(r => {
                    const days = Math.floor((Date.now() - new Date(r.createdAtISO || 0).getTime()) / 86400000);
                    return `<div class="flex items-center justify-between p-2.5 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition-colors" onclick="openDetail('${r.id}')">
                        <div class="flex items-center gap-2">
                            ${statusBadge(r.status)}
                            <span class="font-medium text-slate-700">${escapeHtml(r.userName || '-')}</span>
                            <span class="text-slate-400 text-xs truncate max-w-[120px]">${escapeHtml(r.serviceName || '')}</span>
                        </div>
                        <span class="text-xs text-red-500 font-semibold whitespace-nowrap">${days}일 경과</span>
                    </div>`;
                }).join('');
            } else {
                overdueEl.innerHTML = '<p class="text-slate-400 text-sm py-4 text-center">연락 지연 알림 없음</p>';
            }

            // 연계 조정 현황 (dashboard: 최근 5건)
            const collabEl = document.getElementById('collab-dashboard-list');
            document.getElementById('collab-count').textContent = collabs.length;
            const pendingCount = pendingData.count || 0;
            updateSidebarCollabBadge(pendingCount);

            // 승인 대기 강조
            const pendingBadge = document.getElementById('pending-count-badge');
            if (pendingCount > 0) {
                pendingBadge.style.display = '';
                pendingBadge.textContent = '대기 ' + pendingCount;
            } else {
                pendingBadge.style.display = 'none';
            }

            if (collabs.length > 0) {
                const displayCollabs = collabs.slice(0, 5);
                collabEl.innerHTML = displayCollabs.map(c => renderCollabItem(c)).join('');
            } else {
                collabEl.innerHTML = '<p class="text-slate-400 text-sm py-4 text-center">연계 요청 없음</p>';
            }

            // System KPI
            const kpiEl = document.getElementById('system-kpi');
            kpiEl.innerHTML = `
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-primary">${kpi.ragMatchRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">RAG 매칭률</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-green-600">${kpi.conversionRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">신청 전환율</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-blue-500">${kpi.voiceRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">음성 비율</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-purple-500">${kpi.ttsRate}%</p>
                    <p class="text-xs text-slate-500 mt-1">TTS 비율</p>
                </div>
                <div class="text-center p-3 rounded-lg bg-slate-50">
                    <p class="text-2xl font-bold text-slate-700">${kpi.chatRequest}</p>
                    <p class="text-xs text-slate-500 mt-1">총 채팅 수</p>
                </div>
            `;
        } catch (e) {
            console.error('Dashboard load error:', e);
        }
    }

    // ── Linkage Coordination Panel (Kanban) ──
    let collabSearchTimer = null;
    let expandedCardData = {};
    let collabViewMode = 'kanban'; // 'kanban' or 'table'
    let tableSortKey = 'date';
    let tableSortAsc = false;

    function debounceCollabSearch() {
        clearTimeout(collabSearchTimer);
        collabSearchTimer = setTimeout(() => renderKanbanBoard(allCollabs), 300);
    }
    function applyCollabFilter() { renderKanbanBoard(allCollabs); }

    function filterCollabs(collabs) {
        const cat = document.getElementById('collab-filter-cat')?.value || 'all';
        const search = (document.getElementById('collab-search')?.value || '').trim().toLowerCase();
        return collabs.filter(c => {
            if (cat === 'referral' && c.category !== 'referral') return false;
            if (cat === 'dept' && c.category === 'referral') return false;
            if (search) {
                const haystack = [c.userName, c.serviceName, c.targetService, c.reason,
                    getDeptName(c.fromDept), getDeptName(c.toDept)].filter(Boolean).join(' ').toLowerCase();
                if (!haystack.includes(search)) return false;
            }
            return true;
        });
    }

    // 칸반 4열 분류 (부서→부서 직접 연계)
    function classifyCollabs(collabs) {
        const cols = { dept_review: [], target_accept: [], in_progress: [], done_rejected: [] };
        collabs.forEach(c => {
            const as = c.approvalStatus || 'pending';
            // Col 1: 소속부서 검토 (pending, revision_requested)
            if (as === 'pending' || as === 'revision_requested') cols.dept_review.push(c);
            // Col 2: 대상부서 수락 대기 (dept_approved, target_revision_requested, target_rejected → 재제출 대기)
            else if (as === 'dept_approved' || as === 'target_rejected' || as === 'target_revision_requested') cols.target_accept.push(c);
            // Col 3: 진행중 (approved)
            else if (as === 'approved') cols.in_progress.push(c);
            // Col 4: 완료/반려
            else if (as === 'rejected') cols.done_rejected.push(c);
            else cols.dept_review.push(c);
        });
        return cols;
    }

    function scrollToKanbanCol(colId) {
        const el = document.getElementById(colId);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
    }

    function renderKanbanCard(c, isActionable) {
        const approvalSt = c.approvalStatus ? (APPROVAL_STATUS_MAP[c.approvalStatus] || APPROVAL_STATUS_MAP.pending) : APPROVAL_STATUS_MAP.pending;

        let directionHtml = '';
        if (c.category === 'referral' && c.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700 text-xs truncate">${escapeHtml(c.targetService)}</span>`;
        } else if (c.fromDept && c.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700 text-xs">${getDeptName(c.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" aria-hidden="true" style="font-size:12px">arrow_forward</span>
                <span class="font-semibold text-green-700 text-xs">${getDeptName(c.toDept)}</span>`;
        }

        const dateStr = safeDateStr(c.createdAtISO || c.createdAt);
        const isBulkSelected = bulkSelected.has(c.id);

        // Elapsed time
        const elapsed = safeElapsed(c.createdAtISO || c.createdAt);
        const elapsedText = elapsed.text;
        const isOverdue = elapsed.hours >= 24 && c.approvalStatus !== 'approved';
        const elapsedClass = isOverdue ? 'overdue' : 'normal';

        // Next action label (부서→부서 직접 연계)
        let actionLabel = '';
        const actionLabelMap = {
            pending: '소속부서 검토 대기',
            dept_approved: '대상부서 수락 대기',
            revision_requested: '수정 후 재제출 대기',
            target_rejected: '대상부서 반려 — 재제출 필요',
            target_revision_requested: '대상부서 수정요청 — 재제출 필요',
        };
        actionLabel = actionLabelMap[c.approvalStatus] || '';
        // 부서 조정자: 내 검토/수락 강조
        if (sessionRole === 'dept') {
            if (c.approvalStatus === 'pending' && c.fromDept === sessionDeptId) {
                actionLabel = '내 검토 필요';
            } else if (c.approvalStatus === 'dept_approved' && c.toDept === sessionDeptId) {
                actionLabel = '내 수락 필요';
            } else if ((c.approvalStatus === 'target_rejected' || c.approvalStatus === 'target_revision_requested') && c.fromDept === sessionDeptId) {
                actionLabel = '내 재제출 필요';
            }
        }

        // AI summary preview (from cache only, no extra API call)
        const cached = expandedCardData[c.id];
        let aiPreview = '';
        if (cached && cached.conversationSummary) {
            aiPreview = cached.conversationSummary.slice(0, 30) + (cached.conversationSummary.length > 30 ? '...' : '');
        }

        return `
        <div id="kcard-${c.id}" class="kanban-card ${isBulkSelected ? 'bulk-selected' : ''}" draggable="true" ondragstart="onDragStart(event, '${c.id}')" ondragend="onDragEnd(event)" onclick="openKanbanModal('${c.id}', event)">
            <div class="card-summary">
                <div class="flex items-center gap-1.5">
                    <input type="checkbox" class="bulk-checkbox rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 w-3.5 h-3.5 flex-shrink-0" ${isBulkSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleBulkSelect('${c.id}', this.checked)" />
                    <span class="badge ${approvalSt.bg} ${approvalSt.text}" style="font-size:10px;padding:1px 6px">${approvalSt.label}</span>
                    <span class="flex-1 min-w-0 flex items-center gap-1 truncate">${directionHtml || `<span class="text-xs text-slate-500 truncate">${escapeHtml(c.userName || '-')}</span>`}</span>
                    <span class="card-elapsed ${elapsedClass}">${elapsedText}</span>
                </div>
                ${actionLabel ? `<div class="card-action-label"><span class="material-symbols-outlined" style="font-size:12px" aria-hidden="true">arrow_forward</span>${actionLabel}</div>` : ''}
                ${aiPreview ? `<div class="card-ai-preview" title="${escapeHtml(cached.conversationSummary)}"><span class="material-symbols-outlined" style="font-size:11px;vertical-align:middle" aria-hidden="true">smart_toy</span> ${escapeHtml(aiPreview)}</div>` : ''}
            </div>
        </div>`;
    }

    function renderKanbanColumn(bodyId, items, isActionable) {
        const el = document.getElementById(bodyId);
        if (!el) return;
        if (items.length === 0) {
            el.innerHTML = '<p class="text-slate-400 text-xs text-center py-6">항목 없음</p>';
            return;
        }
        el.innerHTML = items.map(c => renderKanbanCard(c, isActionable)).join('');
    }

    // ── Kanban Detail Modal ──
    let kanbanModalOpen = false;
    let kanbanModalLinkageId = null;

    async function openKanbanModal(linkageId, event) {
        if (event) event.stopPropagation();
        if (event && event.target.closest('.bulk-checkbox')) return;

        // Route to in-panel detail view instead of modal
        showCollabDetail(linkageId);
    }

    // ── In-Panel Detail View ──
    async function showCollabDetail(linkageId) {
        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;

        collabDetailActive = true;
        collabDetailLinkageId = linkageId;
        // Hide kanban, filter, stats, table, bulk bar
        const hideEls = ['collab-kanban', 'collab-table-view'];
        hideEls.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
        // Hide filter toolbar and stats ribbon (first two direct children card-elevated + grid)
        const panelCollab = document.getElementById('panel-collab');
        const filterBar = panelCollab.querySelector('.card-elevated');
        const statsRibbon = panelCollab.querySelector('.grid.grid-cols-2');
        const bulkBar = document.getElementById('bulk-bar');
        if (filterBar) filterBar.style.display = 'none';
        if (statsRibbon) statsRibbon.style.display = 'none';
        if (bulkBar) bulkBar.style.display = 'none';

        // Show detail view
        const detailView = document.getElementById('collab-detail-view');
        detailView.style.display = '';
        detailView.style.animation = 'none';
        detailView.offsetHeight;
        detailView.style.animation = '';

        // Show loading state
        document.getElementById('collab-detail-unified').innerHTML = '<p class="text-slate-400 text-sm text-center py-8">로딩 중...</p>';

        // Render header and summary immediately with collab data
        renderDetailHeader(collab);
        renderDetailSummary(collab);

        // Fetch request data if needed
        if (collab.requestId && !expandedCardData[linkageId]) {
            try {
                const data = await api(`/api/admin/requests/${collab.requestId}`);
                expandedCardData[linkageId] = data;
            } catch (e) {
                expandedCardData[linkageId] = { error: true };
            }
        }

        // Render both columns
        renderDetailColumns();
    }

    function hideCollabDetail() {
        collabDetailActive = false;
        collabDetailLinkageId = null;

        // Hide detail view
        document.getElementById('collab-detail-view').style.display = 'none';

        // Restore kanban/table/filter/stats
        const panelCollab = document.getElementById('panel-collab');
        const filterBar = panelCollab.querySelector('.card-elevated');
        const statsRibbon = panelCollab.querySelector('.grid.grid-cols-2');
        if (filterBar) filterBar.style.display = '';
        if (statsRibbon) statsRibbon.style.display = '';

        // Show correct view mode
        if (collabViewMode === 'kanban') {
            document.getElementById('collab-kanban').style.display = '';
            document.getElementById('collab-table-view').style.display = 'none';
        } else {
            document.getElementById('collab-kanban').style.display = 'none';
            document.getElementById('collab-table-view').style.display = '';
        }

        // Re-render board to pick up any changes
        renderKanbanBoard(allCollabs);
    }

    // ── Detail View Renderers ──
    function renderDetailHeader(collab) {
        let actionBtns = '';

        // 1) 소속부서 검토 (pending)
        const canReviewAsDept = collab.approvalStatus === 'pending'
            && (sessionRole === 'admin' || (sessionRole === 'dept' && collab.fromDept === sessionDeptId));
        if (canReviewAsDept) {
            actionBtns = `
                <button onclick="toggleDetailComment('dept_approve')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">check_circle</span>승인
                </button>
                <button onclick="toggleDetailComment('dept_reject')" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>
                <button onclick="toggleDetailComment('dept_revision')" class="px-3 py-1.5 bg-white border border-orange-300 text-orange-600 rounded-lg text-xs font-semibold hover:bg-orange-50 transition-colors">수정요청</button>`;
        }

        // 2) 대상부서 수락 (dept_approved)
        const canReviewAsTarget = collab.approvalStatus === 'dept_approved'
            && (sessionRole === 'admin' || (sessionRole === 'dept' && collab.toDept === sessionDeptId));
        if (canReviewAsTarget) {
            actionBtns = `
                <button onclick="toggleDetailComment('target_accept')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">check_circle</span>수락
                </button>
                <button onclick="toggleDetailComment('target_reject')" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>
                <button onclick="toggleDetailComment('target_revision')" class="px-3 py-1.5 bg-white border border-orange-300 text-orange-600 rounded-lg text-xs font-semibold hover:bg-orange-50 transition-colors">수정요청</button>`;
        }

        // 3) 대상부서 반환 → 소속부서 재제출 (target_rejected / target_revision_requested)
        const canResubmitToTarget = (collab.approvalStatus === 'target_rejected' || collab.approvalStatus === 'target_revision_requested')
            && (sessionRole === 'admin' || (sessionRole === 'dept' && collab.fromDept === sessionDeptId));
        if (canResubmitToTarget) {
            actionBtns = `
                <button onclick="toggleDetailComment('resubmit_to_target')" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">send</span>재제출
                </button>
                <button onclick="toggleDetailComment('dept_reject')" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>`;
        }

        // 4) 관리자 최종 승인 (target_approved)
        const isAdminFinal = sessionRole === 'admin' && collab.approvalStatus === 'target_approved';
        if (isAdminFinal) {
            actionBtns = `
                <button onclick="toggleDetailComment('approve')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">check_circle</span>최종승인
                </button>
                <button onclick="toggleDetailComment('reject')" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>
                <button onclick="toggleDetailComment('redirect')" class="px-3 py-1.5 bg-white border border-purple-300 text-purple-600 rounded-lg text-xs font-semibold hover:bg-purple-50 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">swap_horiz</span>부서변경
                </button>
                <button onclick="toggleDetailComment('add_dept')" class="px-3 py-1.5 bg-white border border-indigo-300 text-indigo-600 rounded-lg text-xs font-semibold hover:bg-indigo-50 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">group_add</span>부서추가
                </button>`;
        }

        document.getElementById('collab-detail-header').innerHTML = `
            <div class="collab-detail-sticky-header">
                <button onclick="hideCollabDetail()" class="flex items-center gap-1 text-sm text-slate-600 hover:text-slate-800 font-semibold flex-shrink-0">
                    <span class="material-symbols-outlined text-lg" aria-hidden="true">arrow_back</span>
                    연계조정 목록
                </button>
                <div class="flex items-center gap-2 ml-auto flex-wrap">
                    ${actionBtns}
                </div>
            </div>
            <div id="collab-detail-comment-area" class="collab-detail-comment-slide">
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <p id="detail-comment-label" class="text-xs font-semibold text-slate-500 mb-2">코멘트</p>
                    <div id="detail-dept-select-area" style="display:none" class="mb-2">
                        <label class="text-xs text-slate-500 mb-1 block">대상 부서 선택</label>
                        <select id="detail-dept-select" class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary"></select>
                    </div>
                    <textarea id="detail-comment-input" rows="2" placeholder="코멘트 입력..." class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 mb-2 focus:ring-primary focus:border-primary resize-none"></textarea>
                    <div class="flex gap-2">
                        <button id="detail-comment-submit" onclick="submitDetailAction()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-primary-light transition-colors">확인</button>
                        <button onclick="toggleDetailComment(null)" class="px-3 py-2 text-sm text-slate-500 hover:text-slate-700">취소</button>
                    </div>
                </div>
            </div>`;
    }

    function renderDetailSummary(collab) {
        const approvalSt = collab.approvalStatus ? (APPROVAL_STATUS_MAP[collab.approvalStatus] || APPROVAL_STATUS_MAP.pending) : APPROVAL_STATUS_MAP.pending;
        const elapsed = safeElapsed(collab.createdAtISO || collab.createdAt);
        const elapsedText = `접수 ${elapsed.text}`;

        // 소속부서(originDept/fromDept) → 대상부서(targetDept/toDept) (설계문서 §11)
        const originDept = collab.originDept || collab.fromDept;
        const targetDept = collab.targetDept || collab.toDept;
        let directionHtml = '';
        if (collab.category === 'referral' && collab.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(collab.targetService)}</span>`;
        } else if (originDept && targetDept) {
            directionHtml = `<span class="text-xs text-slate-400">소속</span>
                <span class="font-semibold text-indigo-700">${getDeptName(originDept)}</span>
                <span class="material-symbols-outlined text-slate-400" aria-hidden="true" style="font-size:14px">arrow_forward</span>
                <span class="text-xs text-slate-400">대상</span>
                <span class="font-semibold text-green-700">${getDeptName(targetDept)}</span>`;
        } else if (collab.fromDept && collab.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(collab.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" aria-hidden="true" style="font-size:14px">arrow_forward</span>
                <span class="font-semibold text-green-700">${getDeptName(collab.toDept)}</span>`;
        }

        const typeName = COLLAB_TYPE_MAP[collab.type] || collab.type || '-';
        const dateStr = safeDateStr(collab.createdAtISO || collab.createdAt);

        // 실행상태 배지 (approved 건)
        const EXEC_BADGE = {
            in_progress: { label: '진행중', bg: 'bg-blue-100', text: 'text-blue-700', icon: 'sync' },
            completed: { label: '완료', bg: 'bg-green-100', text: 'text-green-700', icon: 'check_circle' },
            completed_with_followup: { label: '완료+후속', bg: 'bg-teal-100', text: 'text-teal-700', icon: 'check_circle' },
            on_hold: { label: '보류', bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'pause_circle' },
            cancelled: { label: '취소', bg: 'bg-red-100', text: 'text-red-600', icon: 'cancel' },
        };
        const execInfo = collab.executionStatus ? EXEC_BADGE[collab.executionStatus] : null;
        const execBadgeHtml = collab.approvalStatus === 'approved'
            ? (execInfo
                ? `<span class="badge ${execInfo.bg} ${execInfo.text} flex items-center gap-0.5"><span class="material-symbols-outlined" style="font-size:11px" aria-hidden="true">${execInfo.icon}</span>${execInfo.label}</span>`
                : `<span class="badge bg-slate-100 text-slate-500 flex items-center gap-0.5"><span class="material-symbols-outlined" style="font-size:11px" aria-hidden="true">hourglass_empty</span>미착수</span>`)
            : '';

        // 재배정 이력 표시 (설계문서 §4-1)
        let redirectHtml = '';
        if (collab.redirectHistory && collab.redirectHistory.length > 0) {
            redirectHtml = `<div class="mt-2 p-2 bg-purple-50 border border-purple-100 rounded-lg text-xs">
                <span class="font-semibold text-purple-700">재배정 이력:</span>
                ${collab.redirectHistory.map(r => `<span class="text-slate-600 ml-1">${getDeptName(r.fromDept)} → ${getDeptName(r.toDept)} (${escapeHtml(r.reason || '')})</span>`).join(', ')}
            </div>`;
        }

        document.getElementById('collab-detail-summary').innerHTML = `
            <div class="collab-detail-summary-card" style="max-width:720px;margin:0 auto">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                    <span class="text-sm font-bold text-slate-800">${escapeHtml(collab.userName || '-')}</span>
                    <span class="text-sm text-slate-500">·</span>
                    <span class="text-sm text-slate-600">${escapeHtml(collab.serviceName || '-')}</span>
                    <span class="badge bg-slate-100 text-slate-600" style="font-size:10px">${typeName}</span>
                    <span class="text-xs text-slate-400 ml-auto">${dateStr} · ${elapsedText}</span>
                </div>
                <div class="flex items-center gap-2 mb-3 flex-wrap">
                    <span class="badge ${approvalSt.bg} ${approvalSt.text}">${approvalSt.label}</span>
                    ${execBadgeHtml}
                    ${directionHtml ? `<div class="flex items-center gap-1.5 text-sm">${directionHtml}</div>` : ''}
                </div>
                ${renderApprovalStepper(collab.approvalStatus)}
                ${redirectHtml}
            </div>`;
    }

    // ── Detail Content (통합 뷰) ──
    function renderDetailColumns() {
        const linkageId = collabDetailLinkageId;
        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;
        const ed = expandedCardData[linkageId];

        let html = '';

        // AI 상담 요약 (상단)
        if (ed && !ed.error && ed.conversationSummary) {
            html += `<div class="mb-4">
                <div class="p-4 bg-purple-50 border border-purple-100 rounded-xl">
                    <div class="flex items-center gap-1.5 mb-2">
                        <span class="material-symbols-outlined text-sm text-purple-500" aria-hidden="true">smart_toy</span>
                        <span class="text-xs font-bold text-purple-600">AI 상담 요약</span>
                    </div>
                    <p class="text-sm text-slate-700 whitespace-pre-line leading-relaxed">${escapeHtml(ed.conversationSummary)}</p>
                </div>
            </div>`;
        }

        // 상담 처리 (케이스 스테퍼 + 상태 버튼 + 서비스 계획/메모)
        html += renderCaseTab(collab, ed);

        // 연계 흐름도 + 이력 (통합)
        html += renderLinkageTab(collab, ed);

        document.getElementById('collab-detail-unified').innerHTML = html;
    }

    // ── 승인상태 → 서비스상태 최대치 매핑 ──
    function getMaxCaseStatus(approvalStatus) {
        const CASE_STEPS = ['open', 'confirmed', 'contacted', 'connected', 'providing', 'closed'];
        if (approvalStatus === 'approved') return CASE_STEPS.length - 1; // 제한 없음
        if (approvalStatus === 'dept_approved') return CASE_STEPS.indexOf('connected'); // 연결까지
        return CASE_STEPS.indexOf('contacted'); // 그 외(pending 등) → 연락까지
    }

    // ── 상담 처리 (통합 뷰 내부) ──
    function renderCaseTab(collab, ed) {
        if (!ed) return '';
        if (ed.error) return '';

        const maxIdx = getMaxCaseStatus(collab.approvalStatus);

        let html = '';

        // ① 케이스 스테퍼 — 컴팩트 (승인상태 기반 상한 적용)
        html += renderCaseStatusStepperCompact(ed, maxIdx);

        // ② 상태 변경 버튼 (승인상태 초과 시 비활성화)
        const CASE_STEPS_ORDER = ['open', 'confirmed', 'contacted', 'connected', 'providing', 'closed'];
        html += `<div class="flex items-center gap-1.5 flex-wrap mb-3">
            <span class="text-[10px] text-slate-400 font-semibold mr-1">상태:</span>
            ${Object.entries(STATUS_MAP).map(([key, val]) => {
                const stepIdx = CASE_STEPS_ORDER.indexOf(key);
                const isLocked = stepIdx >= 0 && stepIdx > maxIdx;
                const isCurrent = ed.status === key;
                if (isLocked) {
                    return `<button disabled class="px-2 py-1 rounded text-[11px] font-medium border bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed" title="승인 완료 후 사용 가능">
                        ${val.label}
                    </button>`;
                }
                return `<button onclick="changeCaseStatusFromDetail('${ed.id}', '${key}')" class="px-2 py-1 rounded text-[11px] font-medium border transition-colors ${isCurrent ? val.bg + ' ' + val.text + ' border-current' : 'bg-white border-slate-200 text-slate-400 hover:border-slate-400 hover:text-slate-600'}">
                    ${val.label}
                </button>`;
            }).join('')}
        </div>`;

        // ③ 서비스 계획 + 메모 — 2열 그리드
        const steps = (ed.servicePlan && ed.servicePlan.steps) || [];
        const caseNotes = ed.notes || [];

        html += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">`;

        // 서비스 계획 (좌)
        html += `<div class="bg-slate-50 rounded-lg p-3">
            <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex items-center gap-1">
                <span class="material-symbols-outlined" style="font-size:13px" aria-hidden="true">route</span>서비스 계획
            </h4>
            ${steps.length > 0 ? `<div class="space-y-1">${steps.map((s, i) => `
                <div class="flex items-center gap-1.5 text-[12px]">
                    <span class="text-slate-400 font-bold">${i + 1}.</span>
                    <span class="text-slate-700 truncate flex-1">${escapeHtml(s.serviceName)}</span>
                    <span class="text-[10px] px-1.5 py-0.5 rounded ${s.status === 'completed' ? 'bg-green-100 text-green-700' : s.status === 'in_progress' ? 'bg-blue-100 text-blue-600' : 'bg-slate-200 text-slate-500'}">${s.status === 'completed' ? '완료' : s.status === 'in_progress' ? '진행' : '대기'}</span>
                </div>
            `).join('')}</div>` : '<p class="text-[11px] text-slate-400">없음</p>'}
            <div class="flex gap-1.5 mt-2">
                <input id="case-sp-input-${ed.id}" type="text" placeholder="추가..." class="flex-1 rounded border-slate-300 text-[11px] py-1 px-2 focus:ring-primary focus:border-primary" />
                <button onclick="addServicePlanFromDetail('${ed.id}')" class="px-2 py-1 bg-primary text-white rounded text-[11px] font-semibold hover:bg-primary-light">+</button>
            </div>
        </div>`;

        // 메모 (우)
        html += `<div class="bg-slate-50 rounded-lg p-3">
            <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex items-center gap-1">
                <span class="material-symbols-outlined" style="font-size:13px" aria-hidden="true">sticky_note_2</span>메모 (${caseNotes.length})
            </h4>
            <div class="space-y-1.5 max-h-[120px] overflow-y-auto mb-2">
                ${caseNotes.length > 0 ? caseNotes.slice(-3).map(n => {
                    const isSelf = (n.author || '') !== '담당자';
                    return `<div class="text-[12px]">
                        <span class="font-semibold ${isSelf ? 'text-amber-600' : 'text-green-600'}">${escapeHtml(n.author || '관리자')}</span>
                        <span class="text-slate-500 ml-1">${escapeHtml(n.text)}</span>
                        <span class="text-[9px] text-slate-300 ml-1">${safeDateStr(n.createdAt)}</span>
                    </div>`;
                }).join('') : '<p class="text-[11px] text-slate-400">없음</p>'}
                ${caseNotes.length > 3 ? `<p class="text-[10px] text-slate-400 text-center">... 외 ${caseNotes.length - 3}건</p>` : ''}
            </div>
            <div class="flex gap-1.5">
                <input id="case-note-input-${ed.id}" type="text" placeholder="메모..." class="flex-1 rounded border-slate-300 text-[11px] py-1 px-2 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addCaseNoteFromDetail('${ed.id}')" />
                <button onclick="addCaseNoteFromDetail('${ed.id}')" class="px-2 py-1 bg-indigo-600 text-white rounded text-[11px] font-semibold hover:bg-indigo-700">+</button>
            </div>
        </div>`;

        html += `</div>`;
        html += `<div class="mb-4"></div>`;

        return html;
    }

    // 컴팩트 케이스 스테퍼 (maxIdx: 승인상태 기반 상한)
    function renderCaseStatusStepperCompact(data, maxIdx) {
        const CASE_STEPS = ['open', 'confirmed', 'contacted', 'connected', 'providing', 'closed'];
        const CASE_STEP_LABELS = { open: '접수', confirmed: '확인', contacted: '연락', connected: '연결', providing: '제공중', closed: '종결' };
        const rawIdx = Math.max(0, CASE_STEPS.indexOf(data.status || 'open'));
        const cappedMax = (maxIdx !== undefined) ? maxIdx : CASE_STEPS.length - 1;
        const currentIdx = Math.min(rawIdx, cappedMax);

        let html = '<div class="flex items-center gap-0 mb-3">';
        CASE_STEPS.forEach((step, i) => {
            const isLocked = i > cappedMax;
            const done = i < currentIdx;
            const current = i === currentIdx;
            let dotColor, icon;
            if (isLocked) {
                dotColor = 'bg-slate-50 text-slate-200 border border-dashed border-slate-200';
                icon = 'lock';
            } else if (done) {
                dotColor = 'bg-green-500 text-white';
                icon = 'check';
            } else if (current) {
                dotColor = 'bg-green-100 text-green-800 ring-2 ring-green-400';
                icon = 'radio_button_checked';
            } else {
                dotColor = 'bg-slate-100 text-slate-400';
                icon = 'radio_button_unchecked';
            }
            html += `<div class="flex flex-col items-center" style="min-width:36px">
                <div class="w-6 h-6 rounded-full flex items-center justify-center ${dotColor}">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">${icon}</span>
                </div>
                <span class="text-[9px] mt-0.5 ${isLocked ? 'text-slate-200' : current ? 'font-bold text-green-800' : done ? 'text-green-600' : 'text-slate-400'}">${CASE_STEP_LABELS[step]}</span>
            </div>`;
            if (i < CASE_STEPS.length - 1) {
                const lineColor = isLocked || i >= cappedMax ? 'bg-slate-100' : i < currentIdx ? 'bg-green-400' : 'bg-slate-200';
                html += `<div class="flex-1 h-0.5 ${lineColor} -mt-3"></div>`;
            }
        });
        html += '</div>';
        return html;
    }

    // Case tab action helpers
    async function changeCaseStatusFromDetail(requestId, status) {
        // 승인상태 기반 상한 검증
        const collab = collabDetailLinkageId ? allCollabs.find(c => c.id === collabDetailLinkageId) : null;
        if (collab) {
            const STEPS = ['open', 'confirmed', 'contacted', 'connected', 'providing', 'closed'];
            const maxIdx = getMaxCaseStatus(collab.approvalStatus);
            const targetIdx = STEPS.indexOf(status);
            if (targetIdx > maxIdx) {
                const approvalLabel = collab.approvalStatus === 'dept_approved' ? '부서 승인' : '최종 승인';
                alert(`${approvalLabel} 완료 후 "${STATUS_MAP[status]?.label || status}" 단계로 변경할 수 있습니다.`);
                return;
            }
        }
        try {
            await fetch(`/api/admin/requests/${requestId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }),
            });
            // Reload data and re-render
            const data = await api(`/api/admin/requests/${requestId}`);
            const linkageId = collabDetailLinkageId;
            if (linkageId) expandedCardData[linkageId] = data;
            renderDetailColumns();
        } catch (e) {
            alert('상태 변경 실패');
        }
    }

    async function addCaseNoteFromDetail(requestId) {
        const input = document.getElementById('case-note-input-' + requestId);
        const noteText = input?.value.trim();
        if (!noteText) return;
        try {
            await fetch(`/api/admin/requests/${requestId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note: noteText }),
            });
            const data = await api(`/api/admin/requests/${requestId}`);
            const linkageId = collabDetailLinkageId;
            if (linkageId) expandedCardData[linkageId] = data;
            renderDetailColumns();
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    async function addServicePlanFromDetail(requestId) {
        const input = document.getElementById('case-sp-input-' + requestId);
        const serviceName = input?.value.trim();
        if (!serviceName) return;
        try {
            const data = await api(`/api/admin/requests/${requestId}`);
            const existingSteps = (data.servicePlan && data.servicePlan.steps) ? data.servicePlan.steps : [];
            existingSteps.push({ order: existingSteps.length + 1, serviceName, status: 'pending' });
            await fetch(`/api/case/${requestId}/service-plan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: existingSteps }),
            });
            const updated = await api(`/api/admin/requests/${requestId}`);
            const linkageId = collabDetailLinkageId;
            if (linkageId) expandedCardData[linkageId] = updated;
            renderDetailColumns();
        } catch (e) {
            alert('서비스 계획 저장 실패');
        }
    }

    // ── 연계 이력 — 도식화 시각화 ──
    const LF_EXEC = {
        not_started: { label: '미착수', icon: 'hourglass_empty', color: '#64748B', bg: '#F1F5F9' },
        in_progress: { label: '진행중', icon: 'sync', color: '#2563EB', bg: '#DBEAFE' },
        completed: { label: '완료', icon: 'check_circle', color: '#16A34A', bg: '#DCFCE7' },
        completed_with_followup: { label: '완료+후속', icon: 'check_circle', color: '#0D9488', bg: '#CCFBF1' },
        on_hold: { label: '보류', icon: 'pause_circle', color: '#CA8A04', bg: '#FEF9C3' },
        cancelled: { label: '취소', icon: 'cancel', color: '#DC2626', bg: '#FEE2E2' },
    };

    function lfDeptLabel(collab, ed, side) {
        if (side === 'origin') {
            if (collab.fromDept) return getDeptName(collab.fromDept);
            if (collab.originDept) return getDeptName(collab.originDept);
            return ed?.serviceName || collab.serviceName || '요청 부서';
        }
        if (collab.toDept) return getDeptName(collab.toDept);
        if (collab.targetDept) return getDeptName(collab.targetDept);
        if (collab.targetService) return collab.targetService;
        return '대상 부서';
    }

    // 부서 목록 (허브-스포크 시각화용) — deptMap에서 동적으로 가져오되 폴백 하드코딩
    const HUB_DEPT_ICONS = {
        care: 'favorite', emergency: 'emergency', facility: 'account_balance',
        casemanage: 'folder_shared', private: 'handshake',
    };
    const HUB_DEPT_FALLBACK = [
        { id: 'care', name: '통합돌봄팀' }, { id: 'emergency', name: '긴급지원팀' },
        { id: 'facility', name: '시설운영팀' }, { id: 'casemanage', name: '사례관리팀' },
        { id: 'private', name: '민간협력팀' },
    ];

    function getHubDeptList() {
        const entries = Object.entries(deptMap);
        if (entries.length > 0) return entries.map(([id, name]) => ({ id, name }));
        return HUB_DEPT_FALLBACK;
    }

    function renderLinkageTab(collab, ed) {
        let html = '';

        // ── ① 허브-스포크 연계 흐름도 ──
        const allPersonLinkages = allCollabs.filter(l => l.userName && l.userName === collab.userName);
        const sortedLinkages = [collab, ...allPersonLinkages.filter(l => l.id !== collab.id)];
        const totalCount = sortedLinkages.length;

        // 요청 부서 이름 (첫 번째 연계 기준)
        const originName = lfDeptLabel(collab, ed, 'origin');

        // 승인상태 → 배지 매핑 (approved가 아닐 때 실행상태 대신 표시)
        const APPROVAL_BADGE = {
            pending:              { label: '승인대기', icon: 'hourglass_empty', color: '#A16207', bg: '#FEF9C3' },
            rejected:             { label: '반려',     icon: 'cancel',          color: '#DC2626', bg: '#FEE2E2' },
            revision_requested:   { label: '수정요청', icon: 'refresh',         color: '#EA580C', bg: '#FFF7ED' },
            admin_rejected:       { label: '관리자반려', icon: 'cancel',        color: '#DC2626', bg: '#FEE2E2' },
            admin_revision_requested: { label: '관리자수정요청', icon: 'refresh', color: '#EA580C', bg: '#FFF7ED' },
            dept_approved:        { label: '부서승인', icon: 'check_circle',    color: '#2563EB', bg: '#DBEAFE' },
            origin_approved:      { label: '1차승인', icon: 'check_circle',    color: '#0284C7', bg: '#E0F2FE' },
            target_approved:      { label: '2차승인', icon: 'check_circle',    color: '#2563EB', bg: '#DBEAFE' },
        };

        // 대상 부서 정보 수집: { deptId → [{ linkage, typeName, exec }] }
        const targetMap = new Map();
        sortedLinkages.forEach(l => {
            const deptId = l.toDept || l.targetDept || l.targetService || null;
            if (!deptId) return;
            if (!targetMap.has(deptId)) targetMap.set(deptId, []);
            // approved면 실행상태, 아니면 승인상태 배지 표시
            const isApproved = l.approvalStatus === 'approved';
            const badge = isApproved
                ? (LF_EXEC[l.executionStatus] || LF_EXEC.not_started)
                : (APPROVAL_BADGE[l.approvalStatus] || APPROVAL_BADGE.pending);
            targetMap.set(deptId, [...targetMap.get(deptId), {
                linkage: l,
                typeName: COLLAB_TYPE_MAP[l.type] || l.type || '연계',
                exec: badge,
                isCurrent: l.id === collab.id,
            }]);
        });

        // 전체 부서 목록
        const allDepts = getHubDeptList();
        const allDeptIds = new Set(allDepts.map(d => d.id));

        // 부서 목록에 없는 대상(targetService 등)은 별도 노드로 추가
        const extraTargets = [];
        for (const [deptId] of targetMap) {
            if (!allDeptIds.has(deptId)) {
                extraTargets.push({ id: deptId, name: getDeptName(deptId) });
            }
        }

        html += `<div class="lf-card mb-4">`;

        // 타이틀
        html += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:12px">
            <span class="material-symbols-outlined" style="font-size:18px;color:#6366F1" aria-hidden="true">hub</span>
            <span style="font-size:13px;font-weight:800;color:#1E293B">${escapeHtml(collab.userName)} 님 연계 흐름도</span>
            <span style="font-size:11px;color:#94A3B8;font-weight:600">${totalCount}건</span>
        </div>`;

        // 허브-스포크 레이아웃
        html += `<div class="lf-hub-layout">`;

        // ── 왼쪽: 요청 부서 노드 ──
        html += `<div class="lf-hub-origin">
            <div class="lf-hub-origin-icon">
                <span class="material-symbols-outlined" style="font-size:20px;color:#6366F1" aria-hidden="true">apartment</span>
            </div>
            <div class="lf-hub-origin-name">${escapeHtml(originName)}</div>
            <div style="font-size:9px;color:#94A3B8;margin-top:3px">요청 부서</div>
        </div>`;

        // ── 오른쪽: 전체 부서 목록 ──
        html += `<div class="lf-hub-depts">`;

        allDepts.forEach(dept => {
            const linkages = targetMap.get(dept.id);
            const isTarget = !!linkages;
            const icon = HUB_DEPT_ICONS[dept.id] || 'domain';

            if (isTarget) {
                linkages.forEach(info => {
                    html += `<div class="lf-hub-dept lf-target">`;
                    html += `<div class="lf-hub-arrow-inline">
                        <span class="lf-hub-type-label">${escapeHtml(info.typeName)}</span>
                        <span class="lf-hub-arrow-line"></span>
                        <span class="lf-hub-arrow-head"></span>
                    </div>`;
                    html += `<div class="lf-hub-dept-icon">
                        <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">${icon}</span>
                    </div>`;
                    html += `<span class="lf-hub-dept-name">${escapeHtml(dept.name)}</span>`;
                    html += `<span class="lf-exec-badge" style="background:${info.exec.bg};color:${info.exec.color};font-size:9px;padding:1px 6px;margin-left:auto">
                        <span class="material-symbols-outlined" style="font-size:10px" aria-hidden="true">${info.exec.icon}</span>${info.exec.label}
                    </span>`;
                    if (info.isCurrent) {
                        html += `<span style="font-size:8px;font-weight:700;color:white;background:#6366F1;padding:1px 5px;border-radius:3px;margin-left:2px">현재</span>`;
                    }
                    html += `</div>`;
                });
            } else {
                html += `<div class="lf-hub-dept lf-inactive">`;
                html += `<div class="lf-hub-dept-icon">
                    <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">${icon}</span>
                </div>`;
                html += `<span class="lf-hub-dept-name">${escapeHtml(dept.name)}</span>`;
                html += `</div>`;
            }
        });

        // 별도 노드 (부서 목록에 없는 대상)
        extraTargets.forEach(extra => {
            const linkages = targetMap.get(extra.id);
            if (linkages) {
                linkages.forEach(info => {
                    html += `<div class="lf-hub-extra-node">`;
                    html += `<div class="lf-hub-arrow-inline">
                        <span class="lf-hub-type-label">${escapeHtml(info.typeName)}</span>
                        <span class="lf-hub-arrow-line"></span>
                        <span class="lf-hub-arrow-head"></span>
                    </div>`;
                    html += `<div class="lf-hub-dept-icon">
                        <span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">open_in_new</span>
                    </div>`;
                    html += `<span class="lf-hub-dept-name">${escapeHtml(extra.name)}</span>`;
                    html += `<span class="lf-exec-badge" style="background:${info.exec.bg};color:${info.exec.color};font-size:9px;padding:1px 6px;margin-left:auto">
                        <span class="material-symbols-outlined" style="font-size:10px" aria-hidden="true">${info.exec.icon}</span>${info.exec.label}
                    </span>`;
                    if (info.isCurrent) {
                        html += `<span style="font-size:8px;font-weight:700;color:white;background:#6366F1;padding:1px 5px;border-radius:3px;margin-left:2px">현재</span>`;
                    }
                    html += `</div>`;
                });
            }
        });

        html += `</div>`; // .lf-hub-depts end
        html += `</div>`; // .lf-hub-layout end

        // ── 재배정/추가부서/승인 파이프라인 (각 연계별) ──
        sortedLinkages.forEach((l, idx) => {
            const isCurrent = l.id === collab.id;
            const redirects = l.redirectHistory || [];
            const additionalDepts = l.additionalDepts || [];
            const tName = lfDeptLabel(l, isCurrent ? ed : null, 'target');
            const hasExtra = redirects.length > 0 || additionalDepts.length > 0;

            if (hasExtra || isCurrent) {
                const border = isCurrent ? 'border:1.5px solid #C7D2FE;background:#FAFAFF' : 'border:1px solid #E2E8F0;background:white';
                html += `<div style="${border};border-radius:8px;padding:6px 10px;margin-top:6px;position:relative">`;
                html += `<div style="font-size:10px;font-weight:700;color:#64748B;margin-bottom:4px">
                    <span class="material-symbols-outlined" style="font-size:12px;vertical-align:-2px" aria-hidden="true">arrow_forward</span>
                    ${escapeHtml(tName)}
                </div>`;

                if (redirects.length > 0) {
                    html += `<div class="lf-redirect-bar" style="margin-bottom:4px;font-size:9px;padding:3px 6px">
                        <span class="material-symbols-outlined text-purple-500" style="font-size:11px" aria-hidden="true">swap_horiz</span>`;
                    redirects.forEach(r => {
                        html += `<span style="font-weight:700;color:#4338CA">${getDeptName(r.fromDept)}</span>
                            <span class="material-symbols-outlined text-purple-400" style="font-size:10px" aria-hidden="true">trending_flat</span>
                            <span style="font-weight:700;color:#047857">${getDeptName(r.toDept)}</span>`;
                    });
                    html += `</div>`;
                }
                if (additionalDepts.length > 0) {
                    html += `<div class="lf-add-dept-bar" style="margin-bottom:4px;font-size:9px;padding:3px 6px">
                        <span class="material-symbols-outlined text-amber-500" style="font-size:11px" aria-hidden="true">group_add</span>
                        ${additionalDepts.map(d => `<span style="padding:1px 5px;background:white;border-radius:3px;border:1px solid #FCD34D;font-weight:700;color:#92400E">${getDeptName(d)}</span>`).join('')}
                    </div>`;
                }

                html += renderApprovalPipelineInline(l);
                html += `</div>`;
            } else {
                // 비현재 + 추가정보 없는 연계: 승인 파이프라인만 컴팩트 표시
                html += `<div style="margin-top:4px;padding:2px 8px">`;
                html += `<span style="font-size:9px;color:#94A3B8;margin-right:4px">${escapeHtml(tName)}:</span>`;
                html += renderApprovalPipelineInline(l);
                html += `</div>`;
            }
        });

        html += `</div>`; // .lf-card end

        // ── ② 서비스 여정 체인 (후속 연계) ──
        if (collab.previousLinkageId || collab.followupLinkageId || collab.isFollowup) {
            html += renderLinkageChainFlow(collab, ed);
        }

        // ── ③ 접이식 상세 (연계사유 · 승인이력 · 메모) ──
        if (collab.reason || (collab.requiredServices && collab.requiredServices.length > 0)) {
            html += `<div class="mb-2">
                <div class="case-collapse-toggle flex items-center gap-1.5 p-2 bg-slate-50 border border-slate-200 rounded-lg cursor-pointer" onclick="toggleCaseCollapse('lf-detail-info', this)">
                    <span class="material-symbols-outlined text-slate-400" style="font-size:14px" aria-hidden="true">info</span>
                    <span class="text-xs font-semibold text-slate-600">연계 사유 · 필요 서비스</span>
                    <span class="material-symbols-outlined text-slate-400 case-collapse-icon ml-auto" style="font-size:16px" aria-hidden="true">expand_more</span>
                </div>
                <div id="lf-detail-info" class="case-collapse-body">
                    <div class="px-3 pt-2 pb-1 space-y-2 text-sm">
                        ${collab.reason ? `<p class="text-slate-700 text-[13px]">${escapeHtml(collab.reason)}</p>` : ''}
                        ${collab.requiredServices?.length > 0 ? `<div class="flex flex-wrap gap-1">${collab.requiredServices.map(s => `<span class="badge bg-blue-50 text-blue-600">${escapeHtml(s)}</span>`).join('')}</div>` : ''}
                    </div>
                </div>
            </div>`;
        }

        if (collab.approvalHistory && collab.approvalHistory.length > 0) {
            html += `<div class="mb-2">
                <div class="case-collapse-toggle flex items-center gap-1.5 p-2 bg-blue-50 border border-blue-100 rounded-lg cursor-pointer" onclick="toggleCaseCollapse('lf-approval-hist', this)">
                    <span class="material-symbols-outlined text-blue-500" style="font-size:14px" aria-hidden="true">timeline</span>
                    <span class="text-xs font-semibold text-blue-700">승인 이력 (${collab.approvalHistory.length}건)</span>
                    <span class="material-symbols-outlined text-blue-400 case-collapse-icon ml-auto" style="font-size:16px" aria-hidden="true">expand_more</span>
                </div>
                <div id="lf-approval-hist" class="case-collapse-body">
                    <div class="pt-2 px-1">${renderApprovalTimeline(collab.approvalHistory)}</div>
                </div>
            </div>`;
        }

        const linkageNotes = collab.notes || [];
        if (linkageNotes.length > 0) {
            html += `<div class="mb-2">
                <div class="case-collapse-toggle flex items-center gap-1.5 p-2 bg-slate-50 border border-slate-200 rounded-lg cursor-pointer" onclick="toggleCaseCollapse('lf-notes', this)">
                    <span class="material-symbols-outlined text-indigo-500" style="font-size:14px" aria-hidden="true">sticky_note_2</span>
                    <span class="text-xs font-semibold text-slate-600">연계 메모 (${linkageNotes.length}건)</span>
                    <span class="material-symbols-outlined text-slate-400 case-collapse-icon ml-auto" style="font-size:16px" aria-hidden="true">expand_more</span>
                </div>
                <div id="lf-notes" class="case-collapse-body">
                    <div class="pt-2 px-1 space-y-1.5">${linkageNotes.map(n => `<div class="p-2 bg-indigo-50 rounded-lg text-[12px]">
                        <span class="font-semibold text-indigo-700">${escapeHtml(n.dept || n.author || '관리자')}</span>
                        <span class="text-slate-500 ml-1">${escapeHtml(n.text)}</span>
                        <span class="text-[9px] text-slate-400 ml-1">${safeDateStr(n.createdAt)}</span>
                    </div>`).join('')}</div>
                </div>
            </div>`;
        }

        return html;
    }

    // 승인 파이프라인 — 도식화 (흐름 카드 내부)
    // 승인 파이프라인 — 인라인 컴팩트 (통합 흐름도 행 내부용)
    function renderApprovalPipelineInline(l) {
        const status = l.approvalStatus || 'pending';
        const isRejected = status === 'rejected' || status === 'admin_rejected';
        const isRevision = status === 'revision_requested' || status === 'admin_revision_requested';
        const steps = [
            { label: '접수', icon: 'edit_note' },
            { label: '소속', icon: 'verified' },
            { label: '대상', icon: 'verified' },
            { label: '승인', icon: 'check_circle' },
        ];
        const stepKeys = ['pending', 'origin_approved', 'target_approved', 'approved'];
        let cIdx = stepKeys.indexOf(status);
        if (status === 'dept_approved') cIdx = 2;
        if (status === 'approved') cIdx = 3;
        if (cIdx < 0) cIdx = 0;

        let html = `<div style="display:flex;align-items:center;justify-content:center;gap:0;margin-top:4px">`;
        steps.forEach((s, i) => {
            const done = i < cIdx || (i === cIdx && status === 'approved');
            const cur = i === cIdx && status !== 'approved';
            const fail = cur && (isRejected || isRevision);
            const dotBg = done ? '#22C55E' : fail ? '#EF4444' : cur ? '#6366F1' : '#CBD5E1';
            const dotIcon = done ? 'check' : fail ? (isRejected ? 'close' : 'refresh') : cur ? s.icon : 'radio_button_unchecked';
            const labelColor = done ? '#16A34A' : fail ? '#DC2626' : cur ? '#4338CA' : '#94A3B8';

            html += `<div style="display:flex;flex-direction:column;align-items:center">
                <div style="width:18px;height:18px;border-radius:50%;background:${dotBg};display:flex;align-items:center;justify-content:center">
                    <span class="material-symbols-outlined" style="font-size:11px;color:white" aria-hidden="true">${dotIcon}</span>
                </div>
                <span style="font-size:8px;font-weight:600;color:${labelColor};margin-top:1px">${s.label}</span>
            </div>`;
            if (i < steps.length - 1) {
                html += `<div style="flex:1;height:2px;min-width:8px;border-radius:1px;background:${i < cIdx ? '#22C55E' : '#E2E8F0'};margin:0 -1px -10px"></div>`;
            }
        });
        html += `</div>`;
        return html;
    }

    // 서비스 여정 — 미니 흐름도 체인
    function renderLinkageChainFlow(collab, ed) {
        let rootId = collab.id;
        let seen = new Set([rootId]);
        let walker = collab;
        while (walker && walker.previousLinkageId) {
            const prev = allCollabs.find(c => c.id === walker.previousLinkageId);
            if (!prev || seen.has(prev.id)) break;
            seen.add(prev.id);
            rootId = prev.id;
            walker = prev;
        }
        const chain = [];
        let cur = allCollabs.find(c => c.id === rootId);
        while (cur) {
            chain.push(cur);
            if (!cur.followupLinkageId) break;
            const next = allCollabs.find(c => c.id === cur.followupLinkageId);
            if (!next || chain.includes(next)) break;
            cur = next;
        }
        if (chain.length <= 1 && chain[0]?.id === collab.id && !collab.isFollowup) return '';

        let html = `<div class="mb-3">
            <div style="font-size:11px;font-weight:700;color:#64748B;margin-bottom:6px;display:flex;align-items:center;gap:4px">
                <span class="material-symbols-outlined" style="font-size:14px;color:#0D9488" aria-hidden="true">route</span>서비스 여정 (${chain.length}단계)
            </div>`;

        chain.forEach((c, i) => {
            const isCurrent = c.id === collab.id;
            const exec = LF_EXEC[c.executionStatus] || LF_EXEC.not_started;
            const oName = c.fromDept ? getDeptName(c.fromDept) : (c.originDept ? getDeptName(c.originDept) : (c.serviceName || '-'));
            const tName = c.toDept ? getDeptName(c.toDept) : (c.targetDept ? getDeptName(c.targetDept) : (c.targetService || '-'));
            html += `<div class="lf-mini-row${isCurrent ? ' lf-current' : ''}">
                <div class="lf-mini-dot" style="background:#818CF8"></div>
                <span style="font-weight:700;color:#4338CA;font-size:11px">${escapeHtml(oName)}</span>
                <div class="lf-mini-arrow"></div>
                <div class="lf-mini-dot" style="background:#34D399"></div>
                <span style="font-weight:700;color:#047857;font-size:11px">${escapeHtml(tName)}</span>
                <span class="lf-exec-badge" style="background:${exec.bg};color:${exec.color};font-size:9px;margin-left:auto">
                    <span class="material-symbols-outlined" style="font-size:9px" aria-hidden="true">${exec.icon}</span>${exec.label}
                </span>
                ${isCurrent ? '<span style="font-size:9px;padding:1px 5px;border-radius:4px;background:#C7D2FE;color:#4338CA;font-weight:700">현재</span>' : ''}
            </div>`;
            if (i < chain.length - 1) {
                html += `<div class="lf-vertical-arrow"><span class="material-symbols-outlined" style="font-size:14px" aria-hidden="true">south</span></div>`;
            }
        });

        html += `</div>`;
        return html;
    }

    // 미니 흐름 카드 — 각 연계를 도식화 (대상자 통합 뷰용)
    // ── Detail View Actions ──
    let detailActionType = null;

    function toggleDetailComment(actionType) {
        const area = document.getElementById('collab-detail-comment-area');
        const label = document.getElementById('detail-comment-label');
        const submitBtn = document.getElementById('detail-comment-submit');
        const input = document.getElementById('detail-comment-input');
        const deptSelectArea = document.getElementById('detail-dept-select-area');

        if (!actionType || detailActionType === actionType) {
            // Close
            area.classList.remove('open');
            detailActionType = null;
            return;
        }

        detailActionType = actionType;
        const labels = {
            approve: '승인 코멘트 (선택)',
            reject: '반려 사유 (필수)',
            redirect: '재배정 사유 (필수) — 대상 부서를 선택하세요',
            add_dept: '추가 부서 배정 사유 (필수) — 추가할 부서를 선택하세요',
        };
        const btnLabels = { approve: '최종승인', reject: '반려', redirect: '부서변경', add_dept: '부서추가' };
        const btnColors = {
            approve: 'bg-green-600 hover:bg-green-700',
            reject: 'bg-red-600 hover:bg-red-700',
            redirect: 'bg-purple-600 hover:bg-purple-700',
            add_dept: 'bg-indigo-600 hover:bg-indigo-700',
        };

        label.textContent = labels[actionType] || '코멘트';
        submitBtn.textContent = btnLabels[actionType] || '확인';
        submitBtn.className = `px-4 py-2 text-white rounded-lg text-sm font-semibold transition-colors ${btnColors[actionType] || 'bg-primary hover:bg-primary-light'}`;
        if (input) input.value = '';

        // Show dept selector for redirect/add_dept (설계문서 §4)
        if (actionType === 'redirect' || actionType === 'add_dept') {
            deptSelectArea.style.display = '';
            populateDeptSelect();
        } else {
            deptSelectArea.style.display = 'none';
        }

        area.classList.add('open');
        setTimeout(() => {
            if (actionType === 'redirect' || actionType === 'add_dept') {
                document.getElementById('detail-dept-select')?.focus();
            } else {
                input?.focus();
            }
        }, 200);
    }

    function populateDeptSelect() {
        const select = document.getElementById('detail-dept-select');
        if (!select) return;
        const deptEntries = Object.entries(deptMap);
        if (deptEntries.length > 0) {
            select.innerHTML = '<option value="">부서 선택...</option>' + deptEntries.map(([id, name]) => `<option value="${id}">${name}</option>`).join('');
        } else {
            // Fallback: hardcoded from 설계문서 §9
            select.innerHTML = `<option value="">부서 선택...</option>
                <option value="경영지원부">경영지원부</option>
                <option value="통합돌봄사업부">통합돌봄사업부</option>
                <option value="민간지원협력부">민간지원협력부</option>
                <option value="정책기획연구부">정책기획연구부</option>
                <option value="통합돌봄지원센터">통합돌봄지원센터</option>
                <option value="노인맞춤돌봄광역지원기관">노인맞춤돌봄 광역지원기관</option>
                <option value="응급안전안심광역지원기관">응급안전안심 광역지원기관</option>
                <option value="경남지역사회서비스지원단">경남지역사회서비스지원단</option>
                <option value="창원종합재가센터">창원종합재가센터</option>
                <option value="김해종합재가센터">김해종합재가센터</option>
                <option value="경상남도장애인종합복지관">경상남도장애인종합복지관</option>
                <option value="경상남도보조기기센터">경상남도보조기기센터</option>`;
        }
    }

    async function submitDetailAction() {
        const linkageId = collabDetailLinkageId;
        if (!linkageId || !detailActionType) return;

        const comment = document.getElementById('detail-comment-input')?.value.trim() || '';
        const selectedDept = document.getElementById('detail-dept-select')?.value || '';

        // Validation
        const rejectTypes = ['reject', 'dept_reject', 'target_reject', 'target_revision'];
        if (rejectTypes.includes(detailActionType) && !comment) {
            alert('사유를 입력하세요.'); return;
        }
        if (detailActionType === 'dept_revision' && !comment) {
            alert('수정요청 사항을 입력하세요.'); return;
        }
        if ((detailActionType === 'redirect' || detailActionType === 'add_dept') && !selectedDept) {
            alert('대상 부서를 선택하세요.'); return;
        }
        if ((detailActionType === 'redirect' || detailActionType === 'add_dept') && !comment) {
            alert('사유를 입력하세요.'); return;
        }

        // Build request — 액션별 API 엔드포인트 매핑
        const routeMap = {
            approve:            `/api/admin/linkage/${linkageId}/approve`,
            reject:             `/api/admin/linkage/${linkageId}/reject`,
            redirect:           `/api/admin/linkage/${linkageId}/redirect`,
            add_dept:           `/api/admin/linkage/${linkageId}/add-dept`,
            dept_approve:       `/api/dept/linkage/${linkageId}/approve`,
            dept_reject:        `/api/dept/linkage/${linkageId}/reject`,
            dept_revision:      `/api/dept/linkage/${linkageId}/revision`,
            target_accept:      `/api/target-dept/linkage/${linkageId}/accept`,
            target_reject:      `/api/target-dept/linkage/${linkageId}/reject`,
            target_revision:    `/api/target-dept/linkage/${linkageId}/revision`,
            resubmit_to_target: `/api/dept/linkage/${linkageId}/resubmit-to-target`,
        };
        const url = routeMap[detailActionType];
        if (!url) return;

        const body = { comment };
        if (detailActionType === 'redirect') body.targetDept = selectedDept;
        if (detailActionType === 'add_dept') body.additionalDept = selectedDept;

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                throw new Error(err.error || '처리 실패');
            }
            delete expandedCardData[linkageId];
            detailActionType = null;
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert(e.message || '처리 실패');
        }
    }


    function renderKanbanModalContent(linkageId) {
        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;

        const body = document.getElementById('kanban-modal-body');
        const ed = expandedCardData[linkageId];
        const typeName = COLLAB_TYPE_MAP[collab.type] || '자문';
        const catLabel = collab.category === 'referral' ? '서비스연계' : '부서협업';

        let directionHtml = '';
        if (collab.category === 'referral' && collab.targetService) {
            directionHtml = `<span class="font-semibold text-blue-700">${escapeHtml(collab.targetService)}</span>`;
        } else if (collab.fromDept && collab.toDept) {
            directionHtml = `<span class="font-semibold text-indigo-700">${getDeptName(collab.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" aria-hidden="true" style="font-size:14px">arrow_forward</span>
                <span class="font-semibold text-green-700">${getDeptName(collab.toDept)}</span>`;
        }

        // ── LEFT COLUMN: 연계 조정 ──
        let leftHtml = '';

        // Category / Type / Direction info
        leftHtml += `<div class="mb-4 pb-4 border-b border-slate-100">
            <div class="flex items-center gap-2 mb-2">
                <span class="badge bg-indigo-50 text-indigo-600" style="font-size:11px">${catLabel}</span>
                <span class="badge bg-slate-100 text-slate-600" style="font-size:11px">${typeName}</span>
                <span class="text-xs text-slate-400 ml-auto">${safeDateStr(collab.createdAtISO || collab.createdAt)}</span>
            </div>
            ${directionHtml ? `<div class="flex items-center gap-1.5 text-sm mb-2">${directionHtml}</div>` : ''}
            <p class="text-sm text-slate-600">${escapeHtml(collab.userName || '-')} · ${escapeHtml(collab.serviceName || '-')}</p>
            ${collab.reason ? `<p class="text-sm text-slate-500 mt-1">${escapeHtml(collab.reason)}</p>` : ''}
        </div>`;

        // Approval stepper (3-step progress)
        leftHtml += `<div class="mb-4">
            <h5 class="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">verified</span>승인 단계
            </h5>
            ${renderApprovalStepper(collab.approvalStatus)}
        </div>`;

        // Approval timeline
        if (collab.approvalHistory && collab.approvalHistory.length > 0) {
            leftHtml += `<div class="mb-4">
                <h5 class="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">timeline</span>승인 이력
                </h5>
                ${renderApprovalTimeline(collab.approvalHistory)}
            </div>`;
        }

        // ── 1) 소속부서 검토 (pending 상태 → 소속부서 또는 관리자가 승인/반려/수정요청) ──
        const canReviewAsDept = collab.approvalStatus === 'pending'
            && (sessionRole === 'admin' || (sessionRole === 'dept' && collab.fromDept === sessionDeptId));
        if (canReviewAsDept) {
            leftHtml += `<div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h5 class="text-xs font-bold text-yellow-700 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">supervisor_account</span>소속부서 검토
                </h5>
                <textarea id="kb-dept-comment-${collab.id}" rows="2" placeholder="코멘트 입력 (선택)..." class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 mb-3 focus:ring-primary focus:border-primary resize-none"></textarea>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="kanbanDeptApprove('${collab.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 flex items-center gap-1.5 transition-colors">
                        <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">check_circle</span>승인
                    </button>
                    <button onclick="kanbanDeptReject('${collab.id}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-50 transition-colors">반려</button>
                    <button onclick="kanbanDeptRevision('${collab.id}')" class="px-4 py-2 bg-white border border-orange-300 text-orange-600 rounded-lg text-sm font-semibold hover:bg-orange-50 transition-colors">수정요청</button>
                </div>
            </div>`;
        }

        // ── 2) 대상부서 수락/반려/수정요청 (dept_approved 상태 → 대상부서 또는 관리자가 처리) ──
        const canReviewAsTarget = collab.approvalStatus === 'dept_approved'
            && (sessionRole === 'admin' || (sessionRole === 'dept' && collab.toDept === sessionDeptId));
        if (canReviewAsTarget) {
            leftHtml += `<div class="mb-4 p-4 bg-teal-50 border border-teal-200 rounded-lg">
                <h5 class="text-xs font-bold text-teal-700 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">domain_verification</span>대상부서 수락 검토
                </h5>
                <textarea id="kb-target-comment-${collab.id}" rows="2" placeholder="코멘트 입력 (선택)..." class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 mb-3 focus:ring-primary focus:border-primary resize-none"></textarea>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="kanbanTargetAccept('${collab.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 flex items-center gap-1.5 transition-colors">
                        <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">check_circle</span>수락
                    </button>
                    <button onclick="kanbanTargetReject('${collab.id}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-50 transition-colors">반려</button>
                    <button onclick="kanbanTargetRevision('${collab.id}')" class="px-4 py-2 bg-white border border-orange-300 text-orange-600 rounded-lg text-sm font-semibold hover:bg-orange-50 transition-colors">수정요청</button>
                </div>
            </div>`;
        }

        // ── 3) 대상부서 반환 → 소속부서 재제출 (target_rejected / target_revision_requested) ──
        const canResubmitToTarget = (collab.approvalStatus === 'target_rejected' || collab.approvalStatus === 'target_revision_requested')
            && (sessionRole === 'admin' || (sessionRole === 'dept' && collab.fromDept === sessionDeptId));
        if (canResubmitToTarget) {
            const returnLabel = collab.approvalStatus === 'target_rejected' ? '대상부서가 반려했습니다' : '대상부서가 수정을 요청했습니다';
            leftHtml += `<div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <h5 class="text-xs font-bold text-red-700 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">assignment_return</span>${returnLabel}
                </h5>
                <textarea id="kb-dept-comment-${collab.id}" rows="2" placeholder="수정사항 또는 코멘트 입력..." class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 mb-3 focus:ring-primary focus:border-primary resize-none"></textarea>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="kanbanResubmitToTarget('${collab.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 flex items-center gap-1.5 transition-colors">
                        <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">send</span>수정 후 재제출
                    </button>
                    <button onclick="kanbanDeptReject('${collab.id}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-50 transition-colors">반려</button>
                </div>
            </div>`;
        }

        // ── 4) 관리자 최종 승인 (approved 상태 아닌 dept_approved를 관리자가 직접 최종 승인하는 경우) ──
        // 관리자는 위 2)에서 대상부서 역할로 수락 가능하므로, 별도 관리자 최종 승인은 target_approved/legacy 흐름용
        const isAdminFinalReview = sessionRole === 'admin' && collab.approvalStatus === 'target_approved';
        if (isAdminFinalReview) {
            leftHtml += `<div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h5 class="text-xs font-bold text-blue-700 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">approval</span>관리자 최종 승인
                </h5>
                <textarea id="kb-comment-${collab.id}" rows="2" placeholder="코멘트 입력 (선택)..." class="w-full rounded-lg border-slate-300 text-sm py-2 px-3 mb-3 focus:ring-primary focus:border-primary resize-none"></textarea>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="kanbanApproveFromModal('${collab.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 flex items-center gap-1.5 transition-colors">
                        <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">check_circle</span>최종 승인
                    </button>
                    <button onclick="kanbanRejectFromModal('${collab.id}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-50 transition-colors">반려</button>
                    <button onclick="kanbanRevisionFromModal('${collab.id}')" class="px-4 py-2 bg-white border border-orange-300 text-orange-600 rounded-lg text-sm font-semibold hover:bg-orange-50 transition-colors">수정요청</button>
                </div>
            </div>`;
        }

        // Notes in left column (linkage-specific notes)
        if (ed && !ed.error) {
            const notes = collab.notes || [];
            leftHtml += `<div class="mb-4">
                <h5 class="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">sticky_note_2</span>연계 메모 (${notes.length})
                </h5>
                ${notes.length > 0 ? '<div class="space-y-1.5 max-h-[180px] overflow-y-auto mb-3">' + notes.map(n => `
                    <div class="text-sm p-2.5 bg-amber-50 rounded-lg">
                        <span class="font-semibold text-indigo-600">${escapeHtml(n.dept || n.author || '관리자')}</span>
                        <span class="text-slate-600 ml-1">${escapeHtml(n.text)}</span>
                        <span class="text-slate-300 ml-1 text-xs">${safeDateStr(n.createdAt)}</span>
                    </div>
                `).join('') + '</div>' : '<p class="text-sm text-slate-400 mb-3">메모 없음</p>'}
                <div class="flex gap-2">
                    <input id="kb-note-${collab.id}" type="text" placeholder="메모 입력..." class="flex-1 rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addKanbanNoteFromModal('${ed.id}','${collab.id}')" />
                    <button onclick="addKanbanNoteFromModal('${ed.id}','${collab.id}')" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors">추가</button>
                </div>
            </div>`;
        }

        // ── RIGHT COLUMN: 상담 처리 (케이스 상세) ──
        let rightHtml = '';

        if (!ed) {
            rightHtml = '<p class="text-sm text-slate-400 text-center py-8">로딩 중...</p>';
        } else if (ed.error) {
            rightHtml = '<p class="text-sm text-red-400 text-center py-8">데이터를 불러올 수 없습니다.</p>';
        } else {
            // Case status stepper (read-only)
            rightHtml += renderCaseStatusStepper(ed);

            // Subject info
            rightHtml += `<div class="mb-5">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm text-green-600" aria-hidden="true">person</span>대상자 정보
                </h4>
                <div class="bg-slate-50 rounded-xl p-4 space-y-2.5 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">이름</span>
                        <span class="font-semibold text-slate-800">${escapeHtml(ed.userName || '-')}</span>
                    </div>
                    <div class="border-t border-slate-100"></div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">전화번호</span>
                        <span class="font-semibold text-slate-800">${escapeHtml(ed.userPhone || '-')}</span>
                    </div>
                    <div class="border-t border-slate-100"></div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">서비스명</span>
                        <span class="font-semibold text-slate-800">${escapeHtml(ed.serviceName || '-')}</span>
                    </div>
                    <div class="border-t border-slate-100"></div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">접수일</span>
                        <span class="text-slate-700">${ed.createdAt || '-'}</span>
                    </div>
                </div>
            </div>`;

            // AI Summary (collapsible)
            if (ed.conversationSummary) {
                rightHtml += `<div class="mb-5">
                    <div class="case-collapse-toggle flex items-center justify-between p-3 bg-purple-50 border border-purple-100 rounded-xl" onclick="toggleCaseCollapse('km-ai-summary', this)">
                        <h4 class="text-xs font-bold text-purple-700 flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-sm" aria-hidden="true">smart_toy</span>AI 상담 요약
                        </h4>
                        <span class="material-symbols-outlined text-purple-400 text-lg case-collapse-icon" aria-hidden="true">expand_more</span>
                    </div>
                    <div id="km-ai-summary" class="case-collapse-body">
                        <div class="px-3 pt-3 pb-1">
                            <p class="text-sm text-slate-700 whitespace-pre-line leading-relaxed">${escapeHtml(ed.conversationSummary)}</p>
                        </div>
                    </div>
                </div>`;
            }

            // Notes section (request-level notes)
            const caseNotes = ed.notes || [];
            rightHtml += `<div class="mb-5">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm text-amber-500" aria-hidden="true">sticky_note_2</span>메모 (${caseNotes.length})
                </h4>
                <div class="space-y-2 mb-3 max-h-[200px] overflow-y-auto">
                    ${caseNotes.length > 0 ? caseNotes.map(n => {
                        const author = n.author || '관리자';
                        const authorBadge = author === '담당자'
                            ? '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 text-green-700">담당자</span>'
                            : '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-amber-100 text-amber-700">관리자</span>';
                        return `<div class="p-3 bg-amber-50 rounded-lg text-sm">
                            <div class="flex items-center gap-1.5 mb-1">${authorBadge}<span class="text-[10px] text-slate-400">${safeDateStr(n.createdAt)}</span></div>
                            <p class="text-slate-700 text-[13px]">${escapeHtml(n.text)}</p>
                        </div>`;
                    }).join('') : '<p class="text-sm text-slate-400 text-center py-3">메모 없음</p>'}
                </div>
                <div class="flex gap-2">
                    <input id="km-note-input" type="text" placeholder="메모 입력..." class="flex-1 rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addKanbanCaseNote('${ed.id}')" />
                    <button onclick="addKanbanCaseNote('${ed.id}')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-light transition-colors flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm" aria-hidden="true">add</span>추가
                    </button>
                </div>
            </div>`;

            // Linkage history
            const linkages = ed.linkages || [];
            if (linkages.length > 0) {
                rightHtml += `<div class="mb-5">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-sm text-indigo-500" aria-hidden="true">hub</span>연계 이력 (${linkages.length})
                    </h4>
                    <div class="space-y-3">
                        ${linkages.map(l => renderCasePanelLinkage(l)).join('')}
                    </div>
                </div>`;
            }
        }

        // Assemble 2-column layout
        body.innerHTML = `<div class="kanban-modal-2col">
            <div class="kanban-modal-col kanban-modal-col-left">${leftHtml}</div>
            <div class="kanban-modal-col">${rightHtml}</div>
        </div>`;
    }

    // (renderModalExpandedDetail removed - logic integrated into renderKanbanModalContent 2-column layout)

    function closeKanbanModal() {
        kanbanModalOpen = false;
        kanbanModalLinkageId = null;
        const modal = document.getElementById('kanban-detail-modal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    function onKanbanModalOverlayClick(event) {
        if (event.target === event.currentTarget) {
            closeKanbanModal();
        }
    }

    // Modal-specific action wrappers (close modal after action, reload panel)
    async function addKanbanNoteFromModal(requestId, linkageId) {
        const input = document.getElementById('kb-note-' + linkageId);
        const text = input?.value.trim();
        if (!text) return;
        try {
            await fetch(`/api/case/${requestId}/linkage/${linkageId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, author: '관리자', dept: '관리자' }),
            });
            const data = await api(`/api/admin/requests/${requestId}`);
            const updatedLinkage = (data.linkages || []).find(l => l.id === linkageId);
            if (updatedLinkage) {
                const collab = allCollabs.find(c => c.id === linkageId);
                if (collab) Object.assign(collab, { notes: updatedLinkage.notes });
            }
            expandedCardData[linkageId] = data;
            renderKanbanModalContent(linkageId);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    async function kanbanApproveFromModal(linkageId) {
        const comment = document.getElementById('kb-comment-' + linkageId)?.value.trim() || '';
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            closeKanbanModal();
            delete expandedCardData[linkageId];
            loadCollabPanel();
        } catch (e) {
            alert('승인 처리 실패');
        }
    }

    async function kanbanRejectFromModal(linkageId) {
        const comment = document.getElementById('kb-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('반려 사유를 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            closeKanbanModal();
            delete expandedCardData[linkageId];
            loadCollabPanel();
        } catch (e) {
            alert('반려 처리 실패');
        }
    }

    async function kanbanRevisionFromModal(linkageId) {
        const comment = document.getElementById('kb-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('수정 요청 사항을 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/revision`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            closeKanbanModal();
            delete expandedCardData[linkageId];
            loadCollabPanel();
        } catch (e) {
            alert('수정 요청 실패');
        }
    }

    // ── 부서 조정자 액션 (칸반 모달) ──
    async function kanbanDeptApprove(linkageId) {
        const comment = document.getElementById('kb-dept-comment-' + linkageId)?.value.trim() || '';
        try {
            const resp = await fetch(`/api/dept/linkage/${linkageId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('부서 조정자 승인 실패');
        }
    }

    async function kanbanDeptReject(linkageId) {
        const comment = document.getElementById('kb-dept-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('반려 사유를 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/dept/linkage/${linkageId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('부서 조정자 반려 실패');
        }
    }

    async function kanbanDeptRevision(linkageId) {
        const comment = document.getElementById('kb-dept-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('수정 요청 사항을 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/dept/linkage/${linkageId}/revision`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('부서 조정자 수정 요청 실패');
        }
    }

    async function kanbanDeptResubmit(linkageId) {
        const comment = document.getElementById('kb-dept-comment-' + linkageId)?.value.trim() || '';
        try {
            const resp = await fetch(`/api/dept/linkage/${linkageId}/resubmit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('부서 조정자 재제출 실패');
        }
    }

    // ── 대상부서 액션 (칸반 모달) ──
    async function kanbanTargetAccept(linkageId) {
        const comment = document.getElementById('kb-target-comment-' + linkageId)?.value.trim() || '';
        try {
            const resp = await fetch(`/api/target-dept/linkage/${linkageId}/accept`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('대상부서 수락 실패');
        }
    }

    async function kanbanTargetReject(linkageId) {
        const comment = document.getElementById('kb-target-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('반려 사유를 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/target-dept/linkage/${linkageId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('대상부서 반려 실패');
        }
    }

    async function kanbanTargetRevision(linkageId) {
        const comment = document.getElementById('kb-target-comment-' + linkageId)?.value.trim() || '';
        if (!comment) { alert('수정요청 사항을 입력하세요.'); return; }
        try {
            const resp = await fetch(`/api/target-dept/linkage/${linkageId}/revision`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('대상부서 수정요청 실패');
        }
    }

    // ── 소속부서 재제출 → 대상부서 (칸반 모달) ──
    async function kanbanResubmitToTarget(linkageId) {
        const comment = document.getElementById('kb-dept-comment-' + linkageId)?.value.trim() || '';
        try {
            const resp = await fetch(`/api/dept/linkage/${linkageId}/resubmit-to-target`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            delete expandedCardData[linkageId];
            hideCollabDetail();
            loadCollabPanel();
        } catch (e) {
            alert('대상부서 재제출 실패');
        }
    }

    function renderApprovalTimeline(approvalHistory) {
        if (!approvalHistory || approvalHistory.length === 0) {
            return '<p class="text-xs text-slate-400">승인 이력 없음</p>';
        }
        let html = '<div class="approval-timeline">';
        approvalHistory.forEach((h, i) => {
            const isLast = i === approvalHistory.length - 1;
            const statusClass = h.action === 'approved' || h.action === 'dept_approved' || h.action === 'origin_approved' || h.action === 'target_approved' ? 'done'
                : (h.action === 'rejected' || h.action === 'admin_rejected') ? 'rejected'
                : isLast ? 'current' : 'done';
            const stageLabels = { origin: '소속부서', target: '대상부서', admin: '관리자' };
            const stagePrefix = h.stage ? stageLabels[h.stage] + ' ' : '';
            const actionLabel = {
                submitted: '제출',
                origin_approved: '1차 소속부서 승인',
                target_approved: '2차 대상부서 승인',
                dept_approved: '부서 승인',
                approved: '최종 승인',
                rejected: stagePrefix + '반려',
                revision_requested: stagePrefix + '수정요청',
                admin_rejected: '관리자 반려',
                admin_revision_requested: '관리자 수정요청',
                redirected: '부서 재배정',
            }[h.action] || h.action;
            const dateStr = safeDateStr(h.timestamp || h.at || h.date || '');
            const actorRoleMap = { dept_coordinator: '조정자', sub_coordinator: '센터장', admin: '본부장' };
            const roleLabel = h.actorRole ? actorRoleMap[h.actorRole] || '' : '';
            html += `<div class="timeline-item ${statusClass}">
                <div class="timeline-dot"></div>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-semibold text-slate-700">${actionLabel}</span>
                    <span class="text-[10px] text-slate-600 font-medium">${h.actor || h.by || ''}</span>
                    ${roleLabel ? `<span class="text-[9px] px-1 py-0.5 rounded bg-slate-100 text-slate-500">${roleLabel}</span>` : ''}
                    <span class="text-[10px] text-slate-400 ml-auto">${dateStr}</span>
                </div>
                ${h.comment || h.reason ? `<p class="text-[11px] text-slate-500 mt-0.5">${escapeHtml(h.comment || h.reason || '')}</p>` : ''}
            </div>`;
        });
        html += '</div>';
        return html;
    }

    function renderKanbanBoard(collabs) {
        const filtered = filterCollabs(collabs);
        const cols = classifyCollabs(filtered);

        document.getElementById('collab-total-count').textContent = `총 ${filtered.length}건`;

        // Stats ribbon
        const stDept = document.getElementById('kb-st-dept-review');
        const stTarget = document.getElementById('kb-st-admin-review');
        const stProgress = document.getElementById('kb-st-completed');
        const stDone = document.getElementById('kb-st-returned');
        if (stDept) stDept.textContent = cols.dept_review.length;
        if (stTarget) stTarget.textContent = cols.target_accept.length;
        if (stProgress) stProgress.textContent = cols.in_progress.length;
        if (stDone) stDone.textContent = cols.done_rejected.length;

        // Column counts
        const cntDept = document.getElementById('cnt-dept-review');
        const cntTarget = document.getElementById('cnt-admin-review');
        const cntProgress = document.getElementById('cnt-completed');
        const cntDone = document.getElementById('cnt-returned');
        if (cntDept) cntDept.textContent = cols.dept_review.length;
        if (cntTarget) cntTarget.textContent = cols.target_accept.length;
        if (cntProgress) cntProgress.textContent = cols.in_progress.length;
        if (cntDone) cntDone.textContent = cols.done_rejected.length;

        // Render columns
        renderKanbanColumn('body-dept-review', cols.dept_review, true);
        renderKanbanColumn('body-admin-review', cols.target_accept, true);
        renderKanbanColumn('body-completed', cols.in_progress, false);
        renderKanbanColumn('body-returned', cols.done_rejected, false);

        // Clean stale bulk selections and update bar
        const validIds = new Set(filtered.map(c => c.id));
        for (const id of bulkSelected) {
            if (!validIds.has(id)) bulkSelected.delete(id);
        }
        updateBulkBar();

        // Also update table view if active
        if (collabViewMode === 'table') {
            renderCollabTable(collabs);
        }
    }

    async function loadCollabPanel() {
        try {
            const [collabs, pendingData] = await Promise.all([
                api('/api/admin/linkages'),
                api('/api/admin/pending-approvals'),
            ]);
            allCollabs = collabs;
            const pendingCount = pendingData.count || pendingData.items?.length || 0;
            updateSidebarCollabBadge(pendingCount);
            renderKanbanBoard(collabs);
        } catch (e) {
            console.error('Linkage panel load error:', e);
        }
    }

    // ── View switching (Kanban ↔ Table) ──
    function switchCollabView(mode) {
        collabViewMode = mode;
        const kanbanEl = document.getElementById('collab-kanban');
        const tableEl = document.getElementById('collab-table-view');
        const kanbanBtn = document.getElementById('view-kanban-btn');
        const tableBtn = document.getElementById('view-table-btn');

        if (mode === 'kanban') {
            kanbanEl.style.display = '';
            tableEl.style.display = 'none';
            kanbanBtn.classList.add('active');
            tableBtn.classList.remove('active');
        } else {
            kanbanEl.style.display = 'none';
            tableEl.style.display = '';
            kanbanBtn.classList.remove('active');
            tableBtn.classList.add('active');
            renderCollabTable(allCollabs);
        }
    }

    function sortTable(key) {
        if (tableSortKey === key) {
            tableSortAsc = !tableSortAsc;
        } else {
            tableSortKey = key;
            tableSortAsc = true;
        }
        renderCollabTable(allCollabs);
    }

    function getCollabSortValue(c, key) {
        switch (key) {
            case 'id': return c.id || '';
            case 'title':
                if (c.category === 'referral' && c.targetService) return c.targetService;
                if (c.fromDept && c.toDept) return getDeptName(c.fromDept) + ' ' + getDeptName(c.toDept);
                return c.userName || '';
            case 'status': return c.approvalStatus || 'pending';
            case 'category': return c.category || '';
            case 'date': return c.createdAt || '';
            case 'dept':
                return getDeptName(c.toDept || c.fromDept || '');
            default: return '';
        }
    }

    function renderCollabTable(collabs) {
        const filtered = filterCollabs(collabs);

        // Sort
        const sorted = [...filtered].sort((a, b) => {
            const av = getCollabSortValue(a, tableSortKey);
            const bv = getCollabSortValue(b, tableSortKey);
            let cmp = 0;
            if (tableSortKey === 'date') {
                cmp = new Date(av).getTime() - new Date(bv).getTime();
            } else {
                cmp = String(av).localeCompare(String(bv), 'ko');
            }
            return tableSortAsc ? cmp : -cmp;
        });

        // Update sort arrows
        document.querySelectorAll('.collab-table thead th .sort-arrow').forEach(el => {
            el.textContent = 'unfold_more';
        });
        const activeHeader = document.querySelector(`.collab-table thead th[onclick="sortTable('${tableSortKey}')"] .sort-arrow`);
        if (activeHeader) {
            activeHeader.textContent = tableSortAsc ? 'expand_less' : 'expand_more';
        }

        const tbody = document.getElementById('collab-table-body');
        if (sorted.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-400 py-8">항목 없음</td></tr>';
            return;
        }

        tbody.innerHTML = sorted.map((c, idx) => {
            const approvalSt = c.approvalStatus ? (APPROVAL_STATUS_MAP[c.approvalStatus] || APPROVAL_STATUS_MAP.pending) : APPROVAL_STATUS_MAP.pending;
            const typeName = COLLAB_TYPE_MAP[c.type] || c.type || '-';
            const catLabel = c.category === 'referral' ? '서비스연계' : '부서협업';
            const dateStr = safeDateStr(c.createdAtISO || c.createdAt);
            const isBulkSelected = bulkSelected.has(c.id);

            let titleHtml = '';
            if (c.category === 'referral' && c.targetService) {
                titleHtml = `<span class="font-semibold text-blue-700">${escapeHtml(c.targetService)}</span>`;
            } else if (c.fromDept && c.toDept) {
                titleHtml = `<span class="text-indigo-700">${getDeptName(c.fromDept)}</span> <span class="text-slate-400">&rarr;</span> <span class="text-green-700">${getDeptName(c.toDept)}</span>`;
            } else {
                titleHtml = escapeHtml(c.userName || '-');
            }

            const deptName = c.toDept ? getDeptName(c.toDept) : (c.fromDept ? getDeptName(c.fromDept) : '-');

            return `<tr class="${isBulkSelected ? 'bulk-selected' : ''}" onclick="openTableRowDetail('${c.requestId}', event)">
                <td style="text-align:center" onclick="event.stopPropagation()">
                    <input type="checkbox" class="bulk-checkbox rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 w-3.5 h-3.5" ${isBulkSelected ? 'checked' : ''} onchange="toggleBulkSelect('${c.id}', this.checked); renderCollabTable(allCollabs)" />
                </td>
                <td class="font-mono text-xs text-slate-400">${shortId(c.id)}</td>
                <td>
                    <div class="flex items-center gap-1.5">
                        ${titleHtml}
                        <span class="text-[10px] text-slate-400">(${typeName})</span>
                    </div>
                    <p class="text-[11px] text-slate-400 truncate max-w-[220px]">${escapeHtml(c.userName || '-')} · ${escapeHtml(c.serviceName || '-')}</p>
                </td>
                <td><span class="badge ${approvalSt.bg} ${approvalSt.text}">${approvalSt.label}</span></td>
                <td><span class="text-xs">${catLabel}</span></td>
                <td class="text-xs text-slate-500 whitespace-nowrap">${dateStr}</td>
                <td class="text-xs text-slate-600">${deptName}</td>
            </tr>`;
        }).join('');

        // Update check-all state
        const checkAll = document.getElementById('collab-table-check-all');
        if (checkAll) {
            const allIds = sorted.map(c => c.id);
            checkAll.checked = allIds.length > 0 && allIds.every(id => bulkSelected.has(id));
        }
    }

    function toggleTableBulkAll(checked) {
        const filtered = filterCollabs(allCollabs);
        filtered.forEach(c => {
            if (checked) bulkSelected.add(c.id);
            else bulkSelected.delete(c.id);
        });
        updateBulkBar();
        renderCollabTable(allCollabs);
    }

    function openTableRowDetail(requestId, event) {
        if (event && event.target.closest('input[type="checkbox"]')) return;
        // Find linkageId by requestId and open in-panel detail view
        const collab = allCollabs.find(c => c.requestId === requestId);
        if (collab) {
            showCollabDetail(collab.id);
        } else if (requestId) {
            openDetail(requestId);
        }
    }

    // ── Drag & Drop ──
    function onDragStart(event, linkageId) {
        draggedLinkageId = linkageId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', linkageId);
        requestAnimationFrame(() => {
            const el = document.getElementById('kcard-' + linkageId);
            if (el) el.classList.add('dragging');
        });
    }

    function onDragEnd(event) {
        if (draggedLinkageId) {
            const el = document.getElementById('kcard-' + draggedLinkageId);
            if (el) el.classList.remove('dragging');
        }
        draggedLinkageId = null;
        document.querySelectorAll('.kanban-col').forEach(col => col.classList.remove('drag-over'));
    }

    function onDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        const col = event.currentTarget;
        if (!col.classList.contains('drag-over')) col.classList.add('drag-over');
    }

    function onDragLeave(event) {
        const col = event.currentTarget;
        if (!col.contains(event.relatedTarget)) col.classList.remove('drag-over');
    }

    async function onDrop(event, targetStatus) {
        event.preventDefault();
        const col = event.currentTarget;
        col.classList.remove('drag-over');
        const linkageId = event.dataTransfer.getData('text/plain');
        if (!linkageId) return;

        const collab = allCollabs.find(c => c.id === linkageId);
        if (!collab) return;

        const currentStatus = collab.approvalStatus || 'pending';
        if (currentStatus === targetStatus) return;

        await changeLinkageApprovalStatus(linkageId, targetStatus);
    }

    async function changeLinkageApprovalStatus(linkageId, targetStatus) {
        const endpointMap = {
            approved: 'approve',
            rejected: 'reject',
            admin_revision_requested: 'revision',
        };

        try {
            if (targetStatus === 'approved') {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/approve`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: '칸반 드래그 이동' }),
                });
                if (!resp.ok) throw new Error();
            } else if (targetStatus === 'rejected') {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/reject`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: '칸반 드래그 이동' }),
                });
                if (!resp.ok) throw new Error();
            } else if (targetStatus === 'pending' || targetStatus === 'dept_approved') {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/revision`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: '칸반 드래그 이동 (상태 재설정)' }),
                });
                if (!resp.ok) throw new Error();
            }
            loadCollabPanel();
        } catch (e) {
            alert('상태 변경 실패');
        }
    }

    // ── Bulk Actions ──
    function toggleBulkSelect(linkageId, checked) {
        if (checked) {
            bulkSelected.add(linkageId);
        } else {
            bulkSelected.delete(linkageId);
        }
        const card = document.getElementById('kcard-' + linkageId);
        if (card) card.classList.toggle('bulk-selected', checked);
        updateBulkBar();
    }

    function updateBulkBar() {
        const bar = document.getElementById('bulk-bar');
        const count = bulkSelected.size;
        if (count > 0) {
            bar.style.display = 'flex';
            document.getElementById('bulk-count').textContent = count + '건 선택';
        } else {
            bar.style.display = 'none';
        }
    }

    function clearBulkSelection() {
        bulkSelected.clear();
        document.querySelectorAll('.kanban-card.bulk-selected').forEach(el => el.classList.remove('bulk-selected'));
        document.querySelectorAll('.collab-table tr.bulk-selected').forEach(el => el.classList.remove('bulk-selected'));
        document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = false);
        const checkAll = document.getElementById('collab-table-check-all');
        if (checkAll) checkAll.checked = false;
        updateBulkBar();
    }

    async function bulkChangeStatus() {
        const targetStatus = document.getElementById('bulk-status-select').value;
        if (!targetStatus) { alert('변경할 상태를 선택하세요.'); return; }
        if (bulkSelected.size === 0) return;

        const ids = [...bulkSelected];
        const confirmMsg = `${ids.length}건의 항목을 일괄 변경하시겠습니까?`;
        if (!confirm(confirmMsg)) return;

        const endpointForStatus = (status) => {
            if (status === 'approved') return 'approve';
            if (status === 'rejected') return 'reject';
            return 'revision';
        };
        const endpoint = endpointForStatus(targetStatus);
        const comment = '일괄 상태 변경';

        let failCount = 0;
        for (const linkageId of ids) {
            try {
                const resp = await fetch(`/api/admin/linkage/${linkageId}/${endpoint}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment }),
                });
                if (!resp.ok) failCount++;
            } catch { failCount++; }
        }
        if (failCount > 0) alert(`${failCount}건 처리 실패`);
        bulkSelected.clear();
        updateBulkBar();
        document.getElementById('bulk-status-select').value = '';
        loadCollabPanel();
    }

    // ── Requests ──
    async function loadRequests() {
        const status = document.getElementById('filter-status').value;
        const search = document.getElementById('filter-search').value;

        try {
            const data = await api(`/api/admin/requests?status=${status}&search=${encodeURIComponent(search)}&page=${currentPage}&limit=20&sort=${currentSort}`);
            const tbody = document.getElementById('requests-tbody');

            if (data.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">결과 없음</td></tr>';
            } else {
                tbody.innerHTML = data.items.map(r => `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-mono text-xs text-slate-400">${shortId(r.id)}</td>
                        <td class="px-4 py-3 font-medium">${escapeHtml(r.userName || '-')}</td>
                        <td class="px-4 py-3 hidden sm:table-cell text-slate-500">${escapeHtml(r.userPhone || '-')}</td>
                        <td class="px-4 py-3 max-w-[200px] truncate">${escapeHtml(r.serviceName || '-')}</td>
                        <td class="px-4 py-3">${statusBadge(r.status)}</td>
                        <td class="px-4 py-3 hidden md:table-cell text-slate-500 text-xs">${formatDate(r)}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="openDetail('${r.id}')" class="p-1.5 hover:bg-primary/10 rounded-lg text-primary transition-colors">
                                <span class="material-symbols-outlined text-lg" aria-hidden="true">open_in_new</span>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Pagination
            document.getElementById('page-info').textContent = `${data.total}건 중 ${(data.page-1)*20+1}-${Math.min(data.page*20, data.total)}`;
            const pageBox = document.getElementById('page-buttons');
            let btns = '';
            if (data.page > 1) btns += `<button onclick="goPage(${data.page-1})" class="px-3 py-1 rounded border border-slate-300 hover:bg-slate-100">이전</button>`;
            for (let i = 1; i <= data.totalPages; i++) {
                const active = i === data.page ? 'bg-primary text-white border-primary' : 'border-slate-300 hover:bg-slate-100';
                btns += `<button onclick="goPage(${i})" class="px-3 py-1 rounded border ${active}">${i}</button>`;
            }
            if (data.page < data.totalPages) btns += `<button onclick="goPage(${data.page+1})" class="px-3 py-1 rounded border border-slate-300 hover:bg-slate-100">다음</button>`;
            pageBox.innerHTML = btns;
        } catch (e) {
            console.error('Requests load error:', e);
        }
    }

    function goPage(p) { currentPage = p; loadRequests(); }
    function debounceSearch() { clearTimeout(searchTimer); searchTimer = setTimeout(() => { currentPage = 1; loadRequests(); }, 300); }
    function toggleSort() {
        currentSort = currentSort === 'newest' ? 'oldest' : 'newest';
        document.getElementById('sort-label').textContent = currentSort === 'newest' ? '최신순' : '오래된순';
        currentPage = 1;
        loadRequests();
    }

    // ── Detail Modal ──
    async function openDetail(id) {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        // Reset and trigger slide-in
        panel.classList.remove('animate-slide-out-right');
        panel.classList.add('animate-slide-in-right');
        document.getElementById('modal-body').innerHTML = '<p class="text-slate-400 py-8 text-center">로딩 중...</p>';

        try {
            const data = await api(`/api/admin/requests/${id}`);
            renderDetail(data);
        } catch (e) {
            document.getElementById('modal-body').innerHTML = '<p class="text-red-500">데이터를 불러올 수 없습니다.</p>';
        }
    }

    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        panel.classList.remove('animate-slide-in-right');
        panel.classList.add('animate-slide-out-right');
        setTimeout(() => {
            modal.classList.add('hidden');
            panel.classList.remove('animate-slide-out-right');
        }, 250);
    }

    function renderDetail(data) {
        const el = document.getElementById('modal-body');
        const chain = data.chain || [];
        const notes = data.notes || [];

        el.innerHTML = `
            <!-- Basic Info -->
            <div class="space-y-3 mb-6">
                <div class="flex items-center justify-between">
                    <span class="text-xs text-slate-400 font-mono">${data.id}</span>
                    ${statusBadge(data.status)}
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><span class="text-slate-400 block text-xs mb-0.5">이름</span><span class="font-medium">${data.userName || '-'}</span></div>
                    <div><span class="text-slate-400 block text-xs mb-0.5">전화</span><span class="font-medium">${data.userPhone || '-'}</span></div>
                    <div class="col-span-2"><span class="text-slate-400 block text-xs mb-0.5">서비스명</span><span class="font-medium">${data.serviceName || '-'}</span></div>
                    <div><span class="text-slate-400 block text-xs mb-0.5">접수일</span><span>${data.createdAt || '-'}</span></div>
                    <div><span class="text-slate-400 block text-xs mb-0.5">최종 수정</span><span>${data.updatedAt ? new Date(data.updatedAt).toLocaleString('ko-KR') : '-'}</span></div>
                </div>
            </div>

            <!-- Conversation Summary -->
            ${data.conversationSummary ? `
            <div class="mb-6 p-4 bg-purple-50 border border-purple-100 rounded-lg">
                <h4 class="text-xs font-semibold text-purple-700 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">smart_toy</span>AI 대화 요약
                </h4>
                <p class="text-sm text-slate-700 whitespace-pre-line leading-relaxed">${escapeHtml(data.conversationSummary)}</p>
            </div>` : ''}

            <!-- Referral Chain -->
            ${chain.length > 1 ? `
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-3 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">link</span>연계 체인
                </h4>
                <div class="space-y-2">
                    ${chain.map(c => `
                        <div class="flex items-center gap-2 text-sm p-2 rounded-lg ${c.current ? 'bg-primary/5 border border-primary/20' : 'bg-slate-50'}">
                            ${statusBadge(c.status)}
                            <span class="${c.current ? 'font-semibold text-primary' : 'text-slate-600'}">${c.serviceName}</span>
                            ${c.reason ? `<span class="text-xs text-slate-400 ml-auto">${c.reason}</span>` : ''}
                        </div>
                    `).join('<div class="flex justify-center"><span class="material-symbols-outlined text-slate-300 text-sm" aria-hidden="true">arrow_downward</span></div>')}
                </div>
            </div>` : ''}

            <!-- 연계 요청 (linkages) -->
            ${(data.linkages && data.linkages.length > 0) ? `
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">hub</span>연계 (${data.linkages.length})
                </h4>
                <div class="space-y-2">
                    ${data.linkages.map(l => {
                        const ast = APPROVAL_STATUS_MAP[l.approvalStatus] || APPROVAL_STATUS_MAP.pending;
                        const typeName = COLLAB_TYPE_MAP[l.type] || l.type || '-';
                        const isDeptApproved = l.approvalStatus === 'target_approved' || l.approvalStatus === 'dept_approved';
                        const isApproved = l.approvalStatus === 'approved';

                        let dirHtml = '';
                        if (l.category === 'referral' && l.targetService) {
                            dirHtml = `<span class="font-semibold text-blue-700">${escapeHtml(l.targetService)}</span>`;
                        } else if (l.fromDept && l.toDept) {
                            dirHtml = `<span class="font-semibold text-indigo-700">${getDeptName(l.fromDept)}</span>
                                <span class="material-symbols-outlined text-slate-400 text-sm" aria-hidden="true">arrow_forward</span>
                                <span class="font-semibold text-green-700">${getDeptName(l.toDept)}</span>`;
                        }

                        const bgClass = isDeptApproved ? 'bg-blue-50 border border-blue-200'
                            : isApproved ? 'bg-green-50 border border-green-100'
                            : l.approvalStatus === 'origin_approved' ? 'bg-sky-50 border border-sky-200'
                            : l.approvalStatus === 'rejected' || l.approvalStatus === 'admin_rejected' || l.approvalStatus === 'admin_revision_requested' ? 'bg-red-50 border border-red-100'
                            : l.approvalStatus === 'redirected' ? 'bg-purple-50 border border-purple-100'
                            : l.approvalStatus === 'pending' ? 'bg-yellow-50 border border-yellow-200'
                            : 'bg-slate-50 border border-slate-100';

                        return `<div class="p-3 ${bgClass} rounded-lg text-sm">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="badge ${ast.bg} ${ast.text}">${ast.label}</span>
                                <span class="text-xs text-slate-400">${l.category === 'referral' ? '서비스연계' : typeName}</span>
                                ${l.executionStatus ? '<span class="text-xs text-blue-600">' + l.executionStatus + '</span>' : ''}
                                <span class="text-xs text-slate-400 ml-auto">${safeDateStr(l.createdAtISO || l.createdAt)}</span>
                            </div>
                            ${renderApprovalStepper(l.approvalStatus)}
                            <div class="flex items-center gap-1.5 text-sm mb-1">${dirHtml}</div>
                            <p class="text-xs text-slate-600">${escapeHtml(l.reason)}</p>
                            ${l.notes && l.notes.length > 0 ? '<div class="mt-1.5 pt-1.5 border-t border-indigo-100 space-y-1">' + l.notes.map(n => '<div class="flex gap-1.5 text-xs"><span class="font-semibold text-indigo-600">' + escapeHtml(n.dept || n.author) + '</span><span class="text-slate-600">' + escapeHtml(n.text) + '</span><span class="text-slate-300 ml-auto">' + safeDateStr(n.createdAt) + '</span></div>').join('') + '</div>' : ''}
                            ${isDeptApproved ? `<div class="mt-2 pt-2 border-t border-blue-200 flex flex-wrap gap-1.5"><button onclick="approveLinkage('${l.id}',event)" class="px-2.5 py-1 bg-green-600 text-white rounded text-xs font-semibold hover:bg-green-700">최종 승인</button><button onclick="rejectLinkage('${l.id}',event)" class="px-2.5 py-1 bg-white border border-red-300 text-red-600 rounded text-xs font-semibold hover:bg-red-50">반려</button><button onclick="revisionLinkage('${l.id}',event)" class="px-2.5 py-1 bg-white border border-orange-300 text-orange-600 rounded text-xs font-semibold hover:bg-orange-50">수정요청</button><div class="flex-1"></div><div class="flex gap-1"><input id="admin-lnote-${l.id}" type="text" placeholder="메모..." class="border border-slate-300 rounded px-2 py-1 text-xs w-28 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addAdminLinkageNote('${data.id}','${l.id}')" /><button onclick="addAdminLinkageNote('${data.id}','${l.id}')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700">추가</button></div></div>` : ''}
                        </div>`;
                    }).join('')}
                </div>
            </div>` : ''}

            <!-- 서비스 계획 설계 -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">route</span>서비스 계획
                </h4>
                <div id="service-plan-editor-${data.id}" class="space-y-2">
                    ${(data.servicePlan && data.servicePlan.steps && data.servicePlan.steps.length > 0) ? data.servicePlan.steps.map((s, i) => `
                        <div class="flex items-center gap-2 text-sm p-2 rounded bg-slate-50">
                            <span class="text-xs font-bold text-slate-500">${i+1}</span>
                            <span class="font-medium">${escapeHtml(s.serviceName)}</span>
                            <span class="badge ${s.status === 'completed' ? 'bg-green-100 text-green-700' : s.status === 'in_progress' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500'} ml-auto">${s.status === 'completed' ? '완료' : s.status === 'in_progress' ? '진행' : '대기'}</span>
                        </div>
                    `).join('') : '<p class="text-xs text-slate-400">서비스 계획 없음</p>'}
                </div>
                <div class="mt-2 flex gap-2">
                    <input id="sp-input-${data.id}" type="text" placeholder="서비스명 추가..." class="flex-1 rounded border-slate-300 text-xs py-1.5 px-2 focus:ring-primary focus:border-primary" />
                    <button onclick="addServicePlanStep('${data.id}')" class="px-3 py-1.5 bg-primary text-white rounded text-xs font-semibold hover:bg-primary-light">추가</button>
                </div>
            </div>

            <!-- 담당자 처리 페이지 링크 -->
            <div class="mb-4">
                <a href="/case/${data.id}" target="_blank" class="flex items-center gap-2 px-4 py-2.5 bg-green-50 border border-green-200 rounded-lg text-sm font-semibold text-green-700 hover:bg-green-100 transition-colors">
                    <span class="material-symbols-outlined text-lg" aria-hidden="true">open_in_new</span>
                    담당자 처리 페이지 열기
                </a>
            </div>

            <!-- Status Change -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-slate-500 mb-2">상태 변경</h4>
                <p class="text-xs text-amber-600 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">warning</span>
                    관리자 오버라이드 - 일반적으로 담당자 처리 페이지에서 상태를 변경합니다.
                </p>
                <div class="flex flex-wrap gap-1.5">
                    ${Object.entries(STATUS_MAP).map(([key, val]) => `
                        <button onclick="changeStatus('${data.id}', '${key}')" class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${data.status === key ? val.bg + ' ' + val.text + ' border-current' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-400'}">
                            ${val.label}
                        </button>
                    `).join('')}
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <h4 class="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm" aria-hidden="true">sticky_note_2</span>메모 (${notes.length})
                </h4>
                <div class="space-y-2 mb-3 max-h-[200px] overflow-y-auto">
                    ${notes.length > 0 ? notes.map(n => {
                        const author = n.author || '관리자';
                        const authorBadge = author === '담당자'
                            ? '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700">담당자</span>'
                            : '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-semibold bg-amber-100 text-amber-700">관리자</span>';
                        return `<div class="p-3 bg-amber-50 rounded-lg text-sm">
                            <div class="flex items-center gap-1.5 mb-1">${authorBadge}<span class="text-xs text-slate-400">${safeDateStr(n.createdAt)}</span></div>
                            <p class="text-slate-700">${escapeHtml(n.text)}</p>
                        </div>`;
                    }).join('') : '<p class="text-sm text-slate-400">메모 없음</p>'}
                </div>
                <div class="flex gap-2">
                    <input id="note-input" type="text" placeholder="메모 입력..." class="flex-1 rounded-lg border-slate-300 text-sm py-2 px-3 focus:ring-primary focus:border-primary" onkeydown="if(event.key==='Enter')addNote('${data.id}')" />
                    <button onclick="addNote('${data.id}')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-light transition-colors">추가</button>
                </div>
            </div>
        `;
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function changeStatus(id, status) {
        try {
            await fetch(`/api/admin/requests/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }),
            });
            openDetail(id);
            if (currentTab === 'requests') loadRequests();
            if (currentTab === 'dashboard') loadDashboard();
        } catch (e) {
            alert('상태 변경 실패');
        }
    }

    async function addNote(id) {
        const input = document.getElementById('note-input');
        const note = input.value.trim();
        if (!note) return;
        try {
            await fetch(`/api/admin/requests/${id}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note }),
            });
            openDetail(id);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    // ── 연계 조정 (관리자 승인/반려/수정요청) ──
    // Legacy prompt-based versions (used by dashboard detail modal)
    async function approveLinkage(linkageId, event) {
        if (event) event.stopPropagation();
        const comment = prompt('승인 코멘트 (선택):') || '';
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error || ''); }
            alert('최종 승인 완료. 이메일이 발송되었습니다.');
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'collab') loadCollabPanel();
        } catch (e) {
            alert('승인 처리 실패');
        }
    }

    async function rejectLinkage(linkageId, event) {
        if (event) event.stopPropagation();
        const comment = prompt('반려 사유를 입력하세요:');
        if (comment === null) return;
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'collab') loadCollabPanel();
        } catch (e) {
            alert('반려 처리 실패');
        }
    }

    async function revisionLinkage(linkageId, event) {
        if (event) event.stopPropagation();
        const comment = prompt('수정 요청 사항을 입력하세요:');
        if (comment === null) return;
        try {
            const resp = await fetch(`/api/admin/linkage/${linkageId}/revision`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment }),
            });
            if (!resp.ok) throw new Error();
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'collab') loadCollabPanel();
        } catch (e) {
            alert('수정 요청 실패');
        }
    }

    async function addAdminLinkageNote(requestId, linkageId) {
        const input = document.getElementById('admin-lnote-' + linkageId);
        const text = input.value.trim();
        if (!text) return;
        try {
            await fetch(`/api/case/${requestId}/linkage/${linkageId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, author: '관리자', dept: '관리자' }),
            });
            input.value = '';
            openDetail(requestId);
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    // 서비스 계획 관리
    async function addServicePlanStep(requestId) {
        const input = document.getElementById('sp-input-' + requestId);
        const serviceName = input.value.trim();
        if (!serviceName) return;

        // 기존 계획 가져오기
        try {
            const data = await api(`/api/admin/requests/${requestId}`);
            const existingSteps = (data.servicePlan && data.servicePlan.steps) ? data.servicePlan.steps : [];
            existingSteps.push({ order: existingSteps.length + 1, serviceName, status: 'pending' });

            await fetch(`/api/case/${requestId}/service-plan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: existingSteps }),
            });
            input.value = '';
            openDetail(requestId);
        } catch (e) {
            alert('서비스 계획 저장 실패');
        }
    }

    // ── Analytics ──
    let cachedAnalytics = null;
    let cachedTrends = null;

    async function loadAnalytics() {
        try {
            const [analytics, trends] = await Promise.all([api('/api/admin/analytics'), api('/api/admin/trends?days=30')]);
            cachedAnalytics = analytics;
            cachedTrends = trends;
            const kpi = analytics.kpi || {};

            // KPI 카드
            const kpiEl = document.getElementById('analytics-kpi');
            if (kpiEl) {
                const kpiItems = [
                    { label: '총 상담', value: kpi.chatRequest || 0, icon: 'chat', color: 'blue' },
                    { label: '서비스 신청', value: kpi.serviceApply || 0, icon: 'description', color: 'green' },
                    { label: '전환율', value: (kpi.conversionRate || 0) + '%', icon: 'trending_up', color: 'purple' },
                    { label: 'RAG 매칭률', value: (kpi.ragMatchRate || 0) + '%', icon: 'search', color: 'teal' },
                    { label: '음성 비율', value: (kpi.voiceRate || 0) + '%', icon: 'mic', color: 'amber' },
                ];
                kpiEl.innerHTML = kpiItems.map(k => `
                    <div class="group relative bg-white rounded-xl border border-slate-200/80 px-3 py-2.5 flex items-center gap-2.5 shadow-sm hover:shadow-md hover:border-slate-300 transition-all overflow-hidden">
                        <div class="absolute inset-y-0 left-0 w-[3px] rounded-r bg-${k.color}-500"></div>
                        <div class="w-8 h-8 rounded-lg bg-${k.color}-50 flex items-center justify-center flex-shrink-0 ml-1">
                            <span class="material-symbols-outlined text-${k.color}-500" style="font-size:16px">${k.icon}</span>
                        </div>
                        <div class="min-w-0">
                            <p class="text-[10px] text-slate-400 font-medium truncate">${k.label}</p>
                            <p class="text-base font-extrabold text-slate-800 leading-tight">${k.value}</p>
                        </div>
                    </div>
                `).join('');
            }

            // 1. 서비스 인기 랭킹 (horizontal bar)
            const ranking = analytics.serviceRanking.slice(0, 10);
            renderHorizontalBarChart('chart-service', ranking.map(r => r.name.length > 12 ? r.name.slice(0, 12) + '..' : r.name), ranking.map(r => r.count));

            // 2. 카테고리 분포 (doughnut)
            const catLabels = Object.keys(analytics.categoryCount);
            const catValues = Object.values(analytics.categoryCount);
            renderDoughnutChart('chart-category', catLabels, catValues);

            // 3. 상태별 현황 (doughnut)
            const STATUS_KR = { open: '접수', confirmed: '확인', contacted: '연락', connected: '연결', providing: '제공중', closed: '종결', referred: '연계' };
            const sd = analytics.statusDist || {};
            const sdLabels = Object.keys(sd).filter(k => sd[k] > 0).map(k => STATUS_KR[k] || k);
            const sdValues = Object.keys(sd).filter(k => sd[k] > 0).map(k => sd[k]);
            renderDoughnutChart('chart-status-dist', sdLabels, sdValues);

            // 4. 종결 케이스 처리 소요일 (bar)
            const db = analytics.durationBuckets || {};
            renderBarChart('chart-duration', Object.keys(db), Object.values(db), '건수', '#FF9800');

            // 5. 시간대별 접수 분포 (bar)
            const hourLabels = (analytics.hourlyDist || []).map((_, i) => i + '시');
            renderBarChart('chart-hourly', hourLabels, analytics.hourlyDist || [], '접수 건수', '#1565C0');

            // 6. 요일별 접수 분포 (bar)
            const WEEKDAY_KR = ['일', '월', '화', '수', '목', '금', '토'];
            renderBarChart('chart-weekday', WEEKDAY_KR, analytics.weekdayDist || [], '접수 건수', '#7B1FA2');

            // 7. 주간 접수 추이 (bar)
            const wt = analytics.weeklyTrend || [];
            renderBarChart('chart-weekly', wt.map(w => w.label), wt.map(w => w.count), '접수 건수', '#2E7D32');

            // 8. 서비스별 종결률 (horizontal bar with %)
            const cr = analytics.completionRanking || [];
            renderCompletionChart('chart-completion', cr);

            // 9. 연계 승인 현황 (doughnut)
            const ls = analytics.linkageStats || {};
            const lsLabels = ['대기', '승인', '반려', '수정요청'].filter((_, i) => [ls.pending, ls.approved, ls.rejected, ls.revision][i] > 0);
            const lsValues = [ls.pending, ls.approved, ls.rejected, ls.revision].filter(v => v > 0);
            if (lsValues.length > 0) {
                renderDoughnutChart('chart-linkage-status', lsLabels, lsValues);
            }

            // 10. 부서/서비스별 연계 (horizontal bar)
            const dlr = analytics.deptLinkageRanking || [];
            renderHorizontalBarChart('chart-dept-linkage', dlr.map(d => d.name.length > 12 ? d.name.slice(0, 12) + '..' : d.name), dlr.map(d => d.count));

            // 11. 이벤트 추이 (30일 line)
            const trendLabels = trends.map(t => t.date.slice(5));
            renderLineChart('chart-trends', trendLabels, trends);
        } catch (e) {
            console.error('Analytics load error:', e);
        }
    }

    function renderCompletionChart(id, data) {
        destroyChart(id);
        if (!data.length) return;
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: data.map(d => d.name.length > 12 ? d.name.slice(0, 12) + '..' : d.name),
                datasets: [{
                    label: '종결률 %',
                    data: data.map(d => d.rate),
                    backgroundColor: '#2E7D3220',
                    borderColor: '#2E7D32',
                    borderWidth: 2,
                    borderRadius: 4,
                }],
            },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const item = data[ctx.dataIndex];
                                return `${item.rate}% (${item.closed}/${item.total})`;
                            },
                        },
                    },
                },
                scales: {
                    x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%', font: { size: 10 } } },
                    y: { grid: { display: false }, ticks: { font: { size: 10 } } },
                },
            },
        });
    }

    // ── Analytics Detail Modal ──
    let analyticsModalOpen = false;

    function openAnalyticsDetail(type) {
        if (!cachedAnalytics) return;
        const a = cachedAnalytics;
        const modal = document.getElementById('analytics-detail-modal');
        const titleEl = document.getElementById('analytics-modal-title');
        const chartWrap = document.getElementById('analytics-modal-chart');
        const tableEl = document.getElementById('analytics-modal-table');

        const STATUS_KR = { open: '접수', confirmed: '확인', contacted: '연락', connected: '연결', providing: '제공중', closed: '종결', referred: '연계' };
        const WEEKDAY_KR = ['일', '월', '화', '수', '목', '금', '토'];

        let title = '', chartFn = null, tableHtml = '';

        if (type === 'service') {
            title = '<span class="material-symbols-outlined text-sm text-primary">leaderboard</span> 서비스 인기 랭킹';
            const data = a.serviceRanking || [];
            const total = data.reduce((s, r) => s + r.count, 0);
            chartFn = () => renderHorizontalBarChart('chart-modal-detail', data.map(r => r.name.length > 18 ? r.name.slice(0, 18) + '..' : r.name), data.map(r => r.count));
            tableHtml = buildTable(['순위', '서비스명', '건수', '비율'], data.map((r, i) => [
                i + 1, r.name, r.count + '건', total > 0 ? Math.round(r.count / total * 100) + '%' : '-'
            ]));
        } else if (type === 'category') {
            title = '<span class="material-symbols-outlined text-sm" style="color:#4A1942">donut_large</span> 카테고리 분포';
            const labels = Object.keys(a.categoryCount || {});
            const values = Object.values(a.categoryCount || {});
            const total = values.reduce((s, v) => s + v, 0);
            chartFn = () => renderDoughnutChart('chart-modal-detail', labels, values);
            tableHtml = buildTable(['카테고리', '건수', '비율'], labels.map((l, i) => [
                l, values[i] + '건', total > 0 ? Math.round(values[i] / total * 100) + '%' : '-'
            ]));
        } else if (type === 'status') {
            title = '<span class="material-symbols-outlined text-sm text-teal-600">pie_chart</span> 상태별 현황';
            const sd = a.statusDist || {};
            const keys = Object.keys(sd);
            const total = keys.reduce((s, k) => s + sd[k], 0);
            chartFn = () => {
                const filteredKeys = keys.filter(k => sd[k] > 0);
                renderDoughnutChart('chart-modal-detail', filteredKeys.map(k => STATUS_KR[k] || k), filteredKeys.map(k => sd[k]));
            };
            tableHtml = buildTable(['상태', '건수', '비율'], keys.map(k => [
                STATUS_KR[k] || k, sd[k] + '건', total > 0 ? Math.round(sd[k] / total * 100) + '%' : '0%'
            ]));
        } else if (type === 'hourly') {
            title = '<span class="material-symbols-outlined text-sm text-blue-500">schedule</span> 시간대별 접수 분포';
            const dist = a.hourlyDist || [];
            const total = dist.reduce((s, v) => s + v, 0);
            const peak = dist.indexOf(Math.max(...dist));
            chartFn = () => renderBarChart('chart-modal-detail', dist.map((_, i) => i + '시'), dist, '접수 건수', '#1565C0');
            tableHtml = `<div class="mb-3 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                <strong>피크 시간대:</strong> ${peak}시 (${dist[peak]}건) &nbsp;|&nbsp; <strong>총 접수:</strong> ${total}건
            </div>` + buildTable(['시간', '건수', '비율'], dist.map((v, i) => [
                i + '시', v + '건', total > 0 ? Math.round(v / total * 100) + '%' : '-'
            ]).filter(r => parseInt(r[1]) > 0));
        } else if (type === 'weekday') {
            title = '<span class="material-symbols-outlined text-sm text-purple-600">date_range</span> 요일별 접수 분포';
            const dist = a.weekdayDist || [];
            const total = dist.reduce((s, v) => s + v, 0);
            const peak = dist.indexOf(Math.max(...dist));
            chartFn = () => renderBarChart('chart-modal-detail', WEEKDAY_KR, dist, '접수 건수', '#7B1FA2');
            tableHtml = `<div class="mb-3 p-3 bg-purple-50 rounded-lg text-xs text-purple-800">
                <strong>최다 요일:</strong> ${WEEKDAY_KR[peak]}요일 (${dist[peak]}건) &nbsp;|&nbsp; <strong>총 접수:</strong> ${total}건
            </div>` + buildTable(['요일', '건수', '비율'], WEEKDAY_KR.map((d, i) => [
                d + '요일', dist[i] + '건', total > 0 ? Math.round(dist[i] / total * 100) + '%' : '-'
            ]));
        } else if (type === 'duration') {
            title = '<span class="material-symbols-outlined text-sm text-amber-600">timer</span> 종결 케이스 처리 소요일';
            const db = a.durationBuckets || {};
            const keys = Object.keys(db);
            const values = Object.values(db);
            const total = values.reduce((s, v) => s + v, 0);
            chartFn = () => renderBarChart('chart-modal-detail', keys, values, '건수', '#FF9800');
            tableHtml = `<div class="mb-3 p-3 bg-amber-50 rounded-lg text-xs text-amber-800">
                <strong>종결 건수:</strong> ${total}건 &nbsp;|&nbsp; <strong>당일 처리:</strong> ${db['당일'] || 0}건 (${total > 0 ? Math.round((db['당일'] || 0) / total * 100) : 0}%)
            </div>` + buildTable(['소요 기간', '건수', '비율'], keys.map((k, i) => [
                k, values[i] + '건', total > 0 ? Math.round(values[i] / total * 100) + '%' : '-'
            ]));
        } else if (type === 'weekly') {
            title = '<span class="material-symbols-outlined text-sm text-green-600">trending_up</span> 주간 접수 추이 (4주)';
            const wt = a.weeklyTrend || [];
            chartFn = () => renderBarChart('chart-modal-detail', wt.map(w => w.label), wt.map(w => w.count), '접수 건수', '#2E7D32');
            const total = wt.reduce((s, w) => s + w.count, 0);
            const avg = wt.length > 0 ? Math.round(total / wt.length) : 0;
            tableHtml = `<div class="mb-3 p-3 bg-green-50 rounded-lg text-xs text-green-800">
                <strong>4주 합계:</strong> ${total}건 &nbsp;|&nbsp; <strong>주 평균:</strong> ${avg}건
            </div>` + buildTable(['주간', '건수'], wt.map(w => [w.label, w.count + '건']));
        } else if (type === 'completion') {
            title = '<span class="material-symbols-outlined text-sm text-green-700">check_circle</span> 서비스별 종결률';
            const cr = a.completionRanking || [];
            chartFn = () => renderCompletionChart('chart-modal-detail', cr);
            tableHtml = buildTable(['서비스명', '총 건수', '종결', '종결률'], cr.map(c => [
                c.name, c.total + '건', c.closed + '건', c.rate + '%'
            ]));
        } else if (type === 'linkage') {
            title = '<span class="material-symbols-outlined text-sm text-indigo-600">hub</span> 연계 승인 현황';
            const ls = a.linkageStats || {};
            const lbls = ['대기', '승인', '반려', '수정요청'];
            const vals = [ls.pending, ls.approved, ls.rejected, ls.revision];
            chartFn = () => {
                const fLbls = lbls.filter((_, i) => vals[i] > 0);
                const fVals = vals.filter(v => v > 0);
                if (fVals.length > 0) renderDoughnutChart('chart-modal-detail', fLbls, fVals);
            };
            tableHtml = `<div class="mb-3 p-3 bg-indigo-50 rounded-lg text-xs text-indigo-800">
                <strong>총 연계:</strong> ${ls.total || 0}건 &nbsp;|&nbsp; <strong>승인율:</strong> ${ls.total > 0 ? Math.round((ls.approved || 0) / ls.total * 100) : 0}%
            </div>` + buildTable(['상태', '건수', '비율'], lbls.map((l, i) => [
                l, vals[i] + '건', ls.total > 0 ? Math.round(vals[i] / ls.total * 100) + '%' : '-'
            ]));
        } else if (type === 'deptLinkage') {
            title = '<span class="material-symbols-outlined text-sm text-orange-600">apartment</span> 부서/서비스별 연계 현황';
            const dlr = a.deptLinkageRanking || [];
            const total = dlr.reduce((s, d) => s + d.count, 0);
            chartFn = () => renderHorizontalBarChart('chart-modal-detail', dlr.map(d => d.name.length > 18 ? d.name.slice(0, 18) + '..' : d.name), dlr.map(d => d.count));
            tableHtml = buildTable(['순위', '부서/서비스', '건수', '비율'], dlr.map((d, i) => [
                i + 1, d.name, d.count + '건', total > 0 ? Math.round(d.count / total * 100) + '%' : '-'
            ]));
        } else if (type === 'trends') {
            title = '<span class="material-symbols-outlined text-sm text-blue-500">show_chart</span> 이벤트 추이 (30일)';
            const trends = cachedTrends || [];
            chartFn = () => {
                const trendLabels = trends.map(t => t.date.slice(5));
                renderLineChart('chart-modal-detail', trendLabels, trends);
            };
            const totals = { chat_request: 0, rag_match: 0, service_apply: 0, tts_request: 0 };
            trends.forEach(t => { for (const k in totals) totals[k] += (t[k] || 0); });
            tableHtml = `<div class="mb-3 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                <strong>30일 합계</strong> &mdash; 채팅: ${totals.chat_request}건 &nbsp;|&nbsp; RAG: ${totals.rag_match}건 &nbsp;|&nbsp; 신청: ${totals.service_apply}건 &nbsp;|&nbsp; TTS: ${totals.tts_request}건
            </div>` + buildTable(['날짜', '채팅', 'RAG', '신청', 'TTS'], trends.slice().reverse().map(t => [
                t.date, t.chat_request || 0, t.rag_match || 0, t.service_apply || 0, t.tts_request || 0
            ]));
        }

        titleEl.innerHTML = title;
        tableEl.innerHTML = tableHtml;
        chartWrap.style.display = chartFn ? '' : 'none';

        modal.classList.add('active');
        analyticsModalOpen = true;

        if (chartFn) setTimeout(chartFn, 50);
    }

    function closeAnalyticsModal() {
        const modal = document.getElementById('analytics-detail-modal');
        modal.classList.remove('active');
        analyticsModalOpen = false;
        destroyChart('chart-modal-detail');
    }

    function buildTable(headers, rows) {
        if (!rows.length) return '<p class="text-xs text-slate-400 py-4 text-center">데이터 없음</p>';
        return `<div class="max-h-[260px] overflow-y-auto rounded-xl border border-slate-200 shadow-sm">
            <table class="analytics-detail-table">
            <thead><tr>${headers.map(h => '<th>' + h + '</th>').join('')}</tr></thead>
            <tbody>${rows.map((r, i) => '<tr>' + r.map((c, j) => '<td' + (j === 0 ? ' class="font-medium"' : '') + '>' + c + '</td>').join('') + '</tr>').join('')}</tbody>
            </table></div>`;
    }

    // ── Chart renderers ──
    function destroyChart(id) {
        if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    }

    function renderBarChart(id, labels, data, label, color) {
        destroyChart(id);
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ label, data, backgroundColor: color + '20', borderColor: color, borderWidth: 1.5, borderRadius: 3 }],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { font: { size: 9 } } },
                },
            },
        });
    }

    function renderHorizontalBarChart(id, labels, data) {
        destroyChart(id);
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ data, backgroundColor: '#98002E20', borderColor: '#98002E', borderWidth: 1.5, borderRadius: 3 }],
            },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } } },
                    y: { grid: { display: false }, ticks: { font: { size: 10 } } },
                },
            },
        });
    }

    function renderDoughnutChart(id, labels, data) {
        destroyChart(id);
        const colors = ['#98002E', '#4A1942', '#1565C0', '#2E7D32', '#FF9800', '#607D8B', '#795548', '#00BCD4'];
        charts[id] = new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { padding: 8, font: { size: 10 }, boxWidth: 10 } },
                },
            },
        });
    }

    function renderLineChart(id, labels, trends) {
        destroyChart(id);
        const eventTypes = [
            { key: 'chat_request', label: '채팅', color: '#98002E' },
            { key: 'rag_match', label: 'RAG', color: '#2E7D32' },
            { key: 'service_apply', label: '신청', color: '#1565C0' },
            { key: 'tts_request', label: 'TTS', color: '#FF9800' },
        ];
        const datasets = eventTypes.map(e => ({
            label: e.label,
            data: trends.map(t => t[e.key] || 0),
            borderColor: e.color,
            backgroundColor: e.color + '10',
            tension: 0.3,
            fill: false,
            pointRadius: 1.5,
            borderWidth: 1.5,
        }));
        charts[id] = new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { padding: 10, font: { size: 10 }, boxWidth: 12 } } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { font: { size: 9 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
                },
            },
        });
    }

    // ── (Case Detail Slide-Over Panel removed - integrated into kanban modal) ──

    // ESC key handler for modals/detail views (most recent layer first)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (analyticsModalOpen) { closeAnalyticsModal(); return; }
            if (collabDetailActive) { hideCollabDetail(); return; }
            if (kanbanModalOpen) { closeKanbanModal(); return; }
            if (!document.getElementById('detail-modal').classList.contains('hidden')) { closeModal(); return; }
        }
    });

    function renderCaseStatusStepper(data) {
        const CASE_STEPS = ['open', 'confirmed', 'contacted', 'connected', 'providing', 'closed'];
        const CASE_STEP_LABELS = { open: '접수', confirmed: '확인', contacted: '연락', connected: '연결', providing: '제공중', closed: '종결' };
        const CASE_STEP_ICONS = {
            done: 'check_circle',
            current: 'radio_button_checked',
            future: 'radio_button_unchecked',
        };

        const currentStatus = data.status || 'open';
        const currentIdx = CASE_STEPS.indexOf(currentStatus);
        const effectiveIdx = currentIdx === -1 ? 0 : currentIdx;

        let html = '<div class="mb-5"><div class="case-stepper">';
        CASE_STEPS.forEach((step, i) => {
            let dotClass, icon;
            if (i < effectiveIdx) {
                dotClass = 'done'; icon = CASE_STEP_ICONS.done;
            } else if (i === effectiveIdx) {
                dotClass = 'current'; icon = CASE_STEP_ICONS.current;
            } else {
                dotClass = 'future'; icon = CASE_STEP_ICONS.future;
            }

            html += `<div class="case-stepper-step">
                <div class="case-stepper-dot ${dotClass}">
                    <span class="material-symbols-outlined" style="font-size:16px" aria-hidden="true">${icon}</span>
                </div>
                <span class="text-[10px] mt-1 ${dotClass === 'current' ? 'font-bold text-green-800' : dotClass === 'done' ? 'text-green-700' : 'text-slate-400'}">${CASE_STEP_LABELS[step]}</span>
            </div>`;

            if (i < CASE_STEPS.length - 1) {
                const lineClass = i < effectiveIdx ? 'done' : 'future';
                html += `<div class="case-stepper-line ${lineClass}"></div>`;
            }
        });
        html += '</div>';

        // Read-only notice
        html += '<p class="text-[10px] text-slate-400 mt-2 flex items-center gap-1"><span class="material-symbols-outlined" style="font-size:12px" aria-hidden="true">info</span>상태는 담당자 처리 페이지에서 변경 가능합니다.</p>';
        html += '</div>';
        return html;
    }

    function renderCasePanelLinkage(l) {
        const ast = APPROVAL_STATUS_MAP[l.approvalStatus] || APPROVAL_STATUS_MAP.pending;
        const typeName = COLLAB_TYPE_MAP[l.type] || '자문';
        const catLabel = l.category === 'referral' ? '서비스연계' : '부서협업';

        let dirHtml = '';
        if (l.category === 'referral' && l.targetService) {
            dirHtml = `<span class="font-semibold text-blue-700 text-sm">${escapeHtml(l.targetService)}</span>`;
        } else if (l.fromDept && l.toDept) {
            dirHtml = `<span class="font-semibold text-indigo-700 text-sm">${getDeptName(l.fromDept)}</span>
                <span class="material-symbols-outlined text-slate-400" style="font-size:14px" aria-hidden="true">arrow_forward</span>
                <span class="font-semibold text-green-700 text-sm">${getDeptName(l.toDept)}</span>`;
        }

        const bgClass = l.approvalStatus === 'approved' ? 'bg-green-50 border-green-200'
            : (l.approvalStatus === 'target_approved' || l.approvalStatus === 'dept_approved') ? 'bg-blue-50 border-blue-200'
            : l.approvalStatus === 'origin_approved' ? 'bg-sky-50 border-sky-200'
            : l.approvalStatus === 'pending' ? 'bg-yellow-50 border-yellow-200'
            : (l.approvalStatus === 'rejected' || l.approvalStatus === 'admin_rejected') ? 'bg-red-50 border-red-200'
            : l.approvalStatus === 'redirected' ? 'bg-purple-50 border-purple-200'
            : 'bg-slate-50 border-slate-200';

        let html = `<div class="p-3 rounded-lg border ${bgClass}">
            <div class="flex items-center gap-2 mb-2">
                <span class="badge ${ast.bg} ${ast.text}" style="font-size:11px">${ast.label}</span>
                <span class="text-[10px] text-slate-400">${catLabel} · ${typeName}</span>
                <span class="text-[10px] text-slate-400 ml-auto">${safeDateStr(l.createdAtISO || l.createdAt)}</span>
            </div>
            ${dirHtml ? `<div class="flex items-center gap-1.5 mb-2">${dirHtml}</div>` : ''}
            ${l.reason ? `<p class="text-xs text-slate-600 mb-2">${escapeHtml(l.reason)}</p>` : ''}
            ${renderApprovalStepper(l.approvalStatus)}`;

        // Approval history timeline
        if (l.approvalHistory && l.approvalHistory.length > 0) {
            html += `<div class="mt-2 pt-2 border-t border-slate-200/60">
                <p class="text-[10px] font-semibold text-slate-400 mb-1.5">승인 이력</p>
                ${renderApprovalTimeline(l.approvalHistory)}
            </div>`;
        }

        html += '</div>';
        return html;
    }

    function toggleCaseCollapse(id, toggleEl) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('open');
        if (toggleEl) toggleEl.classList.toggle('active');
    }

    async function addKanbanCaseNote(requestId) {
        const input = document.getElementById('km-note-input');
        const noteText = input?.value.trim();
        if (!noteText) return;
        try {
            await fetch(`/api/admin/requests/${requestId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note: noteText }),
            });
            // Reload expanded data and re-render modal
            if (kanbanModalLinkageId) {
                const data = await api(`/api/admin/requests/${requestId}`);
                expandedCardData[kanbanModalLinkageId] = data;
                renderKanbanModalContent(kanbanModalLinkageId);
            }
        } catch (e) {
            alert('메모 추가 실패');
        }
    }

    // ── Topbar time ──
    function updateTopbarTime() {
        const now = new Date();
        const str = now.toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', weekday: 'short', hour: '2-digit', minute: '2-digit' });
        document.getElementById('topbar-time').textContent = str;
    }

    // ── 역할 카드 선택 ──
    function selectLoginRole(role) {
        if (role === 'admin') {
            doLoginAs('admin');
        } else {
            document.getElementById('login-role-cards').classList.add('hidden');
            document.getElementById('login-dept-area').classList.remove('hidden');
        }
    }

    function backToRoleSelect() {
        document.getElementById('login-dept-area').classList.add('hidden');
        document.getElementById('login-role-cards').classList.remove('hidden');
        document.getElementById('login-error').classList.add('hidden');
    }

    function doLoginDept(deptId) {
        doLoginAs('dept', deptId);
    }

    // ── 로그인 (통합 인증) ──
    async function doLoginAs(role, deptId) {
        const errEl = document.getElementById('login-error');
        errEl.classList.add('hidden');
        try {
            const resp = await fetch('/api/unified-auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, deptId }),
            });
            const data = await resp.json();
            if (resp.ok && data.success) {
                sessionRole = data.role || role;
                sessionDeptId = data.deptId || null;
                sessionDeptName = data.deptName || null;
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initApp();
            } else {
                errEl.textContent = data.error || '로그인 실패';
                errEl.classList.remove('hidden');
            }
        } catch (e) {
            errEl.textContent = '서버에 연결할 수 없습니다.';
            errEl.classList.remove('hidden');
        }
    }

    let _initTimers = false;
    function initApp() {
        updateSidebarRole();
        loadDeptMap();
        loadDashboard();
        updateTopbarTime();
        if (!_initTimers) {
            _initTimers = true;
            setInterval(updateTopbarTime, 60000);
            setInterval(() => { if (!document.hidden) loadDashboard(); }, 30000);
        }
    }

    // ── 사이드바 역할 표시 ──
    function updateSidebarRole() {
        const icon = document.getElementById('sidebar-role-icon');
        const label = document.getElementById('sidebar-role-label');
        const sub = document.getElementById('sidebar-role-sub');
        if (!icon) return;
        if (sessionRole === 'dept' && sessionDeptName) {
            icon.textContent = 'supervisor_account';
            label.textContent = sessionDeptName;
            sub.textContent = '부서 조정자';
        } else {
            icon.textContent = 'admin_panel_settings';
            label.textContent = '관리자';
            sub.textContent = '전체 관리';
        }
    }

    // ── 역할 전환 (로그아웃 → 로그인 게이트) ──
    async function switchRole() {
        try { await fetch('/api/unified-auth/logout', { method: 'POST' }); } catch {}
        sessionRole = null; sessionDeptId = null; sessionDeptName = null;
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('login-gate').classList.remove('hidden');
        // 로그인 카드 초기 상태로
        document.getElementById('login-role-cards').classList.remove('hidden');
        document.getElementById('login-dept-area').classList.add('hidden');
        document.getElementById('login-error').classList.add('hidden');
    }

    // ── Init: 인증 상태 확인 (통합 인증) ──
    (async function checkAuth() {
        try {
            const resp = await fetch('/api/unified-auth/status');
            const data = await resp.json();
            if (data.authenticated) {
                sessionRole = data.role || 'admin';
                sessionDeptId = data.deptId || null;
                sessionDeptName = data.deptName || null;
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initApp();
            }
        } catch { /* 서버 미응답 시 로그인 화면 유지 */ }
    })();
    </script>
</div><!-- /main-content -->
</body>
</html>
