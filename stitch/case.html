<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 처리 - 노마 AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Pretendard Variable"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Pretendard Variable', sans-serif; }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        @keyframes fade-up { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fade-up 0.4s ease-out; }
        @keyframes spin-slow { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 1.2s linear infinite; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- 로딩 상태 -->
    <div id="state-loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <span class="material-symbols-rounded text-5xl text-green-600 animate-spin-slow block mb-4">progress_activity</span>
            <p class="text-gray-500 text-lg">상담 정보를 불러오는 중...</p>
        </div>
    </div>

    <!-- 404 에러 -->
    <div id="state-error" class="hidden flex items-center justify-center min-h-screen">
        <div class="text-center animate-fade-up">
            <span class="material-symbols-rounded text-6xl text-red-400 block mb-4">error</span>
            <h2 class="text-xl font-bold text-gray-800 mb-2">요청을 찾을 수 없습니다</h2>
            <p class="text-gray-500">유효하지 않거나 만료된 링크입니다.</p>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div id="state-main" class="hidden min-h-screen py-8 px-4">
        <div class="max-w-lg mx-auto animate-fade-up">

            <!-- A. 헤더 (녹색 그라데이션) -->
            <div class="bg-gradient-to-br from-green-700 to-green-900 rounded-t-2xl px-6 py-5 text-white">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-rounded">assignment</span>
                    상담 처리
                </h1>
                <p class="text-green-200 text-sm mt-1">대상자에게 연락하고 처리 상태를 업데이트해 주세요.</p>
            </div>

            <div class="bg-white rounded-b-2xl shadow-lg border border-gray-100 overflow-hidden">

                <!-- A. 대상자 정보 -->
                <div class="px-6 pt-6 pb-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">대상자 정보</p>
                    <div class="bg-gray-50 rounded-xl p-4 space-y-2.5">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">신청 서비스</span>
                            <span id="info-service" class="text-sm font-bold text-gray-800">-</span>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">성함</span>
                            <span id="info-name" class="text-sm font-bold text-gray-800">-</span>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">연락처</span>
                            <span id="info-phone" class="text-sm font-bold text-gray-800">-</span>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">접수일</span>
                            <span id="info-date" class="text-sm text-gray-600">-</span>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">현재 상태</span>
                            <span id="info-status-badge">-</span>
                        </div>
                    </div>
                </div>

                <!-- B. AI 대화 요약 -->
                <div id="section-summary" class="hidden px-6 pb-4">
                    <div class="bg-purple-50 border border-purple-100 rounded-xl p-4">
                        <p class="text-xs font-semibold text-purple-700 mb-2 flex items-center gap-1">
                            <span class="material-symbols-rounded text-base">smart_toy</span>
                            AI 대화 요약
                        </p>
                        <p id="summary-text" class="text-sm text-gray-700 whitespace-pre-line leading-relaxed"></p>
                    </div>
                </div>

                <!-- C. 상태 진행 스테퍼 -->
                <div class="px-6 pb-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">처리 진행</p>
                    <div id="stepper" class="flex items-center justify-between relative"></div>
                    <div id="next-step-area" class="mt-4"></div>
                </div>

                <div class="px-6"><div class="border-t border-gray-100"></div></div>

                <!-- D. 처리 메모 -->
                <div class="px-6 py-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">sticky_note_2</span>
                        처리 메모
                    </p>
                    <div id="notes-list" class="space-y-2 mb-3 max-h-[250px] overflow-y-auto">
                        <p class="text-sm text-gray-400">메모 없음</p>
                    </div>
                    <div class="flex gap-2">
                        <input id="note-input" type="text" placeholder="메모 입력..." class="flex-1 border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                        <button onclick="submitNote()" id="note-btn" class="px-4 py-2.5 bg-green-700 text-white rounded-xl text-sm font-semibold hover:bg-green-800 transition-colors flex items-center gap-1">
                            <span class="material-symbols-rounded text-base">add</span>추가
                        </button>
                    </div>
                </div>

                <!-- E. 부서간 협업 -->
                <div class="px-6 pb-4">
                    <div class="border-t border-gray-100 mb-4"></div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">group_work</span>
                        부서간 협업
                    </p>

                    <!-- 기존 협업 요청 목록 -->
                    <div id="collab-list" class="space-y-3 mb-4"></div>

                    <!-- 새 협업 요청 폼 -->
                    <div id="collab-form-toggle" class="mb-3">
                        <button onclick="toggleCollabForm()" class="w-full py-2.5 border-2 border-dashed border-indigo-300 rounded-xl text-sm font-semibold text-indigo-600 hover:bg-indigo-50 transition-colors flex items-center justify-center gap-1.5">
                            <span class="material-symbols-rounded text-lg">add_circle</span>
                            협업 요청하기
                        </button>
                    </div>
                    <div id="collab-form" class="hidden bg-indigo-50 rounded-xl p-4 mb-3 space-y-3">
                        <p class="text-sm font-semibold text-indigo-800 flex items-center gap-1">
                            <span class="material-symbols-rounded text-base">group_add</span>
                            새 협업 요청
                        </p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">요청 부서 (우리팀)</label>
                                <select id="collab-from" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">협업 대상 부서</label>
                                <select id="collab-to" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">협업 유형</label>
                            <div class="flex gap-2">
                                <label class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-200 text-xs cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-400">
                                    <input type="radio" name="collab-type" value="consultation" checked class="w-3 h-3 text-indigo-600"> 자문 요청
                                </label>
                                <label class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-200 text-xs cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-400">
                                    <input type="radio" name="collab-type" value="joint" class="w-3 h-3 text-indigo-600"> 공동 처리
                                </label>
                                <label class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-200 text-xs cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-400">
                                    <input type="radio" name="collab-type" value="transfer" class="w-3 h-3 text-indigo-600"> 이관 요청
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">협업 사유</label>
                            <textarea id="collab-reason" rows="2" placeholder="협업이 필요한 이유를 입력하세요..." class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 resize-none"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitCollaboration()" class="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-1">
                                <span class="material-symbols-rounded text-base">send</span>요청 보내기
                            </button>
                            <button onclick="toggleCollabForm()" class="px-4 py-2.5 bg-white border border-gray-200 rounded-lg text-sm text-gray-500 hover:bg-gray-50 transition-colors">취소</button>
                        </div>
                    </div>
                </div>

                <!-- F. 연계 체인 -->
                <div id="section-chain" class="hidden px-6 pb-4">
                    <div class="border-t border-gray-100 mb-4"></div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">link</span>
                        연계 체인
                    </p>
                    <div id="chain-list" class="space-y-1"></div>
                </div>

                <!-- G. 하단 버튼 -->
                <div class="px-6 pb-6 pt-2 space-y-2.5">
                    <div class="border-t border-gray-100 mb-4"></div>
                    <a id="btn-call" href="#" class="w-full bg-gradient-to-r from-green-600 to-green-800 text-white font-bold py-3.5 rounded-xl text-sm hover:from-green-700 hover:to-green-900 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded text-lg">call</span>
                        대상자에게 전화
                    </a>
                    <a id="btn-referral" href="#" class="w-full border-2 border-blue-600 text-blue-700 font-bold py-3 rounded-xl text-sm hover:bg-blue-50 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded text-lg">swap_horiz</span>
                        타 서비스 연계
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
    (async function () {
        const requestId = location.pathname.split('/case/')[1];
        const $loading = document.getElementById('state-loading');
        const $error   = document.getElementById('state-error');
        const $main    = document.getElementById('state-main');

        function show(el) {
            [$loading, $error, $main].forEach(s => s.classList.add('hidden'));
            el.classList.remove('hidden');
        }

        // 상태 정의
        const STEPS = ['open', 'confirmed', 'contacted', 'connected', 'closed'];
        const STEP_LABELS = { open: '접수', confirmed: '확인', contacted: '연락', connected: '연결', closed: '완료' };
        const STEP_COLORS = {
            done: 'bg-green-600 text-white',
            current: 'bg-green-100 text-green-800 ring-2 ring-green-600',
            future: 'bg-gray-100 text-gray-400',
        };
        const STATUS_BADGE = {
            open:      '<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-600">접수</span>',
            confirmed: '<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-600">확인</span>',
            contacted: '<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-600">연락</span>',
            connected: '<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-600">연결</span>',
            closed:    '<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">완료</span>',
            referred:  '<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-600">연계</span>',
        };

        let caseData = null;
        let departments = [];

        // 부서 목록 로드
        async function loadDepartments() {
            try {
                const resp = await fetch('/api/departments');
                departments = await resp.json();
                populateDeptSelects();
            } catch { /* ignore */ }
        }

        function populateDeptSelects() {
            const fromSel = document.getElementById('collab-from');
            const toSel = document.getElementById('collab-to');
            if (!fromSel || !toSel) return;
            const opts = departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            fromSel.innerHTML = opts;
            toSel.innerHTML = opts;
            if (departments.length > 1) toSel.selectedIndex = 1;
        }

        function getDeptName(id) {
            const d = departments.find(d => d.id === id);
            return d ? d.name : id;
        }

        // 데이터 로드
        async function loadData() {
            try {
                const resp = await fetch('/api/case/' + requestId);
                if (!resp.ok) throw new Error();
                caseData = await resp.json();
            } catch {
                show($error);
                return false;
            }
            return true;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function render() {
            const req = caseData;

            // A. 대상자 정보
            document.getElementById('info-service').textContent = req.serviceName || '-';
            document.getElementById('info-name').textContent = req.userName || '-';
            document.getElementById('info-phone').textContent = req.userPhone || '-';
            document.getElementById('info-date').textContent = req.createdAt || '-';
            document.getElementById('info-status-badge').innerHTML = STATUS_BADGE[req.status] || req.status;

            // B. AI 대화 요약
            if (req.conversationSummary) {
                document.getElementById('section-summary').classList.remove('hidden');
                document.getElementById('summary-text').textContent = req.conversationSummary;
            }

            // C. 스테퍼
            renderStepper(req.status);

            // D. 메모
            renderNotes(req.notes || []);

            // E. 협업
            renderCollaborations(req.collaborations || []);

            // F. 연계 체인
            const chain = req.chain || [];
            if (chain.length > 1) {
                document.getElementById('section-chain').classList.remove('hidden');
                document.getElementById('chain-list').innerHTML = chain.map(c => {
                    const isCurrent = c.current;
                    return `<div class="flex items-center gap-2 text-sm p-2.5 rounded-lg ${isCurrent ? 'bg-green-50 border border-green-200' : 'bg-gray-50'}">
                        ${STATUS_BADGE[c.status] || ''}
                        <span class="${isCurrent ? 'font-semibold text-green-800' : 'text-gray-600'}">${escapeHtml(c.serviceName)}</span>
                        ${c.reason ? '<span class="text-xs text-gray-400 ml-auto">' + escapeHtml(c.reason) + '</span>' : ''}
                    </div>`;
                }).join('<div class="flex justify-center py-0.5"><span class="material-symbols-rounded text-gray-300 text-sm">arrow_downward</span></div>');
            }

            // F. 하단 버튼
            document.getElementById('btn-call').href = 'tel:' + (req.userPhone || '').replace(/[^0-9+]/g, '');
            document.getElementById('btn-referral').href = '/referral/' + requestId;

            show($main);
        }

        function renderStepper(currentStatus) {
            const stepperEl = document.getElementById('stepper');
            const currentIdx = STEPS.indexOf(currentStatus);
            const effectiveIdx = currentIdx === -1 ? 0 : currentIdx;

            stepperEl.innerHTML = STEPS.map((step, i) => {
                let stateClass, icon;
                if (i < effectiveIdx) {
                    stateClass = STEP_COLORS.done;
                    icon = 'check_circle';
                } else if (i === effectiveIdx) {
                    stateClass = STEP_COLORS.current;
                    icon = 'radio_button_checked';
                } else {
                    stateClass = STEP_COLORS.future;
                    icon = 'radio_button_unchecked';
                }

                const connector = i < STEPS.length - 1
                    ? `<div class="flex-1 h-0.5 mx-1 ${i < effectiveIdx ? 'bg-green-500' : 'bg-gray-200'}"></div>`
                    : '';

                return `
                    <div class="flex flex-col items-center" style="min-width:48px">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center text-sm ${stateClass}">
                            <span class="material-symbols-rounded text-lg">${icon}</span>
                        </div>
                        <span class="text-xs mt-1 ${i === effectiveIdx ? 'font-bold text-green-800' : 'text-gray-400'}">${STEP_LABELS[step]}</span>
                    </div>
                    ${connector}
                `;
            }).join('');

            // 다음 단계 버튼
            const nextArea = document.getElementById('next-step-area');
            if (effectiveIdx < STEPS.length - 1) {
                const nextStep = STEPS[effectiveIdx + 1];
                nextArea.innerHTML = `
                    <button onclick="advanceStatus('${nextStep}')" class="w-full bg-green-700 text-white font-semibold py-3 rounded-xl text-sm hover:bg-green-800 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded text-lg">arrow_forward</span>
                        다음 단계: ${STEP_LABELS[nextStep]}
                    </button>
                `;
            } else {
                nextArea.innerHTML = `
                    <div class="text-center py-3 bg-green-50 rounded-xl">
                        <span class="material-symbols-rounded text-green-600 text-2xl">task_alt</span>
                        <p class="text-sm font-semibold text-green-700 mt-1">처리 완료</p>
                    </div>
                `;
            }
        }

        function renderNotes(notes) {
            const el = document.getElementById('notes-list');
            if (notes.length === 0) {
                el.innerHTML = '<p class="text-sm text-gray-400 py-2 text-center">메모 없음</p>';
                return;
            }
            el.innerHTML = notes.map(n => {
                const authorBadge = n.author === '담당자'
                    ? '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700">담당자</span>'
                    : '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-semibold bg-amber-100 text-amber-700">관리자</span>';
                return `<div class="p-3 bg-gray-50 rounded-lg text-sm">
                    <div class="flex items-center gap-1.5 mb-1">${authorBadge}<span class="text-xs text-gray-400">${new Date(n.createdAt).toLocaleString('ko-KR')}</span></div>
                    <p class="text-gray-700">${escapeHtml(n.text)}</p>
                </div>`;
            }).join('');
            el.scrollTop = el.scrollHeight;
        }

        // 상태 진행 (전진만)
        window.advanceStatus = async function(nextStatus) {
            try {
                const resp = await fetch('/api/case/' + requestId + '/status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: nextStatus }),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    alert(err.error || '상태 변경에 실패했습니다.');
                    return;
                }
                caseData = await resp.json();
                render();
            } catch {
                alert('상태 변경에 실패했습니다.');
            }
        };

        // 메모 추가
        window.submitNote = async function() {
            const input = document.getElementById('note-input');
            const note = input.value.trim();
            if (!note) return;

            const btn = document.getElementById('note-btn');
            btn.disabled = true;

            try {
                const resp = await fetch('/api/case/' + requestId + '/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note }),
                });
                if (!resp.ok) throw new Error();
                caseData = await resp.json();
                input.value = '';
                renderNotes(caseData.notes || []);
            } catch {
                alert('메모 추가에 실패했습니다.');
            }
            btn.disabled = false;
        };

        // Enter 키 지원
        document.getElementById('note-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') window.submitNote();
        });

        // ── 협업 기능 ──
        const COLLAB_STATUS = {
            requested: { label: '요청됨', bg: 'bg-amber-100', text: 'text-amber-700', icon: 'schedule_send' },
            accepted:  { label: '진행중', bg: 'bg-blue-100', text: 'text-blue-700', icon: 'handshake' },
            completed: { label: '완료', bg: 'bg-green-100', text: 'text-green-700', icon: 'check_circle' },
            declined:  { label: '반려', bg: 'bg-red-100', text: 'text-red-700', icon: 'cancel' },
        };
        const COLLAB_TYPE = {
            consultation: { label: '자문 요청', icon: 'question_answer' },
            joint: { label: '공동 처리', icon: 'group_work' },
            transfer: { label: '이관 요청', icon: 'swap_horiz' },
        };

        function renderCollaborations(collabs) {
            const el = document.getElementById('collab-list');
            if (!collabs || collabs.length === 0) {
                el.innerHTML = '<p class="text-sm text-gray-400 py-2 text-center">협업 요청 없음</p>';
                return;
            }
            el.innerHTML = collabs.map(c => {
                const st = COLLAB_STATUS[c.status] || COLLAB_STATUS.requested;
                const tp = COLLAB_TYPE[c.type] || COLLAB_TYPE.consultation;
                const notesHtml = (c.notes || []).map(n => `
                    <div class="flex gap-2 text-xs py-1.5">
                        <span class="font-semibold text-indigo-600 whitespace-nowrap">${escapeHtml(n.dept || n.author)}</span>
                        <span class="text-gray-600">${escapeHtml(n.text)}</span>
                        <span class="text-gray-300 ml-auto whitespace-nowrap">${new Date(n.createdAt).toLocaleString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                `).join('');

                const isActive = c.status === 'requested' || c.status === 'accepted';
                const actions = isActive ? `
                    <div class="flex gap-1.5 mt-2">
                        ${c.status === 'requested' ? `<button onclick="updateCollab('${c.id}','accepted')" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-colors flex items-center gap-1"><span class="material-symbols-rounded text-sm">check</span>수락</button>` : ''}
                        ${c.status === 'requested' ? `<button onclick="updateCollab('${c.id}','declined')" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 transition-colors">반려</button>` : ''}
                        ${c.status === 'accepted' ? `<button onclick="updateCollab('${c.id}','completed')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors flex items-center gap-1"><span class="material-symbols-rounded text-sm">task_alt</span>완료</button>` : ''}
                        <div class="flex-1"></div>
                        <div class="flex gap-1">
                            <input id="cnote-${c.id}" type="text" placeholder="메모..." class="border border-gray-200 rounded-lg px-2.5 py-1.5 text-xs w-32 focus:outline-none focus:ring-1 focus:ring-indigo-400" onkeydown="if(event.key==='Enter')addCollabNote('${c.id}')" />
                            <button onclick="addCollabNote('${c.id}')" class="px-2.5 py-1.5 bg-indigo-600 text-white rounded-lg text-xs hover:bg-indigo-700 transition-colors">
                                <span class="material-symbols-rounded text-sm">send</span>
                            </button>
                        </div>
                    </div>
                ` : '';

                return `
                <div class="border rounded-xl overflow-hidden ${isActive ? 'border-indigo-200 bg-white' : 'border-gray-100 bg-gray-50 opacity-75'}">
                    <div class="px-4 py-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold ${st.bg} ${st.text}">
                                <span class="material-symbols-rounded text-sm">${st.icon}</span>${st.label}
                            </span>
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                <span class="material-symbols-rounded text-sm">${tp.icon}</span>${tp.label}
                            </span>
                            <span class="text-xs text-gray-400 ml-auto">${new Date(c.createdAt).toLocaleString('ko-KR', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-sm mb-1.5">
                            <span class="font-semibold text-indigo-700">${getDeptName(c.fromDept)}</span>
                            <span class="material-symbols-rounded text-gray-400 text-base">arrow_forward</span>
                            <span class="font-semibold text-green-700">${getDeptName(c.toDept)}</span>
                        </div>
                        <p class="text-sm text-gray-600">${escapeHtml(c.reason)}</p>
                        ${c.notes && c.notes.length > 0 ? `<div class="mt-2 pt-2 border-t border-gray-100">${notesHtml}</div>` : ''}
                        ${actions}
                    </div>
                </div>`;
            }).join('');
        }

        window.toggleCollabForm = function() {
            const form = document.getElementById('collab-form');
            form.classList.toggle('hidden');
        };

        window.submitCollaboration = async function() {
            const fromDept = document.getElementById('collab-from').value;
            const toDept = document.getElementById('collab-to').value;
            const reason = document.getElementById('collab-reason').value.trim();
            const type = document.querySelector('input[name="collab-type"]:checked')?.value || 'consultation';
            if (!reason) { alert('협업 사유를 입력하세요.'); return; }
            if (fromDept === toDept) { alert('같은 부서에는 협업 요청할 수 없습니다.'); return; }

            try {
                const resp = await fetch('/api/case/' + requestId + '/collaboration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fromDept, toDept, reason, type }),
                });
                if (!resp.ok) { const err = await resp.json(); alert(err.error); return; }
                document.getElementById('collab-reason').value = '';
                document.getElementById('collab-form').classList.add('hidden');
                if (await loadData()) render();
            } catch { alert('협업 요청에 실패했습니다.'); }
        };

        window.updateCollab = async function(collabId, status) {
            try {
                const resp = await fetch(`/api/case/${requestId}/collaboration/${collabId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status }),
                });
                if (!resp.ok) throw new Error();
                if (await loadData()) render();
            } catch { alert('상태 변경에 실패했습니다.'); }
        };

        window.addCollabNote = async function(collabId) {
            const input = document.getElementById('cnote-' + collabId);
            const text = input.value.trim();
            if (!text) return;
            // 해당 협업의 fromDept를 직접 참조 (드롭다운 의존 제거)
            const collab = (caseData.collaborations || []).find(c => c.id === collabId);
            const deptName = collab ? getDeptName(collab.fromDept) : '담당자';
            try {
                const resp = await fetch(`/api/case/${requestId}/collaboration/${collabId}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, author: '담당자', dept: deptName }),
                });
                if (!resp.ok) throw new Error();
                input.value = '';
                if (await loadData()) render();
            } catch { alert('메모 추가에 실패했습니다.'); }
        };

        // 초기 로드
        await loadDepartments();
        if (await loadData()) {
            render();
        }
    })();
    </script>
</body>
</html>
