<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>경상남도사회서비스원 AI 맞춤형 복지 내비게이터</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js"></script>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#98002E",
                        "primary-light": "#B8003E",
                        "bg-warm": "#F8F5F2",
                        "bg-section": "#F1ECE7",
                        "deep-purple": "#4A1942",
                    },
                    fontFamily: {
                        "sans": ["Pretendard Variable", "Pretendard", "-apple-system", "BlinkMacSystemFont", "system-ui", "Roboto", "Noto Sans KR", "Malgun Gothic", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "3xl": "2.5rem", "full": "9999px" },
                    keyframes: {
                        'fade-up': { '0%': { opacity: '0', transform: 'translateY(24px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        'slide-down': { '0%': { opacity: '0', transform: 'translateY(-12px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'pulse-soft': { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.6' } },
                        'shimmer': { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                    },
                    animation: {
                        'fade-up': 'fade-up 0.5s ease-out forwards',
                        'fade-up-delay-1': 'fade-up 0.5s ease-out 0.1s forwards',
                        'fade-up-delay-2': 'fade-up 0.5s ease-out 0.2s forwards',
                        'fade-up-delay-3': 'fade-up 0.5s ease-out 0.3s forwards',
                        'fade-in': 'fade-in 0.4s ease-out forwards',
                        'slide-down': 'slide-down 0.3s ease-out forwards',
                        'pulse-soft': 'pulse-soft 2s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                },
            },
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .skeleton-shimmer {
            background: linear-gradient(90deg, #f0ebe6 25%, #e8e2db 50%, #f0ebe6 75%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        /* Transition classes */
        .hero-compact .hero-title { font-size: 1.5rem; line-height: 2rem; }
        .hero-compact .hero-subtitle { display: none; }
        .hero-compact .hero-badge { display: none; }
        #hero-section.hero-compact { min-height: auto !important; padding-top: 2rem; padding-bottom: 1rem; }
        .hero-compact #hero-voice-cta-wrap { display: none !important; }
        .hero-compact p.text-center.text-slate-400 { display: none; }
        #results-section { transition: all 0.5s ease-out; }
        /* Mic breathe animation */
        @keyframes mic-breathe {
            0%, 100% { box-shadow: 0 0 0 0 rgba(152, 0, 46, 0.4); }
            50% { box-shadow: 0 0 0 18px rgba(152, 0, 46, 0); }
        }
        .mic-breathe { animation: mic-breathe 2.5s ease-in-out infinite; }
        /* Below-fold fade-up reveal */
        .reveal-fade-up {
            opacity: 0;
            transform: translateY(24px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .reveal-fade-up.revealed {
            opacity: 1;
            transform: translateY(0);
        }
        /* Noma card link styling */
        .noma-card-detail strong { display: block; margin-bottom: 2px; }
        /* Stepper timeline */
        .stepper { position: relative; padding-left: 2rem; }
        .stepper::before {
            content: '';
            position: absolute;
            left: 0.6875rem;
            top: 1.25rem;
            bottom: 1.25rem;
            width: 2px;
            background: #e5e0db;
        }
        .step-item { position: relative; padding-bottom: 0.25rem; }
        .step-item:last-child { padding-bottom: 0; }
        .step-dot {
            position: absolute;
            left: -2rem;
            top: 0.125rem;
            width: 1.375rem;
            height: 1.375rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            z-index: 1;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            cursor: pointer;
            padding: 0.5rem 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .step-header:active { opacity: 0.7; }
        .step-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            opacity: 0;
            padding-bottom: 0;
        }
        .step-body.open {
            max-height: 500px;
            opacity: 1;
            padding-bottom: 0.75rem;
        }
        .step-chevron {
            transition: transform 0.3s ease;
            font-size: 1.125rem !important;
        }
        .step-body.open ~ .step-header .step-chevron,
        .step-item.open .step-chevron {
            transform: rotate(180deg);
        }
        .tel-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #f0fdf4;
            color: #15803d;
            padding: 0.5rem 0.875rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9375rem;
            text-decoration: none;
            border: 1px solid #bbf7d0;
            margin-top: 0.375rem;
        }
        .tel-link:active { background: #dcfce7; }
        /* Voice mode */
        @keyframes voice-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        /* Floating mic button */
        #floating-mic {
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #98002E, #4A1942);
            color: white;
            border: none;
            box-shadow: 0 4px 24px rgba(152, 0, 46, 0.45);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }
        #floating-mic:active { transform: scale(0.92); }
        #floating-mic.listening {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 24px rgba(239, 68, 68, 0.5);
            animation: voice-pulse 1.5s ease-in-out infinite;
        }
        #floating-mic .mic-status {
            position: absolute;
            bottom: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        /* ═══ 모바일 시니어 최적화 오버라이드 ═══ */
        @media (max-width: 767px) {
            /* 기본 폰트 확대 */
            body { font-size: 22px; line-height: 1.6; }

            /* 연한 회색 텍스트 제거 → 가독성 강화 */
            .text-slate-400, .text-slate-500,
            .text-stone-300, .text-stone-400 {
                color: #334155 !important;
            }

            /* 최소 터치 영역 56px */
            button, a, input, select, textarea {
                min-height: 56px;
            }

            /* 스테퍼 자동 펼침 & 쉐브론 숨김 */
            .step-body {
                max-height: 500px !important;
                opacity: 1 !important;
                padding-bottom: 0.75rem !important;
            }
            .step-chevron { display: none !important; }
            .step-header span.font-semibold { font-size: 18px !important; }
            .step-body div { font-size: 18px !important; line-height: 1.6 !important; }

            /* 전화 링크 확대 + 초록 배경 반전 */
            .tel-link {
                font-size: 22px;
                width: 100%;
                justify-content: center;
                background: #15803d;
                color: white !important;
                border-color: #15803d;
                padding: 0.875rem 1rem;
            }
            .tel-link:active { background: #166534; color: white !important; }

            /* 플로팅 마이크 확대 104px */
            #floating-mic { width: 6.5rem; height: 6.5rem; }
            #floating-mic .material-symbols-outlined:first-child { font-size: 44px !important; }

            /* AI 요약 텍스트 확대 */
            #ai-summary-text { font-size: 22px; padding: 1.5rem; }
            #ai-summary-area .flex-shrink-0 { width: 56px !important; height: 56px !important; }
            #ai-summary-area .flex-shrink-0 .material-symbols-outlined { font-size: 28px !important; }
            #ai-summary-area .text-xs { font-size: 16px; }

            /* 카드 서비스명 24px, summary 숨김 */
            #cards-grid h3 { font-size: 24px; }
            #cards-grid .text-slate-500.text-\[13px\] { display: none; }

            /* CTA 버튼 확대 20px */
            .btn-apply {
                font-size: 20px !important;
                padding-top: 1.25rem !important;
                padding-bottom: 1.25rem !important;
            }

            /* 카드 전화 버튼 */
            .card-phone-btn {
                display: flex !important;
                width: 100%;
                background: #15803d;
                color: white;
                font-weight: 700;
                font-size: 22px;
                padding: 1.25rem 1rem;
                border-radius: 0.75rem;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                text-decoration: none;
                margin-bottom: 0.75rem;
                min-height: 64px;
            }
            .card-phone-btn:active { background: #166534; }

            /* 면책 텍스트 숨김 */
            .card-disclaimer { display: none; }

            /* 히어로 칩: 풀너비, 세로 배치, 18px */
            #hero-chips { flex-direction: column; }
            .hero-chip { width: 100%; justify-content: center; }
            .hero-chip span:last-child { font-size: 18px; }

            /* hero badge/subtitle/CTA → 이제 hidden 클래스로 처리 */

            /* 섹션 타이틀 확대 */
            #cards-title h2 { font-size: 24px; }
            #initial-placeholder h2 { font-size: 24px; }
            #initial-placeholder h3 { font-size: 22px; }
            #initial-placeholder p { font-size: 18px; }

            /* discover-more 확대 */
            #discover-more h4 { font-size: 22px; }
            #discover-more p { font-size: 18px; }
            #discover-more button, #discover-more a { font-size: 18px; min-height: 56px; }

            /* browse 전체 확대 */
            #browse-section h2 { font-size: 24px; }
            .browse-tab { font-size: 18px !important; }
            #browse-section h4 { font-size: 20px; }

            /* footer 확대 */
            footer p, footer a { font-size: 16px !important; }
        }

        /* Phase 2: 색상 대비 개선 (WCAG 4.5:1) */
        .text-slate-400 { color: #64748b !important; }

        /* Phase 2: focus-visible indicator 복구 */
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid #98002E;
            outline-offset: 2px;
        }

        /* sr-only 유틸리티 */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0; }

        /* Phase 3: 고대비 모드 */
        @media (prefers-contrast: more) {
            .text-slate-400, .text-slate-500 { color: #1e293b !important; }
            .bg-bg-warm, .bg-bg-section { background-color: #fff !important; }
            .border-stone-100, .border-stone-200 { border-color: #475569 !important; }
            .text-primary { color: #7a0025 !important; }
            .bg-primary\/10 { background-color: rgba(152,0,46,0.2) !important; }
        }

        /* Phase 3: reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body class="bg-bg-warm min-h-screen flex flex-col font-sans text-slate-900 antialiased selection:bg-primary selection:text-white">

    <!-- ═══════════════════ HEADER ═══════════════════ -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-stone-200 bg-white/90 backdrop-blur-sm px-6 lg:px-20 xl:px-40 py-4 sticky top-0 z-50">
        <a href="#" onclick="event.preventDefault();resetToHome()" class="flex items-center gap-3 group">
            <div class="flex flex-col items-center justify-center">
                <div class="flex items-end gap-[2px]">
                    <svg width="22" height="18" viewBox="0 0 24 24" fill="none" class="group-hover:-translate-y-0.5 transition-transform duration-300"><path d="M12 4L3 13H8L12 9L16 13H21L12 4Z" fill="#8dc63f"/></svg>
                    <svg width="22" height="18" viewBox="0 0 24 24" fill="none" class="group-hover:-translate-y-0.5 transition-transform duration-300 delay-75"><path d="M12 4L3 13H8L12 9L16 13H21L12 4Z" fill="#0092d6"/></svg>
                    <svg width="18" height="18" viewBox="0 0 20 20" fill="none" class="mb-[2px] group-hover:scale-110 transition-transform duration-300 delay-150"><circle cx="10" cy="10" r="6" stroke="#f49231" stroke-width="4.5"/></svg>
                </div>
                <span class="text-[9px] font-black text-slate-400 tracking-[0.3em] mt-0.5 ml-1">PASS</span>
            </div>
            <h2 class="text-slate-800 text-lg md:text-xl font-extrabold tracking-tight">경상남도사회서비스원</h2>
        </a>
        <div class="flex items-center gap-3">
            <a class="px-5 py-2 bg-green-600 text-white text-sm font-semibold rounded-full hover:bg-green-700 transition-colors flex items-center gap-1.5" href="tel:055-230-8200">
                <span class="material-symbols-outlined text-base" aria-hidden="true">call</span>
                전화 문의
            </a>
            <button class="text-slate-700" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <span class="material-symbols-outlined text-2xl" aria-hidden="true">menu</span>
            </button>
        </div>
    </header>
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-[60] bg-black/40" onclick="this.classList.add('hidden')">
        <div class="bg-white w-64 h-full p-6 space-y-4" onclick="event.stopPropagation()">
            <a class="block text-slate-700 font-medium py-2" href="#" onclick="event.preventDefault();document.getElementById('mobile-menu').classList.add('hidden');revealBelowFoldSections();setTimeout(()=>document.getElementById('browse-section')?.scrollIntoView({behavior:'smooth'}),100)">전체 서비스</a>
            <a class="block text-slate-700 font-medium py-2" href="#">자주 묻는 질문</a>
            <button id="btn-my-drawer" class="relative block text-slate-700 font-medium py-2 flex items-center gap-2" onclick="document.getElementById('mobile-menu').classList.add('hidden');openMyDrawer()">
                <span class="material-symbols-outlined text-lg" aria-hidden="true">bookmark</span>내 서랍
                <span id="drawer-badge" class="hidden absolute -top-1 -right-2 bg-primary text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">0</span>
            </button>
            <a class="block text-primary font-bold py-2" href="tel:055-230-8200">전화 문의</a>
        </div>
    </div>

    <!-- ═══════════════════ MAIN ═══════════════════ -->
    <main class="flex-1 flex flex-col items-center w-full">

        <!-- ── HERO SECTION ── -->
        <section id="hero-section" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 transition-all duration-500" style="min-height:calc(100vh - 80px);display:flex;align-items:center;justify-content:center;">
            <div class="w-full">
                <div class="max-w-3xl mx-auto text-center space-y-5">
                    <span class="hero-badge hidden inline-block px-4 py-1.5 rounded-full bg-primary/10 text-primary text-sm font-semibold transition-all duration-500">AI 맞춤형 복지 내비게이터</span>
                    <h1 class="hero-title text-slate-900 text-3xl md:text-[2.75rem] font-black leading-tight tracking-tight break-keep transition-all duration-500">
                        어떤 어려움이 있으신가요?
                    </h1>
                    <p class="hero-subtitle hidden text-slate-500 text-base md:text-lg font-medium leading-relaxed max-w-xl mx-auto break-keep transition-all duration-500">
                        복잡한 복지 제도, 이제 찾지 말고 편하게 이야기해 주세요.<br/>
                        AI가 귀하에게 필요한 서비스를 분석해 드립니다.
                    </p>
                    <!-- 음성 중심 CTA (모든 화면에서 기본 표시) -->
                    <div id="hero-voice-cta-wrap" class="flex flex-col items-center gap-4 mt-8">
                        <button id="hero-voice-cta" class="mic-breathe w-32 h-32 rounded-full bg-gradient-to-br from-primary to-deep-purple text-white shadow-2xl flex items-center justify-center hover:scale-105 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined style=" aria-hidden="true"font-size:64px">mic</span>
                        </button>
                        <p class="text-slate-800 text-xl font-bold mt-2">말씀해 주세요</p>
                        <p class="text-slate-600 text-base">버튼을 누르고 원하는 서비스를 말씀해 주세요</p>
                    </div>
                </div>

                <!-- Search Input -->
                <div class="max-w-2xl mx-auto mt-8">
                    <p class="text-center text-slate-400 text-sm font-medium mb-3">-- 또는 글로 입력하세요 --</p>
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-primary/20 via-purple-500/15 to-primary/20 rounded-full blur-md opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition duration-500"></div>
                        <div class="relative flex items-center w-full h-16 md:h-[3.5rem] bg-white rounded-full shadow-lg shadow-stone-200/60 ring-1 ring-stone-200/80 transition-all focus-within:ring-2 focus-within:ring-primary/60 focus-within:shadow-xl overflow-hidden">
                            <button id="hero-mic" class="pl-4 md:pl-7 text-primary hover:text-primary-light flex flex-col items-center justify-center hover:scale-110 transition-all gap-0.5" title="음성으로 입력">
                                <span class="w-11 h-11 md:w-auto md:h-auto rounded-full bg-primary/10 md:bg-transparent flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[30px] md:text-[28px]" aria-hidden="true">mic</span>
                                </span>
                                <span class="text-[10px] font-bold text-primary md:hidden leading-none">말하기</span>
                            </button>
                            <label for="hero-input" class="sr-only">복지 서비스 검색</label>
                    <input id="hero-input"
                                aria-label="어떤 도움이 필요하신가요? 복지 서비스를 검색하세요"
                                class="w-full h-full bg-transparent border-none text-slate-800 placeholder:text-slate-400 text-lg md:text-lg px-4 md:px-5 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/40"
                                placeholder="예: 퇴원 후 당장 돌봐줄 사람이 없어요" />
                            <button id="hero-submit"
                                class="mr-2 md:mr-3 size-12 md:size-11 bg-primary rounded-full flex items-center justify-center text-white hover:bg-primary-light active:scale-95 transition-all shadow-md flex-shrink-0">
                                <span class="material-symbols-outlined text-2xl" aria-hidden="true">arrow_forward</span>
                            </button>
                        </div>
                    </div>
                    <!-- Example Chips (2개만) -->
                    <div id="hero-chips" class="mt-5 flex flex-wrap justify-center gap-2.5">
                        <button class="hero-chip group flex items-center gap-1.5 px-4 py-2.5 bg-white hover:bg-primary/5 border border-stone-200 rounded-full transition-all shadow-sm hover:shadow-md hover:border-primary/30" data-msg="퇴원 후 당장 돌봐줄 사람이 없어요">
                            <span class="material-symbols-outlined text-primary/70 text-base" aria-hidden="true">medical_services</span>
                            <span class="text-slate-600 text-sm font-medium">#퇴원 후 돌봄이 필요해요</span>
                        </button>
                        <button class="hero-chip group flex items-center gap-1.5 px-4 py-2.5 bg-white hover:bg-primary/5 border border-stone-200 rounded-full transition-all shadow-sm hover:shadow-md hover:border-primary/30" data-msg="긴급 돌봄이 필요해요">
                            <span class="material-symbols-outlined text-primary/70 text-base" aria-hidden="true">emergency_home</span>
                            <span class="text-slate-600 text-sm font-medium">#긴급 돌봄</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ── RESULTS SECTION (hidden initially) ── -->
        <section id="results-section" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 pb-8 hidden">
            <div class="max-w-5xl mx-auto">
                <!-- AI Summary Bubble -->
                <div id="ai-summary-area" class="mb-8 hidden">
                    <div class="flex items-start gap-3 max-w-3xl">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-primary to-deep-purple flex items-center justify-center shadow-md">
                            <span class="material-symbols-outlined text-white text-xl" aria-hidden="true">smart_toy</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-primary mb-1.5">노마(Noma) AI 분석 결과</p>
                            <div id="ai-summary-text" class="bg-white rounded-2xl rounded-tl-md px-5 py-4 shadow-sm border border-stone-200 text-[15px] text-slate-700 leading-relaxed break-keep"></div>
                        </div>
                    </div>
                </div>

                <!-- Section Title -->
                <div id="cards-title" class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2.5">
                        <span class="material-symbols-outlined text-primary text-xl" aria-hidden="true">auto_awesome</span>
                        <h2 class="text-xl font-bold text-slate-800">맞춤 추천 서비스</h2>
                    </div>
                    <button id="btn-new-search" class="hidden text-sm text-slate-500 hover:text-primary font-medium flex items-center gap-1 transition-colors">
                        <span class="material-symbols-outlined text-base" aria-hidden="true">refresh</span>
                        새로 질문하기
                    </button>
                </div>

                <!-- Cards Grid -->
                <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>

                <!-- Loading Skeletons -->
                <div id="cards-skeleton" class="hidden grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="bg-white rounded-2xl p-7 border border-stone-100 shadow-sm">
                        <div class="flex items-start justify-between mb-5"><div class="skeleton-shimmer w-12 h-12 rounded-xl"></div><div class="skeleton-shimmer w-16 h-6 rounded-full"></div></div>
                        <div class="skeleton-shimmer h-7 w-3/4 rounded mb-3"></div>
                        <div class="skeleton-shimmer h-4 w-full rounded mb-2"></div>
                        <div class="skeleton-shimmer h-4 w-5/6 rounded mb-6"></div>
                        <div class="skeleton-shimmer h-20 w-full rounded-lg mb-6"></div>
                        <div class="skeleton-shimmer h-12 w-full rounded-xl"></div>
                    </div>
                    <div class="bg-white rounded-2xl p-7 border border-stone-100 shadow-sm">
                        <div class="flex items-start justify-between mb-5"><div class="skeleton-shimmer w-12 h-12 rounded-xl"></div><div class="skeleton-shimmer w-16 h-6 rounded-full"></div></div>
                        <div class="skeleton-shimmer h-7 w-3/4 rounded mb-3"></div>
                        <div class="skeleton-shimmer h-4 w-full rounded mb-2"></div>
                        <div class="skeleton-shimmer h-4 w-5/6 rounded mb-6"></div>
                        <div class="skeleton-shimmer h-20 w-full rounded-lg mb-6"></div>
                        <div class="skeleton-shimmer h-12 w-full rounded-xl"></div>
                    </div>
                </div>

                <!-- Discover More -->
                <div id="discover-more" class="hidden mt-8 bg-white border border-stone-200 rounded-2xl p-6 md:p-7 shadow-sm">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-primary/10 p-3 rounded-full text-primary flex-shrink-0">
                            <span class="material-symbols-outlined text-xl" aria-hidden="true">grid_view</span>
                        </div>
                        <div>
                            <h4 class="text-base font-bold text-slate-800 mb-0.5">찾으시는 서비스가 없으신가요?</h4>
                            <p class="text-slate-500 text-sm break-keep">아래 방법으로도 도움을 받으실 수 있습니다.</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="btn-browse-scroll" class="flex-1 px-5 py-3 bg-white border border-stone-300 text-slate-700 hover:bg-slate-50 font-semibold rounded-xl shadow-sm hover:shadow transition-all flex items-center justify-center gap-1.5 text-sm">
                            <span class="material-symbols-outlined text-base" aria-hidden="true">list_alt</span>
                            전체 서비스 둘러보기
                        </button>
                        <a href="tel:055-230-8200" class="flex-1 px-5 py-3 bg-primary text-white font-semibold rounded-xl shadow-sm hover:bg-primary-light transition-all flex items-center justify-center gap-1.5 text-sm">
                            <span class="material-symbols-outlined text-base" aria-hidden="true">call</span>
                            대표전화 055-230-8200
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- ── INITIAL PLACEHOLDER (shown before search) ── -->
        <section id="initial-placeholder" class="hidden w-full px-4 sm:px-6 lg:px-20 xl:px-40 pb-12">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center gap-2.5 mb-6">
                    <span class="material-symbols-outlined text-primary text-xl" aria-hidden="true">auto_awesome</span>
                    <h2 class="text-xl font-bold text-slate-800">이런 서비스를 제공합니다</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- Placeholder Card 1 -->
                    <div class="bg-white rounded-2xl p-6 border border-stone-100 shadow-sm hover:shadow-md hover:border-primary/20 transition-all group cursor-pointer" onclick="document.getElementById('hero-input').value='긴급 돌봄이 필요해요';document.getElementById('hero-input').focus()">
                        <div class="bg-primary/10 p-3 rounded-xl text-primary w-fit mb-4 group-hover:bg-primary/15 transition-colors">
                            <span class="material-symbols-outlined text-2xl" aria-hidden="true">emergency</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">긴급돌봄 지원</h3>
                        <p class="text-sm text-slate-500 leading-relaxed break-keep">갑작스러운 질병이나 사고로 돌봄이 필요할 때, 72시간 내 긴급 돌봄 서비스를 제공합니다.</p>
                    </div>
                    <!-- Placeholder Card 2 -->
                    <div class="bg-white rounded-2xl p-6 border border-stone-100 shadow-sm hover:shadow-md hover:border-primary/20 transition-all group cursor-pointer" onclick="document.getElementById('hero-input').value='혼자 사는 어르신 안전 관리';document.getElementById('hero-input').focus()">
                        <div class="bg-blue-50 p-3 rounded-xl text-blue-600 w-fit mb-4 group-hover:bg-blue-100 transition-colors">
                            <span class="material-symbols-outlined text-2xl" aria-hidden="true">shield_with_heart</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">AI 스마트 돌봄</h3>
                        <p class="text-sm text-slate-500 leading-relaxed break-keep">AI/IoT 기기를 활용하여 독거 어르신의 건강과 안전을 24시간 모니터링합니다.</p>
                    </div>
                    <!-- Placeholder Card 3 -->
                    <div class="bg-white rounded-2xl p-6 border border-stone-100 shadow-sm hover:shadow-md hover:border-primary/20 transition-all group cursor-pointer" onclick="document.getElementById('hero-input').value='장애인 보조기기 지원';document.getElementById('hero-input').focus()">
                        <div class="bg-emerald-50 p-3 rounded-xl text-emerald-600 w-fit mb-4 group-hover:bg-emerald-100 transition-colors">
                            <span class="material-symbols-outlined text-2xl" aria-hidden="true">accessible_forward</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">장애인 지원 서비스</h3>
                        <p class="text-sm text-slate-500 leading-relaxed break-keep">보조기기 대여, 직업재활, 권익옹호 등 장애인 맞춤형 종합 복지 서비스를 제공합니다.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ── BROWSE ALL SERVICES ── -->
        <section id="browse-section" class="hidden w-full px-4 sm:px-6 lg:px-20 xl:px-40 py-16 bg-white">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-10">
                    <span class="inline-block px-4 py-1.5 rounded-full bg-primary/10 text-primary text-sm font-semibold mb-4">전체 서비스 둘러보기</span>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">경상남도사회서비스원이 제공하는 모든 서비스</h2>
                    <p class="text-sm text-slate-500">카테고리를 선택하여 관심 있는 서비스를 살펴보세요.</p>
                </div>

                <!-- Category Tabs -->
                <div id="browse-tabs" class="flex flex-wrap justify-center gap-3 mb-8"></div>

                <!-- Service List -->
                <div id="browse-list" class="space-y-4"></div>

                <!-- Loading -->
                <div id="browse-loading" class="text-center py-10">
                    <span class="material-symbols-outlined text-stone-300 text-4xl animate-pulse-soft" aria-hidden="true">hourglass_empty</span>
                    <p class="text-slate-400 text-sm mt-2">서비스 목록을 불러오는 중...</p>
                </div>
            </div>
        </section>

        <!-- ── JOURNEY MAP ── -->
        <section id="journey-section" class="hidden w-full px-4 sm:px-6 lg:px-20 xl:px-40 py-16 bg-bg-section/60">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-10">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">서비스 이용 절차</h2>
                    <p class="text-sm text-slate-500">상담 접수부터 서비스 제공까지, 한눈에 확인하세요.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 md:gap-0 relative">
                    <!-- Connector line (desktop) -->
                    <div class="hidden md:block absolute top-10 left-[12.5%] right-[12.5%] h-[3px] bg-stone-200 rounded-full z-0"></div>
                    <!-- Step 1 -->
                    <div class="flex flex-col items-center text-center group journey-connector relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-primary rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-transform duration-300">
                            <span class="material-symbols-outlined text-primary text-3xl" aria-hidden="true">support_agent</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-primary mb-0.5">STEP 1</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">상담 및 신청</h4>
                            <p class="text-xs text-slate-500 leading-snug">온라인 또는 전화로<br/>간편하게 신청</p>
                        </div>
                    </div>
                    <!-- Step 2 -->
                    <div class="flex flex-col items-center text-center group journey-connector relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-stone-200 group-hover:border-primary/50 rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-all duration-300">
                            <span class="material-symbols-outlined text-stone-400 group-hover:text-primary transition-colors text-3xl" aria-hidden="true">fact_check</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-slate-400 group-hover:text-primary transition-colors mb-0.5">STEP 2</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">자격 확인</h4>
                            <p class="text-xs text-slate-500 leading-snug">대상 적격 여부<br/>심사 및 결정</p>
                        </div>
                    </div>
                    <!-- Step 3 -->
                    <div class="flex flex-col items-center text-center group journey-connector relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-stone-200 group-hover:border-primary/50 rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-all duration-300">
                            <span class="material-symbols-outlined text-stone-400 group-hover:text-primary transition-colors text-3xl" aria-hidden="true">person_apron</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-slate-400 group-hover:text-primary transition-colors mb-0.5">STEP 3</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">전담 인력 배정</h4>
                            <p class="text-xs text-slate-500 leading-snug">담당자 매칭 및<br/>방문 계획 수립</p>
                        </div>
                    </div>
                    <!-- Step 4 -->
                    <div class="flex flex-col items-center text-center group relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-stone-200 group-hover:border-primary/50 rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-all duration-300">
                            <span class="material-symbols-outlined text-stone-400 group-hover:text-primary transition-colors text-3xl" aria-hidden="true">handshake</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-slate-400 group-hover:text-primary transition-colors mb-0.5">STEP 4</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">서비스 제공</h4>
                            <p class="text-xs text-slate-500 leading-snug">맞춤형 복지<br/>서비스 시작</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ═══════════════════ FLOATING MIC BUTTON ═══════════════════ -->
    <div id="floating-mic-wrap" style="position:fixed;bottom:2rem;right:1.5rem;z-index:999;display:none;align-items:center;gap:0.75rem;">
        <button id="tts-toggle" title="음성 읽기 켜기/끄기" style="width:40px;height:40px;border-radius:50%;border:2px solid #d1d5db;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <span class="material-symbols-outlined" aria-hidden="true" style="font-size:20px;color:#98002E;">volume_up</span>
        </button>
        <div id="mic-tooltip" class="bg-white text-slate-700 text-sm font-semibold px-4 py-2.5 rounded-2xl shadow-lg border border-stone-200 whitespace-nowrap animate-fade-in" style="display:none;">
            여기를 눌러 말씀해 주세요
            <div style="position:absolute;right:-6px;top:50%;transform:translateY(-50%);width:0;height:0;border-top:6px solid transparent;border-bottom:6px solid transparent;border-left:6px solid white;"></div>
        </div>
        <button id="floating-mic" title="음성으로 대화하기">
            <span class="material-symbols-outlined style=" aria-hidden="true"font-size:36px">mic</span>
            <span class="mic-status">
                <span class="material-symbols-outlined style=" aria-hidden="true"font-size:14px;color:#98002E">volume_off</span>
            </span>
        </button>
    </div>

    <!-- ═══════════════════ FOOTER ═══════════════════ -->
    <footer class="hidden bg-white border-t border-stone-200 py-10 px-6 lg:px-20 xl:px-40">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
                <h5 class="font-bold text-slate-800 mb-1.5 text-sm">경상남도사회서비스원</h5>
                <p class="text-xs text-slate-500 leading-relaxed">
                    경상남도 창원시 성산구 창원대로 524 경남사회적경제혁신타운 본관동 2층<br/>
                    대표전화: 055-230-8200
                </p>
            </div>
            <div class="flex gap-5">
                <a class="text-xs text-slate-500 hover:text-primary" href="#">개인정보처리방침</a>
                <a class="text-xs text-slate-500 hover:text-primary" href="#">이용약관</a>
                <a class="text-xs text-slate-500 hover:text-primary" href="#">사이트맵</a>
            </div>
        </div>
    </footer>

    <!-- ═══════════════════ MY DRAWER (내 서랍) PANEL ═══════════════════ -->
    <div id="drawer-overlay" class="hidden fixed inset-0 z-[150] bg-black/40 backdrop-blur-sm" onclick="closeMyDrawer()"></div>
    <div id="drawer-panel" class="fixed top-0 right-0 z-[160] w-full max-w-md h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col">
        <!-- Drawer Header -->
        <div class="flex items-center justify-between px-6 py-5 border-b border-stone-200 bg-gradient-to-r from-primary/5 to-purple-50">
            <div class="flex items-center gap-2.5">
                <span class="material-symbols-outlined text-primary text-2xl" aria-hidden="true">bookmark</span>
                <div>
                    <h2 class="text-lg font-bold text-slate-800">내 서랍</h2>
                    <p class="text-xs text-slate-500">관심 있는 서비스를 모아두었어요</p>
                </div>
            </div>
            <button onclick="closeMyDrawer()" class="p-1.5 text-slate-400 hover:text-slate-600 transition-colors rounded-lg hover:bg-stone-100">
                <span class="material-symbols-outlined text-xl" aria-hidden="true">close</span>
            </button>
        </div>
        <!-- Drawer Body -->
        <div id="drawer-body" class="flex-1 overflow-y-auto p-5 space-y-4">
            <!-- Empty state (default) -->
            <div id="drawer-empty" class="flex flex-col items-center justify-center h-full text-center py-16">
                <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-5">
                    <span class="material-symbols-outlined text-stone-300 text-4xl" aria-hidden="true">bookmark_border</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-2">아직 담아둔 서비스가 없어요</h3>
                <p class="text-sm text-slate-500 leading-relaxed max-w-xs break-keep">서비스 카드의 <span class="inline-flex items-center gap-0.5 text-primary font-semibold"><span class="material-symbols-outlined text-sm" aria-hidden="true">bookmark_add</span>담기</span> 버튼을 눌러<br/>관심 서비스를 저장해 보세요.</p>
            </div>
            <!-- Saved items rendered here -->
            <div id="drawer-items" class="hidden space-y-3"></div>
        </div>
        <!-- Drawer Footer -->
        <div id="drawer-footer" class="hidden border-t border-stone-200 p-4">
            <button id="drawer-clear-all" class="w-full py-2.5 text-sm font-medium text-red-500 hover:bg-red-50 rounded-xl transition-colors flex items-center justify-center gap-1">
                <span class="material-symbols-outlined text-base" aria-hidden="true">delete_sweep</span>
                모두 비우기
            </button>
        </div>
    </div>

    <!-- ═══════════════════ DRAWER OPT-IN CONSENT MODAL ═══════════════════ -->
    <div id="consent-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="consent-modal-title">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-up">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-outlined text-primary text-3xl" aria-hidden="true">bookmark_add</span>
                </div>
                <h3 id="consent-modal-title" class="text-lg font-bold text-slate-800 mb-3">서비스를 저장할까요?</h3>
                <p class="text-sm text-slate-600 leading-relaxed break-keep mb-1">
                    다음에 다시 보실 수 있도록<br/>이 컴퓨터에 <b>익명의 표식</b>을 남겨둘게요.
                </p>
                <p class="text-xs text-slate-400 leading-relaxed break-keep">
                    개인정보는 저장되지 않으며,<br/>언제든 '내 서랍'에서 삭제하실 수 있어요.
                </p>
            </div>
            <div class="px-6 pb-6 flex gap-3">
                <button id="consent-decline" class="flex-1 py-3 rounded-xl border border-stone-300 text-slate-600 font-semibold hover:bg-slate-50 transition-colors text-sm">괜찮아요</button>
                <button id="consent-accept" class="flex-1 py-3 rounded-xl bg-primary text-white font-semibold hover:bg-primary-light transition-colors text-sm">네, 저장할게요</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════ SERVICE REQUEST MODAL ═══════════════════ -->
    <div id="service-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="service-modal-title">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-up">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-primary to-deep-purple px-6 py-5 text-white">
                <h3 id="service-modal-title" class="text-lg font-bold">상담 신청하기</h3>
                <p id="modal-service-name" class="text-white/80 text-sm mt-1"></p>
            </div>
            <!-- Modal Body -->
            <div class="p-6 space-y-5">
                <div id="modal-step-name">
                    <label for="modal-name-input" class="block text-sm font-semibold text-slate-700 mb-2">성함을 입력해 주세요</label>
                    <input id="modal-name-input" type="text" autocomplete="name" class="w-full px-4 py-3 rounded-xl border border-stone-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-base" placeholder="홍길동" />
                    <p id="modal-name-error" class="hidden text-xs text-red-500 mt-1.5">성함을 입력해 주세요.</p>
                </div>
                <div id="modal-step-phone" class="hidden">
                    <label for="modal-phone-input" class="block text-sm font-semibold text-slate-700 mb-2">연락 받으실 전화번호</label>
                    <input id="modal-phone-input" type="tel" inputmode="tel" autocomplete="tel" class="w-full px-4 py-3 rounded-xl border border-stone-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-base" placeholder="010-1234-5678" />
                    <p id="modal-phone-error" class="hidden text-xs text-red-500 mt-1.5">올바른 전화번호를 입력해 주세요. (예: 010-1234-5678)</p>
                </div>
                <div id="modal-step-confirm" class="hidden text-center py-4">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-emerald-600 text-3xl" aria-hidden="true">check_circle</span>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-2">신청이 완료되었습니다!</h4>
                    <p id="modal-confirm-text" class="text-sm text-slate-500 leading-relaxed"></p>
                </div>
                <div id="modal-step-error" class="hidden text-center py-4">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-red-500 text-3xl" aria-hidden="true">error</span>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-2">오류가 발생했습니다</h4>
                    <p class="text-sm text-slate-500">잠시 후 다시 시도해 주세요. 또는 055-230-8200으로 전화 문의해 주세요.</p>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="px-6 pb-6 flex gap-3">
                <button id="modal-cancel" class="flex-1 py-3 rounded-xl border border-stone-300 text-slate-600 font-semibold hover:bg-slate-50 transition-colors text-sm">취소</button>
                <button id="modal-next" class="flex-1 py-3 rounded-xl bg-primary text-white font-semibold hover:bg-primary-light transition-colors text-sm">다음</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════ JAVASCRIPT ═══════════════════ -->
    <script>
    (() => {
        // ── DOM References ──
        const $ = id => document.getElementById(id);
        const DOM = {
            heroSection: $('hero-section'),
            heroInput: $('hero-input'),
            heroSubmit: $('hero-submit'),
            heroMic: $('hero-mic'),
            heroChips: $('hero-chips'),
            resultsSection: $('results-section'),
            aiSummaryArea: $('ai-summary-area'),
            aiSummaryText: $('ai-summary-text'),
            cardsTitle: $('cards-title'),
            cardsGrid: $('cards-grid'),
            cardsSkeleton: $('cards-skeleton'),
            discoverMore: $('discover-more'),
            btnNewSearch: $('btn-new-search'),
            initialPlaceholder: $('initial-placeholder'),
            // Browse
            browseTabs: $('browse-tabs'),
            browseList: $('browse-list'),
            browseLoading: $('browse-loading'),
            // Modal
            serviceModal: $('service-modal'),
            modalServiceName: $('modal-service-name'),
            modalStepName: $('modal-step-name'),
            modalStepPhone: $('modal-step-phone'),
            modalStepConfirm: $('modal-step-confirm'),
            modalStepError: $('modal-step-error'),
            modalNameInput: $('modal-name-input'),
            modalPhoneInput: $('modal-phone-input'),
            modalConfirmText: $('modal-confirm-text'),
            modalCancel: $('modal-cancel'),
            modalNext: $('modal-next'),
            modalNameError: $('modal-name-error'),
            modalPhoneError: $('modal-phone-error'),
            consentModal: $('consent-modal'),
            // Floating Mic
            floatingMic: $('floating-mic'),
            floatingMicWrap: $('floating-mic-wrap'),
        };

        // ── State ──
        let chatHistory = [];
        let currentCards = [];
        let modalState = { step: 'name', serviceName: '', name: '', phone: '' };
        let isSpeaking = false;
        let currentAudio = null;
        let currentUtterance = null;
        let sectionsRevealed = false;
        // TTS 자동재생 토글 (localStorage 기반)
        const TTS_KEY = 'noma_tts_enabled';
        let ttsEnabled = localStorage.getItem(TTS_KEY) !== 'false'; // 기본: 켜짐

        // ── Progressive Reveal: 아래 섹션 순차 공개 ──
        function revealBelowFoldSections() {
            if (sectionsRevealed) return;
            sectionsRevealed = true;
            const targets = [
                document.getElementById('initial-placeholder'),
                document.getElementById('browse-section'),
                document.getElementById('journey-section'),
                document.querySelector('footer'),
            ];
            targets.forEach((el, i) => {
                if (!el) return;
                el.classList.remove('hidden');
                el.classList.add('reveal-fade-up');
                setTimeout(() => el.classList.add('revealed'), 150 * (i + 1));
            });
        }
        // Expose globally for hamburger menu
        window.revealBelowFoldSections = revealBelowFoldSections;

        // ── Utility: Parse <noma-card> blocks from AI text ──
        function parseNomaCards(text) {
            const cards = [];
            const regex = /<noma-card>([\s\S]*?)<\/noma-card>/g;
            let match;
            while ((match = regex.exec(text)) !== null) {
                try {
                    cards.push(JSON.parse(match[1].trim()));
                } catch (e) { /* skip malformed */ }
            }
            const cleanText = text.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim();
            return { cards, summaryText: cleanText };
        }

        // ── Utility: Parse <noma-apply> block from AI text ──
        function parseNomaApply(text) {
            const regex = /<noma-apply>([\s\S]*?)<\/noma-apply>/;
            const match = regex.exec(text);
            if (!match) return null;
            try {
                const data = JSON.parse(match[1].trim());
                if (data.serviceName && data.userName && data.userPhone) {
                    return data;
                }
            } catch (e) { /* malformed JSON */ }
            return null;
        }

        // ── Utility: Basic markdown to HTML ──
        function md(text) {
            const html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br/>');
            return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;
        }

        // ── Card Colors Pool ──
        const cardThemes = [
            { bg: 'bg-primary/10', text: 'text-primary', icon: 'emergency', border: 'border-primary/20', reasonBg: 'bg-amber-50', reasonBorder: 'border-amber-100', reasonTitle: 'text-amber-800', reasonText: 'text-amber-900/80' },
            { bg: 'bg-blue-50', text: 'text-blue-600', icon: 'home_health', border: 'border-blue-200', reasonBg: 'bg-blue-50', reasonBorder: 'border-blue-100', reasonTitle: 'text-blue-800', reasonText: 'text-blue-900/80' },
            { bg: 'bg-emerald-50', text: 'text-emerald-600', icon: 'smart_toy', border: 'border-emerald-200', reasonBg: 'bg-emerald-50', reasonBorder: 'border-emerald-100', reasonTitle: 'text-emerald-800', reasonText: 'text-emerald-900/80' },
            { bg: 'bg-violet-50', text: 'text-violet-600', icon: 'volunteer_activism', border: 'border-violet-200', reasonBg: 'bg-violet-50', reasonBorder: 'border-violet-100', reasonTitle: 'text-violet-800', reasonText: 'text-violet-900/80' },
        ];

        // ── 전화번호 자동 감지 → tel: 링크 변환 ──
        function linkifyPhone(text) {
            if (!text) return '';
            return text.replace(/(0\d{1,2}[-.\s]?\d{3,4}[-.\s]?\d{4})/g, (match) => {
                const digits = match.replace(/[-.\s]/g, '');
                return `<a href="tel:${digits}" class="tel-link"><span class="material-symbols-outlined style=" aria-hidden="true"font-size:1.125rem">call</span>${match}</a>`;
            });
        }

        // ── Render a single recommendation card (Stepper 경로형) ──
        function createCardElement(data, index) {
            const theme = cardThemes[index % cardThemes.length];
            const delay = index * 100;
            const card = document.createElement('div');
            card.className = `bg-white rounded-2xl p-5 md:p-7 shadow-sm border border-stone-100 hover:border-primary/20 flex flex-col h-full transition-all group relative overflow-hidden opacity-0 animate-fade-up`;
            card.style.animationDelay = `${delay}ms`;

            // 단계 데이터 구성 (값이 있는 단계만 포함)
            const steps = [
                data.target  && { num: 1, title: '대상 확인',  icon: 'person_check', content: data.target,  color: '#2563eb' },
                data.method  && { num: 2, title: '신청 방법',  icon: 'edit_document', content: data.method,  color: '#7c3aed' },
                data.benefits && { num: 3, title: '받는 혜택', icon: 'featured_seasonal_and_gifts', content: data.benefits, color: '#059669' },
                data.agency  && { num: 4, title: '연락처',     icon: 'call',          content: data.agency,  color: '#0891b2', isContact: true },
            ].filter(Boolean);

            // 단계 번호 재정렬
            steps.forEach((s, i) => s.num = i + 1);

            const stepsHTML = steps.map((step, i) => {
                const isFirst = i === 0;
                return `
                    <div class="step-item${isFirst ? ' open' : ''}" data-step>
                        <div class="step-dot" style="background:${step.color}">${step.num}</div>
                        <div class="step-header" data-step-toggle>
                            <span class="material-symbols-outlined text-base" aria-hidden="true" style="color:${step.color}">${step.icon}</span>
                            <span class="font-semibold text-slate-700 text-sm">${step.title}</span>
                            <span class="material-symbols-outlined step-chevron text-stone-400 ml-auto" aria-hidden="true">expand_more</span>
                        </div>
                        <div class="step-body${isFirst ? ' open' : ''}">
                            <div class="text-slate-600 text-[13px] leading-relaxed break-keep pl-0.5">
                                ${step.isContact ? linkifyPhone(step.content) : step.content}
                            </div>
                        </div>
                    </div>`;
            }).join('');

            // 전화번호 추출 (모바일 전화하기 버튼용)
            const phoneMatch = (data.agency || '').match(/0\d{1,2}[-.\s]?\d{3,4}[-.\s]?\d{4}/);
            const phoneBtnHTML = phoneMatch
                ? `<a href="tel:${phoneMatch[0].replace(/[-.\s]/g, '')}" class="card-phone-btn hidden md:!hidden" style="display:none">
                        <span class="material-symbols-outlined text-2xl" aria-hidden="true">call</span>
                        전화하기 ${phoneMatch[0]}
                   </a>`
                : '';

            card.innerHTML = `
                <div class="absolute top-0 right-0 w-28 h-28 ${theme.bg} rounded-full -mr-8 -mt-8 blur-2xl opacity-50 group-hover:opacity-80 transition-opacity"></div>
                <div class="flex items-start justify-between mb-3 relative z-10">
                    <div class="${theme.bg} p-2.5 rounded-xl ${theme.text}">
                        <span class="material-symbols-outlined text-2xl" aria-hidden="true">${theme.icon}</span>
                    </div>
                    <button class="btn-bookmark p-2 rounded-lg text-stone-300 hover:text-primary hover:bg-primary/5 transition-all" data-service-name="${data.serviceName || ''}" title="내 서랍에 담기">
                        <span class="material-symbols-outlined text-xl" aria-hidden="true">bookmark_add</span>
                    </button>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-1 relative z-10 break-keep">${data.serviceName || ''}</h3>
                <p class="text-slate-500 text-[13px] mb-4 leading-relaxed relative z-10 break-keep">${data.summary || ''}</p>

                <div class="stepper relative z-10 mb-4">
                    ${stepsHTML}
                </div>

                <div class="mt-auto relative z-10">
                    ${phoneBtnHTML}
                    <button class="btn-apply w-full bg-primary hover:bg-primary-light active:scale-[0.98] text-white font-bold py-5 md:py-3.5 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 text-lg md:text-sm" data-service="${data.serviceName || ''}">
                        이 서비스 상담 신청
                        <span class="material-symbols-outlined text-base" aria-hidden="true">arrow_outward</span>
                    </button>
                    <p class="card-disclaimer text-[10px] text-slate-400 text-center mt-2 leading-snug">버튼을 누르면 담당 기관에 정보가 전달되며,<br/>2~3일 내 전화 연락드립니다.</p>
                </div>
            `;
            return card;
        }

        // ══════════════════════════════════════════
        // ── BROWSE ALL SERVICES ──
        // ══════════════════════════════════════════

        let browseData = [];
        let browseActiveCategory = null;

        async function loadBrowseServices() {
            try {
                const res = await fetch('/api/services');
                if (!res.ok) throw new Error('API error');
                browseData = await res.json();
                DOM.browseLoading.classList.add('hidden');
                renderBrowseTabs();
                if (browseData.length > 0) selectBrowseCategory(browseData[0].category);
            } catch (e) {
                DOM.browseLoading.innerHTML = '<p class="text-slate-400 text-sm">서비스 목록을 불러올 수 없습니다.</p>';
            }
        }

        function renderBrowseTabs() {
            DOM.browseTabs.innerHTML = browseData.map(cat => `
                <button class="browse-tab flex items-center gap-2 px-5 py-3 rounded-xl border-2 transition-all text-sm font-semibold" data-cat="${cat.category}"
                    style="border-color: ${cat.color}20; color: ${cat.color};">
                    <span class="material-symbols-outlined text-lg" aria-hidden="true">${cat.icon}</span>
                    ${cat.category}
                    <span class="text-xs font-normal opacity-70">(${cat.services.length})</span>
                </button>
            `).join('');

            DOM.browseTabs.addEventListener('click', e => {
                const tab = e.target.closest('.browse-tab');
                if (tab) selectBrowseCategory(tab.dataset.cat);
            });
        }

        function selectBrowseCategory(catName) {
            browseActiveCategory = catName;
            const cat = browseData.find(c => c.category === catName);
            if (!cat) return;

            // Update tab active state
            DOM.browseTabs.querySelectorAll('.browse-tab').forEach(tab => {
                const isActive = tab.dataset.cat === catName;
                tab.style.backgroundColor = isActive ? cat.color + '10' : 'white';
                tab.style.borderColor = isActive ? cat.color : cat.color + '20';
                tab.style.transform = isActive ? 'scale(1.05)' : '';
            });

            // Render service list
            DOM.browseList.innerHTML = `
                <p class="text-sm text-slate-500 mb-4 px-1">${cat.desc}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${cat.services.map((s, i) => `
                        <div class="browse-item bg-white border border-stone-200 rounded-xl p-5 hover:border-primary/30 hover:shadow-md transition-all cursor-pointer group opacity-0 animate-fade-up" style="animation-delay:${i * 50}ms" data-idx="${i}">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-slate-800 text-[15px] mb-1.5 group-hover:text-primary transition-colors break-keep">${s.name}</h4>
                                    <p class="text-xs text-slate-500 leading-relaxed line-clamp-2 break-keep">${s.summary}</p>
                                </div>
                                <div class="flex items-center gap-1 flex-shrink-0">
                                    <button class="browse-bookmark p-1 rounded text-stone-300 hover:text-primary transition-colors" data-service-name="${s.name}" data-summary="${(s.summary || '').replace(/"/g, '&quot;')}" data-agency="${(s.agency || '').replace(/"/g, '&quot;')}" title="내 서랍에 담기" onclick="event.stopPropagation()">
                                        <span class="material-symbols-outlined text-lg" aria-hidden="true">bookmark_add</span>
                                    </button>
                                    <span class="material-symbols-outlined text-stone-300 group-hover:text-primary transition-colors mt-1" aria-hidden="true">chevron_right</span>
                                </div>
                            </div>
                            <!-- Expandable Detail -->
                            <div class="browse-detail hidden mt-4 pt-4 border-t border-stone-100 space-y-3 text-sm">
                                ${s.target ? `<div class="flex gap-2"><span class="material-symbols-outlined text-stone-400 text-base flex-shrink-0 mt-0.5" aria-hidden="true">group</span><div><span class="font-semibold text-slate-700">지원 대상</span><p class="text-slate-500 text-xs mt-0.5 leading-relaxed break-keep">${s.target}</p></div></div>` : ''}
                                ${s.benefits ? `<div class="flex gap-2"><span class="material-symbols-outlined text-stone-400 text-base flex-shrink-0 mt-0.5" aria-hidden="true">featured_seasonal_and_gifts</span><div><span class="font-semibold text-slate-700">지원 내용</span><p class="text-slate-500 text-xs mt-0.5 leading-relaxed break-keep">${s.benefits}</p></div></div>` : ''}
                                ${s.method ? `<div class="flex gap-2"><span class="material-symbols-outlined text-stone-400 text-base flex-shrink-0 mt-0.5" aria-hidden="true">edit_document</span><div><span class="font-semibold text-slate-700">신청 방법</span><p class="text-slate-500 text-xs mt-0.5 leading-relaxed break-keep">${s.method}</p></div></div>` : ''}
                                ${s.agency ? `<p class="text-[11px] text-slate-400 flex items-center gap-1"><span class="material-symbols-outlined text-xs" aria-hidden="true">account_balance</span>담당: ${s.agency}</p>` : ''}
                                <button class="browse-apply w-full bg-primary hover:bg-primary-light text-white font-bold py-3 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 text-sm mt-2" data-service="${s.name}">
                                    이 사업 상담 신청하기
                                    <span class="material-symbols-outlined text-base" aria-hidden="true">arrow_outward</span>
                                </button>
                                <p class="text-[10px] text-slate-400 text-center leading-snug">버튼을 누르시면 담당 기관에 이메일로 정보가 전달되며,<br/>2~3일 내로 전화 연락을 드릴 예정입니다.</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Toggle detail on click
            DOM.browseList.querySelectorAll('.browse-item').forEach(item => {
                item.addEventListener('click', e => {
                    if (e.target.closest('.browse-apply') || e.target.closest('.browse-bookmark')) return;
                    const detail = item.querySelector('.browse-detail');
                    const isOpen = !detail.classList.contains('hidden');
                    // Close all
                    DOM.browseList.querySelectorAll('.browse-detail').forEach(d => d.classList.add('hidden'));
                    if (!isOpen) detail.classList.remove('hidden');
                });
            });

            // Apply buttons
            DOM.browseList.addEventListener('click', e => {
                const btn = e.target.closest('.browse-apply');
                if (btn) { e.stopPropagation(); openServiceModal(btn.dataset.service); }
            });

            // Browse bookmark buttons
            DOM.browseList.querySelectorAll('.browse-bookmark').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    handleBookmark(btn.dataset.serviceName, {
                        serviceName: btn.dataset.serviceName,
                        summary: btn.dataset.summary || '',
                        agency: btn.dataset.agency || ''
                    });
                });
            });
        }

        loadBrowseServices();

        // ══════════════════════════════════════════
        // ── HERO SEARCH → INLINE RESULTS FLOW ──
        // ══════════════════════════════════════════

        // Clean chatHistory before sending to API: strip noma-card blocks and limit length
        // Anchor 방식: 첫 2턴(맥락 고정) + 최근 6턴 = 최대 8턴 유지
        function prepareMessagesForAPI() {
            const MAX_HISTORY = 8;
            const ANCHOR_COUNT = 2;
            const clean = m => ({
                role: m.role,
                content: m.role === 'model'
                    ? m.content.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim()
                    : m.content
            });
            if (chatHistory.length <= MAX_HISTORY) {
                return chatHistory.map(clean);
            }
            const anchor = chatHistory.slice(0, ANCHOR_COUNT).map(clean);
            const recent = chatHistory.slice(-(MAX_HISTORY - ANCHOR_COUNT)).map(clean);
            return [...anchor, ...recent];
        }

        async function performSearch(query) {
            if (!query.trim()) return;

            // Transition to results state
            DOM.heroSection.classList.add('hero-compact');
            DOM.heroChips.classList.add('hidden');
            // Show floating mic after search
            if (DOM.floatingMicWrap && SpeechRecognition) DOM.floatingMicWrap.style.display = 'flex';
            DOM.initialPlaceholder.classList.add('hidden');
            DOM.resultsSection.classList.remove('hidden');
            // Reveal below-fold sections
            revealBelowFoldSections();
            DOM.aiSummaryArea.classList.add('hidden');
            DOM.discoverMore.classList.add('hidden');
            DOM.btnNewSearch.classList.remove('hidden');
            DOM.cardsGrid.innerHTML = '';
            DOM.cardsSkeleton.classList.remove('hidden');

            // Add to chat history
            chatHistory.push({ role: 'user', content: query });

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: prepareMessagesForAPI() }),
                    signal: controller.signal,
                });
                clearTimeout(timeout);

                if (!response.ok) throw new Error('Network error');

                // ── 실시간 스트리밍 처리 ──
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let fullResponse = '';
                let apiError = '';
                let fillerShown = false;
                let streamStarted = false;
                let sseBuffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    sseBuffer += decoder.decode(value, { stream: true });
                    const lines = sseBuffer.split('\n');
                    sseBuffer = lines.pop(); // 마지막 미완성 라인은 버퍼에 유지

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const dataStr = line.slice(6).trim();
                        if (dataStr === '[DONE]') continue;

                        try {
                            const data = JSON.parse(dataStr);

                            // filler 공감 응답: 즉시 표시
                            if (data.type === 'filler' && data.text) {
                                fillerShown = true;
                                DOM.cardsSkeleton.classList.add('hidden');
                                DOM.aiSummaryArea.classList.remove('hidden');
                                DOM.aiSummaryText.innerHTML = `<p class="text-primary/80 animate-pulse">${data.text}</p>`;
                            }

                            // stream 실제 AI 응답: 실시간으로 이어서 표시
                            if (data.type === 'stream' && data.text) {
                                if (!streamStarted) {
                                    streamStarted = true;
                                    DOM.cardsSkeleton.classList.add('hidden');
                                    DOM.aiSummaryArea.classList.remove('hidden');
                                    // filler 아래에 실제 응답 영역 추가
                                    if (fillerShown) {
                                        DOM.aiSummaryText.innerHTML = `<p class="text-primary/80 text-sm mb-2">${DOM.aiSummaryText.textContent}</p><div id="stream-output"></div>`;
                                    } else {
                                        DOM.aiSummaryText.innerHTML = '<div id="stream-output"></div>';
                                    }
                                }
                                fullResponse += data.text;
                                // 실시간으로 마크다운 렌더링 (noma-card 태그는 최종 파싱에서 처리)
                                const streamEl = $('stream-output');
                                if (streamEl) {
                                    const displaySoFar = fullResponse.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim();
                                    streamEl.innerHTML = md(displaySoFar);
                                }
                            }

                            // 하위 호환: type 없는 기존 형식 처리
                            if (!data.type && data.text) {
                                fullResponse += data.text;
                            }

                            if (data.error) apiError = data.error;
                        } catch (e) { /* partial chunk */ }
                    }
                }

                // ── 응답 완료 후 처리 ──

                // API 오류 시 사용자에게 안내 + 재시도 버튼
                if (!fullResponse && apiError) {
                    chatHistory.pop();
                    DOM.cardsSkeleton.classList.add('hidden');
                    DOM.cardsTitle.classList.add('hidden');
                    DOM.cardsGrid.classList.add('hidden');
                    DOM.aiSummaryArea.classList.remove('hidden');
                    DOM.aiSummaryText.innerHTML = `
                        <p>죄송합니다. AI 서버에서 응답을 받지 못했습니다.</p>
                        <p class="text-sm text-slate-500 mt-2">네트워크 상태를 확인하시거나, 잠시 후 다시 시도해 주세요.</p>
                        <button id="btn-retry-search" class="mt-4 px-5 py-2.5 bg-primary text-white text-sm font-semibold rounded-xl hover:bg-primary-light transition-colors inline-flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-base" aria-hidden="true">refresh</span>
                            다시 시도하기
                        </button>
                    `;
                    const retryBtn = $('btn-retry-search');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => {
                            DOM.heroInput.value = query;
                            performSearch(query);
                        });
                    }
                    DOM.discoverMore.classList.remove('hidden');
                    return;
                }

                // 빈 응답 처리
                if (!fullResponse) {
                    chatHistory.pop();
                    DOM.cardsSkeleton.classList.add('hidden');
                    DOM.cardsTitle.classList.add('hidden');
                    DOM.cardsGrid.classList.add('hidden');
                    DOM.aiSummaryArea.classList.remove('hidden');
                    DOM.aiSummaryText.innerHTML = `
                        <p>AI 응답이 비어 있습니다. 다시 시도해 주세요.</p>
                        <button id="btn-retry-search" class="mt-4 px-5 py-2.5 bg-primary text-white text-sm font-semibold rounded-xl hover:bg-primary-light transition-colors inline-flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-base" aria-hidden="true">refresh</span>
                            다시 시도하기
                        </button>
                    `;
                    const retryBtn = $('btn-retry-search');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => {
                            DOM.heroInput.value = query;
                            performSearch(query);
                        });
                    }
                    DOM.discoverMore.classList.remove('hidden');
                    return;
                }

                chatHistory.push({ role: 'model', content: fullResponse });
                saveHistory();

                // Parse cards and summary (최종 전체 응답에서)
                const { cards, summaryText } = parseNomaCards(fullResponse);
                currentCards = cards;

                // 최종 렌더링: 스트리밍 중간 상태를 깔끔한 최종 상태로 교체
                DOM.cardsSkeleton.classList.add('hidden');
                const displayText = summaryText || fullResponse.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim();
                if (displayText) {
                    DOM.aiSummaryArea.classList.remove('hidden');
                    DOM.aiSummaryText.innerHTML = md(displayText);
                }

                // Render cards or handle no-card cases
                if (cards.length > 0) {
                    DOM.cardsTitle.classList.remove('hidden');
                    DOM.cardsGrid.classList.remove('hidden');
                    cards.forEach((card, i) => {
                        DOM.cardsGrid.appendChild(createCardElement(card, i));
                    });
                } else if (displayText) {
                    DOM.cardsTitle.classList.add('hidden');
                    DOM.cardsGrid.classList.add('hidden');
                } else {
                    DOM.cardsTitle.classList.remove('hidden');
                    DOM.cardsGrid.classList.remove('hidden');
                    DOM.cardsGrid.innerHTML = `
                        <div class="col-span-full text-center py-10 opacity-0 animate-fade-up">
                            <span class="material-symbols-outlined text-stone-300 text-5xl mb-3" aria-hidden="true">search_off</span>
                            <p class="text-slate-500 text-sm">관련 서비스를 찾지 못했습니다.<br/>다른 키워드로 다시 검색해 보세요.</p>
                        </div>
                    `;
                }

                // Show discover more
                DOM.discoverMore.classList.remove('hidden');

                // ── 대화형 상담 신청: <noma-apply> 자동 처리 ──
                const applyData = parseNomaApply(fullResponse);
                if (applyData) {
                    try {
                        const applyRes = await fetch('/api/service-request/connect', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                serviceName: applyData.serviceName,
                                userName: applyData.userName,
                                userPhone: applyData.userPhone,
                                chatHistory: chatHistory.map(m => ({
                                    role: m.role,
                                    content: m.role === 'model'
                                        ? m.content.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim()
                                        : m.content
                                })).filter(m => m.content)
                            })
                        });
                        if (!applyRes.ok) throw new Error('API failed');
                        // 성공 카드
                        DOM.aiSummaryText.innerHTML += `
                            <div class="mt-4 p-4 bg-emerald-50 border border-emerald-200 rounded-xl animate-fade-up">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-emerald-600" aria-hidden="true" style="font-size:20px">check_circle</span>
                                    <span class="font-bold text-emerald-800 text-sm">상담 신청 완료</span>
                                </div>
                                <p class="text-emerald-700 text-sm leading-relaxed">${applyData.userName}님, <b>${applyData.serviceName}</b> 담당 기관에 상담 요청을 보냈습니다.<br/>2~3일 내로 <b>${applyData.userPhone}</b>으로 연락드릴 예정입니다.</p>
                            </div>`;
                    } catch (applyErr) {
                        console.error('Auto apply error:', applyErr);
                        // 실패 카드
                        DOM.aiSummaryText.innerHTML += `
                            <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-xl animate-fade-up">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-red-600" aria-hidden="true" style="font-size:20px">error</span>
                                    <span class="font-bold text-red-800 text-sm">신청 중 오류가 발생했습니다</span>
                                </div>
                                <p class="text-red-700 text-sm leading-relaxed">자동 신청에 실패했습니다. 서비스 카드의 <b>"상담 신청"</b> 버튼을 눌러 직접 신청해 주세요.</p>
                            </div>`;
                    }
                }

                // Smooth scroll to results
                DOM.resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // TTS: 토글 설정에 따라 음성으로 읽어주기 (시니어 최적화)
                if (fullResponse && ttsEnabled) {
                    await speakText(extractSpeakableText(fullResponse));
                }

            } catch (err) {
                chatHistory.pop(); // 실패한 사용자 메시지 제거
                console.error('Search error:', err);
                DOM.cardsSkeleton.classList.add('hidden');

                const isTimeout = err.name === 'AbortError';
                DOM.aiSummaryArea.classList.remove('hidden');
                DOM.aiSummaryText.innerHTML = `
                    <p>${isTimeout ? 'AI 서버 응답 시간이 초과되었습니다.' : 'AI 서버에 연결할 수 없습니다.'}</p>
                    <p class="text-sm text-slate-500 mt-2">${isTimeout ? '잠시 후 다시 시도해 주세요.' : '로컬 서버(localhost:5000)가 실행 중인지 확인해 주세요.'}</p>
                    <button id="btn-retry-search" class="mt-4 px-5 py-2.5 bg-primary text-white text-sm font-semibold rounded-xl hover:bg-primary-light transition-colors inline-flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-base" aria-hidden="true">refresh</span>
                        다시 시도하기
                    </button>
                `;
                DOM.cardsTitle.classList.add('hidden');
                DOM.cardsGrid.classList.add('hidden');
                const retryBtn = $('btn-retry-search');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => {
                        DOM.heroInput.value = query;
                        performSearch(query);
                    });
                }
                DOM.discoverMore.classList.remove('hidden');
            }
        }

        // ── Hero Event Handlers ──
        function handleHeroSubmit() {
            const query = DOM.heroInput.value.trim();
            if (!query) return;
            DOM.heroInput.value = '';
            performSearch(query);
        }

        DOM.heroSubmit.addEventListener('click', handleHeroSubmit);
        DOM.heroInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); handleHeroSubmit(); }
        });

        document.querySelectorAll('.hero-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const msg = chip.getAttribute('data-msg');
                DOM.heroInput.value = msg;
                handleHeroSubmit();
            });
        });

        // ── Reset to Home ──
        function resetToHome() {
            DOM.heroSection.classList.remove('hero-compact');
            DOM.heroChips.classList.remove('hidden');
            DOM.resultsSection.classList.add('hidden');
            DOM.heroInput.value = '';
            currentCards = [];

            // 모달 닫기
            DOM.serviceModal.classList.add('hidden');

            // 대화 내역 초기화
            clearChatData();

            // 아래 섹션 다시 숨김
            DOM.initialPlaceholder.classList.add('hidden');
            document.getElementById('browse-section')?.classList.add('hidden');
            document.getElementById('journey-section')?.classList.add('hidden');
            document.querySelector('footer')?.classList.add('hidden');
            sectionsRevealed = false;

            // 히어로 풀스크린 복원
            DOM.heroSection.style.minHeight = 'calc(100vh - 80px)';
            const ctaWrap = $('hero-voice-cta-wrap');
            if (ctaWrap) ctaWrap.style.display = 'flex';

            // 플로팅 마이크 숨김
            if (DOM.floatingMicWrap) {
                DOM.floatingMicWrap.style.display = 'none';
            }

            // 최상단 스크롤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // Expose globally for logo click
        window.resetToHome = resetToHome;

        // New search button
        DOM.btnNewSearch.addEventListener('click', resetToHome);

        // Browse scroll from discover section
        const btnBrowseScroll = $('btn-browse-scroll');
        if (btnBrowseScroll) {
            btnBrowseScroll.addEventListener('click', () => {
                revealBelowFoldSections();
                setTimeout(() => document.getElementById('browse-section')?.scrollIntoView({ behavior: 'smooth' }), 100);
            });
        }

        // ── Stepper: Step toggle (expand/collapse) ──
        DOM.cardsGrid.addEventListener('click', e => {
            const toggle = e.target.closest('[data-step-toggle]');
            if (!toggle) return;
            const stepItem = toggle.closest('[data-step]');
            if (!stepItem) return;
            const body = stepItem.querySelector('.step-body');
            const isOpen = body.classList.contains('open');
            body.classList.toggle('open', !isOpen);
            stepItem.classList.toggle('open', !isOpen);
        });

        // ── Card Click → Service Request Modal ──
        DOM.cardsGrid.addEventListener('click', e => {
            const btn = e.target.closest('.btn-apply');
            if (!btn) return;
            openServiceModal(btn.dataset.service);
        });

        // ══════════════════════════════════════
        // ── SERVICE REQUEST MODAL ──
        // ══════════════════════════════════════

        const APPLY_KEY = 'noma_applied_services';
        function getAppliedServices() {
            try { return JSON.parse(sessionStorage.getItem(APPLY_KEY) || '[]'); } catch { return []; }
        }
        function markApplied(serviceName) {
            const list = getAppliedServices();
            if (!list.includes(serviceName)) list.push(serviceName);
            sessionStorage.setItem(APPLY_KEY, JSON.stringify(list));
        }

        function openServiceModal(serviceName) {
            if (getAppliedServices().includes(serviceName)) {
                showToast('이미 해당 서비스를 신청하셨습니다.');
                return;
            }
            modalState = { step: 'name', serviceName, name: '', phone: '' };
            DOM.modalServiceName.textContent = serviceName;
            DOM.modalStepName.classList.remove('hidden');
            DOM.modalStepPhone.classList.add('hidden');
            DOM.modalStepConfirm.classList.add('hidden');
            DOM.modalStepError.classList.add('hidden');
            DOM.modalNext.textContent = '다음';
            DOM.modalNext.classList.remove('hidden');
            DOM.modalCancel.textContent = '취소';
            DOM.modalCancel.classList.remove('hidden');
            DOM.modalNameInput.value = '';
            DOM.modalPhoneInput.value = '';
            DOM.serviceModal.classList.remove('hidden');
            setTimeout(() => DOM.modalNameInput.focus(), 100);
        }

        DOM.modalCancel.addEventListener('click', () => {
            if (modalState.step === 'confirm') {
                resetToHome();
            } else {
                DOM.serviceModal.classList.add('hidden');
            }
        });

        DOM.serviceModal.addEventListener('click', e => {
            if (e.target === DOM.serviceModal) DOM.serviceModal.classList.add('hidden');
        });

        DOM.modalNext.addEventListener('click', async () => {
            if (modalState.step === 'name') {
                const name = DOM.modalNameInput.value.trim();
                if (!name) {
                    DOM.modalNameError.classList.remove('hidden');
                    DOM.modalNameInput.focus();
                    return;
                }
                DOM.modalNameError.classList.add('hidden');
                modalState.name = name;
                modalState.step = 'phone';
                DOM.modalStepName.classList.add('hidden');
                DOM.modalStepPhone.classList.remove('hidden');
                DOM.modalNext.textContent = '신청 완료';
                setTimeout(() => DOM.modalPhoneInput.focus(), 100);
            } else if (modalState.step === 'phone') {
                const phone = DOM.modalPhoneInput.value.trim();
                const phoneRegex = /^0\d{1,2}-?\d{3,4}-?\d{4}$/;
                if (!phone || !phoneRegex.test(phone)) {
                    DOM.modalPhoneError.classList.remove('hidden');
                    DOM.modalPhoneInput.focus();
                    return;
                }
                DOM.modalPhoneError.classList.add('hidden');
                modalState.phone = phone;
                DOM.modalNext.textContent = '처리 중...';
                DOM.modalNext.disabled = true;

                try {
                    const res = await fetch('/api/service-request/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            serviceName: modalState.serviceName,
                            userName: modalState.name,
                            userPhone: modalState.phone,
                            chatHistory: chatHistory.map(m => ({
                                role: m.role,
                                content: m.role === 'model'
                                    ? m.content.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim()
                                    : m.content
                            })).filter(m => m.content)
                        })
                    });
                    if (!res.ok) throw new Error('API failed');

                    markApplied(modalState.serviceName);
                    modalState.step = 'confirm';
                    DOM.modalStepPhone.classList.add('hidden');
                    DOM.modalStepConfirm.classList.remove('hidden');
                    const escH = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
                    DOM.modalConfirmText.innerHTML = `<b>${escH(modalState.name)}</b>님, <b>${escH(modalState.serviceName)}</b> 담당 기관에 상담 요청을 보냈습니다.<br/>2~3일 내로 <b>${escH(modalState.phone)}</b>으로 연락드릴 예정입니다.<br/><span class="text-[10px] text-slate-500 mt-2 inline-block">잠시 후 처음 화면으로 돌아갑니다...</span>`;
                    DOM.modalNext.classList.add('hidden');
                    DOM.modalCancel.textContent = '닫기';

                    setTimeout(resetToHome, 4000);
                } catch (err) {
                    modalState.step = 'error';
                    DOM.modalStepPhone.classList.add('hidden');
                    DOM.modalStepError.classList.remove('hidden');
                    DOM.modalNext.classList.add('hidden');
                    DOM.modalCancel.textContent = '닫기';
                } finally {
                    DOM.modalNext.disabled = false;
                }
            }
        });

        // Enter key in modal inputs
        DOM.modalNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') DOM.modalNext.click(); });
        DOM.modalPhoneInput.addEventListener('keydown', e => { if (e.key === 'Enter') DOM.modalNext.click(); });

        // ══════════════════════════════════════
        // ── SPEECH RECOGNITION + TTS ──
        // ══════════════════════════════════════

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let activeInput = null;
        let activeBtn = null;
        let isRecognitionRunning = false;

        function startListening(inputEl, btnEl) {
            if (!recognition) return;
            if (isRecognitionRunning) {
                recognition.abort();
                setTimeout(() => startListening(inputEl, btnEl), 150);
                return;
            }
            activeInput = inputEl;
            activeBtn = btnEl;
            try {
                recognition.start();
                isRecognitionRunning = true;
                btnEl.classList.add('animate-pulse', '!text-red-500');
                const icon = btnEl.querySelector('.material-symbols-outlined');
                if (icon) icon.textContent = 'graphic_eq';
                updateFloatingMicState();
            } catch (e) {
                console.error('Speech recognition start failed:', e);
                isRecognitionRunning = false;
                updateFloatingMicState();
            }
        }

        // ── TTS (Text-to-Speech) ──
        function extractSpeakableText(text) {
            const cardRegex = /<noma-card>([\s\S]*?)<\/noma-card>/g;
            const cards = [];
            let m;
            while ((m = cardRegex.exec(text)) !== null) {
                try {
                    const card = JSON.parse(m[1].trim());
                    if (card.serviceName) cards.push(card);
                } catch (e) {}
            }
            let clean = text.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').replace(/<noma-apply>[\s\S]*?<\/noma-apply>/g, '').trim();
            clean = clean.replace(/\*\*(.*?)\*\*/g, '$1');
            clean = clean.replace(/\*(.*?)\*/g, '$1');
            clean = clean.replace(/#{1,6}\s/g, '');
            clean = clean.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
            clean = clean.replace(/`([^`]+)`/g, '$1');
            if (cards.length > 0) {
                const ordinals = ['첫', '두', '세', '네', '다섯'];
                const cardSummary = cards.map((card, i) => {
                    let line = `${ordinals[i] || (i + 1)} 번째 추천 서비스는 ${card.serviceName}입니다.`;
                    // 연락처에서 전화번호 추출하여 읽어주기
                    if (card.agency) {
                        const phoneMatch = card.agency.match(/0\d{1,2}[-.\s]?\d{3,4}[-.\s]?\d{4}/);
                        if (phoneMatch) {
                            line += ` 문의는 ${phoneMatch[0]}로 전화하시면 됩니다.`;
                        }
                    }
                    return line;
                }).join(' ');
                clean += '\n' + cardSummary;
                // 전화번호가 있으면 초록 버튼 안내 추가
                const hasPhone = cards.some(c => c.agency && /0\d{1,2}[-.\s]?\d{3,4}[-.\s]?\d{4}/.test(c.agency));
                if (hasPhone) {
                    clean += ' 전화 연결을 원하시면, 초록색 전화하기 버튼을 눌러주세요.';
                }
            }
            return clean.trim();
        }

        function speakText(text) {
            return new Promise(async resolve => {
                if (!text) { resolve(); return; }
                stopSpeaking();
                isSpeaking = true;
                updateFloatingMicState();

                const ttsText = text.length > 500 ? text.slice(0, 500) + '...' : text;

                // Try Edge TTS (server-side)
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch('/api/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: ttsText }),
                        signal: controller.signal,
                    });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error('TTS API error ' + res.status);
                    const data = await res.json();
                    if (data.audioContent && data.audioContent.length > 100) {
                        const audio = new Audio('data:audio/mpeg;base64,' + data.audioContent);
                        currentAudio = audio;
                        audio.onended = () => { isSpeaking = false; currentAudio = null; updateFloatingMicState(); resolve(); };
                        audio.onerror = (e) => { console.error('Audio playback error:', e); isSpeaking = false; currentAudio = null; updateFloatingMicState(); resolve(); };
                        await audio.play().catch(e => { console.error('Audio play failed:', e); throw e; });
                        return;
                    }
                    throw new Error('Empty audio content');
                } catch (e) {
                    console.warn('Edge TTS failed, using Web Speech API:', e.message);
                }

                // Fallback: Web Speech API
                if (!window.speechSynthesis) { isSpeaking = false; updateFloatingMicState(); resolve(); return; }
                const utterance = new SpeechSynthesisUtterance(ttsText);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;
                currentUtterance = utterance;
                utterance.onend = () => { isSpeaking = false; currentUtterance = null; updateFloatingMicState(); resolve(); };
                utterance.onerror = () => { isSpeaking = false; currentUtterance = null; updateFloatingMicState(); resolve(); };
                speechSynthesis.speak(utterance);
            });
        }

        function stopSpeaking() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            if (window.speechSynthesis && speechSynthesis.speaking) speechSynthesis.cancel();
            isSpeaking = false;
            currentUtterance = null;
            updateFloatingMicState();
        }

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            let voiceSubmitTimer = null;
            recognition.onresult = event => {
                const text = event.results[0][0].transcript;
                if (activeInput) {
                    const wasHeroInput = activeInput === DOM.heroInput;
                    activeInput.value = text;
                    activeInput.dispatchEvent(new Event('input'));
                    if (wasHeroInput) {
                        // 확인 토스트(3초) 후 자동 제출 절충안
                        if (voiceSubmitTimer) clearTimeout(voiceSubmitTimer);
                        showToast(`"${text.length > 20 ? text.slice(0, 20) + '…' : text}" — 3초 후 검색합니다. 수정하려면 입력창을 클릭하세요.`);
                        voiceSubmitTimer = setTimeout(() => { voiceSubmitTimer = null; handleHeroSubmit(); }, 3000);
                        // 사용자가 입력창에 포커스하면 자동 제출 취소
                        const cancelHandler = () => {
                            if (voiceSubmitTimer) { clearTimeout(voiceSubmitTimer); voiceSubmitTimer = null; showToast('자동 검색이 취소되었습니다.'); }
                            DOM.heroInput.removeEventListener('focus', cancelHandler);
                        };
                        DOM.heroInput.addEventListener('focus', cancelHandler);
                    }
                }
            };

            recognition.onend = () => {
                isRecognitionRunning = false;
                DOM.heroMic.classList.remove('animate-pulse', '!text-red-500');
                const icon = DOM.heroMic.querySelector('.material-symbols-outlined');
                if (icon) icon.textContent = 'mic';
                activeInput = null;
                activeBtn = null;
                updateFloatingMicState();
                // 히어로 음성 CTA 버튼 상태 리셋
                const heroVoiceCta = $('hero-voice-cta');
                if (heroVoiceCta) {
                    heroVoiceCta.classList.remove('animate-pulse');
                    heroVoiceCta.querySelector('.material-symbols-outlined').textContent = 'mic';
                }
            };

            recognition.onerror = event => {
                console.warn('Speech recognition error:', event.error);
                isRecognitionRunning = false;
                const errorMessages = {
                    'not-allowed': '마이크 사용 권한이 필요합니다. 브라우저 설정에서 마이크를 허용해 주세요.',
                    'no-speech': '음성이 감지되지 않았습니다. 다시 말씀해 주세요.',
                    'network': '네트워크 연결을 확인해 주세요.',
                    'audio-capture': '마이크를 찾을 수 없습니다. 마이크가 연결되어 있는지 확인해 주세요.',
                    'aborted': null,
                };
                const msg = errorMessages[event.error];
                if (msg) showToast(msg);
            };

            DOM.heroMic.addEventListener('click', e => { e.preventDefault(); startListening(DOM.heroInput, DOM.heroMic); });

            // ── 모바일 히어로 음성 CTA 버튼 ──
            const heroVoiceCta = $('hero-voice-cta');
            if (heroVoiceCta) {
                heroVoiceCta.addEventListener('click', () => {
                    startListening(DOM.heroInput, DOM.heroMic);
                    // CTA 버튼 시각 피드백
                    heroVoiceCta.classList.add('animate-pulse');
                    heroVoiceCta.querySelector('.material-symbols-outlined').textContent = 'graphic_eq';
                });
            }

            // ── Floating Mic Button ──
            if (DOM.floatingMic) {
                DOM.floatingMic.addEventListener('click', () => {
                    if (isSpeaking) stopSpeaking();
                    startListening(DOM.heroInput, DOM.heroMic);
                    updateFloatingMicState();
                });
            }

            // 플로팅 마이크는 첫 검색 후에만 표시 (초기에는 히어로 CTA 사용)

            // ── TTS 토글 버튼 ──
            const ttsToggle = $('tts-toggle');
            if (ttsToggle) {
                function updateTtsToggleUI() {
                    const icon = ttsToggle.querySelector('.material-symbols-outlined');
                    if (ttsEnabled) {
                        icon.textContent = 'volume_up';
                        ttsToggle.style.borderColor = '#98002E';
                        ttsToggle.title = '음성 읽기 끄기';
                    } else {
                        icon.textContent = 'volume_off';
                        ttsToggle.style.borderColor = '#d1d5db';
                        ttsToggle.title = '음성 읽기 켜기';
                    }
                }
                updateTtsToggleUI();
                ttsToggle.addEventListener('click', () => {
                    ttsEnabled = !ttsEnabled;
                    localStorage.setItem(TTS_KEY, ttsEnabled);
                    updateTtsToggleUI();
                    if (!ttsEnabled && isSpeaking) stopSpeaking();
                    showToast(ttsEnabled ? '음성 읽기가 켜졌습니다.' : '음성 읽기가 꺼졌습니다.');
                });
            }
        } else {
            DOM.heroMic.style.display = 'none';
        }

        // Update floating mic visual state
        function updateFloatingMicState() {
            if (!DOM.floatingMic) return;
            const icon = DOM.floatingMic.querySelector('.material-symbols-outlined:first-child');
            const statusIcon = DOM.floatingMic.querySelector('.mic-status .material-symbols-outlined');
            if (isRecognitionRunning) {
                DOM.floatingMic.classList.add('listening');
                if (icon) icon.textContent = 'graphic_eq';
            } else {
                DOM.floatingMic.classList.remove('listening');
                if (icon) icon.textContent = 'mic';
            }
            if (statusIcon) {
                if (isSpeaking) {
                    statusIcon.textContent = 'stop_circle';
                    statusIcon.style.color = '#ef4444';
                } else {
                    statusIcon.textContent = 'volume_off';
                    statusIcon.style.color = '#98002E';
                }
            }
        }

        // ══════════════════════════════════════
        // ── SESSION STORAGE + AUTO EXPIRY ──
        // ══════════════════════════════════════

        const CHAT_STORAGE_KEY = 'nomaChatHistory';
        const CHAT_TIMESTAMP_KEY = 'nomaChatLastActive';
        const CHAT_EXPIRY_MS = 5 * 60 * 1000; // 5분
        let inactivityTimer = null;

        function saveHistory() {
            try {
                sessionStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
                sessionStorage.setItem(CHAT_TIMESTAMP_KEY, Date.now().toString());
                resetInactivityTimer();
            } catch (e) {}
        }

        function loadHistory() {
            try {
                const savedTime = sessionStorage.getItem(CHAT_TIMESTAMP_KEY);
                if (savedTime && (Date.now() - parseInt(savedTime)) > CHAT_EXPIRY_MS) {
                    clearChatData();
                    return;
                }
                const saved = sessionStorage.getItem(CHAT_STORAGE_KEY);
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    resetInactivityTimer();
                }
            } catch (e) {}
        }

        function clearChatData() {
            sessionStorage.removeItem(CHAT_STORAGE_KEY);
            sessionStorage.removeItem(CHAT_TIMESTAMP_KEY);
            chatHistory = [];
            if (inactivityTimer) clearTimeout(inactivityTimer);
        }

        function resetInactivityTimer() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                clearChatData();
            }, CHAT_EXPIRY_MS);
        }

        // ══════════════════════════════════════
        // ── MY DRAWER (내 서랍) ──
        // ══════════════════════════════════════

        const DRAWER_CONSENT_KEY = 'nomaDrawerConsent';
        const DRAWER_DATA_KEY = 'nomaDrawerItems';
        let drawerItems = [];
        let pendingBookmark = null;

        function hasDrawerConsent() {
            return localStorage.getItem(DRAWER_CONSENT_KEY) === 'true';
        }

        function loadDrawerItems() {
            try {
                const saved = localStorage.getItem(DRAWER_DATA_KEY);
                if (saved) drawerItems = JSON.parse(saved);
            } catch (e) { drawerItems = []; }
            updateDrawerBadge();
        }

        function saveDrawerItems() {
            try { localStorage.setItem(DRAWER_DATA_KEY, JSON.stringify(drawerItems)); } catch (e) {}
            updateDrawerBadge();
        }

        function updateDrawerBadge() {
            const badge = $('drawer-badge');
            if (drawerItems.length > 0) {
                badge.textContent = drawerItems.length > 9 ? '9+' : drawerItems.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function addToDrawer(serviceData) {
            if (drawerItems.some(item => item.serviceName === serviceData.serviceName)) {
                showToast('이미 내 서랍에 담겨있는 서비스예요.');
                return;
            }
            drawerItems.push({
                serviceName: serviceData.serviceName,
                summary: serviceData.summary || '',
                agency: serviceData.agency || '',
                savedAt: new Date().toISOString()
            });
            saveDrawerItems();
            showToast('내 서랍에 담았어요!');
            updateBookmarkButtons();
        }

        function removeFromDrawer(serviceName) {
            drawerItems = drawerItems.filter(item => item.serviceName !== serviceName);
            saveDrawerItems();
            renderDrawerItems();
            updateBookmarkButtons();
        }

        function renderDrawerItems() {
            const emptyEl = $('drawer-empty');
            const itemsEl = $('drawer-items');
            const footerEl = $('drawer-footer');

            if (drawerItems.length === 0) {
                emptyEl.classList.remove('hidden');
                itemsEl.classList.add('hidden');
                footerEl.classList.add('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            itemsEl.classList.remove('hidden');
            footerEl.classList.remove('hidden');

            itemsEl.innerHTML = drawerItems.map((item, i) => `
                <div class="bg-white border border-stone-200 rounded-xl p-4 hover:border-primary/30 transition-all group animate-fade-up" style="animation-delay:${i * 50}ms">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 text-sm mb-1 break-keep">${item.serviceName}</h4>
                            <p class="text-xs text-slate-500 leading-relaxed break-keep line-clamp-2">${item.summary}</p>
                            ${item.agency ? `<p class="text-[10px] text-slate-400 mt-1.5 flex items-center gap-0.5"><span class="material-symbols-outlined text-[10px]" aria-hidden="true">account_balance</span>${item.agency}</p>` : ''}
                        </div>
                        <div class="flex flex-col gap-1 flex-shrink-0">
                            <button class="drawer-item-apply p-1.5 rounded-lg text-primary hover:bg-primary/10 transition-colors" data-service="${item.serviceName}" title="상담 신청">
                                <span class="material-symbols-outlined text-lg" aria-hidden="true">outgoing_mail</span>
                            </button>
                            <button class="drawer-item-remove p-1.5 rounded-lg text-stone-300 hover:text-red-500 hover:bg-red-50 transition-colors" data-service="${item.serviceName}" title="서랍에서 빼기">
                                <span class="material-symbols-outlined text-lg" aria-hidden="true">bookmark_remove</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            itemsEl.querySelectorAll('.drawer-item-remove').forEach(btn => {
                btn.addEventListener('click', () => removeFromDrawer(btn.dataset.service));
            });
            itemsEl.querySelectorAll('.drawer-item-apply').forEach(btn => {
                btn.addEventListener('click', () => { closeMyDrawer(); openServiceModal(btn.dataset.service); });
            });
        }

        function updateBookmarkButtons() {
            document.querySelectorAll('.btn-bookmark').forEach(btn => {
                const name = btn.dataset.serviceName;
                const isSaved = drawerItems.some(item => item.serviceName === name);
                const icon = btn.querySelector('.material-symbols-outlined');
                if (isSaved) {
                    icon.textContent = 'bookmark_added';
                    btn.classList.add('!text-primary');
                    btn.title = '내 서랍에 담긴 서비스';
                } else {
                    icon.textContent = 'bookmark_add';
                    btn.classList.remove('!text-primary');
                    btn.title = '내 서랍에 담기';
                }
            });
        }

        // Toast notification
        function showToast(message) {
            const existing = document.querySelector('.noma-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'noma-toast fixed bottom-24 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white text-sm font-medium px-5 py-3 rounded-full shadow-lg animate-fade-up';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 2000);
        }

        // Open/Close drawer
        function openMyDrawer() {
            renderDrawerItems();
            $('drawer-overlay').classList.remove('hidden');
            requestAnimationFrame(() => {
                $('drawer-panel').style.transform = 'translateX(0)';
            });
        }
        window.openMyDrawer = openMyDrawer;

        function closeMyDrawer() {
            $('drawer-panel').style.transform = 'translateX(100%)';
            setTimeout(() => $('drawer-overlay').classList.add('hidden'), 300);
        }
        window.closeMyDrawer = closeMyDrawer;

        // Drawer button in header
        $('btn-my-drawer').addEventListener('click', openMyDrawer);

        // Clear all
        $('drawer-clear-all').addEventListener('click', () => {
            if (!confirm('내 서랍의 모든 서비스를 비울까요?')) return;
            drawerItems = [];
            saveDrawerItems();
            renderDrawerItems();
            updateBookmarkButtons();
        });

        // Bookmark button handler (main page cards)
        function handleBookmark(serviceName, serviceData) {
            if (!hasDrawerConsent()) {
                pendingBookmark = serviceData;
                $('consent-modal').classList.remove('hidden');
                return;
            }
            if (drawerItems.some(item => item.serviceName === serviceName)) {
                removeFromDrawer(serviceName);
                showToast('내 서랍에서 뺐어요.');
            } else {
                addToDrawer(serviceData);
            }
        }

        // Card bookmark buttons on main page
        DOM.cardsGrid.addEventListener('click', e => {
            const btn = e.target.closest('.btn-bookmark');
            if (!btn) return;
            const serviceName = btn.dataset.serviceName;
            const card = currentCards.find(c => c.serviceName === serviceName);
            handleBookmark(serviceName, card || { serviceName });
        });

        // Consent modal handlers
        $('consent-accept').addEventListener('click', () => {
            localStorage.setItem(DRAWER_CONSENT_KEY, 'true');
            $('consent-modal').classList.add('hidden');
            if (pendingBookmark) {
                addToDrawer(pendingBookmark);
                pendingBookmark = null;
            }
        });

        $('consent-decline').addEventListener('click', () => {
            $('consent-modal').classList.add('hidden');
            pendingBookmark = null;
        });

        $('consent-modal').addEventListener('click', e => {
            if (e.target === $('consent-modal')) {
                $('consent-modal').classList.add('hidden');
                pendingBookmark = null;
            }
        });

        // ── 모달 포커스 트래핑 + ESC 닫기 ──
        function trapFocus(modalEl) {
            const focusable = modalEl.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (!focusable.length) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            modalEl._trapHandler = e => {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
                    } else {
                        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
                    }
                }
            };
            modalEl.addEventListener('keydown', modalEl._trapHandler);
        }
        function releaseFocus(modalEl) {
            if (modalEl._trapHandler) {
                modalEl.removeEventListener('keydown', modalEl._trapHandler);
                delete modalEl._trapHandler;
            }
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', e => {
            if (e.key !== 'Escape') return;
            if (!DOM.serviceModal.classList.contains('hidden')) {
                if (modalState.step === 'confirm') { resetToHome(); } else { DOM.serviceModal.classList.add('hidden'); }
                releaseFocus(DOM.serviceModal);
            } else if (!DOM.consentModal.classList.contains('hidden')) {
                DOM.consentModal.classList.add('hidden');
                pendingBookmark = null;
                releaseFocus(DOM.consentModal);
            }
        });

        // 모달 열릴 때 포커스 트래핑 활성화 (MutationObserver)
        [DOM.serviceModal, DOM.consentModal].forEach(modal => {
            new MutationObserver(() => {
                if (!modal.classList.contains('hidden')) {
                    trapFocus(modal);
                } else {
                    releaseFocus(modal);
                }
            }).observe(modal, { attributes: true, attributeFilter: ['class'] });
        });

        // ── Scroll-based Progressive Reveal ──
        window.addEventListener('scroll', () => {
            if (sectionsRevealed) return;
            const scrollPct = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight);
            if (scrollPct > 0.3) revealBelowFoldSections();
        }, { passive: true });

        // ── Init ──
        window.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            loadDrawerItems();
        });

    })();
    </script>
</body>
</html>