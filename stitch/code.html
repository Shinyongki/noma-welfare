<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>경상남도사회서비스원 AI 맞춤형 복지 내비게이터</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#98002E",
                        "primary-light": "#B8003E",
                        "bg-warm": "#F8F5F2",
                        "bg-section": "#F1ECE7",
                        "deep-purple": "#4A1942",
                    },
                    fontFamily: {
                        "sans": ["Pretendard Variable", "Pretendard", "-apple-system", "BlinkMacSystemFont", "system-ui", "Roboto", "Noto Sans KR", "Malgun Gothic", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "3xl": "2.5rem", "full": "9999px" },
                    keyframes: {
                        'fade-up': { '0%': { opacity: '0', transform: 'translateY(24px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        'slide-down': { '0%': { opacity: '0', transform: 'translateY(-12px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'pulse-soft': { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.6' } },
                        'shimmer': { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                    },
                    animation: {
                        'fade-up': 'fade-up 0.5s ease-out forwards',
                        'fade-up-delay-1': 'fade-up 0.5s ease-out 0.1s forwards',
                        'fade-up-delay-2': 'fade-up 0.5s ease-out 0.2s forwards',
                        'fade-up-delay-3': 'fade-up 0.5s ease-out 0.3s forwards',
                        'fade-in': 'fade-in 0.4s ease-out forwards',
                        'slide-down': 'slide-down 0.3s ease-out forwards',
                        'pulse-soft': 'pulse-soft 2s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                },
            },
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .skeleton-shimmer {
            background: linear-gradient(90deg, #f0ebe6 25%, #e8e2db 50%, #f0ebe6 75%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        /* Transition classes */
        .hero-compact .hero-title { font-size: 1.5rem; line-height: 2rem; }
        .hero-compact .hero-subtitle { display: none; }
        .hero-compact .hero-badge { display: none; }
        #results-section { transition: all 0.5s ease-out; }
        /* Noma card link styling */
        .noma-card-detail strong { display: block; margin-bottom: 2px; }
        /* Stepper timeline */
        .stepper { position: relative; padding-left: 2rem; }
        .stepper::before {
            content: '';
            position: absolute;
            left: 0.6875rem;
            top: 1.25rem;
            bottom: 1.25rem;
            width: 2px;
            background: #e5e0db;
        }
        .step-item { position: relative; padding-bottom: 0.25rem; }
        .step-item:last-child { padding-bottom: 0; }
        .step-dot {
            position: absolute;
            left: -2rem;
            top: 0.125rem;
            width: 1.375rem;
            height: 1.375rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            z-index: 1;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            cursor: pointer;
            padding: 0.5rem 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .step-header:active { opacity: 0.7; }
        .step-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            opacity: 0;
            padding-bottom: 0;
        }
        .step-body.open {
            max-height: 500px;
            opacity: 1;
            padding-bottom: 0.75rem;
        }
        .step-chevron {
            transition: transform 0.3s ease;
            font-size: 1.125rem !important;
        }
        .step-body.open ~ .step-header .step-chevron,
        .step-item.open .step-chevron {
            transform: rotate(180deg);
        }
        .tel-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #f0fdf4;
            color: #15803d;
            padding: 0.5rem 0.875rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9375rem;
            text-decoration: none;
            border: 1px solid #bbf7d0;
            margin-top: 0.375rem;
        }
        .tel-link:active { background: #dcfce7; }
        /* Voice mode */
        @keyframes voice-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        /* Floating mic button */
        #floating-mic {
            position: fixed;
            bottom: 2rem;
            right: 1.5rem;
            z-index: 999;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #98002E, #4A1942);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(152, 0, 46, 0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #floating-mic:active { transform: scale(0.92); }
        #floating-mic.listening {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 24px rgba(239, 68, 68, 0.5);
            animation: voice-pulse 1.5s ease-in-out infinite;
        }
        #floating-mic .mic-status {
            position: absolute;
            bottom: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
    </style>
</head>

<body class="bg-bg-warm min-h-screen flex flex-col font-sans text-slate-900 antialiased selection:bg-primary selection:text-white">

    <!-- ═══════════════════ HEADER ═══════════════════ -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-stone-200 bg-white/90 backdrop-blur-sm px-6 lg:px-20 xl:px-40 py-4 sticky top-0 z-50">
        <a href="/" class="flex items-center gap-3 group">
            <div class="flex flex-col items-center justify-center">
                <div class="flex items-end gap-[2px]">
                    <svg width="22" height="18" viewBox="0 0 24 24" fill="none" class="group-hover:-translate-y-0.5 transition-transform duration-300"><path d="M12 4L3 13H8L12 9L16 13H21L12 4Z" fill="#8dc63f"/></svg>
                    <svg width="22" height="18" viewBox="0 0 24 24" fill="none" class="group-hover:-translate-y-0.5 transition-transform duration-300 delay-75"><path d="M12 4L3 13H8L12 9L16 13H21L12 4Z" fill="#0092d6"/></svg>
                    <svg width="18" height="18" viewBox="0 0 20 20" fill="none" class="mb-[2px] group-hover:scale-110 transition-transform duration-300 delay-150"><circle cx="10" cy="10" r="6" stroke="#f49231" stroke-width="4.5"/></svg>
                </div>
                <span class="text-[9px] font-black text-slate-400 tracking-[0.3em] mt-0.5 ml-1">PASS</span>
            </div>
            <h2 class="text-slate-800 text-lg md:text-xl font-extrabold tracking-tight">경상남도사회서비스원</h2>
        </a>
        <nav class="hidden md:flex items-center gap-8">
            <a class="text-slate-500 hover:text-primary transition-colors text-sm font-medium" href="#" onclick="event.preventDefault();document.getElementById('browse-section')?.scrollIntoView({behavior:'smooth'})">전체 서비스</a>
            <a class="text-slate-500 hover:text-primary transition-colors text-sm font-medium" href="#">자주 묻는 질문</a>
            <button id="btn-my-drawer" class="relative text-slate-500 hover:text-primary transition-colors text-sm font-medium flex items-center gap-1" title="내 서랍">
                <span class="material-symbols-outlined text-xl">bookmark</span>
                내 서랍
                <span id="drawer-badge" class="hidden absolute -top-1 -right-2 bg-primary text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">0</span>
            </button>
            <a class="px-5 py-2 bg-primary text-white text-sm font-semibold rounded-full hover:bg-primary-light transition-colors" href="tel:055-230-8200">전화 문의</a>
        </nav>
        <button class="md:hidden text-slate-700" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
            <span class="material-symbols-outlined text-2xl">menu</span>
        </button>
    </header>
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-[60] bg-black/40" onclick="this.classList.add('hidden')">
        <div class="bg-white w-64 h-full p-6 space-y-4" onclick="event.stopPropagation()">
            <a class="block text-slate-700 font-medium py-2" href="#" onclick="event.preventDefault();document.getElementById('mobile-menu').classList.add('hidden');document.getElementById('browse-section')?.scrollIntoView({behavior:'smooth'})">전체 서비스</a>
            <a class="block text-slate-700 font-medium py-2" href="#">자주 묻는 질문</a>
            <button class="block text-slate-700 font-medium py-2 flex items-center gap-2" onclick="document.getElementById('mobile-menu').classList.add('hidden');openMyDrawer()">
                <span class="material-symbols-outlined text-lg">bookmark</span>내 서랍
            </button>
            <a class="block text-primary font-bold py-2" href="tel:055-230-8200">전화 문의</a>
        </div>
    </div>

    <!-- ═══════════════════ MAIN ═══════════════════ -->
    <main class="flex-1 flex flex-col items-center w-full">

        <!-- ── HERO SECTION ── -->
        <section id="hero-section" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 pt-16 pb-10 transition-all duration-500">
            <div class="max-w-3xl mx-auto text-center space-y-5">
                <span class="hero-badge inline-block px-4 py-1.5 rounded-full bg-primary/10 text-primary text-sm font-semibold transition-all duration-500">AI 맞춤형 복지 내비게이터</span>
                <h1 class="hero-title text-slate-900 text-3xl md:text-[2.75rem] font-black leading-tight tracking-tight break-keep transition-all duration-500">
                    어떤 어려움이 있으신가요?<br/>딱 맞는 지원을 찾아드립니다.
                </h1>
                <p class="hero-subtitle text-slate-500 text-base md:text-lg font-medium leading-relaxed max-w-xl mx-auto break-keep transition-all duration-500">
                    복잡한 복지 제도, 이제 찾지 말고 편하게 이야기해 주세요.<br/>
                    AI가 귀하에게 필요한 서비스를 분석해 드립니다.
                </p>
            </div>

            <!-- Search Input -->
            <div class="max-w-2xl mx-auto mt-8">
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-primary/20 via-purple-500/15 to-primary/20 rounded-full blur-md opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition duration-500"></div>
                    <div class="relative flex items-center w-full h-16 md:h-[4.5rem] bg-white rounded-full shadow-lg shadow-stone-200/60 ring-1 ring-stone-200/80 transition-all focus-within:ring-2 focus-within:ring-primary/60 focus-within:shadow-xl overflow-hidden">
                        <button id="hero-mic" class="pl-5 md:pl-7 text-primary/70 hover:text-primary flex items-center justify-center hover:scale-110 transition-all" title="음성으로 입력">
                            <span class="material-symbols-outlined text-[28px]">mic</span>
                        </button>
                        <input id="hero-input"
                            class="w-full h-full bg-transparent border-none text-slate-800 placeholder:text-slate-400 text-lg md:text-xl px-4 md:px-5 focus:ring-0 focus:outline-none"
                            placeholder="예: 퇴원 후 당장 돌봐줄 사람이 없어요" />
                        <button id="hero-submit"
                            class="mr-2 md:mr-3 size-12 md:size-13 bg-primary rounded-full flex items-center justify-center text-white hover:bg-primary-light active:scale-95 transition-all shadow-md flex-shrink-0">
                            <span class="material-symbols-outlined text-2xl">arrow_forward</span>
                        </button>
                    </div>
                </div>
                <!-- Example Chips -->
                <div id="hero-chips" class="mt-5 flex flex-wrap justify-center gap-2.5">
                    <button class="hero-chip group flex items-center gap-1.5 px-4 py-2.5 bg-white hover:bg-primary/5 border border-stone-200 rounded-full transition-all shadow-sm hover:shadow-md hover:border-primary/30" data-msg="퇴원 후 당장 돌봐줄 사람이 없어요">
                        <span class="material-symbols-outlined text-primary/70 text-base">medical_services</span>
                        <span class="text-slate-600 text-sm font-medium">#퇴원 후 돌봄이 필요해요</span>
                    </button>
                    <button class="hero-chip group flex items-center gap-1.5 px-4 py-2.5 bg-white hover:bg-primary/5 border border-stone-200 rounded-full transition-all shadow-sm hover:shadow-md hover:border-primary/30" data-msg="스마트폰으로 건강 관리를 받고 싶어요">
                        <span class="material-symbols-outlined text-primary/70 text-base">smartphone</span>
                        <span class="text-slate-600 text-sm font-medium">#스마트 건강관리</span>
                    </button>
                    <button class="hero-chip group flex items-center gap-1.5 px-4 py-2.5 bg-white hover:bg-primary/5 border border-stone-200 rounded-full transition-all shadow-sm hover:shadow-md hover:border-primary/30" data-msg="긴급 돌봄이 필요해요">
                        <span class="material-symbols-outlined text-primary/70 text-base">emergency_home</span>
                        <span class="text-slate-600 text-sm font-medium">#긴급 돌봄</span>
                    </button>
                    <button class="hero-chip group flex items-center gap-1.5 px-4 py-2.5 bg-white hover:bg-primary/5 border border-stone-200 rounded-full transition-all shadow-sm hover:shadow-md hover:border-primary/30" data-msg="혼자 사는 어르신 안전 관리">
                        <span class="material-symbols-outlined text-primary/70 text-base">favorite</span>
                        <span class="text-slate-600 text-sm font-medium">#독거 어르신 안전</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- ── RESULTS SECTION (hidden initially) ── -->
        <section id="results-section" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 pb-8 hidden">
            <div class="max-w-5xl mx-auto">
                <!-- AI Summary Bubble -->
                <div id="ai-summary-area" class="mb-8 hidden">
                    <div class="flex items-start gap-3 max-w-3xl">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-primary to-deep-purple flex items-center justify-center shadow-md">
                            <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-primary mb-1.5">노마(Noma) AI 분석 결과</p>
                            <div id="ai-summary-text" class="bg-white rounded-2xl rounded-tl-md px-5 py-4 shadow-sm border border-stone-200 text-[15px] text-slate-700 leading-relaxed break-keep"></div>
                        </div>
                    </div>
                </div>

                <!-- Section Title -->
                <div id="cards-title" class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2.5">
                        <span class="material-symbols-outlined text-primary text-xl">auto_awesome</span>
                        <h2 class="text-xl font-bold text-slate-800">맞춤 추천 서비스</h2>
                    </div>
                    <button id="btn-new-search" class="hidden text-sm text-slate-500 hover:text-primary font-medium flex items-center gap-1 transition-colors">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        새로 질문하기
                    </button>
                </div>

                <!-- Cards Grid -->
                <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>

                <!-- Loading Skeletons -->
                <div id="cards-skeleton" class="hidden grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="bg-white rounded-2xl p-7 border border-stone-100 shadow-sm">
                        <div class="flex items-start justify-between mb-5"><div class="skeleton-shimmer w-12 h-12 rounded-xl"></div><div class="skeleton-shimmer w-16 h-6 rounded-full"></div></div>
                        <div class="skeleton-shimmer h-7 w-3/4 rounded mb-3"></div>
                        <div class="skeleton-shimmer h-4 w-full rounded mb-2"></div>
                        <div class="skeleton-shimmer h-4 w-5/6 rounded mb-6"></div>
                        <div class="skeleton-shimmer h-20 w-full rounded-lg mb-6"></div>
                        <div class="skeleton-shimmer h-12 w-full rounded-xl"></div>
                    </div>
                    <div class="bg-white rounded-2xl p-7 border border-stone-100 shadow-sm">
                        <div class="flex items-start justify-between mb-5"><div class="skeleton-shimmer w-12 h-12 rounded-xl"></div><div class="skeleton-shimmer w-16 h-6 rounded-full"></div></div>
                        <div class="skeleton-shimmer h-7 w-3/4 rounded mb-3"></div>
                        <div class="skeleton-shimmer h-4 w-full rounded mb-2"></div>
                        <div class="skeleton-shimmer h-4 w-5/6 rounded mb-6"></div>
                        <div class="skeleton-shimmer h-20 w-full rounded-lg mb-6"></div>
                        <div class="skeleton-shimmer h-12 w-full rounded-xl"></div>
                    </div>
                </div>

                <!-- Discover More -->
                <div id="discover-more" class="hidden mt-8 bg-white border border-stone-200 rounded-2xl p-6 md:p-7 shadow-sm">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-primary/10 p-3 rounded-full text-primary flex-shrink-0">
                            <span class="material-symbols-outlined text-xl">grid_view</span>
                        </div>
                        <div>
                            <h4 class="text-base font-bold text-slate-800 mb-0.5">찾으시는 서비스가 없으신가요?</h4>
                            <p class="text-slate-500 text-sm break-keep">아래 방법으로도 도움을 받으실 수 있습니다.</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="btn-browse-scroll" class="flex-1 px-5 py-3 bg-white border border-stone-300 text-slate-700 hover:bg-slate-50 font-semibold rounded-xl shadow-sm hover:shadow transition-all flex items-center justify-center gap-1.5 text-sm">
                            <span class="material-symbols-outlined text-base">list_alt</span>
                            전체 서비스 둘러보기
                        </button>
                        <a href="tel:055-230-8200" class="flex-1 px-5 py-3 bg-primary text-white font-semibold rounded-xl shadow-sm hover:bg-primary-light transition-all flex items-center justify-center gap-1.5 text-sm">
                            <span class="material-symbols-outlined text-base">call</span>
                            대표전화 055-230-8200
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- ── INITIAL PLACEHOLDER (shown before search) ── -->
        <section id="initial-placeholder" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 pb-12">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center gap-2.5 mb-6">
                    <span class="material-symbols-outlined text-primary text-xl">auto_awesome</span>
                    <h2 class="text-xl font-bold text-slate-800">이런 서비스를 제공합니다</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- Placeholder Card 1 -->
                    <div class="bg-white rounded-2xl p-6 border border-stone-100 shadow-sm hover:shadow-md hover:border-primary/20 transition-all group cursor-pointer" onclick="document.getElementById('hero-input').value='긴급 돌봄이 필요해요';document.getElementById('hero-input').focus()">
                        <div class="bg-primary/10 p-3 rounded-xl text-primary w-fit mb-4 group-hover:bg-primary/15 transition-colors">
                            <span class="material-symbols-outlined text-2xl">emergency</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">긴급돌봄 지원</h3>
                        <p class="text-sm text-slate-500 leading-relaxed break-keep">갑작스러운 질병이나 사고로 돌봄이 필요할 때, 72시간 내 긴급 돌봄 서비스를 제공합니다.</p>
                    </div>
                    <!-- Placeholder Card 2 -->
                    <div class="bg-white rounded-2xl p-6 border border-stone-100 shadow-sm hover:shadow-md hover:border-primary/20 transition-all group cursor-pointer" onclick="document.getElementById('hero-input').value='혼자 사는 어르신 안전 관리';document.getElementById('hero-input').focus()">
                        <div class="bg-blue-50 p-3 rounded-xl text-blue-600 w-fit mb-4 group-hover:bg-blue-100 transition-colors">
                            <span class="material-symbols-outlined text-2xl">shield_with_heart</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">AI 스마트 돌봄</h3>
                        <p class="text-sm text-slate-500 leading-relaxed break-keep">AI/IoT 기기를 활용하여 독거 어르신의 건강과 안전을 24시간 모니터링합니다.</p>
                    </div>
                    <!-- Placeholder Card 3 -->
                    <div class="bg-white rounded-2xl p-6 border border-stone-100 shadow-sm hover:shadow-md hover:border-primary/20 transition-all group cursor-pointer" onclick="document.getElementById('hero-input').value='장애인 보조기기 지원';document.getElementById('hero-input').focus()">
                        <div class="bg-emerald-50 p-3 rounded-xl text-emerald-600 w-fit mb-4 group-hover:bg-emerald-100 transition-colors">
                            <span class="material-symbols-outlined text-2xl">accessible_forward</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">장애인 지원 서비스</h3>
                        <p class="text-sm text-slate-500 leading-relaxed break-keep">보조기기 대여, 직업재활, 권익옹호 등 장애인 맞춤형 종합 복지 서비스를 제공합니다.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ── BROWSE ALL SERVICES ── -->
        <section id="browse-section" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 py-16 bg-white">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-10">
                    <span class="inline-block px-4 py-1.5 rounded-full bg-primary/10 text-primary text-sm font-semibold mb-4">전체 서비스 둘러보기</span>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">경상남도사회서비스원이 제공하는 모든 서비스</h2>
                    <p class="text-sm text-slate-500">카테고리를 선택하여 관심 있는 서비스를 살펴보세요.</p>
                </div>

                <!-- Category Tabs -->
                <div id="browse-tabs" class="flex flex-wrap justify-center gap-3 mb-8"></div>

                <!-- Service List -->
                <div id="browse-list" class="space-y-4"></div>

                <!-- Loading -->
                <div id="browse-loading" class="text-center py-10">
                    <span class="material-symbols-outlined text-stone-300 text-4xl animate-pulse-soft">hourglass_empty</span>
                    <p class="text-slate-400 text-sm mt-2">서비스 목록을 불러오는 중...</p>
                </div>
            </div>
        </section>

        <!-- ── JOURNEY MAP ── -->
        <section id="journey-section" class="w-full px-4 sm:px-6 lg:px-20 xl:px-40 py-16 bg-bg-section/60">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-10">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">서비스 이용 절차</h2>
                    <p class="text-sm text-slate-500">상담 접수부터 서비스 제공까지, 한눈에 확인하세요.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 md:gap-0 relative">
                    <!-- Connector line (desktop) -->
                    <div class="hidden md:block absolute top-10 left-[12.5%] right-[12.5%] h-[3px] bg-stone-200 rounded-full z-0"></div>
                    <!-- Step 1 -->
                    <div class="flex flex-col items-center text-center group journey-connector relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-primary rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-transform duration-300">
                            <span class="material-symbols-outlined text-primary text-3xl">support_agent</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-primary mb-0.5">STEP 1</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">상담 및 신청</h4>
                            <p class="text-xs text-slate-500 leading-snug">온라인 또는 전화로<br/>간편하게 신청</p>
                        </div>
                    </div>
                    <!-- Step 2 -->
                    <div class="flex flex-col items-center text-center group journey-connector relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-stone-200 group-hover:border-primary/50 rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-all duration-300">
                            <span class="material-symbols-outlined text-stone-400 group-hover:text-primary transition-colors text-3xl">fact_check</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-slate-400 group-hover:text-primary transition-colors mb-0.5">STEP 2</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">자격 확인</h4>
                            <p class="text-xs text-slate-500 leading-snug">대상 적격 여부<br/>심사 및 결정</p>
                        </div>
                    </div>
                    <!-- Step 3 -->
                    <div class="flex flex-col items-center text-center group journey-connector relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-stone-200 group-hover:border-primary/50 rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-all duration-300">
                            <span class="material-symbols-outlined text-stone-400 group-hover:text-primary transition-colors text-3xl">person_apron</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-slate-400 group-hover:text-primary transition-colors mb-0.5">STEP 3</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">전담 인력 배정</h4>
                            <p class="text-xs text-slate-500 leading-snug">담당자 매칭 및<br/>방문 계획 수립</p>
                        </div>
                    </div>
                    <!-- Step 4 -->
                    <div class="flex flex-col items-center text-center group relative z-10">
                        <div class="w-20 h-20 bg-white border-[3px] border-stone-200 group-hover:border-primary/50 rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-all duration-300">
                            <span class="material-symbols-outlined text-stone-400 group-hover:text-primary transition-colors text-3xl">handshake</span>
                        </div>
                        <div class="bg-white px-4 py-3 rounded-xl border border-stone-100 shadow-sm w-full max-w-[180px]">
                            <p class="text-xs font-bold text-slate-400 group-hover:text-primary transition-colors mb-0.5">STEP 4</p>
                            <h4 class="font-bold text-slate-800 text-[15px] mb-1">서비스 제공</h4>
                            <p class="text-xs text-slate-500 leading-snug">맞춤형 복지<br/>서비스 시작</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ═══════════════════ FLOATING MIC BUTTON ═══════════════════ -->
    <button id="floating-mic" title="음성으로 대화하기">
        <span class="material-symbols-outlined" style="font-size:32px">mic</span>
        <span class="mic-status">
            <span class="material-symbols-outlined" style="font-size:14px;color:#98002E">volume_off</span>
        </span>
    </button>

    <!-- ═══════════════════ FOOTER ═══════════════════ -->
    <footer class="bg-white border-t border-stone-200 py-10 px-6 lg:px-20 xl:px-40">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
                <h5 class="font-bold text-slate-800 mb-1.5 text-sm">경상남도사회서비스원</h5>
                <p class="text-xs text-slate-500 leading-relaxed">
                    경상남도 창원시 성산구 창원대로 524 경남사회적경제혁신타운 본관동 2층<br/>
                    대표전화: 055-230-8200
                </p>
            </div>
            <div class="flex gap-5">
                <a class="text-xs text-slate-500 hover:text-primary" href="#">개인정보처리방침</a>
                <a class="text-xs text-slate-500 hover:text-primary" href="#">이용약관</a>
                <a class="text-xs text-slate-500 hover:text-primary" href="#">사이트맵</a>
            </div>
        </div>
    </footer>

    <!-- ═══════════════════ MY DRAWER (내 서랍) PANEL ═══════════════════ -->
    <div id="drawer-overlay" class="hidden fixed inset-0 z-[150] bg-black/40 backdrop-blur-sm" onclick="closeMyDrawer()"></div>
    <div id="drawer-panel" class="fixed top-0 right-0 z-[160] w-full max-w-md h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col">
        <!-- Drawer Header -->
        <div class="flex items-center justify-between px-6 py-5 border-b border-stone-200 bg-gradient-to-r from-primary/5 to-purple-50">
            <div class="flex items-center gap-2.5">
                <span class="material-symbols-outlined text-primary text-2xl">bookmark</span>
                <div>
                    <h2 class="text-lg font-bold text-slate-800">내 서랍</h2>
                    <p class="text-xs text-slate-500">관심 있는 서비스를 모아두었어요</p>
                </div>
            </div>
            <button onclick="closeMyDrawer()" class="p-1.5 text-slate-400 hover:text-slate-600 transition-colors rounded-lg hover:bg-stone-100">
                <span class="material-symbols-outlined text-xl">close</span>
            </button>
        </div>
        <!-- Drawer Body -->
        <div id="drawer-body" class="flex-1 overflow-y-auto p-5 space-y-4">
            <!-- Empty state (default) -->
            <div id="drawer-empty" class="flex flex-col items-center justify-center h-full text-center py-16">
                <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-5">
                    <span class="material-symbols-outlined text-stone-300 text-4xl">bookmark_border</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-2">아직 담아둔 서비스가 없어요</h3>
                <p class="text-sm text-slate-500 leading-relaxed max-w-xs break-keep">서비스 카드의 <span class="inline-flex items-center gap-0.5 text-primary font-semibold"><span class="material-symbols-outlined text-sm">bookmark_add</span>담기</span> 버튼을 눌러<br/>관심 서비스를 저장해 보세요.</p>
            </div>
            <!-- Saved items rendered here -->
            <div id="drawer-items" class="hidden space-y-3"></div>
        </div>
        <!-- Drawer Footer -->
        <div id="drawer-footer" class="hidden border-t border-stone-200 p-4">
            <button id="drawer-clear-all" class="w-full py-2.5 text-sm font-medium text-red-500 hover:bg-red-50 rounded-xl transition-colors flex items-center justify-center gap-1">
                <span class="material-symbols-outlined text-base">delete_sweep</span>
                모두 비우기
            </button>
        </div>
    </div>

    <!-- ═══════════════════ DRAWER OPT-IN CONSENT MODAL ═══════════════════ -->
    <div id="consent-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-up">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-outlined text-primary text-3xl">bookmark_add</span>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-3">서비스를 저장할까요?</h3>
                <p class="text-sm text-slate-600 leading-relaxed break-keep mb-1">
                    다음에 다시 보실 수 있도록<br/>이 컴퓨터에 <b>익명의 표식</b>을 남겨둘게요.
                </p>
                <p class="text-xs text-slate-400 leading-relaxed break-keep">
                    개인정보는 저장되지 않으며,<br/>언제든 '내 서랍'에서 삭제하실 수 있어요.
                </p>
            </div>
            <div class="px-6 pb-6 flex gap-3">
                <button id="consent-decline" class="flex-1 py-3 rounded-xl border border-stone-300 text-slate-600 font-semibold hover:bg-slate-50 transition-colors text-sm">괜찮아요</button>
                <button id="consent-accept" class="flex-1 py-3 rounded-xl bg-primary text-white font-semibold hover:bg-primary-light transition-colors text-sm">네, 저장할게요</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════ SERVICE REQUEST MODAL ═══════════════════ -->
    <div id="service-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-up">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-primary to-deep-purple px-6 py-5 text-white">
                <h3 class="text-lg font-bold">상담 신청하기</h3>
                <p id="modal-service-name" class="text-white/80 text-sm mt-1"></p>
            </div>
            <!-- Modal Body -->
            <div class="p-6 space-y-5">
                <div id="modal-step-name">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">성함을 입력해 주세요</label>
                    <input id="modal-name-input" type="text" class="w-full px-4 py-3 rounded-xl border border-stone-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-base" placeholder="홍길동" />
                </div>
                <div id="modal-step-phone" class="hidden">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">연락 받으실 전화번호</label>
                    <input id="modal-phone-input" type="tel" class="w-full px-4 py-3 rounded-xl border border-stone-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-base" placeholder="010-1234-5678" />
                </div>
                <div id="modal-step-confirm" class="hidden text-center py-4">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-emerald-600 text-3xl">check_circle</span>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-2">신청이 완료되었습니다!</h4>
                    <p id="modal-confirm-text" class="text-sm text-slate-500 leading-relaxed"></p>
                </div>
                <div id="modal-step-error" class="hidden text-center py-4">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-red-500 text-3xl">error</span>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-2">오류가 발생했습니다</h4>
                    <p class="text-sm text-slate-500">잠시 후 다시 시도해 주세요. 또는 055-230-8200으로 전화 문의해 주세요.</p>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="px-6 pb-6 flex gap-3">
                <button id="modal-cancel" class="flex-1 py-3 rounded-xl border border-stone-300 text-slate-600 font-semibold hover:bg-slate-50 transition-colors text-sm">취소</button>
                <button id="modal-next" class="flex-1 py-3 rounded-xl bg-primary text-white font-semibold hover:bg-primary-light transition-colors text-sm">다음</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════ JAVASCRIPT ═══════════════════ -->
    <script>
    (() => {
        // ── DOM References ──
        const $ = id => document.getElementById(id);
        const DOM = {
            heroSection: $('hero-section'),
            heroInput: $('hero-input'),
            heroSubmit: $('hero-submit'),
            heroMic: $('hero-mic'),
            heroChips: $('hero-chips'),
            resultsSection: $('results-section'),
            aiSummaryArea: $('ai-summary-area'),
            aiSummaryText: $('ai-summary-text'),
            cardsTitle: $('cards-title'),
            cardsGrid: $('cards-grid'),
            cardsSkeleton: $('cards-skeleton'),
            discoverMore: $('discover-more'),
            btnNewSearch: $('btn-new-search'),
            initialPlaceholder: $('initial-placeholder'),
            // Browse
            browseTabs: $('browse-tabs'),
            browseList: $('browse-list'),
            browseLoading: $('browse-loading'),
            // Modal
            serviceModal: $('service-modal'),
            modalServiceName: $('modal-service-name'),
            modalStepName: $('modal-step-name'),
            modalStepPhone: $('modal-step-phone'),
            modalStepConfirm: $('modal-step-confirm'),
            modalStepError: $('modal-step-error'),
            modalNameInput: $('modal-name-input'),
            modalPhoneInput: $('modal-phone-input'),
            modalConfirmText: $('modal-confirm-text'),
            modalCancel: $('modal-cancel'),
            modalNext: $('modal-next'),
            // Floating Mic
            floatingMic: $('floating-mic'),
        };

        // ── State ──
        let chatHistory = [];
        let currentCards = [];
        let modalState = { step: 'name', serviceName: '', name: '', phone: '' };
        let lastInputWasVoice = false;
        let isSpeaking = false;
        let currentAudio = null;
        let currentUtterance = null;

        // ── Utility: Parse <noma-card> blocks from AI text ──
        function parseNomaCards(text) {
            const cards = [];
            const regex = /<noma-card>([\s\S]*?)<\/noma-card>/g;
            let match;
            while ((match = regex.exec(text)) !== null) {
                try {
                    cards.push(JSON.parse(match[1].trim()));
                } catch (e) { /* skip malformed */ }
            }
            const cleanText = text.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').trim();
            return { cards, summaryText: cleanText };
        }

        // ── Utility: Basic markdown to HTML ──
        function md(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br/>');
        }

        // ── Card Colors Pool ──
        const cardThemes = [
            { bg: 'bg-primary/10', text: 'text-primary', icon: 'emergency', border: 'border-primary/20', reasonBg: 'bg-amber-50', reasonBorder: 'border-amber-100', reasonTitle: 'text-amber-800', reasonText: 'text-amber-900/80' },
            { bg: 'bg-blue-50', text: 'text-blue-600', icon: 'home_health', border: 'border-blue-200', reasonBg: 'bg-blue-50', reasonBorder: 'border-blue-100', reasonTitle: 'text-blue-800', reasonText: 'text-blue-900/80' },
            { bg: 'bg-emerald-50', text: 'text-emerald-600', icon: 'smart_toy', border: 'border-emerald-200', reasonBg: 'bg-emerald-50', reasonBorder: 'border-emerald-100', reasonTitle: 'text-emerald-800', reasonText: 'text-emerald-900/80' },
            { bg: 'bg-violet-50', text: 'text-violet-600', icon: 'volunteer_activism', border: 'border-violet-200', reasonBg: 'bg-violet-50', reasonBorder: 'border-violet-100', reasonTitle: 'text-violet-800', reasonText: 'text-violet-900/80' },
        ];

        // ── 전화번호 자동 감지 → tel: 링크 변환 ──
        function linkifyPhone(text) {
            if (!text) return '';
            return text.replace(/(0\d{1,2}[-.\s]?\d{3,4}[-.\s]?\d{4})/g, (match) => {
                const digits = match.replace(/[-.\s]/g, '');
                return `<a href="tel:${digits}" class="tel-link"><span class="material-symbols-outlined" style="font-size:1.125rem">call</span>${match}</a>`;
            });
        }

        // ── Render a single recommendation card (Stepper 경로형) ──
        function createCardElement(data, index) {
            const theme = cardThemes[index % cardThemes.length];
            const delay = index * 100;
            const card = document.createElement('div');
            card.className = `bg-white rounded-2xl p-5 md:p-7 shadow-sm border border-stone-100 hover:border-primary/20 flex flex-col h-full transition-all group relative overflow-hidden opacity-0 animate-fade-up`;
            card.style.animationDelay = `${delay}ms`;

            // 단계 데이터 구성 (값이 있는 단계만 포함)
            const steps = [
                data.target  && { num: 1, title: '대상 확인',  icon: 'person_check', content: data.target,  color: '#2563eb' },
                data.method  && { num: 2, title: '신청 방법',  icon: 'edit_document', content: data.method,  color: '#7c3aed' },
                data.benefits && { num: 3, title: '받는 혜택', icon: 'featured_seasonal_and_gifts', content: data.benefits, color: '#059669' },
                data.agency  && { num: 4, title: '연락처',     icon: 'call',          content: data.agency,  color: '#0891b2', isContact: true },
            ].filter(Boolean);

            // 단계 번호 재정렬
            steps.forEach((s, i) => s.num = i + 1);

            const stepsHTML = steps.map((step, i) => {
                const isFirst = i === 0;
                return `
                    <div class="step-item${isFirst ? ' open' : ''}" data-step>
                        <div class="step-dot" style="background:${step.color}">${step.num}</div>
                        <div class="step-header" data-step-toggle>
                            <span class="material-symbols-outlined text-base" style="color:${step.color}">${step.icon}</span>
                            <span class="font-semibold text-slate-700 text-sm">${step.title}</span>
                            <span class="material-symbols-outlined step-chevron text-stone-400 ml-auto">expand_more</span>
                        </div>
                        <div class="step-body${isFirst ? ' open' : ''}">
                            <div class="text-slate-600 text-[13px] leading-relaxed break-keep pl-0.5">
                                ${step.isContact ? linkifyPhone(step.content) : step.content}
                            </div>
                        </div>
                    </div>`;
            }).join('');

            card.innerHTML = `
                <div class="absolute top-0 right-0 w-28 h-28 ${theme.bg} rounded-full -mr-8 -mt-8 blur-2xl opacity-50 group-hover:opacity-80 transition-opacity"></div>
                <div class="flex items-start justify-between mb-3 relative z-10">
                    <div class="${theme.bg} p-2.5 rounded-xl ${theme.text}">
                        <span class="material-symbols-outlined text-2xl">${theme.icon}</span>
                    </div>
                    <button class="btn-bookmark p-2 rounded-lg text-stone-300 hover:text-primary hover:bg-primary/5 transition-all" data-service-name="${data.serviceName || ''}" title="내 서랍에 담기">
                        <span class="material-symbols-outlined text-xl">bookmark_add</span>
                    </button>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-1 relative z-10 break-keep">${data.serviceName || ''}</h3>
                <p class="text-slate-500 text-[13px] mb-4 leading-relaxed relative z-10 break-keep">${data.summary || ''}</p>

                <div class="stepper relative z-10 mb-4">
                    ${stepsHTML}
                </div>

                <div class="mt-auto relative z-10">
                    <button class="btn-apply w-full bg-primary hover:bg-primary-light active:scale-[0.98] text-white font-bold py-3.5 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 text-sm" data-service="${data.serviceName || ''}">
                        이 서비스 상담 신청
                        <span class="material-symbols-outlined text-base">arrow_outward</span>
                    </button>
                    <p class="text-[10px] text-slate-400 text-center mt-2 leading-snug">버튼을 누르면 담당 기관에 정보가 전달되며,<br/>2~3일 내 전화 연락드립니다.</p>
                </div>
            `;
            return card;
        }

        // ══════════════════════════════════════════
        // ── BROWSE ALL SERVICES ──
        // ══════════════════════════════════════════

        let browseData = [];
        let browseActiveCategory = null;

        async function loadBrowseServices() {
            try {
                const res = await fetch('/api/services');
                if (!res.ok) throw new Error('API error');
                browseData = await res.json();
                DOM.browseLoading.classList.add('hidden');
                renderBrowseTabs();
                if (browseData.length > 0) selectBrowseCategory(browseData[0].category);
            } catch (e) {
                DOM.browseLoading.innerHTML = '<p class="text-slate-400 text-sm">서비스 목록을 불러올 수 없습니다.</p>';
            }
        }

        function renderBrowseTabs() {
            DOM.browseTabs.innerHTML = browseData.map(cat => `
                <button class="browse-tab flex items-center gap-2 px-5 py-3 rounded-xl border-2 transition-all text-sm font-semibold" data-cat="${cat.category}"
                    style="border-color: ${cat.color}20; color: ${cat.color};">
                    <span class="material-symbols-outlined text-lg">${cat.icon}</span>
                    ${cat.category}
                    <span class="text-xs font-normal opacity-70">(${cat.services.length})</span>
                </button>
            `).join('');

            DOM.browseTabs.addEventListener('click', e => {
                const tab = e.target.closest('.browse-tab');
                if (tab) selectBrowseCategory(tab.dataset.cat);
            });
        }

        function selectBrowseCategory(catName) {
            browseActiveCategory = catName;
            const cat = browseData.find(c => c.category === catName);
            if (!cat) return;

            // Update tab active state
            DOM.browseTabs.querySelectorAll('.browse-tab').forEach(tab => {
                const isActive = tab.dataset.cat === catName;
                tab.style.backgroundColor = isActive ? cat.color + '10' : 'white';
                tab.style.borderColor = isActive ? cat.color : cat.color + '20';
                tab.style.transform = isActive ? 'scale(1.05)' : '';
            });

            // Render service list
            DOM.browseList.innerHTML = `
                <p class="text-sm text-slate-500 mb-4 px-1">${cat.desc}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${cat.services.map((s, i) => `
                        <div class="browse-item bg-white border border-stone-200 rounded-xl p-5 hover:border-primary/30 hover:shadow-md transition-all cursor-pointer group opacity-0 animate-fade-up" style="animation-delay:${i * 50}ms" data-idx="${i}">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-slate-800 text-[15px] mb-1.5 group-hover:text-primary transition-colors break-keep">${s.name}</h4>
                                    <p class="text-xs text-slate-500 leading-relaxed line-clamp-2 break-keep">${s.summary}</p>
                                </div>
                                <div class="flex items-center gap-1 flex-shrink-0">
                                    <button class="browse-bookmark p-1 rounded text-stone-300 hover:text-primary transition-colors" data-service-name="${s.name}" data-summary="${(s.summary || '').replace(/"/g, '&quot;')}" data-agency="${(s.agency || '').replace(/"/g, '&quot;')}" title="내 서랍에 담기" onclick="event.stopPropagation()">
                                        <span class="material-symbols-outlined text-lg">bookmark_add</span>
                                    </button>
                                    <span class="material-symbols-outlined text-stone-300 group-hover:text-primary transition-colors mt-1">chevron_right</span>
                                </div>
                            </div>
                            <!-- Expandable Detail -->
                            <div class="browse-detail hidden mt-4 pt-4 border-t border-stone-100 space-y-3 text-sm">
                                ${s.target ? `<div class="flex gap-2"><span class="material-symbols-outlined text-stone-400 text-base flex-shrink-0 mt-0.5">group</span><div><span class="font-semibold text-slate-700">지원 대상</span><p class="text-slate-500 text-xs mt-0.5 leading-relaxed break-keep">${s.target}</p></div></div>` : ''}
                                ${s.benefits ? `<div class="flex gap-2"><span class="material-symbols-outlined text-stone-400 text-base flex-shrink-0 mt-0.5">featured_seasonal_and_gifts</span><div><span class="font-semibold text-slate-700">지원 내용</span><p class="text-slate-500 text-xs mt-0.5 leading-relaxed break-keep">${s.benefits}</p></div></div>` : ''}
                                ${s.method ? `<div class="flex gap-2"><span class="material-symbols-outlined text-stone-400 text-base flex-shrink-0 mt-0.5">edit_document</span><div><span class="font-semibold text-slate-700">신청 방법</span><p class="text-slate-500 text-xs mt-0.5 leading-relaxed break-keep">${s.method}</p></div></div>` : ''}
                                ${s.agency ? `<p class="text-[11px] text-slate-400 flex items-center gap-1"><span class="material-symbols-outlined text-xs">account_balance</span>담당: ${s.agency}</p>` : ''}
                                <button class="browse-apply w-full bg-primary hover:bg-primary-light text-white font-bold py-3 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 text-sm mt-2" data-service="${s.name}">
                                    이 사업 상담 신청하기
                                    <span class="material-symbols-outlined text-base">arrow_outward</span>
                                </button>
                                <p class="text-[10px] text-slate-400 text-center leading-snug">버튼을 누르시면 담당 기관에 이메일로 정보가 전달되며,<br/>2~3일 내로 전화 연락을 드릴 예정입니다.</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Toggle detail on click
            DOM.browseList.querySelectorAll('.browse-item').forEach(item => {
                item.addEventListener('click', e => {
                    if (e.target.closest('.browse-apply') || e.target.closest('.browse-bookmark')) return;
                    const detail = item.querySelector('.browse-detail');
                    const isOpen = !detail.classList.contains('hidden');
                    // Close all
                    DOM.browseList.querySelectorAll('.browse-detail').forEach(d => d.classList.add('hidden'));
                    if (!isOpen) detail.classList.remove('hidden');
                });
            });

            // Apply buttons
            DOM.browseList.addEventListener('click', e => {
                const btn = e.target.closest('.browse-apply');
                if (btn) { e.stopPropagation(); openServiceModal(btn.dataset.service); }
            });

            // Browse bookmark buttons
            DOM.browseList.querySelectorAll('.browse-bookmark').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    handleBookmark(btn.dataset.serviceName, {
                        serviceName: btn.dataset.serviceName,
                        summary: btn.dataset.summary || '',
                        agency: btn.dataset.agency || ''
                    });
                });
            });
        }

        loadBrowseServices();

        // ══════════════════════════════════════════
        // ── HERO SEARCH → INLINE RESULTS FLOW ──
        // ══════════════════════════════════════════

        // Clean chatHistory before sending to API: strip noma-card blocks and limit length
        function prepareMessagesForAPI() {
            const MAX_HISTORY = 8;
            return chatHistory.slice(-MAX_HISTORY).map(m => ({
                role: m.role,
                content: m.role === 'model'
                    ? m.content.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').trim()
                    : m.content
            }));
        }

        async function performSearch(query) {
            if (!query.trim()) return;

            // Transition to results state
            DOM.heroSection.classList.add('hero-compact');
            DOM.heroChips.classList.add('hidden');
            // Show floating mic on mobile
            if (DOM.floatingMic && SpeechRecognition) DOM.floatingMic.style.display = 'flex';
            DOM.initialPlaceholder.classList.add('hidden');
            DOM.resultsSection.classList.remove('hidden');
            DOM.aiSummaryArea.classList.add('hidden');
            DOM.discoverMore.classList.add('hidden');
            DOM.btnNewSearch.classList.remove('hidden');
            DOM.cardsGrid.innerHTML = '';
            DOM.cardsSkeleton.classList.remove('hidden');

            // Add to chat history
            chatHistory.push({ role: 'user', content: query });

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: prepareMessagesForAPI() }),
                    signal: controller.signal,
                });
                clearTimeout(timeout);

                if (!response.ok) throw new Error('Network error');

                const responseText = await response.text();
                let fullResponse = '';
                let apiError = '';
                for (const line of responseText.split('\n')) {
                    if (!line.startsWith('data: ')) continue;
                    const dataStr = line.slice(6).trim();
                    if (dataStr === '[DONE]') break;
                    try {
                        const data = JSON.parse(dataStr);
                        if (data.text) fullResponse += data.text;
                        if (data.error) apiError = data.error;
                    } catch (e) { /* partial chunk */ }
                }

                // API 오류 시 사용자에게 안내 + 재시도 버튼
                if (!fullResponse && apiError) {
                    chatHistory.pop(); // 실패한 사용자 메시지 제거
                    DOM.cardsSkeleton.classList.add('hidden');
                    DOM.cardsTitle.classList.add('hidden');
                    DOM.cardsGrid.classList.add('hidden');
                    DOM.aiSummaryArea.classList.remove('hidden');
                    DOM.aiSummaryText.innerHTML = `
                        <p>죄송합니다. AI 서버에서 응답을 받지 못했습니다.</p>
                        <p class="text-sm text-slate-500 mt-2">네트워크 상태를 확인하시거나, 잠시 후 다시 시도해 주세요.</p>
                        <button id="btn-retry-search" class="mt-4 px-5 py-2.5 bg-primary text-white text-sm font-semibold rounded-xl hover:bg-primary-light transition-colors inline-flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-base">refresh</span>
                            다시 시도하기
                        </button>
                    `;
                    const retryBtn = $('btn-retry-search');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => {
                            DOM.heroInput.value = query;
                            performSearch(query);
                        });
                    }
                    DOM.discoverMore.classList.remove('hidden');
                    return;
                }

                // 빈 응답 처리 (fullResponse가 없고 에러도 없는 경우)
                if (!fullResponse) {
                    chatHistory.pop();
                    DOM.cardsSkeleton.classList.add('hidden');
                    DOM.cardsTitle.classList.add('hidden');
                    DOM.cardsGrid.classList.add('hidden');
                    DOM.aiSummaryArea.classList.remove('hidden');
                    DOM.aiSummaryText.innerHTML = `
                        <p>AI 응답이 비어 있습니다. 다시 시도해 주세요.</p>
                        <button id="btn-retry-search" class="mt-4 px-5 py-2.5 bg-primary text-white text-sm font-semibold rounded-xl hover:bg-primary-light transition-colors inline-flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-base">refresh</span>
                            다시 시도하기
                        </button>
                    `;
                    const retryBtn = $('btn-retry-search');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => {
                            DOM.heroInput.value = query;
                            performSearch(query);
                        });
                    }
                    DOM.discoverMore.classList.remove('hidden');
                    return;
                }

                chatHistory.push({ role: 'model', content: fullResponse });
                saveHistory();

                // Parse cards and summary
                const { cards, summaryText } = parseNomaCards(fullResponse);
                currentCards = cards;

                // Hide skeleton
                DOM.cardsSkeleton.classList.add('hidden');

                // Show AI summary
                const displayText = summaryText || fullResponse.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').trim();
                if (displayText) {
                    DOM.aiSummaryArea.classList.remove('hidden');
                    DOM.aiSummaryText.innerHTML = md(displayText);
                }

                // Render cards or handle no-card cases
                if (cards.length > 0) {
                    DOM.cardsTitle.classList.remove('hidden');
                    DOM.cardsGrid.classList.remove('hidden');
                    cards.forEach((card, i) => {
                        DOM.cardsGrid.appendChild(createCardElement(card, i));
                    });
                } else if (displayText) {
                    DOM.cardsTitle.classList.add('hidden');
                    DOM.cardsGrid.classList.add('hidden');
                } else {
                    DOM.cardsTitle.classList.remove('hidden');
                    DOM.cardsGrid.classList.remove('hidden');
                    DOM.cardsGrid.innerHTML = `
                        <div class="col-span-full text-center py-10 opacity-0 animate-fade-up">
                            <span class="material-symbols-outlined text-stone-300 text-5xl mb-3">search_off</span>
                            <p class="text-slate-500 text-sm">관련 서비스를 찾지 못했습니다.<br/>다른 키워드로 다시 검색해 보세요.</p>
                        </div>
                    `;
                }

                // Show discover more
                DOM.discoverMore.classList.remove('hidden');

                // Smooth scroll to results
                DOM.resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // TTS: read AI summary aloud (voice input only)
                if (fullResponse && lastInputWasVoice) {
                    lastInputWasVoice = false;
                    await speakText(extractSpeakableText(fullResponse));
                } else {
                    lastInputWasVoice = false;
                }

            } catch (err) {
                lastInputWasVoice = false;
                chatHistory.pop(); // 실패한 사용자 메시지 제거
                console.error('Search error:', err);
                DOM.cardsSkeleton.classList.add('hidden');

                const isTimeout = err.name === 'AbortError';
                DOM.aiSummaryArea.classList.remove('hidden');
                DOM.aiSummaryText.innerHTML = `
                    <p>${isTimeout ? 'AI 서버 응답 시간이 초과되었습니다.' : 'AI 서버에 연결할 수 없습니다.'}</p>
                    <p class="text-sm text-slate-500 mt-2">${isTimeout ? '잠시 후 다시 시도해 주세요.' : '로컬 서버(localhost:5000)가 실행 중인지 확인해 주세요.'}</p>
                    <button id="btn-retry-search" class="mt-4 px-5 py-2.5 bg-primary text-white text-sm font-semibold rounded-xl hover:bg-primary-light transition-colors inline-flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        다시 시도하기
                    </button>
                `;
                DOM.cardsTitle.classList.add('hidden');
                DOM.cardsGrid.classList.add('hidden');
                const retryBtn = $('btn-retry-search');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => {
                        DOM.heroInput.value = query;
                        performSearch(query);
                    });
                }
                DOM.discoverMore.classList.remove('hidden');
            }
        }

        // ── Hero Event Handlers ──
        function handleHeroSubmit() {
            const query = DOM.heroInput.value.trim();
            if (!query) return;
            performSearch(query);
        }

        DOM.heroSubmit.addEventListener('click', handleHeroSubmit);
        DOM.heroInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); handleHeroSubmit(); }
        });

        document.querySelectorAll('.hero-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const msg = chip.getAttribute('data-msg');
                DOM.heroInput.value = msg;
                handleHeroSubmit();
            });
        });

        // ── Reset to Home ──
        function resetToHome() {
            DOM.heroSection.classList.remove('hero-compact');
            DOM.heroChips.classList.remove('hidden');
            DOM.resultsSection.classList.add('hidden');
            DOM.initialPlaceholder.classList.remove('hidden');
            DOM.heroInput.value = '';
            currentCards = [];

            // 모달 닫기
            DOM.serviceModal.classList.add('hidden');

            // 대화 내역 초기화
            clearChatData();

            // 최상단 스크롤
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Hide floating mic
            if (DOM.floatingMic) DOM.floatingMic.style.display = 'none';
        }

        // New search button
        DOM.btnNewSearch.addEventListener('click', resetToHome);

        // Browse scroll from discover section
        const btnBrowseScroll = $('btn-browse-scroll');
        if (btnBrowseScroll) {
            btnBrowseScroll.addEventListener('click', () => {
                document.getElementById('browse-section')?.scrollIntoView({ behavior: 'smooth' });
            });
        }

        // ── Stepper: Step toggle (expand/collapse) ──
        DOM.cardsGrid.addEventListener('click', e => {
            const toggle = e.target.closest('[data-step-toggle]');
            if (!toggle) return;
            const stepItem = toggle.closest('[data-step]');
            if (!stepItem) return;
            const body = stepItem.querySelector('.step-body');
            const isOpen = body.classList.contains('open');
            body.classList.toggle('open', !isOpen);
            stepItem.classList.toggle('open', !isOpen);
        });

        // ── Card Click → Service Request Modal ──
        DOM.cardsGrid.addEventListener('click', e => {
            const btn = e.target.closest('.btn-apply');
            if (!btn) return;
            openServiceModal(btn.dataset.service);
        });

        // ══════════════════════════════════════
        // ── SERVICE REQUEST MODAL ──
        // ══════════════════════════════════════

        function openServiceModal(serviceName) {
            modalState = { step: 'name', serviceName, name: '', phone: '' };
            DOM.modalServiceName.textContent = serviceName;
            DOM.modalStepName.classList.remove('hidden');
            DOM.modalStepPhone.classList.add('hidden');
            DOM.modalStepConfirm.classList.add('hidden');
            DOM.modalStepError.classList.add('hidden');
            DOM.modalNext.textContent = '다음';
            DOM.modalNext.classList.remove('hidden');
            DOM.modalCancel.textContent = '취소';
            DOM.modalCancel.classList.remove('hidden');
            DOM.modalNameInput.value = '';
            DOM.modalPhoneInput.value = '';
            DOM.serviceModal.classList.remove('hidden');
            setTimeout(() => DOM.modalNameInput.focus(), 100);
        }

        DOM.modalCancel.addEventListener('click', () => {
            if (modalState.step === 'confirm') {
                resetToHome();
            } else {
                DOM.serviceModal.classList.add('hidden');
            }
        });

        DOM.serviceModal.addEventListener('click', e => {
            if (e.target === DOM.serviceModal) DOM.serviceModal.classList.add('hidden');
        });

        DOM.modalNext.addEventListener('click', async () => {
            if (modalState.step === 'name') {
                const name = DOM.modalNameInput.value.trim();
                if (!name) { DOM.modalNameInput.focus(); return; }
                modalState.name = name;
                modalState.step = 'phone';
                DOM.modalStepName.classList.add('hidden');
                DOM.modalStepPhone.classList.remove('hidden');
                DOM.modalNext.textContent = '신청 완료';
                setTimeout(() => DOM.modalPhoneInput.focus(), 100);
            } else if (modalState.step === 'phone') {
                const phone = DOM.modalPhoneInput.value.trim();
                if (!phone) { DOM.modalPhoneInput.focus(); return; }
                modalState.phone = phone;
                DOM.modalNext.textContent = '처리 중...';
                DOM.modalNext.disabled = true;

                try {
                    const res = await fetch('/api/service-request/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            serviceName: modalState.serviceName,
                            userName: modalState.name,
                            userPhone: modalState.phone
                        })
                    });
                    if (!res.ok) throw new Error('API failed');

                    modalState.step = 'confirm';
                    DOM.modalStepPhone.classList.add('hidden');
                    DOM.modalStepConfirm.classList.remove('hidden');
                    DOM.modalConfirmText.innerHTML = `<b>${modalState.name}</b>님, <b>${modalState.serviceName}</b> 담당 기관에 상담 요청을 보냈습니다.<br/>2~3일 내로 <b>${modalState.phone}</b>으로 연락드릴 예정입니다.<br/><span class="text-[10px] text-slate-400 mt-2 inline-block">잠시 후 처음 화면으로 돌아갑니다...</span>`;
                    DOM.modalNext.classList.add('hidden');
                    DOM.modalCancel.textContent = '닫기';

                    setTimeout(resetToHome, 4000);
                } catch (err) {
                    modalState.step = 'error';
                    DOM.modalStepPhone.classList.add('hidden');
                    DOM.modalStepError.classList.remove('hidden');
                    DOM.modalNext.classList.add('hidden');
                    DOM.modalCancel.textContent = '닫기';
                } finally {
                    DOM.modalNext.disabled = false;
                }
            }
        });

        // Enter key in modal inputs
        DOM.modalNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') DOM.modalNext.click(); });
        DOM.modalPhoneInput.addEventListener('keydown', e => { if (e.key === 'Enter') DOM.modalNext.click(); });

        // ══════════════════════════════════════
        // ── SPEECH RECOGNITION + TTS ──
        // ══════════════════════════════════════

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let activeInput = null;
        let activeBtn = null;
        let isRecognitionRunning = false;

        function startListening(inputEl, btnEl) {
            if (!recognition) return;
            if (isRecognitionRunning) {
                recognition.abort();
                setTimeout(() => startListening(inputEl, btnEl), 150);
                return;
            }
            activeInput = inputEl;
            activeBtn = btnEl;
            try {
                recognition.start();
                isRecognitionRunning = true;
                btnEl.classList.add('animate-pulse', '!text-red-500');
                const icon = btnEl.querySelector('.material-symbols-outlined');
                if (icon) icon.textContent = 'graphic_eq';
                updateFloatingMicState();
            } catch (e) {
                console.error('Speech recognition start failed:', e);
                isRecognitionRunning = false;
                updateFloatingMicState();
            }
        }

        // ── TTS (Text-to-Speech) ──
        function extractSpeakableText(text) {
            const cardRegex = /<noma-card>([\s\S]*?)<\/noma-card>/g;
            const cards = [];
            let m;
            while ((m = cardRegex.exec(text)) !== null) {
                try {
                    const card = JSON.parse(m[1].trim());
                    if (card.serviceName) cards.push(card);
                } catch (e) {}
            }
            let clean = text.replace(/<noma-card>[\s\S]*?<\/noma-card>/g, '').trim();
            clean = clean.replace(/\*\*(.*?)\*\*/g, '$1');
            clean = clean.replace(/\*(.*?)\*/g, '$1');
            clean = clean.replace(/#{1,6}\s/g, '');
            clean = clean.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
            clean = clean.replace(/`([^`]+)`/g, '$1');
            if (cards.length > 0) {
                const ordinals = ['첫', '두', '세', '네', '다섯'];
                const cardSummary = cards.map((card, i) => {
                    let line = `${ordinals[i] || (i + 1)} 번째 추천 서비스는 ${card.serviceName}입니다.`;
                    // 연락처에서 전화번호 추출하여 읽어주기
                    if (card.agency) {
                        const phoneMatch = card.agency.match(/0\d{1,2}[-.\s]?\d{3,4}[-.\s]?\d{4}/);
                        if (phoneMatch) {
                            line += ` 문의는 ${phoneMatch[0]}로 전화하시면 됩니다.`;
                        }
                    }
                    return line;
                }).join(' ');
                clean += '\n' + cardSummary;
            }
            return clean.trim();
        }

        function speakText(text) {
            return new Promise(async resolve => {
                if (!text) { resolve(); return; }
                stopSpeaking();
                isSpeaking = true;
                updateFloatingMicState();

                const ttsText = text.length > 500 ? text.slice(0, 500) + '...' : text;

                // Try Edge TTS (server-side)
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch('/api/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: ttsText }),
                        signal: controller.signal,
                    });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error('TTS API error ' + res.status);
                    const data = await res.json();
                    if (data.audioContent && data.audioContent.length > 100) {
                        const audio = new Audio('data:audio/mpeg;base64,' + data.audioContent);
                        currentAudio = audio;
                        audio.onended = () => { isSpeaking = false; currentAudio = null; updateFloatingMicState(); resolve(); };
                        audio.onerror = (e) => { console.error('Audio playback error:', e); isSpeaking = false; currentAudio = null; updateFloatingMicState(); resolve(); };
                        await audio.play().catch(e => { console.error('Audio play failed:', e); throw e; });
                        return;
                    }
                    throw new Error('Empty audio content');
                } catch (e) {
                    console.warn('Edge TTS failed, using Web Speech API:', e.message);
                }

                // Fallback: Web Speech API
                if (!window.speechSynthesis) { isSpeaking = false; updateFloatingMicState(); resolve(); return; }
                const utterance = new SpeechSynthesisUtterance(ttsText);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;
                currentUtterance = utterance;
                utterance.onend = () => { isSpeaking = false; currentUtterance = null; updateFloatingMicState(); resolve(); };
                utterance.onerror = () => { isSpeaking = false; currentUtterance = null; updateFloatingMicState(); resolve(); };
                speechSynthesis.speak(utterance);
            });
        }

        function stopSpeaking() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            if (window.speechSynthesis && speechSynthesis.speaking) speechSynthesis.cancel();
            isSpeaking = false;
            currentUtterance = null;
            updateFloatingMicState();
        }

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = event => {
                const text = event.results[0][0].transcript;
                if (activeInput) {
                    lastInputWasVoice = true;
                    activeInput.value = text;
                    activeInput.dispatchEvent(new Event('input'));
                    setTimeout(() => {
                        if (activeInput === DOM.heroInput) {
                            handleHeroSubmit();
                        }
                    }, 300);
                }
            };

            recognition.onend = () => {
                isRecognitionRunning = false;
                DOM.heroMic.classList.remove('animate-pulse', '!text-red-500');
                const icon = DOM.heroMic.querySelector('.material-symbols-outlined');
                if (icon) icon.textContent = 'mic';
                activeInput = null;
                activeBtn = null;
                updateFloatingMicState();
            };

            recognition.onerror = event => {
                console.warn('Speech recognition error:', event.error);
                isRecognitionRunning = false;
            };

            DOM.heroMic.addEventListener('click', e => { e.preventDefault(); startListening(DOM.heroInput, DOM.heroMic); });

            // ── Floating Mic Button ──
            if (DOM.floatingMic) {
                DOM.floatingMic.addEventListener('click', () => {
                    if (isSpeaking) stopSpeaking();
                    startListening(DOM.heroInput, DOM.heroMic);
                    updateFloatingMicState();
                });
            }
        } else {
            DOM.heroMic.style.display = 'none';
        }

        // Update floating mic visual state
        function updateFloatingMicState() {
            if (!DOM.floatingMic) return;
            const icon = DOM.floatingMic.querySelector('.material-symbols-outlined:first-child');
            const statusIcon = DOM.floatingMic.querySelector('.mic-status .material-symbols-outlined');
            if (isRecognitionRunning) {
                DOM.floatingMic.classList.add('listening');
                if (icon) icon.textContent = 'graphic_eq';
            } else {
                DOM.floatingMic.classList.remove('listening');
                if (icon) icon.textContent = 'mic';
            }
            if (statusIcon) {
                if (isSpeaking) {
                    statusIcon.textContent = 'stop_circle';
                    statusIcon.style.color = '#ef4444';
                } else {
                    statusIcon.textContent = 'volume_off';
                    statusIcon.style.color = '#98002E';
                }
            }
        }

        // ══════════════════════════════════════
        // ── SESSION STORAGE + AUTO EXPIRY ──
        // ══════════════════════════════════════

        const CHAT_STORAGE_KEY = 'nomaChatHistory';
        const CHAT_TIMESTAMP_KEY = 'nomaChatLastActive';
        const CHAT_EXPIRY_MS = 5 * 60 * 1000; // 5분
        let inactivityTimer = null;

        function saveHistory() {
            try {
                sessionStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
                sessionStorage.setItem(CHAT_TIMESTAMP_KEY, Date.now().toString());
                resetInactivityTimer();
            } catch (e) {}
        }

        function loadHistory() {
            try {
                const savedTime = sessionStorage.getItem(CHAT_TIMESTAMP_KEY);
                if (savedTime && (Date.now() - parseInt(savedTime)) > CHAT_EXPIRY_MS) {
                    clearChatData();
                    return;
                }
                const saved = sessionStorage.getItem(CHAT_STORAGE_KEY);
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    resetInactivityTimer();
                }
            } catch (e) {}
        }

        function clearChatData() {
            sessionStorage.removeItem(CHAT_STORAGE_KEY);
            sessionStorage.removeItem(CHAT_TIMESTAMP_KEY);
            chatHistory = [];
            if (inactivityTimer) clearTimeout(inactivityTimer);
        }

        function resetInactivityTimer() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                clearChatData();
            }, CHAT_EXPIRY_MS);
        }

        // ══════════════════════════════════════
        // ── MY DRAWER (내 서랍) ──
        // ══════════════════════════════════════

        const DRAWER_CONSENT_KEY = 'nomaDrawerConsent';
        const DRAWER_DATA_KEY = 'nomaDrawerItems';
        let drawerItems = [];
        let pendingBookmark = null;

        function hasDrawerConsent() {
            return localStorage.getItem(DRAWER_CONSENT_KEY) === 'true';
        }

        function loadDrawerItems() {
            try {
                const saved = localStorage.getItem(DRAWER_DATA_KEY);
                if (saved) drawerItems = JSON.parse(saved);
            } catch (e) { drawerItems = []; }
            updateDrawerBadge();
        }

        function saveDrawerItems() {
            try { localStorage.setItem(DRAWER_DATA_KEY, JSON.stringify(drawerItems)); } catch (e) {}
            updateDrawerBadge();
        }

        function updateDrawerBadge() {
            const badge = $('drawer-badge');
            if (drawerItems.length > 0) {
                badge.textContent = drawerItems.length > 9 ? '9+' : drawerItems.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function addToDrawer(serviceData) {
            if (drawerItems.some(item => item.serviceName === serviceData.serviceName)) {
                showToast('이미 내 서랍에 담겨있는 서비스예요.');
                return;
            }
            drawerItems.push({
                serviceName: serviceData.serviceName,
                summary: serviceData.summary || '',
                agency: serviceData.agency || '',
                savedAt: new Date().toISOString()
            });
            saveDrawerItems();
            showToast('내 서랍에 담았어요!');
            updateBookmarkButtons();
        }

        function removeFromDrawer(serviceName) {
            drawerItems = drawerItems.filter(item => item.serviceName !== serviceName);
            saveDrawerItems();
            renderDrawerItems();
            updateBookmarkButtons();
        }

        function renderDrawerItems() {
            const emptyEl = $('drawer-empty');
            const itemsEl = $('drawer-items');
            const footerEl = $('drawer-footer');

            if (drawerItems.length === 0) {
                emptyEl.classList.remove('hidden');
                itemsEl.classList.add('hidden');
                footerEl.classList.add('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            itemsEl.classList.remove('hidden');
            footerEl.classList.remove('hidden');

            itemsEl.innerHTML = drawerItems.map((item, i) => `
                <div class="bg-white border border-stone-200 rounded-xl p-4 hover:border-primary/30 transition-all group animate-fade-up" style="animation-delay:${i * 50}ms">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 text-sm mb-1 break-keep">${item.serviceName}</h4>
                            <p class="text-xs text-slate-500 leading-relaxed break-keep line-clamp-2">${item.summary}</p>
                            ${item.agency ? `<p class="text-[10px] text-slate-400 mt-1.5 flex items-center gap-0.5"><span class="material-symbols-outlined text-[10px]">account_balance</span>${item.agency}</p>` : ''}
                        </div>
                        <div class="flex flex-col gap-1 flex-shrink-0">
                            <button class="drawer-item-apply p-1.5 rounded-lg text-primary hover:bg-primary/10 transition-colors" data-service="${item.serviceName}" title="상담 신청">
                                <span class="material-symbols-outlined text-lg">outgoing_mail</span>
                            </button>
                            <button class="drawer-item-remove p-1.5 rounded-lg text-stone-300 hover:text-red-500 hover:bg-red-50 transition-colors" data-service="${item.serviceName}" title="서랍에서 빼기">
                                <span class="material-symbols-outlined text-lg">bookmark_remove</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            itemsEl.querySelectorAll('.drawer-item-remove').forEach(btn => {
                btn.addEventListener('click', () => removeFromDrawer(btn.dataset.service));
            });
            itemsEl.querySelectorAll('.drawer-item-apply').forEach(btn => {
                btn.addEventListener('click', () => { closeMyDrawer(); openServiceModal(btn.dataset.service); });
            });
        }

        function updateBookmarkButtons() {
            document.querySelectorAll('.btn-bookmark').forEach(btn => {
                const name = btn.dataset.serviceName;
                const isSaved = drawerItems.some(item => item.serviceName === name);
                const icon = btn.querySelector('.material-symbols-outlined');
                if (isSaved) {
                    icon.textContent = 'bookmark_added';
                    btn.classList.add('!text-primary');
                    btn.title = '내 서랍에 담긴 서비스';
                } else {
                    icon.textContent = 'bookmark_add';
                    btn.classList.remove('!text-primary');
                    btn.title = '내 서랍에 담기';
                }
            });
        }

        // Toast notification
        function showToast(message) {
            const existing = document.querySelector('.noma-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'noma-toast fixed bottom-24 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white text-sm font-medium px-5 py-3 rounded-full shadow-lg animate-fade-up';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 2000);
        }

        // Open/Close drawer
        function openMyDrawer() {
            renderDrawerItems();
            $('drawer-overlay').classList.remove('hidden');
            requestAnimationFrame(() => {
                $('drawer-panel').style.transform = 'translateX(0)';
            });
        }
        window.openMyDrawer = openMyDrawer;

        function closeMyDrawer() {
            $('drawer-panel').style.transform = 'translateX(100%)';
            setTimeout(() => $('drawer-overlay').classList.add('hidden'), 300);
        }
        window.closeMyDrawer = closeMyDrawer;

        // Drawer button in header
        $('btn-my-drawer').addEventListener('click', openMyDrawer);

        // Clear all
        $('drawer-clear-all').addEventListener('click', () => {
            if (!confirm('내 서랍의 모든 서비스를 비울까요?')) return;
            drawerItems = [];
            saveDrawerItems();
            renderDrawerItems();
            updateBookmarkButtons();
        });

        // Bookmark button handler (main page cards)
        function handleBookmark(serviceName, serviceData) {
            if (!hasDrawerConsent()) {
                pendingBookmark = serviceData;
                $('consent-modal').classList.remove('hidden');
                return;
            }
            if (drawerItems.some(item => item.serviceName === serviceName)) {
                removeFromDrawer(serviceName);
                showToast('내 서랍에서 뺐어요.');
            } else {
                addToDrawer(serviceData);
            }
        }

        // Card bookmark buttons on main page
        DOM.cardsGrid.addEventListener('click', e => {
            const btn = e.target.closest('.btn-bookmark');
            if (!btn) return;
            const serviceName = btn.dataset.serviceName;
            const card = currentCards.find(c => c.serviceName === serviceName);
            handleBookmark(serviceName, card || { serviceName });
        });

        // Consent modal handlers
        $('consent-accept').addEventListener('click', () => {
            localStorage.setItem(DRAWER_CONSENT_KEY, 'true');
            $('consent-modal').classList.add('hidden');
            if (pendingBookmark) {
                addToDrawer(pendingBookmark);
                pendingBookmark = null;
            }
        });

        $('consent-decline').addEventListener('click', () => {
            $('consent-modal').classList.add('hidden');
            pendingBookmark = null;
        });

        $('consent-modal').addEventListener('click', e => {
            if (e.target === $('consent-modal')) {
                $('consent-modal').classList.add('hidden');
                pendingBookmark = null;
            }
        });

        // ── Init ──
        window.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            loadDrawerItems();
        });

    })();
    </script>
</body>
</html>