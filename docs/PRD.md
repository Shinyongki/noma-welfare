# PRD (Product Requirements Document)
# 노마(Noma) AI 맞춤형 복지 내비게이터

---

## 1. 제품 개요

| 항목 | 내용 |
|------|------|
| **제품명** | 노마(Noma) - AI 맞춤형 복지 내비게이터 |
| **소유 기관** | 경상남도사회서비스원 |
| **목적** | 도민이 일상 언어로 복지 서비스를 검색·신청하고, 담당자가 사건을 처리·연계·협업할 수 있는 통합 AI 복지 플랫폼 |
| **대상 사용자** | 일반 도민, 고령자, 정보 취약계층, 담당자, 부서 조정자, 관리자 |
| **플랫폼** | 모바일 웹 (반응형, 데스크톱 겸용) |
| **기술 스택** | Node.js/Express, Google Gemini 2.0 Flash (RAG), Edge TTS, Nodemailer (Naver SMTP), TailwindCSS (CDN), Web Speech API, Chart.js, express-session |

---

## 2. 문제 정의

### 2.1 도민 측 문제
- 복지 서비스 정보가 **행정 용어**로 작성되어, 일반 도민(특히 고령자)이 자신에게 해당하는 서비스를 찾기 어려움
- 기존 복지 포털은 **카테고리 탐색 방식**으로, 사용자가 자신의 상황을 어떤 카테고리에 매핑해야 하는지 알아야 함
- 고령자·장애인 등 정보 취약계층은 **텍스트 입력**이 어려워 접근성이 낮음

### 2.2 내부 업무 측 문제
- 상담 신청 접수 후 담당자에게 이메일만 전달되어 **처리 현황 추적 불가**
- 부서 간 **서비스 연계·협업**이 구두/메일 기반으로 비효율적
- 연계·협업 시 **승인 체계 부재**로 무분별한 연계 발생 가능
- 담당자가 **서비스 배정 근거**를 찾기 위해 법령·지침을 수동 검색

### 2.3 솔루션
- **자연어 대화형 검색**: "몸이 아파" → 긴급돌봄지원사업 자동 매칭
- **음성 입출력**: STT(음성→텍스트) + TTS(텍스트→음성)로 눈/손이 불편한 사용자도 이용 가능
- **경로형 안내**: 대상 확인 → 신청 방법 → 혜택 → 연락처를 단계별로 제시
- **관리자 대시보드**: 칸반 보드, KPI, 분석 차트로 전체 현황 실시간 모니터링
- **상담 처리 시스템**: 담당자가 상태 진행, 메모 작성, 연계 요청, AI 상담을 한 화면에서 처리
- **2단계 승인 워크플로우**: 부서 조정자 → 관리자 순차 승인으로 연계·협업 품질 관리

---

## 3. 사용자 페르소나

### P1. 김순자 (72세, 독거 어르신)
- **환경**: 안드로이드 스마트폰, 자녀가 북마크 해둔 웹 주소로 접속
- **니즈**: 퇴원 후 집에서 돌봐줄 사람이 없는데 어디에 연락해야 하는지 모름
- **행동 특성**: 텍스트 입력 어려움, 음성 사용 선호, 전화번호를 바로 누르고 싶음
- **핵심 가치**: 전화번호 하나만 알면 됨

### P2. 박민수 (38세, 장애인 자녀 부모)
- **환경**: 아이폰, 검색으로 유입
- **니즈**: 장애인 보조기기 지원이 있다고 들었는데 신청 자격과 방법을 알고 싶음
- **행동 특성**: 텍스트 입력 능숙, 여러 서비스 비교하고 싶음
- **핵심 가치**: 정확한 자격 요건과 신청 절차

### P3. 이영희 (55세, 읍면동 복지담당자)
- **환경**: 데스크톱, 민원인에게 서비스 안내 시 참고 자료로 활용
- **니즈**: 전체 서비스를 카테고리별로 빠르게 조회
- **행동 특성**: 전체 서비스 목록 브라우징, 서비스 상세정보 확인
- **핵심 가치**: 정확한 공식 정보

### P4. 정미영 (42세, 돌봄서비스과 담당자)
- **환경**: 데스크톱, 이메일 알림으로 상담 신청 수신
- **니즈**: 접수된 상담을 빠르게 확인하고 대상자에게 연락, 필요 시 타 부서 연계
- **행동 특성**: case.html에서 상태 업데이트, 메모 작성, AI와 배정 근거 논의
- **핵심 가치**: 정확한 배정 근거, 연계 절차 간소화

### P5. 김준호 (48세, 부서 조정자)
- **환경**: 데스크톱, admin.html의 연계 조정 탭 사용
- **니즈**: 소속 부서 담당자의 연계 요청을 검토하고 승인/반려/수정요청
- **행동 특성**: 승인 대기 목록 확인, 사유 검토 후 코멘트와 함께 판단
- **핵심 가치**: 근거 기반 의사결정, 부서 간 협업 품질 관리

### P6. 최관리 (50세, 관리자)
- **환경**: 데스크톱, admin.html 대시보드
- **니즈**: 전체 상담 현황 모니터링, KPI 확인, 최종 승인 처리, 서비스 계획 수립
- **행동 특성**: 칸반 보드로 전체 흐름 파악, 분석 탭으로 추이 확인, 승인 대기건 처리
- **핵심 가치**: 데이터 기반 운영 의사결정

---

## 4. 핵심 기능 요구사항

### 4.1 AI 대화형 검색 (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-01 | 자연어 질의 | 일상 한국어로 복지 서비스 검색 가능 |
| F-02 | 의미 기반 매칭 (RAG) | 유의어 사전 + 어미 제거 + 복합어 분해로 행정 용어 매핑 |
| F-03 | Strict Grounding | 지식베이스에 근거한 답변만 제공, 허위 서비스 생성 금지 |
| F-04 | 넓게→좁혀가기 대화 | 첫 질문에 2~3개 서비스 추천 후 후속 질문으로 좁혀감 |
| F-05 | STT 오류 보정 | 음성 인식 오타를 복지 맥락에 맞게 자동 보정 |
| F-06 | 대화 컨텍스트 유지 | 최근 8개 메시지 기반 멀티턴 대화 지원 |

### 4.2 음성 인터페이스 (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-07 | 음성 입력 (STT) | Web Speech API, 한국어(ko-KR), 음성 종료 시 자동 전송 |
| F-08 | 음성 출력 (TTS) | Edge TTS (ko-KR-SunHiNeural), AI 응답 + 추천 서비스명 + 연락처 읽어주기 |
| F-09 | 플로팅 마이크 | 모바일 우하단 고정 버튼, 녹음/재생 상태 시각 피드백 |

### 4.3 서비스 카드 UI (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-10 | 단계별 경로(Stepper) 카드 | ① 대상 확인 → ② 신청 방법 → ③ 받는 혜택 → ④ 연락처 |
| F-11 | 펼침/접힘 인터랙션 | 첫 단계 자동 펼침, 나머지 탭으로 토글 |
| F-12 | 전화번호 자동 링크 | 연락처 내 전화번호 감지 → `tel:` 링크로 탭-투-콜 |
| F-13 | 서비스 북마크 | "내 서랍" 저장 기능 (LocalStorage, 동의 필수) |
| F-14 | 상담 신청 (카드 버튼) | 카드 하단 버튼 → 모달에서 이름·전화번호 입력 → 담당 기관 이메일 발송 |
| F-14a | 대화형 상담 신청 | AI 대화 중 이름·전화번호 수집 → `<noma-apply>` 태그로 자동 신청 → 인라인 확인 카드 |
| F-14b | 이메일 알림 | Nodemailer(Naver SMTP)로 담당 기관에 상담 신청 이메일 발송 + AI 대화 요약 포함 |
| F-14c | 서비스 연계 요청 | 이메일 내 "타 서비스 연계" 버튼 → 연계 폼 페이지 → 연쇄 연계 지원 |

### 4.4 전체 서비스 브라우징 (Should-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-15 | 카테고리 탭 네비게이션 | 공공돌봄 / 민간지원 / 국공립시설 컬러별 탭 |
| F-16 | 서비스 상세 펼침 | 리스트 항목 클릭 시 상세정보 표시 |
| F-17 | 서비스 이용 경로 안내 | 상담→자격확인→인력배정→서비스제공 4단계 시각화 |

### 4.5 세션 관리 (Should-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-18 | 대화 이력 보존 | SessionStorage, 5분 비활성 시 자동 만료 |
| F-19 | 내 서랍 영속 저장 | LocalStorage, 명시적 동의 후 저장 |
| F-20 | 인사/일상 대화 처리 | 인사·감사·작별에 자연스럽게 응대, 서비스 검색 안 함 |

### 4.6 인증 및 접근제어 (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-21 | 세션 기반 인증 | express-session으로 관리자/담당자 인증. 비밀번호 로그인 → 8시간 세션 유지 |
| F-22 | 로그인 게이트 | admin.html, case.html에 로그인 UI 게이트. 인증 전 메인 콘텐츠 숨김 |
| F-23 | API 보호 | /api/case/*, /api/dept/*, /api/admin/*, /api/staff/* 경로에 requireAuth 미들웨어 적용 |
| F-24 | 인증 상태 확인 | GET /api/auth/status로 세션 유효 확인 → 이미 로그인 시 게이트 자동 스킵 |

### 4.7 관리자 대시보드 (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-25 | 현황판 (Dashboard) | KPI 카드 4종(총 접수, 처리 중, 연계 활성, 완료율) + 칸반 보드(5단계 컬럼) + 14일 접수 추이 차트 |
| F-26 | 상담 요청 관리 | 필터(상태)/검색(이름·전화·서비스)/정렬/페이지네이션 + 상세 모달(상태변경, 메모, 연계체인) |
| F-27 | 분석 탭 | 서비스별 인기도 막대 차트 + 카테고리 분포 도넛 차트 + KPI 추이 + 일별 이벤트 추이 |
| F-28 | 연계 조정 탭 | 2단계 승인 대기 목록(부서→관리자) + 승인/반려/수정요청 처리 + 승인 타임라인 + 이메일 자동 발송(최종 승인 시) |
| F-29 | 서비스 계획 수립 | 상담 요청 상세에서 단계별 서비스 계획 작성·저장 |

### 4.8 상담 처리 시스템 (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-30 | 상태 진행 스테퍼 | open → confirmed → contacted → connected → closed 5단계 전진형 상태관리 |
| F-31 | 처리 메모 | 담당자가 메모 추가, 시간순 정렬, 스크롤 |
| F-32 | 통합 연계 요청 | 부서 협업(자문/공동처리/이관) + 서비스 연계를 하나의 폼에서 생성. 2단계 승인 필요 |
| F-33 | 승인 상태 추적 | pending → dept_approved → approved (또는 rejected/revision_requested). 배지로 실시간 표시 |
| F-34 | 배정 근거 표시 | AI가 생성한 서비스 배정 근거(법적·제도적·실무적)와 담당 부서 정보 표시 |
| F-35 | 담당자 AI 상담 | 사건 컨텍스트 기반 AI와 대화. 배정 근거 분석, 처리 방안 제안, 연계 필요성 평가, 보고 요약 생성 |
| F-36 | 연계 체인 뷰 | 연쇄 연계 이력을 시각적 체인으로 표시 |
| F-37 | 서비스 계획 뷰어 | 관리자가 수립한 서비스 계획을 읽기 전용으로 표시 |

### 4.9 2단계 승인 워크플로우 (Must-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-38 | 부서 조정자 승인 | pending → dept_approved/rejected/revision_requested. 코멘트 필수 |
| F-39 | 관리자 최종 승인 | dept_approved → approved/admin_rejected/admin_revision_requested. 승인 시 이메일 자동 발송 |
| F-40 | 반려/수정요청 처리 | 반려 시 사유 필수. 수정요청 시 담당자가 재제출 가능 (approvalStatus 자동 리셋) |
| F-41 | 승인 타임라인 | 각 승인 단계 일시, 코멘트, 처리자를 타임라인으로 시각화 |

### 4.10 부서 간 협업 (Should-Have)

| ID | 요구사항 | 상세 |
|----|---------|------|
| F-42 | 협업 유형 | 자문(consultation), 공동처리(joint), 이관(transfer) 3가지 유형 |
| F-43 | 부서 목록 | 8개 부서(경영지원과, 전략기획과, 사회서비스품질과 등) + 4개 시설 |
| F-44 | 협업 메모 | 부서 간 의견 교환용 메모 (author, dept, timestamp 포함) |
| F-45 | 실행 상태 관리 | 승인 후 in_progress → completed/declined 실행 상태 추적 |

---

## 5. 비기능 요구사항

| 항목 | 요구사항 |
|------|---------|
| **성능** | AI 응답 SSE 스트리밍 (체감 지연 최소화), TTS 2회 재시도, Gemini 429 시 3초 백오프 재시도 |
| **접근성** | 큰 터치 영역(60px 마이크 버튼), 고대비 색상, 쉬운 한국어, 전체 아이콘 aria-hidden="true" 적용 |
| **반응형** | 모바일 1열 / 태블릿·데스크톱 2열 그리드, 768px 브레이크포인트. 칸반 보드 모바일 세로 스택 |
| **개인정보** | PII 서버 미저장(상담 신청 제외), 익명 북마크, 세션 자동 만료 |
| **가용성** | Gemini API 429 시 에러 메시지 + 대표전화 안내 폴백 |
| **보안** | 세션 기반 인증(httpOnly, sameSite, secure), CORS 오리진 제한, JSON 본문 1MB 제한, 보호 API requireAuth |
| **안정성** | 글로벌 에러 핸들러(Express + unhandledRejection + uncaughtException), 원자적 파일 쓰기(tmp→rename), 백업 자동 생성, 손상 자동 복구 |

---

## 6. 지식베이스 구조

| 카테고리 | 서비스 수 | 예시 서비스 |
|---------|----------|-----------|
| **공공돌봄** | 약 10건 | 긴급돌봄지원, 종합재가센터, 통합돌봄지원센터, 노인맞춤돌봄, 응급안전안심서비스 |
| **민간지원** | 약 4건 | 사회복지시설 대체인력, 장기요양기관 컨설팅, 활동지원사 교육 |
| **국공립시설** | 약 3건 | 경상남도청어린이집, 보조기기센터, 피해장애인쉼터 |

---

## 7. 기술 아키텍처 요약

```
[도민 브라우저 - code.html]
     │
     ├── 음성 입력 ──→ Web Speech API (STT) ──→ 텍스트 변환
     │
     ├── 텍스트 입력 ──→ POST /api/chat ──→ [Express 서버]
     │                                        │
     │                                  ┌─────┴─────┐
     │                                  │ RAG 엔진  │
     │                                  │ 어미 제거  │
     │                                  │ 유의어 확장 │
     │                                  │ 스코어링   │
     │                                  └─────┬─────┘
     │                                        │
     │                                  ┌─────┴─────┐
     │                                  │ Gemini AI │
     │                                  │ 2.0 Flash │
     │                                  └─────┬─────┘
     │                                        │
     ├── SSE 스트림 ←──────────────────────────┘
     │
     ├── TTS 요청 ──→ POST /api/tts ──→ Edge TTS ──→ 음성 재생
     │
     ├── 카드 렌더링 ──→ Stepper UI + tel: 링크
     │
     ├── 상담 신청 ──→ POST /api/service-request/connect
     │                      │
     │                ┌─────┴──────┐
     │                │ 대화 요약   │──→ AI 배정 근거 생성
     │                │ (Gemini)   │
     │                └─────┬──────┘
     │                      │
     │                ┌─────┴──────┐
     │                │ 이메일 발송 │──→ 담당 기관 이메일 (연계 버튼 포함)
     │                │ (Nodemailer)│
     │                └─────┬──────┘
     │                      │
     │                ┌─────┴──────┐
     │                │ requestStore│──→ JSON 파일 저장 (원자적 쓰기 + 백업)
     │                └────────────┘
     │
     └── 서비스 연계 ──→ /referral/:id ──→ POST /api/referral/:id/send

[담당자 브라우저 - case.html]
     │
     ├── 로그인 ──→ POST /api/auth/login ──→ 세션 발급
     │
     ├── 사건 조회 ──→ GET /api/case/:id ──→ 상세 + linkages + 연계체인
     │
     ├── 상태 변경 ──→ PATCH /api/case/:id/status ──→ 전진형 5단계
     │
     ├── 메모 추가 ──→ POST /api/case/:id/notes
     │
     ├── 연계 요청 ──→ POST /api/case/:id/linkage ──→ 2단계 승인 대기
     │
     └── AI 상담 ──→ POST /api/staff/chat ──→ Gemini AI (사건 컨텍스트 + KB)

[관리자 브라우저 - admin.html]
     │
     ├── 로그인 ──→ POST /api/auth/login ──→ 세션 발급
     │
     ├── 현황판 ──→ GET /api/admin/stats (KPI + 14일 추이 + 미처리 알림)
     │
     ├── 상담 관리 ──→ GET /api/admin/requests (필터/검색/페이지네이션)
     │             ──→ PATCH /api/admin/requests/:id/status (상태 변경)
     │
     ├── 분석 ──→ GET /api/admin/analytics (서비스 인기도, 카테고리 분포)
     │        ──→ GET /api/admin/kpi (KPI 통계)
     │        ──→ GET /api/admin/trends (일별 이벤트 추이)
     │
     └── 연계 조정 ──→ GET /api/admin/pending-approvals
                  ──→ POST /api/admin/linkage/:lid/approve (최종 승인 + 이메일)
                  ──→ POST /api/admin/linkage/:lid/reject

[부서 조정자 API]
     ├── GET /api/dept/pending-approvals (부서 승인 대기)
     ├── POST /api/dept/linkage/:lid/approve (부서 승인)
     ├── POST /api/dept/linkage/:lid/reject (부서 반려)
     └── POST /api/dept/linkage/:lid/revision (수정 요청)
```

---

## 8. 성공 지표 (KPI)

| 지표 | 측정 방법 | 목표 |
|------|----------|------|
| RAG 매칭률 | 일상어 쿼리 대비 관련 서비스 매칭 비율 | 80% 이상 |
| 상담 전환율 | 카드 노출 대비 "상담 신청" 클릭 비율 | 15% 이상 |
| 음성 사용률 | 전체 검색 대비 음성 입력 비율 | 30% 이상 (모바일) |
| 이탈률 | "서비스를 찾을 수 없습니다" 응답 비율 | 20% 이하 |
| TTS 완청률 | 음성 응답 시작 대비 끝까지 들은 비율 | 60% 이상 |
| 평균 처리 시간 | 접수(open)→완료(closed) 소요 일수 | 3일 이하 |
| 연계 승인율 | 연계 요청 대비 최종 승인 비율 | 70% 이상 |
| 미처리 알림 | 3일 이상 open 상태인 요청 수 | 0건 유지 |

---

## 9. 환경변수

| 변수 | 설명 | 기본값 |
|------|------|--------|
| `GEMINI_API_KEY` | Google Gemini API 키 | (필수) |
| `ADMIN_PASSWORD` | 관리자/담당자 로그인 비밀번호 | (필수) |
| `SESSION_SECRET` | express-session 서명 키 | crypto.randomUUID() |
| `EMAIL_USER` | Naver SMTP 사용자 | (필수) |
| `EMAIL_PASS` | Naver SMTP 비밀번호 | (필수) |
| `EMAIL_RECIPIENT` | 개발용 이메일 수신자 | admin@example.com |
| `ALLOWED_ORIGINS` | CORS 허용 오리진 (쉼표 구분) | 전체 허용 |
| `NODE_ENV` | 실행 환경 (production 시 secure 쿠키) | development |
| `PORT` | 서버 포트 | 3000 |

---

## 10. 제약 사항 및 향후 로드맵

### 현재 제약
- Gemini 무료 티어: 분당 요청 제한 (429 시 자동 재시도)
- 이메일 수신 주소: 개발용 환경변수 설정 (운영 시 기관별 매핑 필요)
- 지식베이스: CSV 18건 (확장 필요)
- 인증 체계: 단일 비밀번호 방식 (운영 시 개인 계정 + 역할 기반 접근제어 필요)
- 요청 저장소: JSON 파일 기반 (운영 시 DB 전환 필요)
- CDN Tailwind: 런타임 빌드 (로컬 빌드 전환 필요)

### 향후 로드맵
| 단계 | 내용 |
|------|------|
| Phase 2 | XSS 방어(DOMPurify), 보안 헤더(helmet), 입력 검증 강화, Rate Limiting, CDN→로컬 Tailwind 빌드 |
| Phase 3 | 인메모리 캐시, 대화 히스토리 sliding window, case.html 일회성 토큰 인증, 고대비 모드 |
| Phase 4 | Vector DB 전환 (임베딩 기반 시맨틱 검색), 서비스 50건+ 확장 |
| Phase 5 | 개인 계정 + RBAC(역할 기반 접근제어), SMS 발송 연동 |
| Phase 6 | 다국어 지원 (영어, 중국어, 베트남어) |
