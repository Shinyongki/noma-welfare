# Use Case 명세서
# 노마(Noma) AI 맞춤형 복지 내비게이터

---

## Use Case 목록

| ID | Use Case | 주 액터 | 우선순위 |
|----|---------|--------|---------|
| UC-01 | 자연어로 복지 서비스 검색 | 도민 | Must |
| UC-02 | 음성으로 복지 서비스 검색 | 도민(고령자) | Must |
| UC-03 | 서비스 카드 경로 단계 탐색 | 도민 | Must |
| UC-04 | 서비스 상담 신청 (카드 버튼 경로) | 도민 | Must |
| UC-04a | 대화형 상담 신청 (음성/텍스트 경로) | 도민 | Must |
| UC-05 | 전화번호 탭하여 바로 연결 | 도민(고령자) | Must |
| UC-06 | 서비스 북마크(내 서랍) 관리 | 도민 | Should |
| UC-07 | 전체 서비스 카테고리 브라우징 | 도민/복지담당자 | Should |
| UC-08 | 음성 응답(TTS)으로 결과 듣기 | 도민(고령자) | Must |
| UC-09 | 후속 대화로 서비스 좁혀가기 | 도민 | Should |
| UC-10 | 예시 칩으로 빠른 검색 | 도민 | Nice |
| UC-11 | 서비스 연계 요청 (이메일 경로) | 복지담당자 | Should |
| UC-12 | 관리자/담당자 로그인 | 관리자/담당자 | Must |
| UC-13 | 대시보드 현황 모니터링 | 관리자 | Must |
| UC-14 | 상담 요청 관리 (관리자) | 관리자 | Must |
| UC-15 | 상담 처리 (담당자) | 담당자 | Must |
| UC-16 | 연계/협업 요청 생성 | 담당자 | Must |
| UC-17 | 2단계 승인 처리 | 부서 조정자/관리자 | Must |
| UC-18 | 담당자 AI 상담 | 담당자 | Should |
| UC-19 | 분석 및 KPI 확인 | 관리자 | Should |
| UC-20 | 서비스 계획 수립 | 관리자 | Should |

---

## UC-01. 자연어로 복지 서비스 검색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (일반 사용자) |
| **목적** | 일상 언어로 자신의 상황을 설명하고, 해당하는 복지 서비스를 찾는다 |
| **사전 조건** | 사용자가 웹 페이지에 접속한 상태 |
| **사후 조건** | 관련 서비스 카드가 화면에 표시되고, AI 요약이 제공된다 |

### 기본 흐름 (Main Flow)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 검색창에 일상어로 입력 (예: "몸이 아파요") | |
| 2 | 전송 버튼 클릭 또는 Enter | |
| 3 | | 히어로 영역 축소, 로딩 스켈레톤 표시 |
| 4 | | 입력 텍스트에서 한국어 어미 제거 ("아파요" → "아파") |
| 5 | | synonymMap으로 유의어 확장 ("아파" → 질병, 부상, 돌봄, 의료, 긴급돌봄) |
| 6 | | 지식베이스 17건과 매칭, 관련도 스코어링 |
| 7 | | 상위 5건 + 노이즈 필터링 (30% 미만 제외) |
| 8 | | RAG 컨텍스트 + 사용자 메시지를 Gemini AI에 전송 |
| 9 | | SSE 스트리밍으로 AI 응답 수신 |
| 10 | | AI 요약 텍스트 표시 + Stepper 서비스 카드 렌더링 |
| 11 | 결과를 확인하고 서비스 카드의 각 단계를 탭하여 상세 확인 | |

### 대안 흐름 (Alternative Flow)

**A1. RAG 매칭 결과 0건**
| # | 시스템 |
|---|--------|
| 7a | 매칭 결과가 없으면 빈 RAG 컨텍스트로 AI에 전송 |
| 8a | AI가 "관련 서비스를 찾지 못했다"고 안내 + 대표전화 055-230-8200 안내 |
| 9a | "전체 서비스 둘러보기" 버튼 표시 |

**A2. 인사/일상 대화 입력**
| # | 시스템 |
|---|--------|
| 4a | "안녕하세요", "고마워요" 등 인사 감지 |
| 5a | AI가 자연스럽게 인사 응답 (서비스 검색 안 함) |
| 6a | 서비스 카드 미표시, AI 요약만 표시 |

**A3. API 오류/타임아웃**
| # | 시스템 |
|---|--------|
| 8a | Gemini API 429 또는 네트워크 오류 발생 |
| 9a | 에러 메시지 표시: "AI 서버에서 응답을 받지 못했습니다" |
| 10a | "다시 시도" 버튼 + 대표전화 안내 표시 |

---

## UC-02. 음성으로 복지 서비스 검색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (고령자, 시각장애인) |
| **목적** | 음성으로 말해서 복지 서비스를 검색하고, 음성으로 결과를 듣는다 |
| **사전 조건** | 마이크 권한 허용, 브라우저 Web Speech API 지원 |
| **사후 조건** | 검색 결과가 카드로 표시되고, TTS로 음성 안내가 재생된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 플로팅 마이크 버튼 또는 검색창 마이크 버튼 탭 | |
| 2 | | 마이크 활성화, 버튼 빨간색 펄스 애니메이션 |
| 3 | "퇴원 후 돌봐줄 사람이 없어요"라고 말한다 | |
| 4 | | Web Speech API가 음성 → 텍스트 변환 (ko-KR) |
| 5 | | 변환된 텍스트를 검색창에 자동 입력 |
| 6 | | `lastInputWasVoice = true` 설정 |
| 7 | | 300ms 후 자동 검색 실행 (UC-01 Step 3~10) |
| 8 | | 검색 결과 렌더링 완료 후 TTS 자동 실행 |
| 9 | | Edge TTS로 AI 요약 읽어주기 |
| 10 | | "첫 번째 추천 서비스는 긴급돌봄지원사업입니다. 문의는 055-230-8216으로 전화하시면 됩니다." |
| 11 | 음성 안내를 듣고, 필요 시 전화번호 탭 | |

### 대안 흐름

**A1. 음성 인식 실패**
| # | 시스템 |
|---|--------|
| 4a | STT가 빈 결과 반환 또는 에러 발생 |
| 5a | 마이크 버튼 원래 상태로 복귀, 입력 없음 |
| 6a | 사용자가 다시 마이크 탭하여 재시도 |

**A2. TTS 재생 중 사용자가 중단**
| # | 액터 | 시스템 |
|---|------|--------|
| 9a | 플로팅 마이크 버튼 탭 | |
| 10a | | TTS 재생 중단, 음성 입력 모드로 전환 |

---

## UC-03. 서비스 카드 경로 단계 탐색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 추천된 서비스의 대상·신청방법·혜택·연락처를 단계별로 확인한다 |
| **사전 조건** | UC-01 또는 UC-02에 의해 서비스 카드가 표시된 상태 |
| **사후 조건** | 사용자가 필요한 정보를 단계별로 확인했다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | | 카드 표시 시 ① 대상 확인 단계가 자동으로 펼쳐져 있음 |
| 2 | "② 신청 방법" 헤더 탭 | |
| 3 | | ② 단계 내용 펼침 (슬라이드 애니메이션), 쉐브론 회전 |
| 4 | 신청 방법 내용 확인 | |
| 5 | "③ 받는 혜택" 헤더 탭 | |
| 6 | | ③ 단계 내용 펼침 |
| 7 | "④ 연락처" 헤더 탭 | |
| 8 | | ④ 단계 펼침, 전화번호가 초록색 tel: 링크 버튼으로 표시 |
| 9 | 전화번호 버튼 탭 → UC-05로 이동 | |

### 대안 흐름

**A1. 이미 펼쳐진 단계 다시 탭**
| # | 시스템 |
|---|--------|
| 3a | 해당 단계 접힘 (토글), 쉐브론 원래 방향으로 복귀 |

---

## UC-04. 서비스 상담 신청 (카드 버튼 경로)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 관심 있는 서비스에 대해 상담을 신청하여, 담당 기관에서 연락받는다 |
| **사전 조건** | 서비스 카드가 표시된 상태 |
| **사후 조건** | 담당 기관에 이메일이 발송되고 (AI 대화 요약 + 배정 근거 포함), 확인 화면이 표시된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 카드 하단 "이 서비스 상담 신청" 버튼 클릭 | |
| 2 | | 상담 신청 모달 표시 (서비스명 헤더) |
| 3 | | Step 1: 성함 입력 화면 표시, 입력 필드 포커스 |
| 4 | 이름 입력 (예: "김순자") | |
| 5 | "다음" 버튼 클릭 | |
| 6 | | 이름 저장, Step 2: 연락처 입력 화면으로 전환 |
| 7 | 전화번호 입력 (예: "010-1234-5678") | |
| 8 | "신청 완료" 버튼 클릭 | |
| 9 | | 버튼 비활성화 + "처리 중..." 텍스트 |
| 10 | | POST /api/service-request/connect 호출 (chatHistory 포함) |
| 11 | | Gemini로 대화 요약 생성 + AI 배정 근거 생성 |
| 12 | | requestStore에 요청 저장 (원자적 쓰기 + 백업) |
| 13 | | Nodemailer로 담당 기관 이메일 발송 (신청 정보 + 대화 요약 + 배정 근거 + 연계 버튼 + case 처리 링크) |
| 14 | | analyticsStore에 이벤트 기록 |
| 15 | | Step 3: 완료 화면 (체크 아이콘 + 신청 정보 요약) |
| 16 | | "김순자님, 긴급돌봄지원사업 상담 신청이 완료되었습니다" |
| 17 | | 4초 후 자동으로 초기 화면으로 복귀 |

### 대안 흐름

**A1. 빈 이름으로 "다음" 클릭**
| # | 시스템 |
|---|--------|
| 5a | 아무 동작 안 함 (빈 값 검증 실패) |

**A2. API 호출 실패**
| # | 시스템 |
|---|--------|
| 10a | Step 4: 오류 화면 표시 |
| 11a | "잠시 후 다시 시도하거나, 055-230-8200으로 전화 문의" 안내 |

**A3. 모달 닫기**
| # | 액터 | 시스템 |
|---|------|--------|
| * | "취소" 버튼 또는 오버레이 클릭 | 모달 닫힘, 폼 상태 초기화 |

---

## UC-04a. 대화형 상담 신청 (음성/텍스트 대화 경로)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 카드 버튼을 누르지 않고, AI 대화만으로 상담 신청을 완료한다 |
| **사전 조건** | AI와 대화 중이며, 서비스가 추천된 상태 |
| **사후 조건** | 담당 기관에 이메일이 발송되고, 인라인 확인 카드가 표시된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | "이 서비스 신청하고 싶어요" 입력/음성 | |
| 2 | | AI가 신청 대상 서비스 확인 (직전 추천 서비스 자동 선택) |
| 3 | | AI: "노인맞춤돌봄서비스 상담을 신청해 드릴까요? 성함을 알려주시겠어요?" |
| 4 | "김순자예요" 입력/음성 | |
| 5 | | AI: "김순자님, 연락받으실 전화번호도 알려주시겠어요?" |
| 6 | "010-1234-5678이요" 입력/음성 | |
| 7 | | AI: 확인 문구 + `<noma-apply>` 태그 출력 (3필드 완성) |
| 8 | | 클라이언트: `parseNomaApply()` → JSON 파싱 + 유효성 검증 |
| 9 | | POST /api/service-request/connect (chatHistory 포함) |
| 10 | | 이메일 발송 (신청 정보 + AI 대화 요약 + 배정 근거 + 연계 버튼 + case 처리 링크) |
| 11 | | 인라인 초록색 확인 카드 표시: "김순자님, 노인맞춤돌봄서비스 담당 기관에 상담 요청을 보냈습니다" |

### 대안 흐름

**A1. 이전 대화에서 이름/전화번호를 이미 수집한 경우**
| # | 시스템 |
|---|--------|
| 3a | AI가 이미 파악된 정보는 다시 묻지 않고, 미수집 정보만 질문 |
| 7a | 모든 정보 확보 시 바로 확인 문구 + `<noma-apply>` 출력 |

**A2. `<noma-apply>` 필드 불완전**
| # | 시스템 |
|---|--------|
| 8a | `parseNomaApply()` → null 반환, 자동 신청 안 함 |
| 9a | 사용자에게 영향 없음 (대화만 표시) |

**A3. API 호출 실패**
| # | 시스템 |
|---|--------|
| 9a | 인라인 빨간색 에러 카드 표시 |
| 10a | "자동 신청에 실패했습니다. 서비스 카드의 '상담 신청' 버튼을 눌러 직접 신청해 주세요." |

**A4. 전화번호 형식 오류**
| # | 시스템 |
|---|--------|
| 6a | AI가 한국 전화번호 형식이 아님을 감지 |
| 7a | AI: "죄송해요, 전화번호 형식이 맞지 않는 것 같아요. 다시 한번 알려주시겠어요?" |

---

## UC-05. 전화번호 탭하여 바로 연결

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (특히 고령자) |
| **목적** | 담당 기관에 바로 전화를 건다 |
| **사전 조건** | 카드의 ④ 연락처 단계가 펼쳐진 상태, 또는 헤더의 전화 문의 버튼 |
| **사후 조건** | 기기의 전화 앱이 실행되어 해당 번호로 발신 준비 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 카드 ④ 연락처 단계의 초록색 전화번호 버튼 탭 | |
| 2 | | `tel:0552308216` 링크 실행 → OS 전화 앱 호출 |
| 3 | 전화 앱에서 발신 확인 | |

---

## UC-06. 서비스 북마크(내 서랍) 관리

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 관심 있는 서비스를 저장해두고, 나중에 다시 확인한다 |
| **사전 조건** | 서비스 카드 또는 브라우징 리스트가 표시된 상태 |
| **사후 조건** | 서비스가 내 서랍에 저장/삭제되고, LocalStorage에 영속 저장된다 |

### 기본 흐름 (최초 저장)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 카드 우상단 북마크 아이콘 탭 | |
| 2 | | (첫 사용 시) 동의 모달 표시: "서비스를 저장할까요?" |
| 3 | "네, 저장할게요" 탭 | |
| 4 | | 동의 기록 (LocalStorage), 서비스 저장 |
| 5 | | 토스트 알림: "내 서랍에 담았어요!" |
| 6 | | 북마크 아이콘 → 채워진 아이콘으로 변경, 헤더 뱃지 카운트 +1 |

### 기본 흐름 (서랍 확인 및 삭제)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 헤더의 "내 서랍" 메뉴 클릭 | |
| 2 | | 우측 서랍 패널 슬라이드 인 |
| 3 | | 저장된 서비스 목록 표시 (서비스명, 요약, 담당 기관) |
| 4 | 특정 서비스의 삭제 버튼 탭 | |
| 5 | | 해당 서비스 삭제, 리스트 갱신, 뱃지 카운트 -1 |
| 6 | X 버튼 또는 오버레이 클릭 | 서랍 패널 닫힘 |

---

## UC-07. 전체 서비스 카테고리 브라우징

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민, 복지담당자 |
| **목적** | AI 검색 없이, 전체 서비스를 카테고리별로 탐색한다 |
| **사전 조건** | 페이지 로드 시 API로 서비스 목록 자동 불러오기 완료 |
| **사후 조건** | 원하는 서비스의 상세 정보를 확인했다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 페이지 스크롤 또는 "전체 서비스" 메뉴 클릭 | |
| 2 | | 전체 서비스 섹션으로 이동 |
| 3 | | 카테고리 탭 표시: 공공돌봄(n건) / 민간지원(n건) / 국공립시설(n건) |
| 4 | "공공돌봄" 탭 클릭 (기본 선택) | |
| 5 | | 해당 카테고리의 서비스 리스트 렌더링 (2열 그리드) |
| 6 | 특정 서비스 항목 클릭 | |
| 7 | | 상세 정보 펼침: 지원 대상, 지원 내용, 신청 방법, 문의처 |
| 8 | "상담 신청" 버튼 클릭 → UC-04로 이동 | |

---

## UC-08. 음성 응답(TTS)으로 결과 듣기

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (고령자, 시각장애인) |
| **목적** | 검색 결과를 음성으로 들어서, 화면을 보지 않고도 핵심 정보를 얻는다 |
| **사전 조건** | UC-02(음성 검색)로 검색이 완료된 상태 |
| **사후 조건** | AI 요약 + 추천 서비스명 + 연락처가 음성으로 안내된다 |

### 기본 흐름
| # | 시스템 |
|---|--------|
| 1 | 음성 검색 완료 후 자동으로 TTS 실행 |
| 2 | AI 요약 텍스트를 Edge TTS로 변환 (ko-KR-SunHiNeural) |
| 3 | "몸이 아프셔서 많이 힘드셨겠어요..." 읽어주기 |
| 4 | 추천 서비스 안내: "첫 번째 추천 서비스는 긴급돌봄지원사업입니다." |
| 5 | 연락처 안내: "문의는 055-230-8216으로 전화하시면 됩니다." |
| 6 | 플로팅 마이크 상태 아이콘 → 재생 중 표시 |
| 7 | 재생 완료 후 대기 상태로 복귀 |

### 대안 흐름

**A1. Edge TTS 실패 → Web Speech API 폴백**
| # | 시스템 |
|---|--------|
| 2a | Edge TTS API 호출 실패 또는 빈 오디오 반환 |
| 3a | 브라우저 내장 SpeechSynthesis API로 대체 (rate=0.9) |

---

## UC-09. 후속 대화로 서비스 좁혀가기

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 첫 검색 후 추가 정보를 제공하여 더 적합한 서비스를 찾는다 |
| **사전 조건** | UC-01의 첫 검색이 완료되고 AI가 후속 질문을 한 상태 |
| **사후 조건** | 좁혀진 1~2개 서비스가 더 높은 관련도로 추천된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | | AI: "혹시 연세가 어떻게 되실까요? 지금 혼자 계신가요?" |
| 2 | "72살이고 혼자 살아요"라고 입력/음성 | |
| 3 | | 새 RAG 검색 실행 (확장: 독거노인, 1인가구, 고독사예방) |
| 4 | | 이전 대화 8개 + 새 RAG 컨텍스트를 Gemini에 전송 |
| 5 | | AI가 이전 정보(질병) + 새 정보(독거, 72세)를 종합하여 1~2개 서비스로 좁혀 추천 |
| 6 | | 새 Stepper 카드 렌더링 (이전 카드 교체) |

---

## UC-10. 예시 칩으로 빠른 검색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 뭘 검색해야 할지 모를 때 예시를 보고 클릭하여 바로 검색한다 |
| **사전 조건** | 초기 화면 상태 (히어로 영역에 예시 칩 표시) |
| **사후 조건** | 해당 쿼리로 검색이 실행된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | "#퇴원 후 돌봄이 필요해요" 칩 탭 | |
| 2 | | 검색창에 "퇴원 후 돌봄이 필요해요" 자동 입력 |
| 3 | | 즉시 검색 실행 (UC-01 Step 3~) |

---

## UC-11. 서비스 연계 요청 (이메일 경로)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 복지담당자 |
| **목적** | 상담 신청 이메일 수신 후, 해당 이용자를 더 적합한 타 서비스로 연계한다 |
| **사전 조건** | 상담 신청 이메일을 수신하고, 이메일 내 "타 서비스 연계 요청" 버튼 존재 |
| **사후 조건** | 타 서비스 담당 기관에 연계 이메일이 발송되고, 연쇄 연계도 가능하다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 상담 신청 이메일에서 "타 서비스 연계 요청" 버튼 클릭 | |
| 2 | | /referral/:requestId 페이지 표시 (원래 상담 요청 정보 + 서비스 목록) |
| 3 | 연계 대상 서비스 선택 (카테고리별 드롭다운) | |
| 4 | 연계 사유 입력 | |
| 5 | "연계 요청 보내기" 버튼 클릭 | |
| 6 | | POST /api/referral/:requestId/send |
| 7 | | 새 요청 ID 생성, 원래 요청에 연계 기록 추가 |
| 8 | | 연계 이메일 발송 (파란색 헤더, 연계 사유, 원래 신청 정보) |
| 9 | | 연계 이메일에도 "타 서비스 연계 요청" 버튼 포함 (연쇄 연계) |
| 10 | | 성공 화면 표시 |

### 대안 흐름

**A1. 요청 ID 유효하지 않음**
| # | 시스템 |
|---|--------|
| 2a | 404 에러 표시: "요청을 찾을 수 없습니다" |

**A2. 이메일 발송 실패**
| # | 시스템 |
|---|--------|
| 8a | 에러 메시지 표시: "연계 이메일 발송에 실패했습니다" |

---

## UC-12. 관리자/담당자 로그인

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 관리자, 담당자, 부서 조정자 |
| **목적** | 관리 페이지(admin.html, case.html)에 접근하기 위해 인증한다 |
| **사전 조건** | ADMIN_PASSWORD 환경변수가 서버에 설정된 상태 |
| **사후 조건** | 세션 쿠키가 발급되어 보호된 API 접근 가능, 로그인 게이트가 닫히고 메인 콘텐츠 표시 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | /admin 또는 /case/:id 접속 | |
| 2 | | GET /api/auth/status 호출하여 기존 세션 확인 |
| 3 | | 세션 없음 → 로그인 게이트 표시 (비밀번호 입력 + 로그인 버튼) |
| 4 | 비밀번호 입력 | |
| 5 | 로그인 버튼 클릭 (또는 Enter) | |
| 6 | | POST /api/auth/login 호출 |
| 7 | | 비밀번호 일치 → 세션 발급 (authenticated=true, 8시간 유효) |
| 8 | | 로그인 게이트 숨김, 메인 콘텐츠(#main-content) 표시 |
| 9 | | 데이터 로드 시작 (admin: stats/requests/analytics, case: 사건 상세) |

### 대안 흐름

**A1. 비밀번호 불일치**
| # | 시스템 |
|---|--------|
| 7a | 403 응답: "비밀번호가 올바르지 않습니다." |
| 8a | 에러 메시지를 로그인 게이트에 표시 |

**A2. ADMIN_PASSWORD 미설정**
| # | 시스템 |
|---|--------|
| 7a | 500 응답: "ADMIN_PASSWORD 환경변수가 설정되지 않았습니다." |

**A3. 이미 인증된 세션 존재**
| # | 시스템 |
|---|--------|
| 2a | GET /api/auth/status → authenticated: true |
| 3a | 로그인 게이트 자동 스킵, 바로 메인 콘텐츠 표시 |

---

## UC-13. 대시보드 현황 모니터링

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 관리자 |
| **목적** | 전체 상담 현황을 실시간으로 파악하고, 미처리 건을 식별한다 |
| **사전 조건** | UC-12에 의해 admin.html 로그인 완료 |
| **사후 조건** | KPI, 칸반 보드, 추이 차트를 통해 전체 현황을 파악했다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 사이드바 "현황판" 탭 선택 (기본) | |
| 2 | | GET /api/admin/stats 호출 |
| 3 | | KPI 카드 4종 렌더링: 총 접수, 처리 중, 연계 활성, 완료율 |
| 4 | | 칸반 보드 5컬럼 렌더링 (접수/확인/연락/연결/완료) |
| 5 | | 각 컬럼에 해당 상태의 요청 카드 배치 (카운트 뱃지 포함) |
| 6 | | 14일 접수 추이 막대 차트 렌더링 (Chart.js) |
| 7 | 칸반 카드 클릭 | |
| 8 | | 카드 확장: 상세 정보(서비스명, 신청자, 연락처, 일시) + 메모 + 상태변경 + 연계체인 |
| 9 | 카드 내 상태 변경 또는 메모 추가 | |
| 10 | | 해당 API 호출 → 칸반 보드 갱신 |

### 대안 흐름

**A1. 미처리 건 존재 (3일 이상 open)**
| # | 시스템 |
|---|--------|
| 3a | 미처리 건수를 KPI 카드 또는 알림으로 표시 |

---

## UC-14. 상담 요청 관리 (관리자)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 관리자 |
| **목적** | 전체 상담 요청을 필터·검색하고, 개별 요청의 상태를 관리한다 |
| **사전 조건** | UC-12에 의해 admin.html 로그인 완료 |
| **사후 조건** | 요청의 상태가 변경되거나, 메모가 추가되거나, 서비스 계획이 수립된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 사이드바 "상담 요청" 탭 선택 | |
| 2 | | GET /api/admin/requests 호출 (기본: 최신순, 전체 상태, 1페이지) |
| 3 | | 요청 테이블 렌더링 (서비스명, 신청자, 연락처, 접수일, 상태배지) |
| 4 | 상태 필터 드롭다운 변경 (예: "접수") | |
| 5 | | 필터 적용하여 재조회 |
| 6 | 검색 입력 (이름/전화/서비스명) | |
| 7 | | 검색어 적용하여 재조회 |
| 8 | 특정 요청의 "보기" 버튼 클릭 | |
| 9 | | GET /api/admin/requests/:id → 상세 모달 표시 |
| 10 | | 모달 내용: 대상자 정보 + 상태 변경 + AI 요약 + 메모 + 연계 체인 + 서비스 계획 |
| 11 | 모달 내 상태 변경 또는 메모 추가 수행 | |
| 12 | | 해당 API 호출 → 테이블 갱신 |

### 대안 흐름

**A1. 검색 결과 0건**
| # | 시스템 |
|---|--------|
| 7a | "검색 결과가 없습니다" 메시지 표시 |

---

## UC-15. 상담 처리 (담당자)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 담당자 |
| **목적** | 접수된 상담 신청을 확인하고, 대상자에게 연락하여 상태를 업데이트한다 |
| **사전 조건** | 이메일 알림의 case 링크 클릭 + UC-12 로그인 완료 |
| **사후 조건** | 상담 상태가 진행되고, 처리 메모가 기록된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 이메일의 "사건 처리하기" 링크 클릭 | |
| 2 | | /case/:requestId 페이지 로드 → UC-12 로그인 |
| 3 | | GET /api/case/:requestId 호출 (상세 + linkages + chain) |
| 4 | | 대상자 정보 표시 (서비스명, 이름, 연락처, 접수일, 상태) |
| 5 | | AI 대화 요약 표시 (존재 시) |
| 6 | | 상태 스테퍼 렌더링 (5단계, 현재 위치 하이라이트) |
| 7 | 대상자 정보 확인 후 "대상자에게 전화" 버튼 탭 | |
| 8 | | tel: 링크 실행 → 전화 앱 호출 |
| 9 | 전화 통화 완료 후, 다음 단계 버튼 클릭 (예: "확인 완료") | |
| 10 | | PATCH /api/case/:id/status 호출 (전진형: 이전 단계 불가) |
| 11 | | 스테퍼 갱신, 다음 단계 버튼 표시 |
| 12 | 처리 메모 입력 (예: "전화 통화 완료, 서비스 신청 안내함") | |
| 13 | | POST /api/case/:id/notes 호출 |
| 14 | | 메모 목록에 새 메모 추가 (author: '담당자', timestamp) |

### 대안 흐름

**A1. 요청 ID 유효하지 않음**
| # | 시스템 |
|---|--------|
| 3a | 404 에러 상태 표시: "요청을 찾을 수 없습니다" |

**A2. 이전 단계로 되돌리기 시도**
| # | 시스템 |
|---|--------|
| 10a | 400 에러: "이전 단계로 되돌릴 수 없습니다." |

---

## UC-16. 연계/협업 요청 생성

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 담당자 |
| **목적** | 현재 사건을 타 부서와 협업하거나, 다른 서비스로 연계한다 |
| **사전 조건** | UC-15에 의해 case.html에서 사건을 처리 중인 상태 |
| **사후 조건** | 연계 요청이 생성되어 부서 조정자 승인 대기 상태가 된다 (pending) |

### 기본 흐름 (부서 협업)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | "연계 요청하기" 버튼 클릭 | |
| 2 | | 연계 요청 폼 표시 (토글) |
| 3 | "부서 협업" 탭 선택 (기본) | |
| 4 | 우리팀(from) 드롭다운에서 소속 부서 선택 | |
| 5 | 대상팀(to) 드롭다운에서 협업 요청할 부서 선택 | |
| 6 | 유형 선택: 자문(consultation) / 공동처리(joint) / 이관(transfer) | |
| 7 | 사유 입력 | |
| 8 | "요청 보내기" 버튼 클릭 | |
| 9 | | POST /api/case/:id/linkage (category=collaboration) |
| 10 | | linkage 생성 (approvalStatus=pending, executionStatus=pending) |
| 11 | | 연계 목록에 새 항목 표시 (부서 검토 대기 배지) |
| 12 | | "관리자 승인 후 실행됩니다" 안내 |

### 기본 흐름 (서비스 연계)
| # | 액터 | 시스템 |
|---|------|--------|
| 3a | "서비스 연계" 탭 선택 | |
| 4a | 대상 서비스 드롭다운에서 연계할 서비스 선택 | |
| 5a | 사유 입력 | |
| 6a | "요청 보내기" 버튼 클릭 | |
| 7a | | POST /api/case/:id/linkage (category=referral) |
| 8a | | 이하 동일 |

### 대안 흐름

**A1. 같은 부서에 협업 요청**
| # | 시스템 |
|---|--------|
| 9a | 400 에러: "같은 부서에는 협업 요청할 수 없습니다." |

**A2. 사유 미입력**
| # | 시스템 |
|---|--------|
| 9a | 400 에러: "사유를 입력하세요." |

---

## UC-17. 2단계 승인 처리

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 부서 조정자 (1단계), 관리자 (2단계) |
| **목적** | 연계/협업 요청을 검토하고, 근거 기반으로 승인/반려/수정요청한다 |
| **사전 조건** | UC-16에 의해 연계 요청이 생성된 상태 (pending) |
| **사후 조건** | 1단계 완료 시 dept_approved → 관리자 검토 대기. 2단계 승인 시 이메일 자동 발송. 반려/수정요청 시 담당자에게 재제출 요청 |

### 기본 흐름 (1단계: 부서 조정자 승인)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | admin.html → 연계 조정 탭 선택 | |
| 2 | | GET /api/dept/pending-approvals 호출 |
| 3 | | 승인 대기 목록 표시 (사건 정보, 연계 유형, 사유) |
| 4 | 연계 항목의 사유와 근거 검토 | |
| 5 | 코멘트 입력 (선택) | |
| 6 | "승인" 버튼 클릭 | |
| 7 | | POST /api/dept/linkage/:lid/approve |
| 8 | | approvalStatus: pending → dept_approved |
| 9 | | approvalHistory에 기록 추가 (action=dept_approved, comment, at) |
| 10 | | 목록 갱신 → 관리자 최종 승인 대기로 이동 |

### 기본 흐름 (2단계: 관리자 최종 승인)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | admin.html → 연계 조정 탭 → 관리자 승인 대기 섹션 | |
| 2 | | GET /api/admin/pending-approvals 호출 |
| 3 | | dept_approved 상태 목록 표시 (승인 타임라인 포함) |
| 4 | 사유 + 부서 조정자 코멘트 검토 | |
| 5 | 코멘트 입력 (선택) | |
| 6 | "최종 승인" 버튼 클릭 | |
| 7 | | POST /api/admin/linkage/:lid/approve |
| 8 | | approvalStatus: dept_approved → approved |
| 9 | | 연계 대상 기관에 이메일 자동 발송 (Nodemailer) |
| 10 | | executionStatus: pending → email_sent |
| 11 | | approvalHistory에 기록 추가 |

### 대안 흐름

**A1. 부서 조정자 반려**
| # | 액터 | 시스템 |
|---|------|--------|
| 6a | "반려" 버튼 + 반려 사유 입력 | |
| 7a | | POST /api/dept/linkage/:lid/reject |
| 8a | | approvalStatus → rejected |
| 9a | | 담당자 case.html에서 배지로 반려 상태 표시 |

**A2. 부서 조정자 수정 요청**
| # | 액터 | 시스템 |
|---|------|--------|
| 6a | "수정 요청" 버튼 + 수정 사유 입력 | |
| 7a | | POST /api/dept/linkage/:lid/revision |
| 8a | | approvalStatus → revision_requested |
| 9a | | 담당자가 사유 수정 후 재제출 (PATCH로 approvalStatus → pending 리셋) |

**A3. 관리자 반려**
| # | 액터 | 시스템 |
|---|------|--------|
| 6a | "반려" 버튼 + 반려 사유 입력 | |
| 7a | | POST /api/admin/linkage/:lid/reject |
| 8a | | approvalStatus → admin_rejected |
| 9a | | 담당자 재제출 시 → approvalStatus → dept_approved (관리자 반환이므로 부서 조정자 재검토 불필요) |

**A4. 관리자 수정 요청**
| # | 액터 | 시스템 |
|---|------|--------|
| 6a | "수정 요청" 버튼 + 수정 사유 입력 | |
| 7a | | POST /api/admin/linkage/:lid/revision |
| 8a | | approvalStatus → admin_revision_requested |
| 9a | | 담당자 재제출 시 → approvalStatus → dept_approved |

---

## UC-18. 담당자 AI 상담

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 담당자, 부서 조정자, 관리자 |
| **목적** | 사건 처리와 관련하여 AI와 논리적으로 의견을 교환하면서 합리적인 결론을 도출한다 |
| **사전 조건** | UC-15에 의해 case.html에서 사건을 확인 중인 상태 |
| **사후 조건** | AI가 법적·제도적·실무적 근거와 함께 배정 근거, 처리 방안, 연계 필요성 등을 제시한다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | AI 상담 섹션에서 역할 선택 (담당자/부서 조정자/관리자 조정자/타부서 담당자/타부서 조정자) | |
| 2 | 빠른 질문 버튼 클릭 (예: "배정 근거") | |
| 3 | | POST /api/staff/chat 호출 (messages + requestId + role) |
| 4 | | 서버: 사건 컨텍스트 구성 (신청자 정보, 담당 부서, KB 상세, 처리 메모, 연계 이력) |
| 5 | | Gemini AI에 전송 (staffSystemPrompt + caseContext + kbSummary + 대화) |
| 6 | | AI 응답: 근거 기반 분석 (법적 근거, 자격요건 매칭, 서비스 특성) |
| 7 | | 대화 영역에 AI 응답 표시 |
| 8 | 후속 질문 또는 의견 제시 (자유 입력) | |
| 9 | | 이전 대화 + 새 질문을 Gemini에 전송 |
| 10 | | AI: 비판적 검토 + 타당성 평가 + 보완점 지적 + 합리적 결론 도출 |

### 대안 흐름

**A1. 빠른 질문 버튼 4종**
| 버튼 | 프리셋 질문 |
|------|------------|
| 배정 근거 | "이 서비스를 우리 부서에서 처리해야 하는 근거가 무엇인가요?" |
| 처리 방안 | "이 사건의 처리 방안을 제안해 주세요." |
| 연계 필요성 | "다른 부서와 협업이나 연계가 필요한가요?" |
| 보고 요약 | "상급자에게 보고할 때 이 사건의 핵심 포인트를 정리해 주세요." |

**A2. API 오류**
| # | 시스템 |
|---|--------|
| 6a | 에러 메시지를 대화 영역에 표시: "AI 응답을 받지 못했습니다. 다시 시도해 주세요." |

---

## UC-19. 분석 및 KPI 확인

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 관리자 |
| **목적** | 서비스 이용 현황과 운영 지표를 분석하여 데이터 기반 의사결정에 활용한다 |
| **사전 조건** | UC-12에 의해 admin.html 로그인 완료 |
| **사후 조건** | 서비스 인기도, 카테고리 분포, KPI 추이, 이벤트 추이를 확인했다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 사이드바 "분석" 탭 선택 | |
| 2 | | GET /api/admin/analytics (서비스 인기도 + 카테고리 분포) |
| 3 | | GET /api/admin/kpi (검색 수, 신청 수, TTS 사용 수) |
| 4 | | GET /api/admin/trends (일별 이벤트 추이) |
| 5 | | KPI 요약 카드 렌더링 |
| 6 | | 서비스 인기도 가로 막대 차트 (Chart.js) |
| 7 | | 카테고리 분포 도넛 차트 (Chart.js) |
| 8 | | 일별 이벤트 추이 라인 차트 (7/14/30일 전환 가능) |
| 9 | 기간 변경 (7일/14일/30일) | |
| 10 | | 해당 기간으로 데이터 재조회 + 차트 갱신 |

---

## UC-20. 서비스 계획 수립

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 관리자 |
| **목적** | 특정 상담 요청에 대해 서비스 제공 계획을 단계별로 수립한다 |
| **사전 조건** | UC-14에 의해 상담 요청 상세 모달이 열린 상태 |
| **사후 조건** | 서비스 계획이 저장되어, 담당자가 case.html에서 조회 가능하다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 상세 모달 내 "서비스 계획" 섹션으로 이동 | |
| 2 | "단계 추가" 버튼 클릭 | |
| 3 | 단계 내용 입력 (예: "대상자 자격 확인", "서비스 신청서 작성", "전담 인력 배정") | |
| 4 | 필요 시 추가 단계 반복 | |
| 5 | "계획 저장" 버튼 클릭 | |
| 6 | | POST /api/case/:id/service-plan (steps 배열) |
| 7 | | requestStore에 servicePlan 저장 |
| 8 | | 저장 완료 표시 |

### 대안 흐름

**A1. 단계 삭제**
| # | 액터 | 시스템 |
|---|------|--------|
| 3a | 특정 단계의 삭제 버튼 클릭 | |
| 4a | | 해당 단계 UI에서 제거 |

---

## 액터-Use Case 매핑

```
                    ┌─────────┐
                    │  도민   │
                    │ (일반)  │
                    └────┬────┘
                         │
         ┌───────┬───────┼───────┬───────┬────────┐
         ▼       ▼       ▼       ▼       ▼        ▼
      UC-01   UC-03   UC-04   UC-06   UC-07    UC-10
      자연어   경로    상담    북마크   브라우징  예시칩
      검색    탐색    신청    관리              검색
         ▲       ▲    (카드)
         │       │    UC-04a
    ┌────┴────┐  │    (대화)
    │  도민   │  │       ▲
    │ (고령자) ├──┘       │
    └────┬────┘          │
         │               │
    ┌────┴────┬──────────┘
    ▼         ▼
  UC-02    UC-05    UC-08    UC-09
  음성     전화     TTS     후속
  검색     연결     듣기    대화

                    ┌──────────┐
                    │ 복지담당자 │
                    └─────┬────┘
                          │
                     ┌────┴────┐
                     ▼         ▼
                  UC-07     UC-11
                 브라우징   서비스 연계
                          (이메일)

                    ┌──────────┐
                    │  담당자   │
                    └─────┬────┘
                          │
              ┌───────────┼───────────┐
              ▼           ▼           ▼
           UC-12       UC-15       UC-16
           로그인      상담 처리    연계/협업
                          │        요청 생성
                          ▼
                       UC-18
                       AI 상담

                    ┌──────────┐
                    │부서 조정자│
                    └─────┬────┘
                          │
                     ┌────┴────┐
                     ▼         ▼
                  UC-12     UC-17
                  로그인    2단계 승인
                          (1단계)

                    ┌──────────┐
                    │  관리자   │
                    └─────┬────┘
                          │
              ┌───────┬───┼───────┬────────┐
              ▼       ▼   ▼       ▼        ▼
           UC-12   UC-13 UC-14  UC-17    UC-19
           로그인  현황판 상담관리 2단계승인 분석
                                (2단계)
                                  │
                                  ▼
                               UC-20
                            서비스계획
```

---

## 비기능 Use Case

### NF-01. 세션 자동 만료 (도민)
| 항목 | 내용 |
|------|------|
| **트리거** | 사용자가 5분간 비활동 |
| **동작** | SessionStorage 대화 이력 자동 삭제, chatHistory 초기화 |
| **목적** | 공용 기기에서의 개인정보 보호 |

### NF-02. 오프라인/에러 폴백
| 항목 | 내용 |
|------|------|
| **트리거** | Gemini API 장애, 네트워크 끊김, 타임아웃(30초) |
| **동작** | 에러 메시지 + 대표전화(055-230-8200) 안내 + 재시도 버튼 |
| **목적** | 어떤 상황에서도 사용자가 연락 경로를 얻을 수 있도록 함 |

### NF-03. 개인정보 동의 처리
| 항목 | 내용 |
|------|------|
| **트리거** | 첫 북마크 시도 |
| **동작** | 동의 모달 → 동의 시 LocalStorage 활성화, 거부 시 기능 미사용 |
| **목적** | 개인정보보호법 준수 (최소 수집, 명시적 동의) |

### NF-04. 관리자 세션 관리
| 항목 | 내용 |
|------|------|
| **트리거** | 관리자/담당자 세션 생성 시 |
| **동작** | httpOnly + sameSite(lax) + secure(production) 쿠키로 8시간 유지 |
| **목적** | 세션 탈취 방지, CSRF 방어, 적절한 세션 수명 |

### NF-05. 데이터 안정성
| 항목 | 내용 |
|------|------|
| **트리거** | requestStore/analyticsStore 파일 쓰기 시 |
| **동작** | 원자적 쓰기 (tmp→rename), 자동 백업 (.bak), 손상 시 자동 복구 |
| **목적** | 프로세스 중단/에러 시 데이터 손실·손상 방지 |

### NF-06. 글로벌 에러 처리
| 항목 | 내용 |
|------|------|
| **트리거** | 라우트 핸들러에서 잡히지 않은 에러, unhandledRejection, uncaughtException |
| **동작** | 에러 로그 기록, 클라이언트에 500 응답, 프로세스 유지 (PM2 재시작 대비) |
| **목적** | 서버 갑작스러운 종료 방지, 에러 추적 가능 |
