# Use Case 명세서
# 노마(Noma) AI 맞춤형 복지 내비게이터

---

## Use Case 목록

| ID | Use Case | 주 액터 | 우선순위 |
|----|---------|--------|---------|
| UC-01 | 자연어로 복지 서비스 검색 | 도민 | Must |
| UC-02 | 음성으로 복지 서비스 검색 | 도민(고령자) | Must |
| UC-03 | 서비스 카드 경로 단계 탐색 | 도민 | Must |
| UC-04 | 서비스 상담 신청 (카드 버튼 경로) | 도민 | Must |
| UC-04a | 대화형 상담 신청 (음성/텍스트 경로) | 도민 | Must |
| UC-05 | 전화번호 탭하여 바로 연결 | 도민(고령자) | Must |
| UC-06 | 서비스 북마크(내 서랍) 관리 | 도민 | Should |
| UC-07 | 전체 서비스 카테고리 브라우징 | 도민/복지담당자 | Should |
| UC-08 | 음성 응답(TTS)으로 결과 듣기 | 도민(고령자) | Must |
| UC-09 | 후속 대화로 서비스 좁혀가기 | 도민 | Should |
| UC-10 | 예시 칩으로 빠른 검색 | 도민 | Nice |
| UC-11 | 서비스 연계 요청 | 복지담당자 | Should |

---

## UC-01. 자연어로 복지 서비스 검색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (일반 사용자) |
| **목적** | 일상 언어로 자신의 상황을 설명하고, 해당하는 복지 서비스를 찾는다 |
| **사전 조건** | 사용자가 웹 페이지에 접속한 상태 |
| **사후 조건** | 관련 서비스 카드가 화면에 표시되고, AI 요약이 제공된다 |

### 기본 흐름 (Main Flow)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 검색창에 일상어로 입력 (예: "몸이 아파요") | |
| 2 | 전송 버튼 클릭 또는 Enter | |
| 3 | | 히어로 영역 축소, 로딩 스켈레톤 표시 |
| 4 | | 입력 텍스트에서 한국어 어미 제거 ("아파요" → "아파") |
| 5 | | synonymMap으로 유의어 확장 ("아파" → 질병, 부상, 돌봄, 의료, 긴급돌봄) |
| 6 | | 지식베이스 17건과 매칭, 관련도 스코어링 |
| 7 | | 상위 5건 + 노이즈 필터링 (30% 미만 제외) |
| 8 | | RAG 컨텍스트 + 사용자 메시지를 Gemini AI에 전송 |
| 9 | | SSE 스트리밍으로 AI 응답 수신 |
| 10 | | AI 요약 텍스트 표시 + Stepper 서비스 카드 렌더링 |
| 11 | 결과를 확인하고 서비스 카드의 각 단계를 탭하여 상세 확인 | |

### 대안 흐름 (Alternative Flow)

**A1. RAG 매칭 결과 0건**
| # | 시스템 |
|---|--------|
| 7a | 매칭 결과가 없으면 빈 RAG 컨텍스트로 AI에 전송 |
| 8a | AI가 "관련 서비스를 찾지 못했다"고 안내 + 대표전화 055-230-8200 안내 |
| 9a | "전체 서비스 둘러보기" 버튼 표시 |

**A2. 인사/일상 대화 입력**
| # | 시스템 |
|---|--------|
| 4a | "안녕하세요", "고마워요" 등 인사 감지 |
| 5a | AI가 자연스럽게 인사 응답 (서비스 검색 안 함) |
| 6a | 서비스 카드 미표시, AI 요약만 표시 |

**A3. API 오류/타임아웃**
| # | 시스템 |
|---|--------|
| 8a | Gemini API 429 또는 네트워크 오류 발생 |
| 9a | 에러 메시지 표시: "AI 서버에서 응답을 받지 못했습니다" |
| 10a | "다시 시도" 버튼 + 대표전화 안내 표시 |

---

## UC-02. 음성으로 복지 서비스 검색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (고령자, 시각장애인) |
| **목적** | 음성으로 말해서 복지 서비스를 검색하고, 음성으로 결과를 듣는다 |
| **사전 조건** | 마이크 권한 허용, 브라우저 Web Speech API 지원 |
| **사후 조건** | 검색 결과가 카드로 표시되고, TTS로 음성 안내가 재생된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 플로팅 마이크 버튼 또는 검색창 마이크 버튼 탭 | |
| 2 | | 마이크 활성화, 버튼 빨간색 펄스 애니메이션 |
| 3 | "퇴원 후 돌봐줄 사람이 없어요"라고 말한다 | |
| 4 | | Web Speech API가 음성 → 텍스트 변환 (ko-KR) |
| 5 | | 변환된 텍스트를 검색창에 자동 입력 |
| 6 | | `lastInputWasVoice = true` 설정 |
| 7 | | 300ms 후 자동 검색 실행 (UC-01 Step 3~10) |
| 8 | | 검색 결과 렌더링 완료 후 TTS 자동 실행 |
| 9 | | Edge TTS로 AI 요약 읽어주기 |
| 10 | | "첫 번째 추천 서비스는 긴급돌봄지원사업입니다. 문의는 055-230-8216으로 전화하시면 됩니다." |
| 11 | 음성 안내를 듣고, 필요 시 전화번호 탭 | |

### 대안 흐름

**A1. 음성 인식 실패**
| # | 시스템 |
|---|--------|
| 4a | STT가 빈 결과 반환 또는 에러 발생 |
| 5a | 마이크 버튼 원래 상태로 복귀, 입력 없음 |
| 6a | 사용자가 다시 마이크 탭하여 재시도 |

**A2. TTS 재생 중 사용자가 중단**
| # | 액터 | 시스템 |
|---|------|--------|
| 9a | 플로팅 마이크 버튼 탭 | |
| 10a | | TTS 재생 중단, 음성 입력 모드로 전환 |

---

## UC-03. 서비스 카드 경로 단계 탐색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 추천된 서비스의 대상·신청방법·혜택·연락처를 단계별로 확인한다 |
| **사전 조건** | UC-01 또는 UC-02에 의해 서비스 카드가 표시된 상태 |
| **사후 조건** | 사용자가 필요한 정보를 단계별로 확인했다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | | 카드 표시 시 ① 대상 확인 단계가 자동으로 펼쳐져 있음 |
| 2 | "② 신청 방법" 헤더 탭 | |
| 3 | | ② 단계 내용 펼침 (슬라이드 애니메이션), 쉐브론 회전 |
| 4 | 신청 방법 내용 확인 | |
| 5 | "③ 받는 혜택" 헤더 탭 | |
| 6 | | ③ 단계 내용 펼침 |
| 7 | "④ 연락처" 헤더 탭 | |
| 8 | | ④ 단계 펼침, 전화번호가 초록색 tel: 링크 버튼으로 표시 |
| 9 | 전화번호 버튼 탭 → UC-05로 이동 | |

### 대안 흐름

**A1. 이미 펼쳐진 단계 다시 탭**
| # | 시스템 |
|---|--------|
| 3a | 해당 단계 접힘 (토글), 쉐브론 원래 방향으로 복귀 |

---

## UC-04. 서비스 상담 신청 (카드 버튼 경로)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 관심 있는 서비스에 대해 상담을 신청하여, 담당 기관에서 연락받는다 |
| **사전 조건** | 서비스 카드가 표시된 상태 |
| **사후 조건** | 담당 기관에 이메일이 발송되고 (AI 대화 요약 포함), 확인 화면이 표시된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 카드 하단 "이 서비스 상담 신청" 버튼 클릭 | |
| 2 | | 상담 신청 모달 표시 (서비스명 헤더) |
| 3 | | Step 1: 성함 입력 화면 표시, 입력 필드 포커스 |
| 4 | 이름 입력 (예: "김순자") | |
| 5 | "다음" 버튼 클릭 | |
| 6 | | 이름 저장, Step 2: 연락처 입력 화면으로 전환 |
| 7 | 전화번호 입력 (예: "010-1234-5678") | |
| 8 | "신청 완료" 버튼 클릭 | |
| 9 | | 버튼 비활성화 + "처리 중..." 텍스트 |
| 10 | | POST /api/service-request/connect 호출 (chatHistory 포함) |
| 11 | | Gemini로 대화 요약 생성 → 이메일에 포함 |
| 12 | | Nodemailer로 담당 기관 이메일 발송 (신청 정보 + 대화 요약 + 연계 버튼) |
| 13 | | Step 3: 완료 화면 (체크 아이콘 + 신청 정보 요약) |
| 14 | | "김순자님, 긴급돌봄지원사업 상담 신청이 완료되었습니다" |
| 15 | | 4초 후 자동으로 초기 화면으로 복귀 |

### 대안 흐름

**A1. 빈 이름으로 "다음" 클릭**
| # | 시스템 |
|---|--------|
| 5a | 아무 동작 안 함 (빈 값 검증 실패) |

**A2. API 호출 실패**
| # | 시스템 |
|---|--------|
| 10a | Step 4: 오류 화면 표시 |
| 11a | "잠시 후 다시 시도하거나, 055-230-8200으로 전화 문의" 안내 |

**A3. 모달 닫기**
| # | 액터 | 시스템 |
|---|------|--------|
| * | "취소" 버튼 또는 오버레이 클릭 | 모달 닫힘, 폼 상태 초기화 |

---

## UC-04a. 대화형 상담 신청 (음성/텍스트 대화 경로)

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 카드 버튼을 누르지 않고, AI 대화만으로 상담 신청을 완료한다 |
| **사전 조건** | AI와 대화 중이며, 서비스가 추천된 상태 |
| **사후 조건** | 담당 기관에 이메일이 발송되고, 인라인 확인 카드가 표시된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | "이 서비스 신청하고 싶어요" 입력/음성 | |
| 2 | | AI가 신청 대상 서비스 확인 (직전 추천 서비스 자동 선택) |
| 3 | | AI: "노인맞춤돌봄서비스 상담을 신청해 드릴까요? 성함을 알려주시겠어요?" |
| 4 | "김순자예요" 입력/음성 | |
| 5 | | AI: "김순자님, 연락받으실 전화번호도 알려주시겠어요?" |
| 6 | "010-1234-5678이요" 입력/음성 | |
| 7 | | AI: 확인 문구 + `<noma-apply>` 태그 출력 (3필드 완성) |
| 8 | | 클라이언트: `parseNomaApply()` → JSON 파싱 + 유효성 검증 |
| 9 | | POST /api/service-request/connect (chatHistory 포함) |
| 10 | | 이메일 발송 (신청 정보 + AI 대화 요약 + 연계 버튼) |
| 11 | | 인라인 초록색 확인 카드 표시: "김순자님, 노인맞춤돌봄서비스 담당 기관에 상담 요청을 보냈습니다" |

### 대안 흐름

**A1. 이전 대화에서 이름/전화번호를 이미 수집한 경우**
| # | 시스템 |
|---|--------|
| 3a | AI가 이미 파악된 정보는 다시 묻지 않고, 미수집 정보만 질문 |
| 7a | 모든 정보 확보 시 바로 확인 문구 + `<noma-apply>` 출력 |

**A2. `<noma-apply>` 필드 불완전**
| # | 시스템 |
|---|--------|
| 8a | `parseNomaApply()` → null 반환, 자동 신청 안 함 |
| 9a | 사용자에게 영향 없음 (대화만 표시) |

**A3. API 호출 실패**
| # | 시스템 |
|---|--------|
| 9a | 인라인 빨간색 에러 카드 표시 |
| 10a | "자동 신청에 실패했습니다. 서비스 카드의 '상담 신청' 버튼을 눌러 직접 신청해 주세요." |

**A4. 전화번호 형식 오류**
| # | 시스템 |
|---|--------|
| 6a | AI가 한국 전화번호 형식이 아님을 감지 |
| 7a | AI: "죄송해요, 전화번호 형식이 맞지 않는 것 같아요. 다시 한번 알려주시겠어요?" |

---

## UC-05. 전화번호 탭하여 바로 연결

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (특히 고령자) |
| **목적** | 담당 기관에 바로 전화를 건다 |
| **사전 조건** | 카드의 ④ 연락처 단계가 펼쳐진 상태, 또는 헤더의 전화 문의 버튼 |
| **사후 조건** | 기기의 전화 앱이 실행되어 해당 번호로 발신 준비 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 카드 ④ 연락처 단계의 초록색 전화번호 버튼 탭 | |
| 2 | | `tel:0552308216` 링크 실행 → OS 전화 앱 호출 |
| 3 | 전화 앱에서 발신 확인 | |

---

## UC-06. 서비스 북마크(내 서랍) 관리

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 관심 있는 서비스를 저장해두고, 나중에 다시 확인한다 |
| **사전 조건** | 서비스 카드 또는 브라우징 리스트가 표시된 상태 |
| **사후 조건** | 서비스가 내 서랍에 저장/삭제되고, LocalStorage에 영속 저장된다 |

### 기본 흐름 (최초 저장)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 카드 우상단 북마크 아이콘 탭 | |
| 2 | | (첫 사용 시) 동의 모달 표시: "서비스를 저장할까요?" |
| 3 | "네, 저장할게요" 탭 | |
| 4 | | 동의 기록 (LocalStorage), 서비스 저장 |
| 5 | | 토스트 알림: "내 서랍에 담았어요!" |
| 6 | | 북마크 아이콘 → 채워진 아이콘으로 변경, 헤더 뱃지 카운트 +1 |

### 기본 흐름 (서랍 확인 및 삭제)
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 헤더의 "내 서랍" 메뉴 클릭 | |
| 2 | | 우측 서랍 패널 슬라이드 인 |
| 3 | | 저장된 서비스 목록 표시 (서비스명, 요약, 담당 기관) |
| 4 | 특정 서비스의 삭제 버튼 탭 | |
| 5 | | 해당 서비스 삭제, 리스트 갱신, 뱃지 카운트 -1 |
| 6 | X 버튼 또는 오버레이 클릭 | 서랍 패널 닫힘 |

---

## UC-07. 전체 서비스 카테고리 브라우징

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민, 복지담당자 |
| **목적** | AI 검색 없이, 전체 서비스를 카테고리별로 탐색한다 |
| **사전 조건** | 페이지 로드 시 API로 서비스 목록 자동 불러오기 완료 |
| **사후 조건** | 원하는 서비스의 상세 정보를 확인했다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 페이지 스크롤 또는 "전체 서비스" 메뉴 클릭 | |
| 2 | | 전체 서비스 섹션으로 이동 |
| 3 | | 카테고리 탭 표시: 공공돌봄(n건) / 민간지원(n건) / 국공립시설(n건) |
| 4 | "공공돌봄" 탭 클릭 (기본 선택) | |
| 5 | | 해당 카테고리의 서비스 리스트 렌더링 (2열 그리드) |
| 6 | 특정 서비스 항목 클릭 | |
| 7 | | 상세 정보 펼침: 지원 대상, 지원 내용, 신청 방법, 문의처 |
| 8 | "상담 신청" 버튼 클릭 → UC-04로 이동 | |

---

## UC-08. 음성 응답(TTS)으로 결과 듣기

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 (고령자, 시각장애인) |
| **목적** | 검색 결과를 음성으로 들어서, 화면을 보지 않고도 핵심 정보를 얻는다 |
| **사전 조건** | UC-02(음성 검색)로 검색이 완료된 상태 |
| **사후 조건** | AI 요약 + 추천 서비스명 + 연락처가 음성으로 안내된다 |

### 기본 흐름
| # | 시스템 |
|---|--------|
| 1 | 음성 검색 완료 후 자동으로 TTS 실행 |
| 2 | AI 요약 텍스트를 Edge TTS로 변환 (ko-KR-SunHiNeural) |
| 3 | "몸이 아프셔서 많이 힘드셨겠어요..." 읽어주기 |
| 4 | 추천 서비스 안내: "첫 번째 추천 서비스는 긴급돌봄지원사업입니다." |
| 5 | 연락처 안내: "문의는 055-230-8216으로 전화하시면 됩니다." |
| 6 | 플로팅 마이크 상태 아이콘 → 재생 중 표시 |
| 7 | 재생 완료 후 대기 상태로 복귀 |

### 대안 흐름

**A1. Edge TTS 실패 → Web Speech API 폴백**
| # | 시스템 |
|---|--------|
| 2a | Edge TTS API 호출 실패 또는 빈 오디오 반환 |
| 3a | 브라우저 내장 SpeechSynthesis API로 대체 (rate=0.9) |

---

## UC-09. 후속 대화로 서비스 좁혀가기

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 첫 검색 후 추가 정보를 제공하여 더 적합한 서비스를 찾는다 |
| **사전 조건** | UC-01의 첫 검색이 완료되고 AI가 후속 질문을 한 상태 |
| **사후 조건** | 좁혀진 1~2개 서비스가 더 높은 관련도로 추천된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | | AI: "혹시 연세가 어떻게 되실까요? 지금 혼자 계신가요?" |
| 2 | "72살이고 혼자 살아요"라고 입력/음성 | |
| 3 | | 새 RAG 검색 실행 (확장: 독거노인, 1인가구, 고독사예방) |
| 4 | | 이전 대화 8개 + 새 RAG 컨텍스트를 Gemini에 전송 |
| 5 | | AI가 이전 정보(질병) + 새 정보(독거, 72세)를 종합하여 1~2개 서비스로 좁혀 추천 |
| 6 | | 새 Stepper 카드 렌더링 (이전 카드 교체) |

---

## UC-10. 예시 칩으로 빠른 검색

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 도민 |
| **목적** | 뭘 검색해야 할지 모를 때 예시를 보고 클릭하여 바로 검색한다 |
| **사전 조건** | 초기 화면 상태 (히어로 영역에 예시 칩 표시) |
| **사후 조건** | 해당 쿼리로 검색이 실행된다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | "#퇴원 후 돌봄이 필요해요" 칩 탭 | |
| 2 | | 검색창에 "퇴원 후 돌봄이 필요해요" 자동 입력 |
| 3 | | 즉시 검색 실행 (UC-01 Step 3~) |

---

## UC-11. 서비스 연계 요청

### 기본 정보
| 항목 | 내용 |
|------|------|
| **액터** | 복지담당자 |
| **목적** | 상담 신청 이메일 수신 후, 해당 이용자를 더 적합한 타 서비스로 연계한다 |
| **사전 조건** | 상담 신청 이메일을 수신하고, 이메일 내 "타 서비스 연계 요청" 버튼 존재 |
| **사후 조건** | 타 서비스 담당 기관에 연계 이메일이 발송되고, 연쇄 연계도 가능하다 |

### 기본 흐름
| # | 액터 | 시스템 |
|---|------|--------|
| 1 | 상담 신청 이메일에서 "타 서비스 연계 요청" 버튼 클릭 | |
| 2 | | /referral/:requestId 페이지 표시 (원래 상담 요청 정보 + 서비스 목록) |
| 3 | 연계 대상 서비스 선택 (카테고리별 드롭다운) | |
| 4 | 연계 사유 입력 | |
| 5 | "연계 요청 보내기" 버튼 클릭 | |
| 6 | | POST /api/referral/:requestId/send |
| 7 | | 새 요청 ID 생성, 원래 요청에 연계 기록 추가 |
| 8 | | 연계 이메일 발송 (파란색 헤더, 연계 사유, 원래 신청 정보) |
| 9 | | 연계 이메일에도 "타 서비스 연계 요청" 버튼 포함 (연쇄 연계) |
| 10 | | 성공 화면 표시 |

### 대안 흐름

**A1. 요청 ID 유효하지 않음**
| # | 시스템 |
|---|--------|
| 2a | 404 에러 표시: "요청을 찾을 수 없습니다" |

**A2. 이메일 발송 실패**
| # | 시스템 |
|---|--------|
| 8a | 에러 메시지 표시: "연계 이메일 발송에 실패했습니다" |

---

## 액터-Use Case 매핑

```
                    ┌─────────┐
                    │  도민   │
                    │ (일반)  │
                    └────┬────┘
                         │
         ┌───────┬───────┼───────┬───────┬────────┐
         ▼       ▼       ▼       ▼       ▼        ▼
      UC-01   UC-03   UC-04   UC-06   UC-07    UC-10
      자연어   경로    상담    북마크   브라우징  예시칩
      검색    탐색    신청    관리              검색
         ▲       ▲    (카드)
         │       │    UC-04a
    ┌────┴────┐  │    (대화)
    │  도민   │  │       ▲
    │ (고령자) ├──┘       │
    └────┬────┘          │
         │               │
    ┌────┴────┬──────────┘
    ▼         ▼
  UC-02    UC-05    UC-08    UC-09
  음성     전화     TTS     후속
  검색     연결     듣기    대화

                    ┌──────────┐
                    │ 복지담당자 │
                    └─────┬────┘
                          │
                     ┌────┴────┐
                     ▼         ▼
                  UC-07     UC-11
                 브라우징   서비스 연계
```

---

## 비기능 Use Case

### NF-01. 세션 자동 만료
| 항목 | 내용 |
|------|------|
| **트리거** | 사용자가 5분간 비활동 |
| **동작** | SessionStorage 대화 이력 자동 삭제, chatHistory 초기화 |
| **목적** | 공용 기기에서의 개인정보 보호 |

### NF-02. 오프라인/에러 폴백
| 항목 | 내용 |
|------|------|
| **트리거** | Gemini API 장애, 네트워크 끊김, 타임아웃(30초) |
| **동작** | 에러 메시지 + 대표전화(055-230-8200) 안내 + 재시도 버튼 |
| **목적** | 어떤 상황에서도 사용자가 연락 경로를 얻을 수 있도록 함 |

### NF-03. 개인정보 동의 처리
| 항목 | 내용 |
|------|------|
| **트리거** | 첫 북마크 시도 |
| **동작** | 동의 모달 → 동의 시 LocalStorage 활성화, 거부 시 기능 미사용 |
| **목적** | 개인정보보호법 준수 (최소 수집, 명시적 동의) |
