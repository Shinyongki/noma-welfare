# 노마(Noma) AI 복지 내비게이터 — 연계 흐름 설계 문서

> 기존 2단계 승인 구조를 재검토하여, 조직 논리에 맞는 3단계 승인 + 관리자 재배정 구조로 재설계한 문서
> 자문(consultation)은 연계 파이프라인에서 분리하여 별도 경량 채널로 운영

---

## 1. 기존 구조의 문제 진단

### 기존 흐름 (현 시스템 문서 기준)

```
담당자 → [pending] → 대상 부서 조정자 → [dept_approved] → 관리자 → [approved] → 이메일
```

### 문제점

| 문제 | 설명 |
|------|------|
| **보내는 쪽 검증 부재** | 담당자가 소속 부서 조정자를 거치지 않고 바로 타 부서에 요청을 보냄. 내부 해결 가능한 건이 외부로 나갈 수 있음 |
| **소속 부서 조정자의 사각지대** | 자기 부서에서 뭐가 나갔는지 파악 불가. 부서 차원의 연계 현황 관리 불가능 |
| **정보 품질 미검증** | 연계 요청서의 완결성(대상자 정보, 연계 사유, 필요 서비스)을 확인하는 1차 필터 없음 |
| **관리자 재배정 불가** | 관리자가 "이건 다른 부서가 더 적합하다"고 판단해도 승인/반려만 가능 |

---

## 2. 재설계: 3단계 승인 + 관리자 재배정 구조

### 핵심 원칙

> **각 단계의 판단 기준이 서로 다르기 때문에 3단계가 필요하다**

| 단계 | 판단 주체 | 판단 기준 | 판단 질문 |
|------|-----------|-----------|-----------|
| **1차** | 소속 부서 조정자 (부장/센터장) | 연계 **필요성** | "내부 해결 불가가 맞는가? 정보가 충분한가?" |
| **2차** | 대상 부서 조정자 (부장/센터장) | 연계 **수용성** | "우리 부서 소관이 맞는가? 자원 여유가 있는가?" |
| **3차** | 관리자 (본부장) | 연계 **적절성** | "기관 전체 자원 배분 관점에서 타당한가?" |

---

## 3. 전체 흐름도

### 정상 흐름 (Happy Path)

```
[담당자] 연계 요청 생성 (case.html)
    │
    ▼
┌─────────────────────────────────────────────────┐
│  1차: 소속 부서 조정자                              │
│  상태: [pending]                                   │
│                                                    │
│  검증 항목:                                         │
│  · 내부 해결 시도 여부                               │
│  · 연계 요청 정보 완결성 (대상자 정보, 사유, 필요서비스) │
│  · 대상 부서 선정의 타당성                            │
│                                                    │
│  → 승인 / 반려 / 수정요청                             │
└─────────────────────────────────────────────────┘
    │ 승인
    ▼
┌─────────────────────────────────────────────────┐
│  2차: 대상 부서 조정자                               │
│  상태: [origin_approved]                            │
│                                                    │
│  검증 항목:                                         │
│  · 우리 부서 소관 업무인가                             │
│  · 현재 인력/자원 수용 가능한가                        │
│  · 요청 내용의 실행 가능성                             │
│                                                    │
│  → 승인 / 반려 / 수정요청                             │
└─────────────────────────────────────────────────┘
    │ 승인
    ▼
┌─────────────────────────────────────────────────┐
│  3차: 관리자 (최종)                                  │
│  상태: [target_approved]                            │
│                                                    │
│  검증 항목:                                         │
│  · 기관 전체 자원 배분 관점의 타당성                    │
│  · 부서 간 업무 중복/충돌 여부                         │
│  · 우선순위 판단 (긴급/일반)                           │
│                                                    │
│  → 최종승인 / 반려 / 부서변경 / 부서추가               │
└─────────────────────────────────────────────────┘
    │ 최종 승인
    ▼
[approved] → 이메일 자동 발송 → 실행 단계 진입
```

### 반려 흐름

```
어느 단계에서든 반려 시:
    │
    ▼
[rejected] → 반려 사유 기재 → 담당자에게 알림
    │
    ▼
담당자가 수정 후 재제출 → [pending]으로 복귀 → 1차부터 다시 시작
```

### 수정요청 흐름

```
1차 또는 2차 조정자가 수정요청 시:
    │
    ▼
[revision_requested] → 수정 필요 항목 기재 → 담당자에게 알림
    │
    ▼
담당자가 수정 후 재제출 → 수정요청한 단계로 복귀
```

---

## 4. 관리자 재배정 흐름 (핵심 신규 기능)

### 4-1. 부서 변경 (재배정)

관리자가 "이건 원래 대상 부서보다 다른 부서가 더 적합하다"고 판단할 때

```
[target_approved] → 관리자가 부서 변경 결정
    │
    ▼
[redirected] → 새 대상 부서 조정자에게 전달
    │            (사유 + 관리자 배정 태그 포함)
    ▼
┌─────────────────────────────────────────────────┐
│  새 대상 부서 조정자                                 │
│                                                    │
│  · 관리자 배정 건이므로 긴급 표시                       │
│  · 수용 가능 여부 확인                               │
│                                                    │
│  → 수용 승인 → [approved] → 실행                     │
│  → 수용 불가 → 관리자에게 사유와 함께 반환              │
└─────────────────────────────────────────────────┘
```

### 4-2. 부서 추가 (공동처리 확장)

관리자가 "원래 대상 부서에 추가로 다른 부서도 함께 투입해야 한다"고 판단할 때

```
[target_approved] → 관리자가 부서 추가 결정
    │
    ├─→ 원래 대상 부서: [approved] 확정
    │
    └─→ 추가 부서 조정자에게 [additional_pending] 전달
         │
         ▼
         추가 부서 조정자 수용 승인 → [approved]
```

### 4-3. 연계 유형별 관리자 재배정 시나리오

| 연계 유형 | 재배정 시나리오 | 관리자 액션 |
|-----------|----------------|------------|
| **공동처리** | "A부서만으로 부족하니 C부서도 함께 투입" | 부서 추가 |
| **이관** | "이건 A부서 소관이 아니라 D부서 소관이다" | 부서 변경 |

> **자문은 연계가 아닙니다.** 자문은 "의견을 묻고 돌려받는 것"이지 업무 책임이 이동하거나 공유되지 않으므로, 3단계 승인 파이프라인이 아닌 별도 경량 채널로 운영합니다. (→ 14장 참조)

---

## 5. 승인상태 (Approval Status) 전체 목록

기존 7종에서 논리적 흐름을 반영하여 재정의

| 코드 | 한글명 | 의미 | 다음 가능 상태 |
|------|--------|------|---------------|
| `pending` | 승인대기 | 담당자가 생성, 소속 부서 조정자 검토 대기 | origin_approved, rejected, revision_requested |
| `origin_approved` | 소속부서 승인 | 소속 부서 조정자 통과, 대상 부서 검토 대기 | target_approved, rejected, revision_requested |
| `target_approved` | 대상부서 승인 | 대상 부서 조정자 통과, 관리자 최종 검토 대기 | approved, rejected, redirected, additional_pending |
| `approved` | 최종승인 | 관리자 최종 승인 완료, 이메일 발송됨 | (실행상태로 전이) |
| `rejected` | 반려 | 어느 단계에서든 반려됨 (사유 필수) | pending (재제출 시) |
| `revision_requested` | 수정요청 | 조정자가 정보 보완 요청 | pending 또는 origin_approved (재제출 시) |
| `redirected` | 재배정 | 관리자가 다른 부서로 변경함 | approved (새 부서 수용 시), target_approved (반환 시) |

---

## 6. 실행상태 (Execution Status) 정의

승인 완료(`approved`) 이후 실제 연계 서비스가 어떻게 진행되는지를 추적

| 코드 | 한글명 | 의미 |
|------|--------|------|
| `not_started` | 미착수 | 승인 완료 후 아직 실행 시작 전 |
| `in_progress` | 진행중 | 대상 부서에서 서비스 제공 중 |
| `completed` | 완료 | 연계 서비스 제공 완료 (후속 연계 없음) |
| `completed_with_followup` | 완료+후속연계 | 서비스 완료 후 대상 부서가 후속 연계를 생성함 |
| `on_hold` | 보류 | 대상자 사유 등으로 일시 중단 |
| `cancelled` | 취소 | 대상자 철회 또는 상황 변경으로 취소 |

---

## 7. 역할 정의 및 권한 매트릭스

### 7-1. 역할 ↔ 직책 매핑

| 시스템 역할 | 실제 직책 | 비고 |
|------------|-----------|------|
| **관리자** | 본부장 | 기관 전체 최종 의사결정권자 |
| **조정자** | 부장 (본부 부서) | 각 부서의 연계 승인·반려 권한 |
| **부조정자** | 센터장 (광역지원기관) | 광역지원기관은 센터장이 조정자 역할 수행 |
| **담당자** | 소속 직원 | 현장에서 상담 처리 및 연계 요청을 생성하는 실무자 |

> **광역지원기관 특이사항**: 광역지원기관(통합돌봄지원센터, 노인맞춤돌봄 광역지원기관, 응급안전안심 광역지원기관, 경남지역사회서비스지원단)은 통합돌봄사업부 소속이지만 자체 센터장이 있으므로, 연계 승인 시 센터장이 부조정자로서 해당 기관의 1차/2차 승인을 처리한다. 통합돌봄사업부 부장은 이들 기관 전체를 총괄하는 상위 조정자 역할을 겸한다.

### 7-2. 권한 매트릭스

| 액션 | 담당자 (소속 직원) | 조정자 (부장/센터장) - 소속 | 조정자 (부장/센터장) - 대상 | 관리자 (본부장) |
|------|-------------------|--------------------------|--------------------------|----------------|
| 연계 요청 생성 | ✅ | ❌ | ❌ | ❌ |
| **후속 연계 요청 생성** | ❌ | ❌ | ✅ (서비스 완료 시점에만) | ❌ |
| 1차 승인 (필요성) | ❌ | ✅ | ❌ | ❌ |
| 2차 승인 (수용성) | ❌ | ❌ | ✅ | ❌ |
| 최종 승인 (적절성) | ❌ | ❌ | ❌ | ✅ |
| 반려 | ❌ | ✅ | ✅ | ✅ |
| 수정요청 | ❌ | ✅ | ✅ | ❌ |
| 부서 변경 (재배정) | ❌ | ❌ | ❌ | ✅ |
| 부서 추가 (공동처리) | ❌ | ❌ | ❌ | ✅ |
| 재배정 건 수용/반환 | ❌ | ❌ | ✅ | ❌ |
| 실행상태 변경 | ❌ | ❌ | ✅ | ✅ |
| 전체 현황 모니터링 | ❌ | 자기 부서/기관만 | 자기 부서/기관만 | ✅ 전체 |

---

## 8. 화면별 연계 관련 기능 매핑

### 8-1. case.html (담당자 화면)

| 영역 | 기능 |
|------|------|
| **연계 요청 생성 폼** | 연계 유형(공동처리/이관), 대상 부서 선택, 연계 사유, 필요 서비스 기술 → 3단계 승인 파이프라인 |
| **전문가 자문 요청** | 대상 부서/기관 선택, 질의 내용 작성 → 승인 없이 즉시 알림 → 답변 시 케이스 메모에 자동 첨부 |
| 연계 체인 뷰 | 현재 건에 걸린 모든 연계의 상태를 타임라인으로 표시 (자문 이력 + 후속 연계 체인 포함) |
| 수정/재제출 | 반려 또는 수정요청 시 해당 내용을 수정하여 재제출 |
| 자문→연계 전환 | 자문 결과를 근거로 정식 연계 요청을 생성 (자문 내용이 사유에 자동 첨부) |
| **후속 연계 생성** (대상 부서 직원) | 서비스 완료(`completed`) 전환 시 "후속 연계 필요" 옵션 → 후속 연계 요청 생성 (이전 연계·케이스 자동 연결) |

### 8-2. admin.html (관리자 화면)

| 영역 | 기능 |
|------|------|
| 현황판 - 칸반 보드 | 상담 건 카드에 연계 상태 뱃지 표시. 클릭 시 모달에서 연계 상세 확인 |
| 현황판 - KPI | 연계 건수, 평균 처리 시간, 부서별 연계 부하, 반려율, 후속 연계 발생율 (연계만, 자문 제외) |
| 연계 조정 탭 | `target_approved` 상태 건의 최종 승인/반려/부서변경/부서추가 처리 |
| 분석 차트 | 부서별 연계 추이, 유형별 비율, 처리 소요 시간 분포 |
| 서비스 여정 뷰 | 대상자별 연계 체인 시각화 — 후속 연계 포함 전체 서비스 이력 조회 |
| 자문 통계 (별도 섹션) | 자문 건수, 평균 응답 시간, 부서별 자문 부하, 자문→연계 전환율 |

### 8-3. 조정자 뷰 — 부장/센터장 (admin.html 내 역할 분기)

| 영역 | 기능 |
|------|------|
| 보내기 대기함 | 자기 부서/기관 직원이 올린 `pending` 건 목록 → 1차 승인/반려/수정요청 |
| 받기 대기함 | 타 부서에서 자기 부서/기관으로 온 `origin_approved` 건 목록 → 2차 승인/반려/수정요청 |
| 재배정 수신함 | 본부장이 재배정한 `redirected` 건 → 수용/반환 |

> **광역지원기관의 경우**: 센터장이 부조정자로서 위 기능을 수행하며, 통합돌봄사업부 부장은 산하 광역지원기관 전체의 연계 현황을 총괄 모니터링

---

## 9. 대상 조직 구조 (연계 가능 부서/시설)

### 본부 4개 부서

| 부서 | 주요 소관 |
|------|-----------|
| 경영지원부 | 인사, 감사, 회계, 홍보 |
| 통합돌봄사업부 | 광역지원기관(4개) 총괄, 직영시설(4개) 관리, 긴급돌봄, AI 온하나케어, 장기요양 표준모델 |
| 민간지원협력부 | 민간 기관 컨설팅, 안전점검, 대체인력, 장기요양 평가 |
| 정책기획연구부 | 정책 연구, 통계 DB, 보장계획 모니터링 |

### 광역 지원기관 4개 (통합돌봄사업부 소속)

| 기관 | 주요 소관 |
|------|-----------|
| 통합돌봄지원센터 | 경남형 희망나눔 통합돌봄, 4중 안전망, 홈클린버스 |
| 노인맞춤돌봄 광역지원기관 | 59개 수행기관 관리, 종사자 교육, 사례관리 |
| 응급안전안심 광역지원기관 | ICT 장비 관리, 18개 시·군 지역센터 관리 |
| 경남지역사회서비스지원단 | 지역자율형 사회서비스 투자사업 기획·관리, 1,545개 제공기관 품질관리, 부정수급 관리 |

### 직영 시설 (통합돌봄사업부 관리)

| 시설 | 소재지 |
|------|--------|
| 창원종합재가센터 | 창원시 성산구 |
| 김해종합재가센터 | 김해시 |
| 경상남도장애인종합복지관 | 창원시 의창구 |
| 경상남도보조기기센터 | 보조기기 상담·평가·대여·수리·맞춤제작 |

---

## 10. 시나리오 예시

### 시나리오 A: 정상 3단계 승인

> 통합돌봄지원센터 직원이 독거 어르신의 보조기기 필요를 발견

1. **담당자(직원)** → 보조기기센터로 연계 요청 생성 → `pending`
2. **통합돌봄지원센터 센터장** (소속 기관 부조정자) → "내부 해결 불가 확인, 정보 충분" → 승인 → `origin_approved`
3. **보조기기센터 담당 부장** (대상 시설, 통합돌봄사업부 소속) → "소관 맞음, 수용 가능" → 승인 → `target_approved`
4. **본부장** → "적절함" → 최종 승인 → `approved` → 이메일 발송

### 시나리오 B: 관리자 부서 변경 (본부장 재배정)

> 민간지원협력부 직원이 긴급돌봄이 필요한 건을 통합돌봄지원센터에 연계 요청

1. **담당자(직원)** → 통합돌봄지원센터로 연계 요청 → `pending`
2. **민간지원협력부 부장** (소속 부서 조정자) → 승인 → `origin_approved`
3. **통합돌봄지원센터 센터장** (대상 기관 부조정자) → 승인 → `target_approved`
4. **본부장** → "이건 창원종합재가센터가 직접 수행하는 게 빠르겠다" → **부서 변경** → `redirected`
5. **창원종합재가센터 담당** → 수용 승인 → `approved` → 이메일 발송

### 시나리오 C: 본부장 부서 추가 (공동처리)

> 독거 어르신이 보조기기도 필요하고 긴급돌봄도 필요한 복합 케이스

1. **담당자(직원)** → 보조기기센터로 연계 요청 (공동처리) → 3단계 승인 완료
2. **본부장** → "이 건은 통합돌봄지원센터도 함께 투입해야 한다" → **부서 추가**
3. 원래 보조기기센터: `approved` 확정
4. 통합돌봄지원센터 센터장: `additional_pending` → 수용 → `approved`

### 시나리오 D: 1차에서 반려 (부장/센터장이 브레이크)

> 소속 직원이 내부에서 해결 가능한 건을 외부로 보내려 함

1. **담당자(직원)** → 타 부서 연계 요청 → `pending`
2. **소속 부서 부장** → "이건 우리 부서 내부에서 해결 가능하다" → **반려** (사유: "부서 내 OO팀에서 처리 가능")
3. `rejected` → 담당자에게 알림 → 담당자가 내부 처리로 전환

### 시나리오 E: 전문가 자문 (경량 채널)

> 통합돌봄지원센터 직원이 보조기기센터에 기기 적합성 의견을 구함

1. **담당자(직원)** → case.html에서 **"전문가 자문 요청"** 클릭
2. 대상: 보조기기센터, 질의: "80세 여성, 좌측 편마비, 실내 이동용 보조기기 추천"
3. 보조기기센터 담당 직원에게 **시스템 알림** (승인 절차 없음)
4. 보조기기센터 직원이 답변: "경량 실내용 보행기 + 욕실 안전손잡이 권장"
5. 답변이 해당 케이스 메모에 **자동 첨부**, 자문 이력에 기록

### 시나리오 F: 자문 → 연계 전환

> 자문을 받아보니 우리 부서가 아닌 대상 부서가 직접 서비스해야 하는 상황

1. 시나리오 E 진행 후, 보조기기센터 답변: "이 케이스는 맞춤형 제작이 필요해서 우리 센터에서 직접 평가·제작해야 합니다"
2. **담당자(직원)** → 자문 결과 화면에서 **"연계 요청으로 전환"** 클릭
3. 연계 요청 생성 폼이 열리며, 자문 내용이 **연계 사유에 자동 첨부**
4. 이후 정상 3단계 승인 파이프라인 진행 (시나리오 A와 동일)

### 시나리오 G: 서비스 완료 후 후속 연계 (대상 부서 → 다른 부서)

> 보조기기 대여 서비스가 완료되었는데, 서비스 중 어르신의 재가돌봄 필요를 발견

1. **보조기기센터 직원** → 실행상태를 `completed`로 변경하면서 **"후속 연계 필요"** 선택
2. 후속 연계 요청 생성 폼이 열림
   - 원본 케이스 정보 자동 첨부
   - 이전 연계(LNK-001) 이력 자동 연결
   - 서비스 중 발견한 상황 기술: "보조기기 설치 방문 중 거동 불편 및 식사 불규칙 확인"
   - 대상 부서: 창원종합재가센터, 연계 유형: 이관
3. 원래 연계(LNK-001)의 실행상태 → `completed_with_followup`
4. 후속 연계(LNK-002) 생성 → `pending`
   - `previousLinkageId: "LNK-001"`, `isFollowup: true`
   - 원래 연계(LNK-001)의 `followupLinkageId: "LNK-002"` 업데이트
5. **보조기기센터 센터장/부장** (이번에는 보내는 쪽 1차) → 승인 → `origin_approved`
6. **창원종합재가센터 담당** (받는 쪽 2차) → 승인 → `target_approved`
7. **본부장** → 최종 승인 → `approved` → 이메일 발송

> **왜 대상 부서가 직접 생성하는가**: 부서 변경(재배정)이 있었을 경우, 원래 담당자는 이미 해당 건의 관리 주체가 아니므로 현재 상황을 정확히 모를 수 있다. 반면 마지막으로 서비스를 제공한 부서는 대상자의 현재 상태를 가장 정확하게 파악하고 있으므로, 후속 연계의 필요성과 내용을 가장 정확하게 판단할 수 있다.

### 시나리오 H: 후속 연계 체인 — 서비스 여정 추적

> 한 어르신에게 연속적으로 여러 서비스가 제공된 사례

```
LNK-001: 보조기기센터 (보조기기 대여)
  └─ completed_with_followup
      │
      ▼
LNK-002: 창원종합재가센터 (재가돌봄)  ← 후속 연계
  └─ completed_with_followup
      │
      ▼
LNK-003: 통합돌봄지원센터 (4중 안전망 편입)  ← 후속 연계
  └─ in_progress
```

이 체인을 통해 "이 어르신에게 어떤 서비스가 어떤 순서로 제공되었는가"를 한눈에 볼 수 있으며, 각 서비스 완료 시점에서 후속 필요를 발견한 맥락까지 추적 가능하다.

---

## 11. 데이터 모델 (linkages 객체 구조)

```javascript
{
  id: "LNK-20260301-001",
  requestId: "REQ-xxx",              // 원본 상담 요청 ID
  
  // 연계 기본 정보
  type: "joint" | "transfer",  // 공동처리 / 이관 (자문은 별도 채널)
  reason: "독거 어르신 보조기기 필요",
  requiredServices: ["보조기기 상담", "맞춤 평가"],
  
  // 연계 체인 (후속 연계 추적)
  previousLinkageId: null,            // 이전 연계 ID (후속 연계인 경우)
  followupLinkageId: null,            // 후속 연계 ID (후속 연계가 생성된 경우)
  isFollowup: false,                  // 후속 연계 여부
  followupReason: "",                 // 후속 연계 사유 ("서비스 완료 후 추가 필요 발견")
  
  // 부서 정보
  originDept: "통합돌봄사업부",        // 보내는 부서
  targetDept: "보조기기센터",          // 받는 부서
  additionalDepts: [],                // 관리자가 추가한 부서들
  
  // 승인 상태
  approvalStatus: "pending",          // 7종 중 하나
  approvalHistory: [
    {
      stage: "origin",               // origin | target | admin
      action: "approved",            // approved | rejected | revision_requested | redirected
      actor: "김준호",
      actorRole: "dept_coordinator",  // dept_coordinator(부장) | sub_coordinator(센터장) | admin(본부장)
      dept: "통합돌봄사업부",
      reason: "",
      timestamp: "2026-03-01T10:30:00"
    }
  ],
  
  // 재배정 이력 (관리자 부서변경 시)
  redirectHistory: [
    {
      fromDept: "통합돌봄사업부",
      toDept: "창원종합재가센터",
      reason: "직접 수행기관이 더 적합",
      actor: "최관리",
      timestamp: "2026-03-01T14:00:00"
    }
  ],
  
  // 실행 상태
  executionStatus: "not_started",     // 5종 중 하나
  executionHistory: [],
  
  // 메타
  createdBy: "정미영",
  createdAt: "2026-03-01T09:00:00",
  updatedAt: "2026-03-01T14:00:00",
  
  // 알림
  notifications: [
    {
      to: "김준호",
      type: "approval_required",
      sent: true,
      sentAt: "2026-03-01T09:01:00"
    }
  ]
}
```

---

## 12. 현실적 절충안 (조직 규모 고려)

경남사회서비스원 본부 인력은 22명으로 소규모. 3단계가 과부하가 될 수 있으므로:

### 권장: 묵시적 승인 + 동시 알림 하이브리드

| 단계 | 처리 방식 | 타임아웃 |
|------|-----------|----------|
| 1차 (소속 부서) | **24시간 내 반려하지 않으면 자동 승인** (묵시적 승인) | 24시간 |
| 2차 (대상 부서) | 명시적 승인 필수 (수용 여부는 현장만 알 수 있음) | 없음 |
| 3차 (관리자) | 명시적 승인 필수 (재배정 판단 필요) | 없음 |

이렇게 하면 1차는 "이상 없으면 자동 통과"로 속도를 확보하면서도, 문제가 있을 때는 소속 부서 조정자(부장 또는 센터장)가 브레이크를 걸 수 있어요.

추가로, 소속 부서 조정자(부장/센터장)에게는 **연계 발송 알림(CC)**이 항상 가므로 현황 파악은 가능합니다.

---

## 13. 구현 우선순위

| 순서 | 항목 | 현재 상태 | 비고 |
|------|------|-----------|------|
| 1 | 승인상태 7종 재정의 | 기존 7종 → 의미 재정의 필요 | server.js 상태 전이 로직 |
| 2 | 소속 부서 조정자(부장/센터장) 1차 승인 추가 | 신규 | 가장 큰 구조 변경 |
| 3 | 본부장 부서변경/추가 기능 | 신규 | admin.html 연계 조정 탭 |
| 4 | redirected 상태 + 새 부서 수용 흐름 | 신규 | 재배정 수신함 UI |
| 5 | 묵시적 승인 타이머 (24시간) | 신규 (선택) | 24시간 자동 승인 로직 |
| 6 | 조정자 뷰 분리 (보내기/받기) | 기존 연계 조정 탭 개편 | admin.html 내 역할 분기 (부장 vs 센터장) |
| 7 | 후속 연계 생성 기능 | 신규 | 서비스 완료 시점 조건부 권한, 연계 체인 연결 |
| 8 | 서비스 여정 뷰 (연계 체인 시각화) | 신규 | case.html 연계 체인 뷰에 후속 연계 체인 표시 |
| 9 | 전문가 자문 채널 (경량) | 신규 | case.html 자문 요청/답변 UI + 알림 |
| 10 | 자문→연계 전환 기능 | 신규 | 자문 결과를 근거로 정식 연계 생성 |
| 11 | 자문 통계 (admin.html) | 신규 | 연계 KPI와 분리된 별도 섹션 |

---

## 14. 전문가 자문 채널 (연계와 분리된 경량 시스템)

### 14-1. 왜 분리하는가

| 구분 | 연계 (공동처리/이관) | 자문 |
|------|---------------------|------|
| **본질** | 업무 책임의 이동 또는 공유 | 의견을 묻고 돌려받는 것 |
| **승인** | 3단계 필수 | 불필요 |
| **업무 책임** | 대상 부서로 이동/공유됨 | 요청한 쪽에 그대로 남음 |
| **KPI 추적** | 연계 건수, 처리 시간 등 | 자문 건수, 응답 시간 (별도) |
| **이메일 발송** | 최종 승인 시 자동 발송 | 없음 (시스템 내 알림만) |
| **과도한 행정 비용** | 정당함 (업무 이동이므로) | 부당함 (질문 하나에 본부장 승인은 과도) |

자문을 연계 파이프라인에 넣으면 생기는 문제:
- 단순 질문에 3단계 승인 → 현장 직원이 시스템 우회 (전화/카톡으로 물어봄) → 이력 미기록
- 연계 KPI에 자문이 섞임 → "부서 간 연계 건수 50건" 중 30건이 사실은 질문 → 지표 왜곡
- 관리자가 자문에 대해 "부서 변경"하는 건 논리적 모순

### 14-2. 자문 채널 흐름

```
[담당자] "전문가 자문 요청" (case.html)
    │
    │  승인 절차 없음
    ▼
[대상 부서/기관 직원]에게 시스템 알림
    │
    ▼
대상 직원이 답변 작성
    │
    ▼
답변이 원본 케이스 메모에 자동 첨부
    │
    ▼ (필요 시)
[자문→연계 전환] → 정식 연계 요청 생성 → 3단계 승인 파이프라인
```

### 14-3. 자문 데이터 모델

```javascript
{
  id: "CON-20260301-001",
  requestId: "REQ-xxx",              // 원본 상담 요청 ID (케이스 연결)
  
  // 자문 정보
  fromDept: "통합돌봄지원센터",
  fromUser: "정미영",
  toDept: "보조기기센터",
  toUser: "박기술",                   // 특정 직원 또는 부서 전체
  
  // 질의/응답
  question: "80세 여성, 좌측 편마비, 실내 이동용 보조기기 추천",
  answer: "경량 실내용 보행기 + 욕실 안전손잡이 권장",
  answeredAt: "2026-03-01T15:30:00",
  
  // 상태
  status: "answered",                // pending | answered | converted_to_linkage
  
  // 연계 전환 (발생 시)
  convertedLinkageId: null,          // 전환된 연계 ID (예: "LNK-20260301-002")
  
  // 메타
  createdAt: "2026-03-01T14:00:00",
  attachedToCaseMemo: true           // 케이스 메모 자동 첨부 여부
}
```

### 14-4. 자문→연계 전환 메커니즘

자문 결과 "이건 우리 부서가 직접 해야 한다"는 결론이 나올 수 있음. 이때 자문을 근거로 정식 연계 요청을 생성하는 전환 기능이 필요함.

**전환 시 자동 처리 항목:**

| 항목 | 처리 방식 |
|------|-----------|
| 연계 사유 | 자문 질의 + 답변 내용이 사유란에 자동 첨부 |
| 대상 부서 | 자문 응답 부서가 기본값으로 설정 (변경 가능) |
| 연계 유형 | 답변 내용에 따라 담당자가 선택 (공동처리 / 이관) |
| 자문 상태 | `answered` → `converted_to_linkage`로 변경 |
| 추적 연결 | 자문 ID와 연계 ID가 상호 참조 |

**전환의 장점:**
- 1차 조정자(부장/센터장)가 자문 이력을 보고 "이미 전문가 의견을 거쳤구나" 확인 → 승인 판단 속도 향상
- 연계 사유의 근거가 명확해짐 (단순 "보조기기 필요"가 아닌 전문가 소견 포함)
- 자문과 연계의 인과관계가 시스템에 기록됨

### 14-5. 화면 구현 위치

| 화면 | 자문 관련 기능 |
|------|---------------|
| **case.html** | "전문가 자문 요청" 버튼 (연계 요청과 병렬 배치), 자문 이력 탭, 자문→연계 전환 버튼 |
| **admin.html** | 자문 통계 (건수, 평균 응답 시간, 부서별 자문 부하) — KPI와 분리된 별도 섹션 |
| **알림** | 자문 요청 시 대상 직원에게 시스템 내 알림 (이메일 아님) |

### 14-6. 자문 vs 연계 — 담당자 선택 가이드 (UI에 표시)

담당자가 헷갈리지 않도록 case.html에 간단한 가이드를 표시:

```
┌──────────────────────────────────────────────────┐
│  어떤 도움이 필요한가요?                              │
│                                                    │
│  📋 [전문가 자문 요청]                               │
│     "다른 부서의 전문 의견이 필요해요"                  │
│     → 승인 없이 바로 질문, 답변은 메모에 기록           │
│                                                    │
│  🔗 [연계 요청]                                     │
│     "다른 부서가 직접 서비스를 제공해야 해요"            │
│     → 공동처리 또는 이관, 3단계 승인 필요              │
└──────────────────────────────────────────────────┘
```

---

## 15. 후속 연계 (Follow-up Linkage) — 서비스 완료 후 재연계

### 15-1. 문제 정의

현재 연계 흐름은 `completed`에서 끝난다. 하지만 현실에서는 서비스를 제공하는 과정에서 대상자의 **추가 필요**를 발견하는 경우가 빈번하다.

```
보조기기 설치 방문 → "이 어르신, 식사도 불규칙하고 거동도 불편하시네"
                     → 재가돌봄 서비스 연계 필요
```

이때 **원래 담당자(최초 요청 부서 직원)**에게 돌려보내면 문제가 생긴다:

| 문제 | 설명 |
|------|------|
| **관리 주체 이탈** | 부서 변경(재배정)이 있었을 경우, 원래 담당자는 이미 해당 건의 관리 주체가 아님 |
| **현황 인지 부족** | 원래 담당자는 서비스 제공 과정에서 발견된 새로운 상황을 직접 목격하지 못함 |
| **전달 과정 지연** | 대상 부서 → 원래 담당자 → 새 연계 요청의 추가 단계로 시간 소모 |
| **정보 손실** | 현장에서 관찰한 구체적 상황이 전달 과정에서 축약되거나 누락될 수 있음 |

### 15-2. 설계 원칙

> **서비스를 마지막으로 제공한 부서가 대상자의 현재 상태를 가장 정확하게 안다.**

따라서 **대상 부서(서비스 실행 부서)의 직원**이 서비스 완료 시점에 직접 후속 연계 요청을 생성할 수 있어야 한다.

### 15-3. 후속 연계 흐름

```
[대상 부서 직원] 실행상태를 completed로 변경
    │
    ├─ 후속 연계 불필요
    │   → completed (종결)
    │
    └─ "후속 연계 필요" 선택
         │
         ▼
    ┌─────────────────────────────────────────────────┐
    │  후속 연계 요청 생성 폼                              │
    │                                                    │
    │  자동 첨부:                                         │
    │  · 원본 케이스 정보                                  │
    │  · 이전 연계(LNK-001) 전체 이력                      │
    │  · 제공한 서비스 내용 및 결과                          │
    │                                                    │
    │  직원 작성:                                         │
    │  · 후속 연계 사유 (서비스 중 발견한 상황)               │
    │  · 대상 부서 선택                                    │
    │  · 연계 유형 (공동처리 / 이관)                        │
    │  · 필요 서비스 기술                                  │
    └─────────────────────────────────────────────────┘
         │
         ▼
    원래 연계(LNK-001): completed → completed_with_followup
    후속 연계(LNK-002): 생성 → pending
         │
         ▼
    기존 3단계 승인 파이프라인 진입
    (이번에는 대상 부서가 "보내는 쪽"이 됨)
```

### 15-4. 후속 연계의 승인 흐름 (역할 전환)

후속 연계에서는 **보내는 쪽과 받는 쪽이 바뀐다**는 점이 핵심이다.

```
[원래 연계]                         [후속 연계]
보내는 쪽: 통합돌봄지원센터         보내는 쪽: 보조기기센터 (원래 받는 쪽)
받는 쪽:   보조기기센터              받는 쪽:   창원종합재가센터 (새로운 대상)
```

| 단계 | 후속 연계에서의 역할 |
|------|---------------------|
| 1차 (소속 부서 조정자) | 보조기기센터의 조정자(부장/센터장)가 후속 연계 필요성 검증 |
| 2차 (대상 부서 조정자) | 창원종합재가센터의 조정자가 수용 여부 판단 |
| 3차 (관리자) | 본부장이 전체 적절성 판단 |

### 15-5. 후속 연계 생성 조건 (권한 통제)

후속 연계 생성은 무제한이 아닌 **조건부 권한**이다.

| 조건 | 설명 |
|------|------|
| **시점** | 실행상태를 `completed`로 전환하는 시점에만 생성 가능 |
| **주체** | 해당 연계의 대상 부서 소속 직원만 가능 |
| **횟수** | 하나의 연계에서 후속 연계는 1건만 생성 가능 (추가 필요 시 후속의 후속으로 체인) |
| **검증** | 생성 후 기존 3단계 승인을 동일하게 거침 (후속이라고 승인 생략 불가) |

### 15-6. 연계 체인과 서비스 여정 뷰

후속 연계가 누적되면 하나의 **서비스 여정(Service Journey)**이 형성된다. case.html의 연계 체인 뷰에서 이를 시각화한다.

```
📋 케이스 REQ-xxx: 김OO 어르신 (80세, 독거)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔗 LNK-001  보조기기 대여 (이관)
   통합돌봄지원센터 → 보조기기센터
   ✅ completed_with_followup
   기간: 2026-03-01 ~ 2026-03-15
        │
        ▼ 후속 연계 (서비스 중 재가돌봄 필요 발견)
🔗 LNK-002  재가돌봄 서비스 (이관)
   보조기기센터 → 창원종합재가센터
   ✅ completed_with_followup
   기간: 2026-03-16 ~ 2026-04-30
        │
        ▼ 후속 연계 (안전 모니터링 필요)
🔗 LNK-003  4중 안전망 편입 (공동처리)
   창원종합재가센터 → 통합돌봄지원센터
   🔄 in_progress
   기간: 2026-05-01 ~
```

이 뷰를 통해 관리자(본부장)는 한 대상자에게 제공된 **서비스 전체 여정**을 한눈에 파악하고, 서비스 간 연속성과 적절성을 판단할 수 있다.
